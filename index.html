<!DOCTYPE html>
<html lang="th">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preconnect" href="https://static.line-scdn.net">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4FR74WPRNY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4FR74WPRNY');
    </script>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    
    <title>Kaprao52 - APP</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script defer src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            purple: '#8B5CF6', 
                            yellow: '#FBBF24',
                            text: '#1F2937',        
                        }
                    },
                    fontFamily: {
                        sans: ['Kanit', 'sans-serif'],
                        round: ['Kanit', 'sans-serif'] 
                    },
                    borderRadius: {
                        '4xl': '2.5rem',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        body { 
            color: #1F2937; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            background: #f3f4f6; 
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }
        .safe-area-pt { padding-top: var(--sat); }
        .safe-area-pb { padding-bottom: var(--sab); }
        .safe-area-pb-plus { padding-bottom: calc(1rem + var(--sab)); }

        /* --- BACKGROUND ANIMATION --- */
        #bubbles-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        .bubble {
            position: absolute;
            bottom: -100px;
            background-color: rgba(251, 191, 36, 0.15);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp linear infinite;
            z-index: -1;
        }
        .bubble.purple {
            background-color: rgba(139, 92, 246, 0.1);
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-110vh) translateX(20px); opacity: 0; }
        }

        /* --- NEO-GLASS COMPONENTS --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .fast-card {
            background: #FFFFFF;
            border: 1px solid #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            border-radius: 1.25rem;
            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 1;
        }
        .fast-card:active {
            transform: scale(0.97);
            background: #fafafa;
        }

        .glass-heavy {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 1);
        }

        /* --- ANIMATIONS --- */
        .btn-bounce { transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-bounce:active { transform: scale(0.92); }

        .stagger-item { opacity: 0; animation: fadeInUpSimple 0.4s ease-out forwards; }
        @keyframes fadeInUpSimple { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .skeleton {
            background: #f0f0f0;
            position: relative; overflow: hidden;
        }
        .skeleton::after {
            content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-100%); animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        .page-out { animation: pageOut 0.15s ease-in forwards; }
        .page-in { animation: pageIn 0.2s ease-out forwards; }
        @keyframes pageOut { to { opacity: 0; transform: scale(0.98); } }
        @keyframes pageIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .category-pill-active {
            background: #ffffff;
            border: 2px solid #FBBF24;
            color: #1F2937;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(251, 191, 36, 0.2);
            transform: scale(1.05);
        }
        .category-pill-inactive {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.8);
            color: #6B7280;
        }

        .text-gradient {
            background: linear-gradient(to right, #7C3AED, #DB2777);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-gradient {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
            border: none;
        }
        .btn-gradient-purple {
            background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
            border: none;
        }

        #global-loader { position: fixed; inset: 0; z-index: 9999; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.4s ease, visibility 0.4s; }
        .loader-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .cooking-pan { font-size: 4rem; animation: panFlip 1.5s infinite ease-in-out; transform-origin: center bottom; }
        @keyframes panFlip { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }

        #wheel-container { position: relative; width: 280px; height: 280px; margin: 0 auto 20px auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); }
        #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 8s cubic-bezier(0.1, 0.99, 0.1, 0.99); }
        .wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 35px solid #F59E0B; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); z-index: 20; }
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: white; border-radius: 50%; z-index: 10; box-shadow: 0 0 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 20px; }

        #receipt-capture { position: fixed; top: -9999px; left: -9999px; width: 400px; background: #FFFFFF; padding: 0; border-radius: 0; font-family: 'Kanit', sans-serif; color: #1F2937; }

        .xp-bar-bg { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; }
        .xp-bar-fill { background: linear-gradient(90deg, #F59E0B, #D97706); height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .ticket-stub {
            background-image: radial-gradient(circle at 0 50%, transparent 8px, #ffffff 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, #ffffff 8.5px);
            background-position: 0 0, 0 0; background-size: 100% 100%; transition: transform 0.1s ease;
        }
        
        .avatar-option { width: 65px; height: 65px; cursor: pointer; transition: transform 0.2s; position: relative; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #ffffff; padding: 5px; border: 2px solid #f3f4f6; }
        .avatar-option img { width: 100%; height: 100%; object-fit: contain; }
        .avatar-option:hover { transform: scale(1.1); border-color: #F59E0B; }
        .avatar-selected { background: #fffbeb !important; border: 2px solid #F59E0B; box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); transform: scale(1.1); }
        
        .badge-newbie { background: #fefce8; color: #d97706; border: 1px solid #fde68a; }
        .badge-regular { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .badge-god { background: #fef3c7; color: #78350f; border: 1px solid #fcd34d; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }

    </style>
</head>
<body class="pb-32 font-sans select-none relative overflow-x-hidden safe-area-pt">

    <div id="bubbles-container"></div>

    <div id="global-loader">
        <div class="relative mb-4">
            <div class="absolute inset-0 bg-yellow-200 rounded-full blur-xl opacity-50 animate-pulse"></div>
            <div class="cooking-pan relative z-10">üç≥</div>
        </div>
        <h2 class="text-xl font-bold text-gray-800 tracking-wider">KAPRAO<span class="text-yellow-500">52</span></h2>
        <p id="loader-text" class="text-xs text-gray-400 mt-2 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡πâ‡∏≤‡∏ô...</p>
    </div>

    <div id="welcome-modal" class="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm flex items-center justify-center p-6 stagger-item">
        <div class="glass-heavy rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden border border-white/50">
            <div class="relative z-10">
                <div class="w-24 h-24 bg-white/50 rounded-full flex items-center justify-center mx-auto mb-4 text-5xl shadow-lg border border-white animate-bounce-slow">
                    üéüÔ∏è
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î!</h2>
                <p class="text-gray-600 mb-6 leading-relaxed text-sm">
                    <span class="font-bold text-indigo-600 text-base">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á!</span><br>
                    ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ (‡∏ô‡πâ‡∏≠‡∏¢‡πÜ) ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô<br>
                    ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ Order ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö<br>
                    <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold border border-yellow-200">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•</span><br>
                    ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! üéÅ
                </p>
                <div class="flex flex-col gap-3">
                      <button onclick="requestNotifPermission()" class="btn-bounce w-full bg-white text-indigo-600 font-bold py-3 rounded-xl shadow-sm border border-indigo-200 transition-all text-sm">
                        <i class="fas fa-bell mr-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏´‡∏ß‡∏¢
                    </button>
                    <button onclick="closeWelcome()" class="btn-bounce w-full btn-gradient-purple text-white font-bold py-4 rounded-xl shadow-lg transition-all text-lg hover:scale-[1.02]">
                        ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢! ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î üé∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="avatar-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[120] hidden transition-opacity opacity-0 flex items-center justify-center p-6">
        <div class="glass-heavy rounded-[2rem] p-6 max-w-sm w-full shadow-2xl stagger-item border border-white/60">
            <h3 class="text-xl font-bold text-center mb-4 text-gray-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß üë§</h3>
            
            <div class="grid grid-cols-4 gap-4 mb-6" id="avatar-grid"></div>

            <div class="mb-6">
                 <label class="text-sm font-bold text-gray-700 mb-2 block pl-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üí¨</label>
                 <input type="text" id="pet-name-input" maxlength="12" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤" class="w-full bg-white border border-gray-200 rounded-xl p-3 text-center font-bold text-indigo-600 focus:border-indigo-400 outline-none transition-all">
            </div>

            <button onclick="closeAvatarModal()" class="btn-bounce w-full btn-gradient text-white font-bold py-3 rounded-xl shadow-lg transition-all text-lg">
                ‡∏ï‡∏Å‡∏•‡∏á
            </button>
        </div>
    </div>

    <div class="px-6 pt-6 pb-2 bg-transparent relative z-10">
        
        <div class="flex justify-between items-start mb-6">
            <div class="flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-1">
                    <p class="text-xs text-gray-500 font-medium">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ?</p>
                    <button id="line-login-btn" onclick="handleLogin()" class="hidden bg-[#06C755] hover:bg-[#05b34c] text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm transition-all flex items-center gap-1 btn-bounce">
                        <i class="fab fa-line"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
                
                <h1 class="text-4xl sm:text-5xl font-black leading-none tracking-tighter mb-2 relative z-10 pt-1 drop-shadow-sm whitespace-nowrap flex items-baseline">
                    <span class="text-gray-900">KAPRAO</span>
                    <span class="text-yellow-500 ml-1">52</span>
                </h1>

                <div id="streak-display" class="hidden mt-1 inline-flex items-center gap-1 bg-gradient-to-r from-orange-400 to-red-500 text-white text-[10px] px-2 py-0.5 rounded-full w-max shadow-sm animate-pulse">
                    <i class="fas fa-fire"></i> <span id="streak-text">‡∏™‡∏±‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô 0 ‡∏ß‡∏±‡∏ô</span>
                </div>
            </div>

            <div class="flex flex-col items-center">
                 <div id="header-avatar-btn" onclick="openAvatarModal()" class="btn-bounce w-24 h-24 rounded-full bg-white border border-white shadow-lg flex items-center justify-center relative cursor-pointer overflow-hidden">
                      <img id="avatar-img" src="" class="w-full h-full object-cover">
                      <div class="absolute bottom-0 right-0 bg-indigo-500 rounded-full w-7 h-7 flex items-center justify-center shadow-md border-2 border-white z-30" style="bottom: 5px; right: 5px;">
                          <i class="fas fa-pen text-xs text-white"></i>
                      </div>
                </div>
                <p id="avatar-name-display" class="text-xs font-round font-bold text-indigo-600 mt-3 tracking-wide bg-white/90 px-4 py-1 rounded-full shadow-sm border border-white/50">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
            </div>
        </div>

        <div class="glass-panel p-3 rounded-xl shadow-sm mb-1 flex items-center gap-3 stagger-item" style="animation-delay: 0.1s;">
            <div id="badge-icon" class="w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-inner transition-all duration-500 border border-white bg-white">
                üê£
            </div>
            <div class="flex-1">
                <div class="flex justify-between items-end mb-1">
                    <span id="level-title" class="text-sm font-bold text-gray-700">‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏±‡∏î‡∏Å‡∏¥‡∏ô</span>
                    <span id="level-count" class="text-[10px] text-gray-500">0/10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                </div>
                <div class="xp-bar-bg">
                    <div id="level-fill" class="xp-bar-fill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 mt-2">
            <p class="text-[10px] text-gray-500">‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏ó‡∏ô‡πÉ‡∏à! üéÅ</p>
            <button onclick="openMyTickets()" class="btn-bounce bg-white/80 px-3 py-1.5 rounded-full border border-white shadow-sm flex items-center gap-2 text-xs font-bold text-gray-700 active:bg-white transition-all">
                <span>üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                <div id="unread-ticket-dot" class="w-2 h-2 bg-red-500 rounded-full hidden"></div>
            </button>
        </div>

    </div>

    <div class="max-w-md mx-auto px-5 relative z-10">
        
        <div class="mb-3 flex items-center justify-between">
            <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà 
                <button onclick="randomMenu()" class="btn-bounce bg-white text-indigo-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm border border-gray-200 hover:bg-gray-50 transition-all flex items-center gap-1 ml-2">
                    <i id="dice-icon" class="fas fa-dice"></i> ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
                </button>
            </h3>
            <div class="flex gap-2">
                <button onclick="scrollTabs(-100)" class="btn-bounce bg-white w-11 h-11 rounded-full flex items-center justify-center text-gray-500 hover:text-indigo-600 transition-all border border-gray-200 shadow-sm"><i class="fas fa-chevron-left text-xs"></i></button>
                <button onclick="scrollTabs(100)" class="btn-bounce bg-white w-11 h-11 rounded-full flex items-center justify-center text-gray-500 hover:text-indigo-600 transition-all border border-gray-200 shadow-sm"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>
        </div>
        
        <div id="tabs-container" class="sticky top-0 z-30 pt-2 pb-4 -mx-5 px-5 flex gap-3 snap-x scroll-smooth overflow-x-auto hide-scroll transition-all">
            <button onclick="switchCategory('kaprao')" id="tab-kaprao" class="btn-bounce snap-start category-pill-active min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üå∂Ô∏è</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤</span>
            </button>
            <button onclick="switchCategory('garlic')" id="tab-garlic" class="btn-bounce snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üßÑ</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</span>
            </button>
            <button onclick="switchCategory('noodle')" id="tab-noodle" class="btn-bounce snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üçú</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô</span>
            </button>
            <button onclick="switchCategory('soup')" id="tab-soup" class="btn-bounce snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üç≤</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°</span>
            </button>
            <button onclick="switchCategory('others')" id="tab-others" class="btn-bounce snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üç≥</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏Ç‡πà/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
            </button>
            <button onclick="switchCategory('dessert')" id="tab-dessert" class="btn-bounce snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üç®</span>
                <span class="text-xs">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</span>
            </button>
            <button onclick="switchCategory('promotion')" id="tab-promotion" class="btn-bounce snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all border-dashed border-red-300 text-red-500">
                <span class="text-xl">üßß</span>
                <span class="text-xs font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
            </button>
        </div>

        <div class="mb-4 mt-2">
            <h3 id="section-title" class="font-bold text-gray-800 text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
        </div>

        <div id="dessert-msg" class="hidden mb-6 stagger-item">
            <div class="bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center text-center shadow-sm">
                <div class="text-3xl mb-2">üç® ‚ú®</div>
                <h4 class="font-bold text-indigo-600 text-sm">‡∏£‡∏≠‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà‡πÜ ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</h4>
                <p class="text-xs text-gray-500 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏î‡∏™‡∏£‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô</p>
            </div>
        </div>

        <div id="menu-grid" class="flex flex-col gap-4 min-h-[300px]"></div>

        <div class="text-center mt-12 mb-20 opacity-50">
            <p class="text-[10px] font-bold tracking-widest text-gray-400 uppercase">DEVELOPED BY SORAWIT THUNTHAKIJ V18.4.4 (FullSync)</p>
        </div>

    </div>
    
    <div id="tickets-modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden transition-opacity opacity-0" onclick="closeMyTickets()"></div>
    <div id="tickets-sheet" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-[111] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[70vh] flex flex-col safe-area-pb">
        <div class="w-full flex justify-center pt-4 pb-2">
             <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>
        <div class="px-6 py-2 border-b border-gray-200/50 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏´‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <button onclick="closeMyTickets()" class="btn-bounce w-11 h-11 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-times text-sm"></i></button>
        </div>
        <div id="tickets-list" class="flex-1 overflow-y-auto p-4 space-y-3 hide-scroll">
            <div class="text-center text-gray-400 mt-10">
                <div class="text-4xl mb-2 opacity-30">üéüÔ∏è</div>
                <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
            </div>
        </div>
    </div>

    <div id="mini-cart-bar" class="fixed bottom-[calc(1.5rem+env(safe-area-inset-bottom))] left-5 right-5 z-40 hidden stagger-item">
        <div onclick="openCheckout()" class="btn-bounce bg-white/95 text-gray-800 p-4 rounded-full shadow-2xl flex justify-between items-center cursor-pointer border border-white">
            <div class="flex items-center gap-3 pl-2">
                <div class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center text-yellow-400 font-bold shadow-lg" id="mini-count">0</div>
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                    <span class="font-bold text-lg leading-none text-indigo-600" id="mini-total">0 ‡∏ø</span>
                </div>
            </div>
            <div class="flex items-center gap-2 pr-4 text-indigo-600 font-bold text-sm">
                <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>

    <div id="checkout-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden transition-opacity opacity-0" onclick="closeCheckout()"></div>
    <div id="checkout-sheet" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-50 transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[85vh] flex flex-col touch-pan-y safe-area-pb">
        
        <div id="checkout-drag-handle" class="w-full flex justify-center pt-4 pb-2 cursor-grab active:cursor-grabbing z-50">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <div class="px-6 pb-4 border-b border-gray-200/50 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
            <div class="flex gap-2">
                <button onclick="clearCart()" class="btn-bounce w-11 h-11 rounded-full bg-red-50 flex items-center justify-center text-red-500 active:bg-red-100 transition-all"><i class="fas fa-trash text-xs"></i></button>
                
                <button onclick="generateOrderCard()" class="btn-bounce h-11 px-4 rounded-full bg-indigo-50 flex items-center gap-2 text-indigo-600 font-bold text-xs active:bg-indigo-100 transition-all shadow-sm border border-indigo-100">
                    <i class="fas fa-download"></i>
                    <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•</span>
                </button>

                <button onclick="closeCheckout()" class="btn-bounce w-11 h-11 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 active:bg-gray-200 transition-all"><i class="fas fa-times text-sm"></i></button>
            </div>
        </div>
        
        <div id="cart-list-container" class="flex-1 overflow-y-auto px-6 py-4 space-y-3 hide-scroll"></div>
        
        <div class="p-6 bg-white/90 backdrop-blur-md rounded-t-[2rem] space-y-3 border-t border-white/50">
            <div class="bg-white rounded-xl p-3 flex items-center border border-gray-200 shadow-sm gap-2">
                <i class="fas fa-user text-gray-400 ml-1"></i>
                <input type="text" id="user-name" maxlength="20" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á" class="bg-transparent w-full text-base outline-none text-gray-700">
            </div>
            
            <div class="bg-white rounded-xl p-2 pl-4 flex items-center border border-gray-200 shadow-sm justify-between transition-colors" id="code-input-container">
                <div class="flex items-center gap-2 w-full">
                    <i class="fas fa-ticket-alt text-gray-400" id="code-icon"></i>
                    <input type="text" id="discount-code" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="bg-transparent w-full text-base outline-none text-gray-700 uppercase transition-colors">
                </div>
                <button onclick="applyDiscount()" id="btn-apply-code" class="btn-bounce bg-gray-800 hover:bg-gray-700 text-white text-xs px-4 py-2 rounded-lg transition-colors font-bold whitespace-nowrap active:bg-gray-900">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
            </div>
            <p id="discount-msg" class="text-xs h-4 pl-2 font-medium"></p>

            <div class="flex justify-between items-end mb-2 px-2">
                <div class="flex flex-col">
                    <span class="text-gray-500 text-sm">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                </div>
                <span id="sheet-grand-total" class="text-2xl font-bold text-indigo-600">0 ‡∏ø</span>
            </div>

            <button onclick="submitOrderToLine()" id="btn-submit-order" class="btn-bounce w-full btn-gradient text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 text-lg">
                <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</span>
                <i class="fas fa-paper-plane"></i>
            </button>
            <div class="h-10"></div> </div>
    </div>

    <div id="reward-modal" class="fixed inset-0 z-[130] bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 hidden stagger-item">
        <div class="bg-white rounded-[2rem] p-1 w-full max-w-sm shadow-2xl relative overflow-hidden border border-white">
            <div class="absolute inset-0 z-0 opacity-20" style="background: repeating-conic-gradient(#F59E0B 0 15deg, transparent 15deg 30deg);"></div>
            
            <div class="bg-white/90 backdrop-blur-sm rounded-[1.8rem] p-6 text-center relative z-10">
                <div class="w-28 h-28 btn-gradient rounded-full flex items-center justify-center mx-auto mb-4 text-6xl shadow-lg border-4 border-white animate-bounce-slow">
                    üëë
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-1">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h2>
                <p class="text-indigo-600 font-bold text-lg mb-4">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤"</p>
                
                <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6">
                    <p class="text-sm text-gray-600 mb-2">‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ü‡∏£‡∏µ!</p>
                    <div class="font-bold text-xl text-orange-600">üéÅ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Moshi Moshi</div>
                    <p class="text-[10px] text-gray-400 mt-1">(‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30.-)</p>
                </div>

                <p class="text-xs text-gray-500 mb-4">‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>

                <button onclick="claimReward()" class="btn-bounce w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all text-lg">
                    ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö / ‡πÅ‡∏Ñ‡∏õ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß üì∏
                </button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden transition-opacity opacity-0" onclick="closeModal()"></div>
    <div id="modal-content" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-50 transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[85vh] flex flex-col touch-pan-y safe-area-pb">
        
        <div id="modal-drag-handle" class="w-full flex justify-center pt-4 pb-2 cursor-grab active:cursor-grabbing z-50">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <button onclick="closeModal()" class="btn-bounce absolute top-4 right-4 z-50 bg-gray-900 text-white w-11 h-11 rounded-full flex items-center justify-center shadow-lg active:bg-black transition-all border-2 border-white">
            <i class="fas fa-times text-sm"></i>
        </button>

        <div id="modal-scroll-area" class="flex-1 overflow-y-auto hide-scroll px-6 pb-24 pt-4">
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-6xl shadow-inner border-4 border-white">
                    <span id="modal-icon">üçú</span>
                </div>
            </div>

            <div class="text-center mb-8">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-1 font-round">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h3>
                <div class="flex justify-center items-center gap-2">
                    <span id="modal-kcal" class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-bold transition-all">0 kcal</span>
                    <span class="text-gray-300">|</span>
                    <span id="modal-price" class="text-xl font-bold text-indigo-600">50</span>
                    <span class="text-sm text-gray-400">‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>

            <div class="flex items-center justify-center gap-6 mb-6">
                <button onclick="adjustQty(-1)" class="btn-bounce w-12 h-12 rounded-full bg-white text-gray-600 flex items-center justify-center font-bold shadow-sm border border-gray-200 active:bg-gray-100 transition-all text-lg">-</button>
                <span id="modal-qty" class="text-2xl font-bold text-gray-800 w-8 text-center">1</span>
                <button onclick="adjustQty(1)" class="btn-bounce w-12 h-12 rounded-full btn-gradient text-white flex items-center justify-center font-bold shadow-md active:scale-95 transition-all text-lg">+</button>
            </div>

            <div id="modal-meat-section" class="mb-6 hidden">
                <h4 class="font-bold text-gray-800 mb-3 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scroll p-1" id="meat-options-container">
                    <label class="cursor-pointer flex-shrink-0"><input type="radio" name="modal-meat" value="‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠" class="peer sr-only"><div class="px-4 py-2 rounded-xl border border-gray-200 bg-white text-sm text-gray-500 peer-checked:border-yellow-400 peer-checked:bg-yellow-50 peer-checked:text-gray-800 transition-all btn-bounce shadow-sm">‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠</div></label>
                    <label class="cursor-pointer flex-shrink-0"><input type="radio" name="modal-meat" value="‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö" class="peer sr-only"><div class="px-4 py-2 rounded-xl border border-gray-200 bg-white text-sm text-gray-500 peer-checked:border-yellow-400 peer-checked:bg-yellow-50 peer-checked:text-gray-800 transition-all btn-bounce shadow-sm">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö</div></label>
                    <label class="cursor-pointer flex-shrink-0"><input type="radio" name="modal-meat" value="‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á" class="peer sr-only"><div class="px-4 py-2 rounded-xl border border-gray-200 bg-white text-sm text-gray-500 peer-checked:border-yellow-400 peer-checked:bg-yellow-50 peer-checked:text-gray-800 transition-all btn-bounce shadow-sm">‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á</div></label>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold text-gray-800 mb-3 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢</h4>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-100 hover:border-yellow-200 cursor-pointer transition-all has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 btn-bounce shadow-sm">
                        <div class="flex items-center gap-3"><span class="text-sm font-medium text-gray-700">üíé ‡∏û‡∏¥‡πÄ‡∏®‡∏©</span></div>
                        <div class="flex items-center gap-3"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-special" class="accent-yellow-500 w-5 h-5 rounded" value="10"></div>
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-100 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">üç≥ ‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaikhon" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-100 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">ü•ö ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaidao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-100 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">ü•û ‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaijiao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-100 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">‚ö´ ‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaiyiewma" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-100 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">ü•ö ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaitom" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-bold text-gray-800 mb-2 text-sm">Note</h4>
                <textarea id="modal-note" rows="2" maxlength="100" class="w-full bg-white border border-gray-200 rounded-2xl p-4 text-base focus:ring-2 focus:ring-indigo-400 resize-none shadow-inner" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î, ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢..."></textarea>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-200 rounded-t-[2rem] safe-area-pb-plus">
            <button onclick="addToCart()" class="btn-bounce w-full btn-gradient-purple text-white font-bold text-lg py-4 rounded-full shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
                <span>‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                <i class="fas fa-plus bg-white/20 rounded-full w-6 h-6 flex items-center justify-center text-xs"></i>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-10 z-[120] pointer-events-none">
        <i class="fas fa-info-circle text-yellow-400"></i>
        <span class="font-medium text-sm" id="toast-msg">Notification</span>
    </div>

    <div id="receipt-result-modal" class="fixed inset-0 z-[140] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 hidden">
        <div class="bg-transparent w-full max-w-sm flex flex-col items-center">
            <div class="bg-white p-2 rounded-lg shadow-2xl mb-4 overflow-hidden">
                <img id="receipt-result-img" class="w-full h-auto rounded" src="" alt="Receipt">
            </div>
            
            <div class="flex flex-col gap-2 w-full px-4">
                <button onclick="downloadReceiptImage()" class="btn-bounce bg-gradient-to-r from-yellow-400 to-orange-500 text-white w-full py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 text-lg">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </button>
                
                <p class="text-white/70 text-xs text-center mb-2">
                    (‡∏´‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üì∏)
                </p>

                <button onclick="document.getElementById('receipt-result-modal').classList.add('hidden')" class="btn-bounce bg-white/20 hover:bg-white/30 text-white w-full py-3 rounded-xl font-bold border border-white/50 backdrop-blur-md">
                    ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                </button>
            </div>
        </div>
    </div>

    <div id="receipt-capture">
        <div class="bg-white p-6 relative">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-400 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm relative overflow-hidden">
                    <img id="receipt-avatar-img" src="" class="w-full h-full object-cover" crossorigin="anonymous">
                </div>
                <h2 class="text-2xl font-black text-gray-800 tracking-wider">KAPRAO52</h2>
                <p class="text-[10px] text-gray-400 tracking-widest uppercase mt-1">Authentic Thai Street Food</p>
                <div class="mt-4 inline-block px-4 py-1 bg-gray-100 rounded-full border border-gray-200">
                    <p class="text-xs font-bold text-gray-600">RECEIPT / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</p>
                </div>
            </div>

            <div class="border-t-2 border-dashed border-gray-200 my-4"></div>

            <div class="flex justify-between items-center mb-1">
                <span class="text-xs text-gray-400">Order ID</span>
                <span class="font-bold text-gray-800 tracking-wide receipt-id">KP-XX99</span>
            </div>
            <div class="flex justify-between items-center mb-1">
                <span class="text-xs text-gray-400">Date</span>
                <span class="font-medium text-xs text-gray-600 receipt-date">01/01/2024 12:00</span>
            </div>
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs text-gray-400">Customer</span>
                <span class="font-bold text-sm text-gray-800 receipt-name">Customer</span>
            </div>

            <div class="bg-gray-50 rounded-lg p-3 mb-4 space-y-2 receipt-items">
            </div>

            <div class="space-y-1">
                <div class="flex justify-between text-xs text-gray-500">
                    <span>Subtotal</span>
                    <span class="receipt-subtotal">0.-</span>
                </div>
                <div class="flex justify-between text-xs text-green-600">
                    <span>Discount</span>
                    <span class="receipt-discount">-0.-</span>
                </div>
                <div class="flex justify-between items-end mt-2 pt-2 border-t border-gray-200">
                    <span class="font-bold text-gray-800">TOTAL</span>
                    <span class="font-black text-3xl text-indigo-600 receipt-total">0.-</span>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t-2 border-dotted border-gray-200 text-center">
                <div class="flex justify-center gap-1 text-2xl text-gray-300 mb-2">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <p class="text-[10px] text-gray-400">THANK YOU FOR YOUR ORDER</p>
                <div class="mt-4 flex justify-center opacity-50">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" class="w-16 h-16 mix-blend-multiply">
                </div>
            </div>
            
            <div class="absolute bottom-0 left-0 right-0 h-4 bg-white" style="background: linear-gradient(45deg, transparent 33.333%, #ffffff 33.333%, #ffffff 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #ffffff 33.333%, #ffffff 66.667%, transparent 66.667%); background-size: 20px 40px; transform: translateY(10px);"></div>
        </div>
    </div>

    <script>
        // --- LIFF CONFIGURATION ---
        const MY_LIFF_ID = '2008781875-6whmY1cf'; 
        
        // --- GOOGLE SHEET CONFIG (UPDATED) ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyU3QVueNDPWcA5WqYnD3elmlGZFtrXSTesVLUEo-ae9eBcFPwfnX93_LcuF6xU0mFb/exec'; 
        // ---------------------------

        // --- GLOBAL SYNC LOCK ---
        let isSyncing = false;

        // --- BACK BUTTON HANDLER ---
        let currentOpenModal = null;

        function pushModalState(modalId) {
            currentOpenModal = modalId;
            window.history.pushState({ modal: modalId }, null, "");
        }

        window.addEventListener('popstate', function(event) {
            if (currentOpenModal) {
                if (currentOpenModal === 'menu') closeModal(true);
                else if (currentOpenModal === 'checkout') closeCheckout(true);
                else if (currentOpenModal === 'tickets') closeMyTickets(true);
                else if (currentOpenModal === 'avatar') closeAvatarModal(true);
                
                currentOpenModal = null;
            }
        });

        // --- SOUNDS ---
        const sfxPop = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3'); 
        const sfxOrder = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
        const sfxTrash = new Audio('https://www.soundjay.com/misc/sounds/crumple-paper-1.mp3'); 
        const sfxWin = new Audio('https://www.soundjay.com/misc/sounds/magic-chime-01.mp3');
        const sfxSwitch = new Audio('https://www.soundjay.com/buttons/sounds/button-20.mp3'); 
        
        sfxPop.volume = 0.4;
        sfxSwitch.volume = 0.2;
        sfxOrder.volume = 0.6;
        sfxTrash.volume = 0.8;

        function playSound(type) {
            if(type === 'pop') { sfxPop.currentTime = 0; sfxPop.play(); }
            else if(type === 'switch') { sfxSwitch.currentTime = 0; sfxSwitch.play(); }
        }

        document.addEventListener('click', (e) => {
            if(e.target.closest('.btn-bounce')) {
                playSound('pop');
            }
        });

        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(10); 
        }

        // --- GLOBAL LOADER ---
        function showGlobalLoader(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
            const loader = document.getElementById('global-loader');
            const txt = document.getElementById('loader-text');
            txt.innerText = text;
            loader.classList.remove('loader-hidden');
        }

        function hideGlobalLoader() {
            const loader = document.getElementById('global-loader');
            loader.classList.add('loader-hidden');
        }

        // --- NOTIFICATION ---
        function requestNotifPermission() {
            if (!("Notification" in window)) {
                showToast("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô");
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showToast("‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üîî");
                    triggerHaptic();
                }
            });
        }

        setTimeout(() => {
            hideGlobalLoader();
        }, 4000);

        // --- AVATAR LOGIC ---
        const avatarOptions = [
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Dog%20face/3D/dog_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Cat%20face/3D/cat_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Tiger%20face/3D/tiger_face_3d.png',
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Lion/3D/lion_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Monkey%20face/3D/monkey_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Elephant/3D/elephant_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Pig%20face/3D/pig_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Chicken/3D/chicken_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Panda/3D/panda_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Frog/3D/frog_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Giraffe/3D/giraffe_3d.png'  
        ];
        
        let userAvatar = { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î', userId: null };

        function openAvatarModal() {
            pushModalState('avatar'); 

            const grid = document.getElementById('avatar-grid');
            grid.innerHTML = '';
            avatarOptions.forEach(imgSrc => {
                const el = document.createElement('div');
                el.className = `avatar-option ${userAvatar.image === imgSrc ? 'avatar-selected' : ''}`;
                el.innerHTML = `<img src="${imgSrc}" alt="avatar">`;
                el.onclick = () => selectAvatar(imgSrc);
                grid.appendChild(el);
            });
            
            document.getElementById('pet-name-input').value = userAvatar.name || '';

            const modal = document.getElementById('avatar-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeAvatarModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'avatar') { history.back(); return; }

            const modal = document.getElementById('avatar-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            
            const nameInput = document.getElementById('pet-name-input').value.trim();
            if(nameInput) {
                userAvatar.name = escapeHtml(nameInput);
                const orderNameInput = document.getElementById('user-name');
                if(orderNameInput) orderNameInput.value = userAvatar.name;
            }

            saveToLS();
            updateAvatarDisplay();
            currentOpenModal = null;
        }

        function selectAvatar(imgSrc) {
            userAvatar.image = imgSrc;
            const options = document.querySelectorAll('.avatar-option');
            options.forEach(opt => {
                const img = opt.querySelector('img');
                if (img && img.src === imgSrc) opt.classList.add('avatar-selected');
                else opt.classList.remove('avatar-selected');
            });
            triggerHaptic();
            playSound('pop');
        }

        function updateAvatarDisplay() {
            document.getElementById('avatar-img').src = userAvatar.image;
            const nameDisplay = document.getElementById('avatar-name-display');
            nameDisplay.innerText = userAvatar.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
        }

        function loadAvatar() {
            const saved = JSON.parse(localStorage.getItem('kaprao52_user'));
            if (saved && saved.avatar) {
                userAvatar = saved.avatar;
            }
            updateAvatarDisplay();
        }

        // --- WELCOME POPUP ---
        function closeWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.5s ease';
            setTimeout(() => modal.classList.add('hidden'), 500);
            triggerHaptic();
        }

        // --- BUBBLES LOGIC (Optimized) ---
        function createBubbles() {
            const container = document.getElementById('bubbles-container');
            const bubbleCount = 15; // Limit count for performance
            
            for(let i=0; i<bubbleCount; i++){
                const b = document.createElement('div');
                b.className = 'bubble';
                b.style.width = Math.random() * 60 + 20 + 'px';
                b.style.height = b.style.width;
                b.style.left = Math.random() * 100 + '%';
                b.style.animationDelay = Math.random() * 15 + 's';
                b.style.animationDuration = Math.random() * 10 + 15 + 's'; 
                if(i % 2 === 0) b.classList.add('purple'); // Alternate colors
                container.appendChild(b);
            }
        }
        
        document.addEventListener('DOMContentLoaded', createBubbles);

        // DATA
        const menuItems = [
            { id: 2, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ", price: 55, icon: "üéç", category: "kaprao", reqMeat: true, kcal: 350 },
            { id: 3, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö", price: 50, icon: "üê∑", category: "kaprao", reqMeat: false, kcal: 520 },
            { id: 4, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á", price: 50, icon: "ü•ì", category: "kaprao", reqMeat: false, kcal: 550 },
            { id: 5, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠", price: 50, icon: "ü•©", category: "kaprao", reqMeat: false, kcal: 600 },
            { id: 6, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤", price: 60, icon: "‚ö´", category: "kaprao", reqMeat: false, kcal: 650 },
            { id: 102, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "ü¶ê", category: "kaprao", reqMeat: false, kcal: 450, isNew: true },
            { id: 105, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà", price: 50, icon: "üêî", category: "kaprao", reqMeat: false, kcal: 450, isNew: true }, 
            { id: 108, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å", price: 60, icon: "ü¶ë", category: "kaprao", reqMeat: false, kcal: 480, isNew: true }, 

            { id: 10, name: "‡∏°‡∏≤‡∏°‡πà‡∏≤‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤", price: 50, icon: "üçú", category: "noodle", reqMeat: true, kcal: 450 },
            { id: 1, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô", price: 55, icon: "üçù", category: "noodle", reqMeat: true, kcal: 400 },
            
            { id: 7, name: "‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üßÑ", category: "garlic", reqMeat: false, kcal: 500 },
            { id: 8, name: "‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçñ", category: "garlic", reqMeat: false, kcal: 580 },
            { id: 9, name: "‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçò", category: "garlic", reqMeat: false, kcal: 530 },
            { id: 103, name: "‡∏Å‡∏∏‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 60, icon: "üç§", category: "garlic", reqMeat: false, kcal: 480, isNew: true },

            { id: 101, name: "‡∏ï‡πâ‡∏°‡∏à‡∏∑‡∏î‡πÑ‡∏Ç‡πà‡∏ô‡πâ‡∏≥ (‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß)", price: 40, icon: "ü•ò", category: "soup", reqMeat: false, kcal: 350, isNew: true },

            { id: 11, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏ú‡∏≤", price: 40, icon: "üå∂Ô∏è", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 450 },
            { id: 12, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô", price: 40, icon: "üçö", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 380 },
            { id: 13, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡∏¥‡∏Å‡∏™‡∏î", price: 50, icon: "ü•ò", category: "others", reqMeat: false, kcal: 420 },
            { id: 14, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß 3 ‡∏ü‡∏≠‡∏á", price: 50, icon: "üç≥", category: "others", reqMeat: false, kcal: 480 },
            { id: 15, name: "‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üéã", category: "others", reqMeat: true, kcal: 300 },
            { id: 104, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "üç≥", category: "others", reqMeat: false, kcal: 550, isNew: true },
            { id: 106, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 520, isNew: true }, 
            { id: 107, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏´‡∏°‡∏π‡∏ä‡∏¥‡πâ‡∏ô (‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠)", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 600, isNew: true }, 

            { id: 20, name: "‡πÄ‡∏â‡∏≤‡∏Å‡πä‡∏ß‡∏¢‡∏ô‡∏°‡∏™‡∏î", price: 30, icon: "üßä", category: "dessert", reqMeat: false, kcal: 150 },
            { id: 21, name: "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", price: 25, icon: "üçå", category: "dessert", reqMeat: false, kcal: 220 },
        ];

        // --- NEW PROMOTIONS LOGIC ---
        const promotions = [
            { 
                code: "SAVE10", 
                title: "Set ‡∏≠‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏° (Value) ü•â", 
                desc: "‡∏Ñ‡∏£‡∏ö 150.- ‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó", 
                minOrder: 150, 
                type: "discount", 
                value: 10, 
                color: "bg-orange-400", 
                icon: "ü•°" 
            },
            { 
                code: "SAVE25", 
                title: "Set ‡∏¢‡∏Å‡πÅ‡∏Å‡πä‡∏á (Gang) ü•à", 
                desc: "‡∏Ñ‡∏£‡∏ö 300.- ‡∏•‡∏î 25 ‡∏ö‡∏≤‡∏ó", 
                minOrder: 300, 
                type: "discount", 
                value: 25, 
                color: "bg-blue-500", 
                icon: "üõµ" 
            },
            { 
                code: "SAVE50", 
                title: "Set ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏° (Grand) ü•á", 
                desc: "‡∏Ñ‡∏£‡∏ö 500.- ‡∏•‡∏î 50 ‡∏ö‡∏≤‡∏ó", 
                minOrder: 500, 
                type: "discount", 
                value: 50, 
                color: "bg-brand-purple", 
                icon: "üè¢" 
            }
        ];

        // --- STATE MANAGEMENT ---
        let cart = [];
        let currentItem = null;
        let activeCategory = 'kaprao';
        let discountValue = 0;
        let modalQty = 1;
        let userStats = { orders: 0 }; 
        let lottoHistory = []; 
        let isSubmitting = false; 
        
        const addonIds = ['special', 'kaikhon', 'kaidao', 'kaijiao', 'kaitom', 'kaiyiewma'];
        const addonCalories = { 'special': 80, 'kaikhon': 150, 'kaidao': 120, 'kaijiao': 200, 'kaitom': 75, 'kaiyiewma': 100 };

        const KEYS = {
            USER: 'kaprao52_user',
            HISTORY: 'kaprao_lotto_history',
            STATS: 'kaprao_stats',
            VERSION: 'kaprao_ver'
        };

        const CURRENT_VERSION = '18.4.4'; 

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function getStandardDate(dateObj) {
            if(!dateObj) dateObj = new Date();
            const d = dateObj.getDate().toString().padStart(2, '0');
            const m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const y = dateObj.getFullYear(); 
            return `${d}/${m}/${y}`;
        }

        function formatTime(dateObj) {
            if(!dateObj) dateObj = new Date();
            const h = dateObj.getHours().toString().padStart(2, '0');
            const m = dateObj.getMinutes().toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        function loadUserDataSafe() {
            try {
                const savedUser = localStorage.getItem(KEYS.USER);
                if (savedUser) {
                    const u = JSON.parse(savedUser);
                    cart = u.cart || [];
                    userAvatar = u.avatar || { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î' };
                    if(u.name) document.getElementById('user-name').value = u.name;
                    
                    if (u.userId) {
                        userAvatar.userId = u.userId;
                    }
                }

                const savedHistory = localStorage.getItem(KEYS.HISTORY);
                if (savedHistory) {
                    lottoHistory = JSON.parse(savedHistory) || [];
                }

                const savedStats = localStorage.getItem(KEYS.STATS);
                if (savedStats) {
                    userStats = JSON.parse(savedStats) || { orders: 0 };
                }

            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error);
            }
        }

        function saveToLS() {
            let safeName = escapeHtml(document.getElementById('user-name').value);
            let oldData = {};
            try {
                oldData = JSON.parse(localStorage.getItem(KEYS.USER)) || {};
            } catch (e) {}

            const userState = { 
                ...oldData, 
                cart: cart, 
                name: safeName,
                avatar: userAvatar
            };
            
            localStorage.setItem(KEYS.USER, JSON.stringify(userState));
        }
        
        async function checkForUpdate() {
            try {
                const response = await fetch(window.location.href + '?t=' + new Date().getTime());
                const text = await response.text();
                const serverVerMatch = text.match(/const CURRENT_VERSION = '([\d.]+)';/);
                
                if (serverVerMatch && serverVerMatch[1]) {
                    const serverVer = serverVerMatch[1];
                    if (serverVer !== CURRENT_VERSION) {
                        console.log(`New version found: ${serverVer} (Current: ${CURRENT_VERSION})`);
                        if ('caches' in window) {
                            try {
                                const names = await caches.keys();
                                await Promise.all(names.map(name => caches.delete(name)));
                            } catch(e) {}
                        }
                        window.location.reload(true);
                    }
                }
            } catch (err) {
                console.log("Check update failed (Offline?)", err);
            }
        }

        // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: Sync History ‡∏à‡∏≤‡∏Å Server -> Client (Pull) üî•
        async function syncTicketHistory(userId) {
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å getHistory ‡∏à‡∏≤‡∏Å Backend
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getHistory&userId=' + userId);
                const serverTickets = await response.json();

                if (!Array.isArray(serverTickets) || serverTickets.length === 0) return;

                let updated = false;
                
                // Merge ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏≠‡∏≤‡∏Ç‡∏≠‡∏á Server ‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏á Local ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                serverTickets.forEach(serverT => {
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Ticket ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏±‡∏á?
                    const exists = lottoHistory.some(localT => localT.id === serverT.id);
                    if (!exists) {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Server
                        const drawDateObj = getNextDrawDate(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πä‡∏∞‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏≤‡∏ô)
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Ticket Object
                        const newTicket = {
                            id: serverT.id,
                            number: serverT.id.slice(-2),
                            date: serverT.date,
                            drawDate: getStandardDate(drawDateObj), // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ Default
                            drawDateTimestamp: drawDateObj.getTime(),
                            timestamp: Date.now(), // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏à‡∏≤‡∏Å Server (‡∏ñ‡πâ‡∏≤ Server ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤)
                            price: serverT.price,
                            status: 'pending',
                            checkedDate: null,
                            items: [{ name: serverT.itemsStr, price: serverT.price }], // ‡πÅ‡∏õ‡∏•‡∏á string ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô object ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ
                            customerName: 'Synced'
                        };
                        
                        lottoHistory.push(newTicket);
                        updated = true;
                    }
                });

                if (updated) {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏≠‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 20
                    lottoHistory.sort((a, b) => b.timestamp - a.timestamp); // Sort descending
                    if(lottoHistory.length > 20) lottoHistory = lottoHistory.slice(0, 20);
                    
                    localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
                    updateTicketBadge();
                    autoCheckLottery(); // ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
                    console.log("History Synced from Server");
                }

            } catch (e) {
                console.error("Sync History Failed", e);
            }
        }

        async function syncUserStatsFromServer(userId) {
            if(!userId) return;
            
            const levelCount = document.getElementById('level-count');
            if(levelCount) levelCount.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...";
            
            // LOCK: Start Sync
            isSyncing = true; 

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getUserStats&userId=' + userId);
                const serverData = await response.json();
                
                if (serverData.orders < userStats.orders) {
                    const diff = userStats.orders - serverData.orders;
                    console.log(`‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤ ${diff} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£.. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ Cloud`);

                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'migrate_guest',
                            userId: userId,
                            count: diff
                        })
                    });

                    setTimeout(() => syncUserStatsFromServer(userId), 1500);
                    return; 
                }

                if(serverData && serverData.orders !== undefined) {
                    userStats.orders = serverData.orders;
                    localStorage.setItem(KEYS.STATS, JSON.stringify(userStats));
                    updateLevelUI();
                }
                
                // UNLOCK: Sync Success
                isSyncing = false;

            } catch (error) {
                console.error("Sync Error:", error);
                updateLevelUI();
                // UNLOCK: Sync Failed (Allow user to proceed with local data)
                isSyncing = false;
            }
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    
                    const loginBtn = document.getElementById('line-login-btn');
                    if(loginBtn) loginBtn.classList.add('hidden');

                    let savedUser = {};
                    try {
                        savedUser = JSON.parse(localStorage.getItem(KEYS.USER)) || {};
                    } catch(e) {}

                    savedUser.userId = profile.userId;
                    userAvatar.userId = profile.userId; 

                    const nameInput = document.getElementById('user-name');
                    if(nameInput && (!nameInput.value || nameInput.value.trim() === '')) {
                        nameInput.value = profile.displayName;
                        savedUser.name = profile.displayName;
                    }

                    const isDefaultAvatar = avatarOptions.includes(userAvatar.image);
                    if(profile.pictureUrl && (isDefaultAvatar || !userAvatar.image)) {
                        userAvatar.image = profile.pictureUrl;
                        userAvatar.name = profile.displayName; 
                        savedUser.avatar = userAvatar;
                        updateAvatarDisplay(); 
                    }
                    
                    localStorage.setItem(KEYS.USER, JSON.stringify(savedUser));
                    
                    if (cart.length === 0 && savedUser.cart && savedUser.cart.length > 0) {
                        cart = savedUser.cart;
                        updateMiniCart();
                        renderCheckoutList();
                    }

                    // ============================================
                    // üî• STEP 1: Claim Local Orders (Push) üî•
                    // ============================================
                    const localHistoryIds = lottoHistory.map(t => t.id);
                    
                    if (localHistoryIds.length > 0) {
                        fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'claim_orders',
                                userId: profile.userId,
                                orderIds: localHistoryIds
                            })
                        }).then(() => {
                            console.log("Claim request sent.");
                            // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Claim ‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏ó‡∏≥ Step 2
                            syncUserStatsFromServer(profile.userId); // Sync Level
                            syncTicketHistory(profile.userId);       // üî• STEP 2: Pull History (Sync Down) üî•
                        });
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏° ‡∏Å‡πá Sync ‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏•‡∏¢
                        syncUserStatsFromServer(profile.userId);
                        syncTicketHistory(profile.userId); // üî• STEP 2: Pull History (Sync Down) üî•
                    }

                } else {
                    if (!liff.isInClient()) {
                        const loginBtn = document.getElementById('line-login-btn');
                        if(loginBtn) loginBtn.classList.remove('hidden');
                    } else {
                        liff.login();
                    }
                }
            } catch (err) {
                console.error("LIFF Error", err);
            }
        }

        function handleLogin() {
            const btn = document.getElementById('line-login-btn');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...';
            btn.classList.add('opacity-75');
            
            if (liff.ready) {
                 liff.login();
            } else {
                 liff.init({ liffId: MY_LIFF_ID }).then(() => {
                     liff.login();
                 });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedVer = localStorage.getItem(KEYS.VERSION);
            if(savedVer !== CURRENT_VERSION) {
                localStorage.setItem(KEYS.VERSION, CURRENT_VERSION);
            }

            loadUserDataSafe();
            
            fetchLottoResults();
            initLIFF(); 

            setTimeout(autoCheckLottery, 1000);
            updateTicketBadge();
            updateStreak(); 
            updateAvatarDisplay();
            updateLevelUI();
            updateMiniCart();
            renderCheckoutList();
            
            setTimeout(checkForUpdate, 2000);
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    checkForUpdate();
                }
            });

            const inputs = document.querySelectorAll('input[type="text"], textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
            
            renderMenu();
        });
        
        function updateLevelUI() {
            const count = userStats.orders;
            const bar = document.getElementById('level-fill');
            const txt = document.getElementById('level-count');
            const title = document.getElementById('level-title');
            const icon = document.getElementById('badge-icon');
            
            let percent = (count % 10) * 10;
            if(count > 0 && count % 10 === 0) percent = 100;
            
            bar.style.width = `${percent}%`;
            txt.innerText = `${count}/10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
            
            icon.className = "w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-inner transition-all duration-500 border border-white bg-white";

            if(count >= 10) {
                icon.innerText = 'üëë';
                icon.classList.add('badge-god');
                title.innerText = "‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤";
                title.style.color = '#d97706';
            } else if(count >= 5) {
                icon.innerText = 'üòé';
                icon.classList.add('badge-regular');
                title.innerText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥";
                title.style.color = '#1e40af';
            } else {
                icon.innerText = 'üê£';
                icon.classList.add('badge-newbie');
                title.innerText = "‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏±‡∏î‡∏Å‡∏¥‡∏ô";
                title.style.color = '#d97706';
            }
        }

        let wheelSpinning = false;
        const wheelSegments = [
            { text: "‡∏•‡∏î 5 ‡∏ö‡∏≤‡∏ó", color: "#FFFFFF", type: "discount_5" },
            { text: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•", color: "#F3F4F6", type: "none" },
            { text: "‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ 40‡∏ö.", color: "#FBBF24", type: "free_40" },
            { text: "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", color: "#FFFFFF", type: "none" }, 
            { text: "‡∏ü‡∏£‡∏µ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß", color: "#F3F4F6", type: "free_egg" },
            { text: "‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó", color: "#FBBF24", type: "discount_10" }
        ];
        function drawWheel() {
            const canvas = document.getElementById('wheel-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            const center = size / 2;
            const sliceAngle = (2 * Math.PI) / wheelSegments.length;

            wheelSegments.forEach((seg, i) => {
                const startAngle = i * sliceAngle - (Math.PI / 2); 
                const endAngle = startAngle + sliceAngle;
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, center, startAngle, endAngle);
                ctx.fillStyle = seg.color;
                ctx.fill();
                ctx.strokeStyle = "#E5E7EB";
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#1F2937";
                ctx.font = "bold 14px Kanit";
                ctx.fillText(seg.text, center - 20, 5);
                ctx.restore();
            });
        }
        function spinWheel() {
            if (wheelSpinning) return;
            const today = getStandardDate(new Date()); 
            const lastDate = localStorage.getItem('kaprao_spin_date');
            let count = parseInt(localStorage.getItem('kaprao_spin_count') || '0');

            if (lastDate !== today) {
                count = 0;
                localStorage.setItem('kaprao_spin_date', today);
            }

            if (count >= 3) {
                showToast("‚õî ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!");
                return; 
            }

            localStorage.setItem('kaprao_spin_count', count + 1);

            wheelSpinning = true;
            triggerHaptic();
            sfxPop.play();
            const box = document.getElementById('wheel-canvas');
            const fullSpins = 360 * 8; 
            const targetDegree = 150;  
            const randomVariance = Math.floor(Math.random() * 40) - 20; 
            const nextRotation = fullSpins + targetDegree + randomVariance;
            box.style.transform = `rotate(${nextRotation}deg)`;
            setTimeout(() => {
                wheelSpinning = false;
                box.style.transform = `rotate(${targetDegree}deg)`; 
                box.style.transition = 'none';
                handleReward(wheelSegments[3]); 
                setTimeout(() => box.style.transition = 'transform 8s cubic-bezier(0.1, 0.99, 0.1, 0.99)', 50);
            }, 8000); 
        }
        function handleReward(reward) {
            if(reward.type === 'none') showToast("‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡∏µ‡∏¢‡∏ß! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞");
            else showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${reward.text}`);
        }

        function scrollTabs(amount) {
            document.getElementById('tabs-container').scrollBy({ left: amount, behavior: 'smooth' });
        }

        function renderSkeletonLoader() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            for(let i=0; i<6; i++) {
                const el = document.createElement('div');
                el.className = "fast-card p-4 flex items-center justify-between shadow-sm mb-4";
                el.innerHTML = `
                    <div class="flex items-center gap-4 w-full">
                        <div class="w-16 h-16 rounded-2xl skeleton flex-shrink-0"></div>
                        <div class="flex-1 space-y-2">
                            <div class="h-4 w-3/4 skeleton rounded"></div>
                            <div class="h-3 w-1/3 skeleton rounded"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            }
        }

        function switchCategory(cat) {
            if(activeCategory === cat) return;
            activeCategory = cat; 
            triggerHaptic();
            playSound('switch');
            
            const grid = document.getElementById('menu-grid');
            const msg = document.getElementById('dessert-msg');
            
            grid.classList.add('page-out');
            if(!msg.classList.contains('hidden')) msg.classList.add('page-out');
            
            ['kaprao', 'garlic', 'noodle', 'soup', 'others', 'dessert', 'promotion'].forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                if (c === cat) {
                    btn.className = "snap-start category-pill-active min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all transform scale-105 btn-bounce";
                } else {
                    btn.className = "snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all btn-bounce";
                    if(c === 'promotion') btn.classList.add('border-dashed', 'border-red-300', 'text-red-400');
                }
            });

            setTimeout(() => {
                const title = document.getElementById('section-title');
                msg.classList.add('hidden');
                msg.classList.remove('page-out');

                grid.classList.remove('page-out');
                renderSkeletonLoader();

                setTimeout(() => {
                    if (cat === 'promotion') {
                        title.innerText = "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á & ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô";
                        renderPromotions();
                    } else if (cat === 'dessert') {
                        title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô";
                        msg.classList.remove('hidden'); 
                        renderMenu();
                    } else if (cat === 'soup') {
                        title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°";
                        renderMenu();
                    } else {
                        title.innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥";
                        renderMenu();
                    }
                    
                    document.getElementById('section-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    grid.classList.add('page-in');
                    setTimeout(() => grid.classList.remove('page-in'), 300);
                }, 50);

            }, 150);
        }

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filteredItems = menuItems.filter(i => i.category === activeCategory);
            
            if(filteredItems.length === 0) {
                 grid.innerHTML = `<div class="text-center text-gray-400 mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏£‡∏±‡∏ö...</div>`;
                 return;
            }

            filteredItems.forEach((item, index) => {
                const isDessert = item.category === 'dessert';
                const isSoldOut = item.soldOut || false; 
                
                const el = document.createElement('div');
                el.style.animationDelay = `${index * 0.05}s`;
                
                const grayscaleClass = isSoldOut ? 'grayscale opacity-70' : '';
                const pointerClass = (isDessert || isSoldOut) ? '' : 'cursor-pointer';

                el.className = `fast-card p-4 flex items-center justify-between stagger-item group ${pointerClass} ${grayscaleClass}`;
                
                el.onclick = () => {
                    if (isSoldOut) {
                        showToast('‚õî ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö');
                        triggerHaptic();
                    } else if (isDessert) {
                        showToast('‚è≥ ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö');
                        triggerHaptic();
                    } else {
                        openModal(item);
                    }
                };

                let actionButton;
                if (isSoldOut) {
                    actionButton = `<span class="text-[10px] font-bold text-white bg-red-400 px-2 py-1 rounded-full">‡∏´‡∏°‡∏î</span>`;
                } else if (isDessert) {
                    actionButton = `<span class="text-[10px] font-bold text-white bg-gray-400 px-2 py-1 rounded-full">‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</span>`;
                } else {
                    actionButton = `<div class="btn-bounce w-8 h-8 rounded-full btn-gradient text-white flex items-center justify-center shadow-md"><i class="fas fa-plus text-xs"></i></div>`;
                }
                
                const priceDisplay = (isDessert || isSoldOut) 
                    ? `<span class="font-bold text-gray-400 text-lg line-through decoration-transparent">${item.price}</span>` 
                    : `<span class="font-bold text-gray-700 text-lg">${item.price}</span>`;
                
                const contentStyle = (isDessert || isSoldOut) ? 'opacity-60 grayscale-[50%]' : '';

                const newBadge = item.isNew && !isSoldOut 
                    ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full border-2 border-white shadow-sm z-10 animate-pulse">NEW!</span>` 
                    : '';

                el.innerHTML = `
                    <div class="flex items-center gap-4 ${contentStyle}">
                        <div class="relative p-[2px] rounded-2xl bg-white shadow-sm border border-gray-100">
                            ${newBadge}
                            <div class="w-16 h-16 rounded-2xl bg-white flex items-center justify-center text-3xl">
                                ${item.icon}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-base group-hover:text-indigo-600 transition-colors">${item.name}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-500 bg-gray-50 px-2 py-0.5 rounded-md border border-gray-100">${item.kcal} kcal</span>
                                ${item.reqMeat ? '<span class="text-[10px] text-yellow-600 border border-yellow-200 bg-yellow-50 px-1.5 rounded">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${priceDisplay}
                        ${actionButton}
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        function renderPromotions() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            promotions.forEach((promo, index) => {
                const el = document.createElement('div');
                el.style.animationDelay = `${index * 0.1}s`;
                el.className = "fast-card p-0 flex overflow-hidden cursor-pointer shadow-sm mb-2 btn-bounce stagger-item";
                el.onclick = () => {
                    navigator.clipboard.writeText(promo.code);
                    showToast(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î ${promo.code} ‡πÅ‡∏•‡πâ‡∏ß!`);
                    document.getElementById('discount-code').value = promo.code;
                    playSound('pop');
                };
                el.innerHTML = `
                    <div class="w-24 ${promo.color} flex flex-col items-center justify-center text-white p-2">
                        <span class="text-2xl">${promo.icon}</span>
                        <span class="text-[10px] opacity-80 mt-1">TAP</span>
                    </div>
                    <div class="flex-1 p-4 flex flex-col justify-center relative bg-white">
                        <div class="absolute left-0 top-0 bottom-0 border-l-2 border-dashed border-gray-100"></div>
                        <h3 class="font-bold text-gray-800">${promo.title}</h3>
                        <p class="text-xs text-gray-500 mt-0.5">${promo.desc}</p>
                        <div class="mt-2 bg-gray-50 inline-block px-2 py-1 rounded text-xs font-bold text-gray-600 tracking-wider w-max border border-gray-200 shadow-sm">${promo.code}</div>
                    </div>
                `;
                grid.appendChild(el);
            });

            const wheelDiv = document.createElement('div');
            wheelDiv.className = "w-full fast-card p-6 mt-4 mb-6 shadow-sm flex flex-col items-center stagger-item";
            wheelDiv.style.animationDelay = "0.3s";
            wheelDiv.innerHTML = `
                <h3 class="font-bold text-gray-800 text-lg mb-1">‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ! üé°</h3>
                <p class="text-xs text-gray-500 mb-4">‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤ 40 ‡∏ö‡∏≤‡∏ó ‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô)</p>
                <div id="wheel-container">
                    <div class="wheel-pointer"></div>
                    <canvas id="wheel-canvas" width="300" height="300"></canvas>
                    <div class="wheel-center text-2xl">üòã</div>
                </div>
                <button onclick="spinWheel()" class="btn-bounce btn-gradient-purple text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all hover:scale-105">‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡∏¢!</button>
            `;
            grid.appendChild(wheelDiv);
            setTimeout(drawWheel, 100);
        }

        function openModal(item) {
            pushModalState('menu'); 
            
            triggerHaptic();
            playSound('pop');
            currentItem = item;
            modalQty = 1; 
            document.getElementById('modal-qty').innerText = modalQty;
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-icon').innerText = item.icon;
            document.getElementById('modal-note').value = '';
            document.querySelectorAll('input[name="modal-meat"]').forEach(el => el.checked = false);
            addonIds.forEach(id => document.getElementById(`modal-opt-${id}`).checked = false);
            const meatSec = document.getElementById('modal-meat-section');
            
            document.getElementById('meat-options-container').classList.remove('animate-shake', 'border', 'border-red-500', 'rounded-xl');

            if(item.reqMeat) meatSec.classList.remove('hidden'); else meatSec.classList.add('hidden');
            updateModalPrice();
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.style.transform = ''; 
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            }, 10);
        }

        function closeModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'menu') { 
                history.back(); 
                return; 
            }

            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                currentItem = null;
                content.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function adjustQty(n) {
            modalQty += n;
            if(modalQty < 1) modalQty = 1;
            document.getElementById('modal-qty').innerText = modalQty;
            triggerHaptic();
            updateModalPrice();
        }

        function updateModalPrice() {
            if (!currentItem) return;
            let total = currentItem.price;
            let totalKcal = currentItem.kcal || 0;
            addonIds.forEach(id => {
                if(document.getElementById(`modal-opt-${id}`).checked) {
                    total += 10;
                    totalKcal += (addonCalories[id] || 0); 
                }
            });
            total = total * modalQty;
            totalKcal = totalKcal * modalQty;
            const priceEl = document.getElementById('modal-price');
            priceEl.innerText = total;
            priceEl.classList.remove('price-pop');
            void priceEl.offsetWidth;
            priceEl.classList.add('price-pop');
            document.getElementById('modal-kcal').innerText = totalKcal + ' kcal';
        }

        addonIds.forEach(id => document.getElementById(`modal-opt-${id}`).addEventListener('change', updateModalPrice));

        function addToCart() {
            if (!currentItem) return;
            let meat = null;
            if (currentItem.reqMeat) {
                const r = document.querySelector('input[name="modal-meat"]:checked');
                
                if(!r) {
                    const meatContainer = document.getElementById('meat-options-container');
                    meatContainer.classList.remove('animate-shake');
                    void meatContainer.offsetWidth;
                    meatContainer.classList.add('animate-shake', 'border', 'border-red-500', 'rounded-xl');
                    triggerHaptic();
                    return; 
                }
                meat = r.value;
            }
            let addons = [];
            let addPrice = 0;
            const names = {special:'‡∏û‡∏¥‡πÄ‡∏®‡∏©', kaikhon:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô', kaidao:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', kaijiao:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', kaitom:'‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°', kaiyiewma:'‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤'};
            addonIds.forEach(id => {
                if(document.getElementById(`modal-opt-${id}`).checked) {
                    addons.push(names[id]);
                    addPrice += 10;
                }
            });
            
            const noteSafe = escapeHtml(document.getElementById('modal-note').value.trim());

            for(let i=0; i<modalQty; i++){
                cart.push({
                    id: Date.now() + i,
                    name: currentItem.name,
                    price: currentItem.price + addPrice,
                    meat: meat,
                    addons: addons,
                    note: noteSafe
                });
            }
            playSound('pop'); triggerHaptic();
            closeModal();
            updateMiniCart();
            saveToLS();
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${modalQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!`);
        }
        
        function updateStreak() {
            const today = new Date().toDateString();
            const lastOrderDate = localStorage.getItem('kaprao_last_order_date');
            let currentStreak = parseInt(localStorage.getItem('kaprao_streak') || 0);

            const display = document.getElementById('streak-display');
            const text = document.getElementById('streak-text');
            
            if (currentStreak > 1) {
                display.classList.remove('hidden');
                text.innerText = `‡∏™‡∏±‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô ${currentStreak} ‡∏ß‡∏±‡∏ô!`;
            } else {
                display.classList.add('hidden');
            }
        }

        function recordOrderForStreak() {
            const today = new Date();
            const todayStr = today.toDateString();
            const lastOrderDate = localStorage.getItem('kaprao_last_order_date');
            let currentStreak = parseInt(localStorage.getItem('kaprao_streak') || 0);

            if (lastOrderDate) {
                const lastDate = new Date(lastOrderDate);
                const diffTime = Math.abs(today - lastDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                if (todayStr === lastOrderDate) {
                } else if (diffDays === 1) {
                    currentStreak++;
                } else {
                    currentStreak = 1;
                }
            } else {
                currentStreak = 1;
            }

            localStorage.setItem('kaprao_last_order_date', todayStr);
            localStorage.setItem('kaprao_streak', currentStreak);
            updateStreak();
        }

        function getNextDrawDate() {
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth();
            const year = today.getFullYear();
            let drawDate = new Date();
            if (day <= 1) drawDate = new Date(year, month, 1);
            else if (day <= 16) drawDate = new Date(year, month, 16);
            else drawDate = new Date(year, month + 1, 1);
            return drawDate;
        }

        let OFFICIAL_RESULTS = {};

        async function fetchLottoResults() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getLotto');
                const data = await response.json();
                OFFICIAL_RESULTS = data;
                autoCheckLottery(); 
            } catch (error) {
                console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏´‡∏ß‡∏¢‡πÑ‡∏î‡πâ:", error);
            }
        }

        function getWinningNumberForDate(dateStr) {
            if (OFFICIAL_RESULTS[dateStr]) return OFFICIAL_RESULTS[dateStr];
            return "NotSet"; 
        }

        let currentOrderId = "";
        
        function generateOrderId() {
            const now = Date.now().toString();
            const timePart = now.slice(-2); 

            const myPendingNumbers = lottoHistory
                .filter(t => t.status === 'pending')
                .map(t => t.number);

            let randomPart;
            let isDuplicate = true;
            let attempts = 0;

            while (isDuplicate && attempts < 500) {
                randomPart = Math.floor(Math.random() * 100).toString().padStart(2, '0');

                if (!myPendingNumbers.includes(randomPart) || myPendingNumbers.length >= 100) {
                    isDuplicate = false;
                }
                attempts++;
            }

            currentOrderId = `KP-${timePart}${randomPart}`;
            return currentOrderId;
        }

        function saveTicketToHistory(orderId, totalPrice) {
            const today = new Date();
            const drawDateObj = getNextDrawDate();
            
            const todayStr = getStandardDate(today);
            const drawDateStr = getStandardDate(drawDateObj);

            const name = document.getElementById('user-name').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            
            const ticket = {
                id: orderId,
                number: orderId.slice(-2),
                date: todayStr,
                drawDate: drawDateStr,
                drawDateTimestamp: drawDateObj.getTime(),
                timestamp: Date.now(),
                price: totalPrice,
                status: 'pending',
                checkedDate: null,
                items: JSON.parse(JSON.stringify(cart)), 
                customerName: name 
            };
            
            lottoHistory.unshift(ticket);
            
            // --- FIX: Limit History Size ---
            if (lottoHistory.length > 20) {
                lottoHistory = lottoHistory.slice(0, 20); 
            }
            // ------------------------------

            localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
            updateTicketBadge();
        }

        function autoCheckLottery() {
            const pendingTickets = lottoHistory.filter(t => t.status === 'pending');
            if(pendingTickets.length === 0) return;
            const now = new Date();
            now.setHours(0, 0, 0, 0); 
            let winCount = 0;
            let updated = false;
            pendingTickets.forEach(t => {
                let targetDate;
                if (t.drawDateTimestamp) targetDate = t.drawDateTimestamp;
                else targetDate = 0; 
                
                if (now.getTime() < targetDate) return; 

                const winningNum = getWinningNumberForDate(t.drawDate || getStandardDate(new Date()));
                
                if (t.number === winningNum) {
                    t.status = 'won';
                    winCount++;
                    if (Notification.permission === "granted") {
                        new Notification("‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ü§ë", { 
                            body: `‡∏á‡∏ß‡∏î ${t.drawDate}: Order ${t.id} ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ!`, 
                            icon: 'https://cdn-icons-png.flaticon.com/512/3170/3170733.png' 
                        });
                    }
                } else if (winningNum !== "NotSet") {
                    t.status = 'lost';
                }
                if (winningNum !== "NotSet") {
                    t.checkedDate = getStandardDate(new Date());
                    updated = true;
                }
            });
            if (updated) {
                localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
                if(winCount > 0) {
                    sfxWin.play();
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    showToast(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${winCount} ‡πÉ‡∏ö!`);
                }
                updateTicketBadge();
            }
        }

        function updateTicketBadge() {
            const pending = lottoHistory.filter(t => t.status === 'pending').length;
            const dot = document.getElementById('unread-ticket-dot');
            if(pending > 0) dot.classList.remove('hidden'); else dot.classList.add('hidden');
        }

        function openMyTickets() {
            pushModalState('tickets'); 

            triggerHaptic();
            playSound('pop');
            const list = document.getElementById('tickets-list');
            list.innerHTML = '';
            if(lottoHistory.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <div class="text-4xl mb-2 opacity-30">üéüÔ∏è</div>
                        <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                    </div>`;
            } else {
                lottoHistory.forEach((t, index) => {
                    let statusHtml = '';
                    let statusClass = '';
                    if(t.status === 'pending') {
                        statusHtml = `<span class="text-indigo-600 font-bold"><i class="far fa-clock"></i> ‡∏£‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏á‡∏ß‡∏î ${t.drawDate || '‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ'}</span>`;
                        statusClass = 'border-l-4 border-indigo-500 bg-indigo-50/50';
                    } else if(t.status === 'won') {
                        statusHtml = '<span class="text-yellow-600 font-bold"><i class="fas fa-trophy"></i> ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!</span>';
                        statusClass = 'border-l-4 border-yellow-500 bg-yellow-50/50';
                    } else {
                        statusHtml = '<span class="text-gray-400 font-bold"><i class="fas fa-times-circle"></i> ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>';
                        statusClass = 'border-l-4 border-gray-300 bg-gray-50/50 opacity-70 grayscale';
                    }
                    const item = document.createElement('div');
                    item.onclick = () => reprintReceipt(index);
                    item.className = `ticket-stub p-4 rounded-lg shadow-sm border border-gray-200 mb-3 flex justify-between items-center relative overflow-hidden cursor-pointer active:scale-95 transition-transform btn-bounce ${statusClass}`;
                    item.innerHTML = `
                        <div>
                            <div class="text-[10px] text-gray-400">Order ID: ${t.id}</div>
                            <div class="flex items-baseline gap-2 mt-1">
                                <span class="text-xs text-gray-600">‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô:</span>
                                <span class="text-2xl font-black text-indigo-600 tracking-widest">${t.number}</span>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${t.date}</div>
                            <div class="text-[10px] text-indigo-500 font-bold mt-2"><i class="fas fa-print"></i> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                        </div>
                        <div class="text-right flex flex-col items-end">
                             <div class="text-xs mb-1 bg-white/80 px-2 py-1 rounded-full shadow-sm whitespace-nowrap">${statusHtml}</div>
                             ${t.status === 'won' ? '<button class="text-[10px] bg-yellow-500 text-white font-bold px-2 py-1 rounded shadow-sm mt-1 animate-pulse">‡πÅ‡∏Ñ‡∏õ‡∏à‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>' : ''}
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            const overlay = document.getElementById('tickets-modal-overlay');
            const sheet = document.getElementById('tickets-sheet');
            sheet.style.transform = '';
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                sheet.classList.remove('translate-y-full');
            }, 10);
        }

        function closeMyTickets(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'tickets') { history.back(); return; }

            const overlay = document.getElementById('tickets-modal-overlay');
            const sheet = document.getElementById('tickets-sheet');
            overlay.classList.add('opacity-0');
            sheet.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                sheet.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function openCheckout() {
            pushModalState('checkout'); 

            triggerHaptic();
            playSound('pop');
            renderCheckoutList();
            if(document.getElementById('discount-code').value.trim() !== '' && discountValue > 0) applyDiscount();
            if(cart.length > 0) {
                 const lottoId = generateOrderId(); 
                 const listContainer = document.getElementById('cart-list-container');
                 const lottoBanner = document.createElement('div');
                 lottoBanner.className = "bg-white border border-gray-100 p-4 rounded-xl mb-4 flex justify-between items-center shadow-sm relative overflow-hidden stagger-item";
                 lottoBanner.innerHTML = `
                    <div class="absolute -right-4 -top-4 bg-indigo-100 opacity-50 w-20 h-20 rounded-full"></div>
                    <div class="flex flex-col z-10">
                        <span class="text-[10px] text-gray-500 uppercase tracking-wider">Order ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
                        <div class="flex items-baseline gap-1">
                            <span class="font-bold text-xl text-gray-700">${lottoId.slice(0, -2)}</span>
                            <span class="font-black text-3xl text-yellow-500 drop-shadow-sm">${lottoId.slice(-2)}</span>
                        </div>
                    </div>
                    <div class="z-10 text-right">
                        <div class="text-2xl">üéüÔ∏è</div>
                        <span class="text-[10px] font-bold text-gray-600">‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ!</span>
                    </div>
                 `;
                 listContainer.insertBefore(lottoBanner, listContainer.firstChild);
            }
            const overlay = document.getElementById('checkout-overlay');
            const sheet = document.getElementById('checkout-sheet');
            sheet.style.transform = '';
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                sheet.classList.remove('translate-y-full');
            }, 10);
        }

        function closeCheckout(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'checkout') { history.back(); return; }

            const overlay = document.getElementById('checkout-overlay');
            const sheet = document.getElementById('checkout-sheet');
            overlay.classList.add('opacity-0');
            sheet.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                sheet.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function updateMiniCart() {
            const miniBar = document.getElementById('mini-cart-bar');
            if(cart.length > 0) {
                miniBar.classList.remove('hidden');
                let total = cart.reduce((sum, i) => sum + i.price, 0);
                document.getElementById('mini-count').innerText = cart.length;
                document.getElementById('mini-total').innerText = total + " ‡∏ø";
            } else {
                miniBar.classList.add('hidden');
            }
        }

        function renderCheckoutList() {
            const container = document.getElementById('cart-list-container');
            container.innerHTML = '';
            cart.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-start stagger-item";
                let detail = item.meat ? `<span class="text-orange-500 text-xs bg-orange-50 px-1 rounded">${item.meat}</span> ` : '';
                if(item.addons.length) detail += `<span class="text-gray-400 text-xs">+${item.addons.join(',')}</span>`;
                el.innerHTML = `
                    <div>
                        <h4 class="font-bold text-gray-800 text-sm">${item.name}</h4>
                        <div class="mt-1">${detail}</div>
                        ${item.note ? `<div class="text-[10px] text-gray-400 mt-1">Note: ${item.note}</div>` : ''}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="font-bold text-gray-700">${item.price}.-</span>
                        <button onclick="removeFromCart(${item.id})" class="text-xs text-red-400 bg-red-50 w-9 h-9 rounded flex items-center justify-center border border-red-100 btn-bounce"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
            updateTotalSummary();
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            saveToLS();
            if(cart.length === 0) removeDiscount();
            else if(discountValue > 0) applyDiscount();
            renderCheckoutList();
            updateMiniCart();
            if(cart.length === 0) closeCheckout();
        }
        
        function clearCart() {
            if(cart.length === 0) return;
            if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
            sfxTrash.play();
            cart = [];
            saveToLS();
            removeDiscount();
            updateMiniCart();
            closeCheckout();
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üóëÔ∏è');
        }

        function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim().toUpperCase();
            let total = cart.reduce((sum, i) => sum + i.price, 0);
            const msg = document.getElementById('discount-msg');
            const inputContainer = document.getElementById('code-input-container');
            const btn = document.getElementById('btn-apply-code');
            
            discountValue = 0;

            if (code === '') {
                msg.innerText = '';
                inputContainer.className = "bg-white rounded-xl p-2 pl-4 flex items-center border border-gray-200 shadow-sm justify-between transition-colors";
                btn.innerHTML = '‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î';
                btn.className = 'btn-bounce bg-gray-800 hover:bg-gray-700 text-white text-xs px-4 py-2 rounded-lg transition-colors font-bold whitespace-nowrap active:bg-gray-900';
                btn.onclick = applyDiscount; 
                updateTotalSummary();
                return;
            }

            const promo = promotions.find(p => p.code === code);

            if (promo && total >= promo.minOrder) {
                discountValue = promo.value;
                msg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏î ${promo.value} ‡∏ö‡∏≤‡∏ó</span>`;
                inputContainer.className = "input-success rounded-xl p-2 pl-4 flex items-center border shadow-sm justify-between transition-colors";
                btn.innerHTML = '<i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                btn.className = 'btn-bounce bg-red-500 hover:bg-red-600 text-white text-xs px-4 py-2 rounded-lg transition-colors font-bold whitespace-nowrap';
                btn.onclick = removeDiscount;
                playSound('pop');
            } 
            else {
                msg.innerHTML = `<span class="text-red-400">${promo ? '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö '+promo.minOrder : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î'}</span>`;
                inputContainer.className = "bg-white rounded-xl p-2 pl-4 flex items-center border border-red-200 shadow-sm justify-between transition-colors"; 
                btn.innerHTML = '‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î';
                btn.className = 'btn-bounce bg-gray-800 hover:bg-gray-700 text-white text-xs px-4 py-2 rounded-lg transition-colors font-bold whitespace-nowrap active:bg-gray-900';
                btn.onclick = applyDiscount; 
            }
            updateTotalSummary();
        }

        function removeDiscount() {
            document.getElementById('discount-code').value = '';
            document.getElementById('discount-msg').innerText = '';
            discountValue = 0;
            applyDiscount();
        }

        function updateTotalSummary() {
            let total = cart.reduce((sum, i) => sum + i.price, 0);
            let final = Math.max(0, total - discountValue);
            document.getElementById('sheet-grand-total').innerText = final + " ‡∏ø";
        }

        function openReceiptResult(imgData) {
            const modal = document.getElementById('receipt-result-modal');
            const img = document.getElementById('receipt-result-img');
            img.src = imgData;
            modal.classList.remove('hidden');
        }

        function downloadReceiptImage() {
            const img = document.getElementById('receipt-result-img');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = 'kaprao52-receipt-' + Date.now() + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...');
        }

        function generateOrderCard() {
            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...");
            const name = document.getElementById('user-name').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            
            const nowStr = `${getStandardDate(new Date())} ${formatTime(new Date())}`;

            let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            let netTotal = Math.max(0, subtotal - discountValue);

            document.querySelector('.receipt-id').innerText = currentOrderId || 'KP-XXXX';
            document.querySelector('.receipt-date').innerText = nowStr;
            document.querySelector('.receipt-name').innerText = escapeHtml(name);
            document.querySelector('.receipt-subtotal').innerText = subtotal + '.-';
            document.querySelector('.receipt-discount').innerText = '-' + discountValue + '.-';
            document.querySelector('.receipt-total').innerText = netTotal + '.-';

            const receiptAvatar = document.getElementById('receipt-avatar-img');
            
            // --- FIX: USE GENERIC ICON TO AVOID CORS ---
            receiptAvatar.src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            // ------------------------------------------
            
            const itemsContainer = document.querySelector('.receipt-items');
            itemsContainer.innerHTML = '';
            cart.forEach((i, index) => {
                let detail = `${i.name}`;
                if(i.meat) detail += ` (${i.meat})`;
                if(i.addons.length) detail += ` +${i.addons.join(',')}`;
                const row = document.createElement('div');
                row.className = "flex justify-between text-xs";
                row.innerHTML = `
                    <div class="flex gap-1 text-gray-700">
                        <span class="w-4">${index+1}.</span>
                        <span>${detail}</span>
                    </div>
                    <span class="font-bold text-gray-800">${i.price}.-</span>
                `;
                itemsContainer.appendChild(row);
            });

            const div = document.getElementById('receipt-capture');

            html2canvas(div, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: null 
            }).then(canvas => {
                hideGlobalLoader();
                openReceiptResult(canvas.toDataURL());
                showToast('‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
            }).catch((err) => {
                console.error(err);
                hideGlobalLoader();
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û');
            });
        }

        function reprintReceipt(ticketIndex) {
            triggerHaptic();
            playSound('pop');
            const ticket = lottoHistory[ticketIndex];
            
            if (!ticket.items || ticket.items.length === 0) {
                showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤ üò¢");
                return;
            }

            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...");
            
            const name = ticket.customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            const subtotal = ticket.items.reduce((sum, i) => sum + i.price, 0);
            const netTotal = ticket.price; 
            const discount = subtotal - netTotal; 

            const tDate = new Date(ticket.timestamp);
            const dateStr = `${getStandardDate(tDate)} ${formatTime(tDate)}`;

            document.querySelector('.receipt-id').innerText = ticket.id;
            document.querySelector('.receipt-date').innerText = dateStr;
            document.querySelector('.receipt-name').innerText = escapeHtml(name);
            document.querySelector('.receipt-subtotal').innerText = subtotal + '.-';
            document.querySelector('.receipt-discount').innerText = '-' + discount + '.-';
            document.querySelector('.receipt-total').innerText = netTotal + '.-';

            // --- FIX: USE GENERIC ICON TO AVOID CORS ---
            const receiptAvatar = document.getElementById('receipt-avatar-img');
            receiptAvatar.src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            // ------------------------------------------

            const itemsContainer = document.querySelector('.receipt-items');
            itemsContainer.innerHTML = '';
            ticket.items.forEach((i, index) => {
                let detail = `${i.name}`;
                if(i.meat) detail += ` (${i.meat})`;
                if(i.addons.length) detail += ` +${i.addons.join(',')}`;
                const row = document.createElement('div');
                row.className = "flex justify-between text-xs";
                row.innerHTML = `
                    <div class="flex gap-1 text-gray-700">
                        <span class="w-4">${index+1}.</span>
                        <span>${detail}</span>
                    </div>
                    <span class="font-bold text-gray-800">${i.price}.-</span>
                `;
                itemsContainer.appendChild(row);
            });

            setTimeout(() => {
                const div = document.getElementById('receipt-capture');

                html2canvas(div, { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: null 
                }).then(canvas => {
                    hideGlobalLoader();
                    openReceiptResult(canvas.toDataURL());
                    showToast('‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
                }).catch(() => {
                    hideGlobalLoader();
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û');
                });
            }, 500);
        }

        async function submitOrderToLine() {
            // FIX: RACE CONDITION CHECK
            if (isSyncing) {
                showToast("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");
                return;
            }
            // -------------------------

            if (isSubmitting) return;

            const name = document.getElementById('user-name').value.trim();
            if (!name) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á');

            isSubmitting = true;
            const btn = document.getElementById('btn-submit-order');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå...");
                
                let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
                let netTotal = Math.max(0, subtotal - discountValue);
                const allNotes = cart.filter(i => i.note).map(i => i.note).join(", ");
                
                if(!currentOrderId) generateOrderId();

                const nowStr = `${getStandardDate(new Date())} ${formatTime(new Date())}`;
                
                let msg = `üî• ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà! [${currentOrderId}]\n`;
                msg += `üéüÔ∏è ‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢: ${currentOrderId.slice(-2)}\n`;
                msg += `üìÖ ${nowStr}\n`;
                msg += `üë§ ‡∏Ñ‡∏∏‡∏ì ${name}\n`;
                msg += `üèÖ ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà: ${userStats.orders + 1}\n`;
                msg += `------------------------\n`;
                cart.forEach((i, index) => {
                    let detail = `${i.name} ${i.meat ? '('+i.meat+')' : ''}`;
                    if(i.addons.length) detail += ` +${i.addons.join('+')}`;
                    if(i.note) detail += ` [${i.note}]`;
                    msg += `${index + 1}. ${detail} (${i.price}.-)\n`;
                });
                msg += `------------------------\n`;
                if (discountValue > 0) {
                    msg += `üíµ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${subtotal} ‡∏ö‡∏≤‡∏ó\n`;
                    msg += `üè∑Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${discountValue} ‡∏ö‡∏≤‡∏ó\n`;
                }
                msg += `üí∞ ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${netTotal} ‡∏ö‡∏≤‡∏ó\n`;

                const sheetData = {
                    orderId: currentOrderId,
                    name: name,
                    items: cart,
                    totalPrice: subtotal,
                    discount: discountValue,
                    netTotal: netTotal,
                    allNotes: allNotes,
                    userId: userAvatar.userId 
                };

                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sheetData),
                        keepalive: true 
                    }).catch(err => console.error("Sheet Error:", err));
                }

                recordOrderForStreak();
                userStats.orders++;
                localStorage.setItem(KEYS.STATS, JSON.stringify(userStats));
                saveTicketToHistory(currentOrderId, netTotal);
                
                const lineOAId = "@772ysswn";
                const encodedMsg = encodeURIComponent(msg);
                
                setTimeout(() => {
                    cart = []; 
                    saveToLS();
                    updateMiniCart();
                    closeCheckout();
                    hideGlobalLoader();
                    
                    window.location.href = `https://line.me/R/oaMessage/${lineOAId}/?${encodedMsg}`;
                    
                    isSubmitting = false;
                    btn.innerHTML = originalText;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }, 1000);

            } catch (error) {
                console.error("Critical Submit Error:", error);
                hideGlobalLoader();
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                isSubmitting = false;
                btn.innerHTML = originalText;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- SWIPE UTILS ---
        function enableSwipeToClose(el, scrollEl, closeCallback) {
            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            el.addEventListener('touchstart', (e) => {
                if (scrollEl.scrollTop <= 0) { startY = e.touches[0].clientY; isDragging = true; el.style.transition = 'none'; }
            }, { passive: true });
            el.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const diff = e.touches[0].clientY - startY;
                if (diff > 0) { if (scrollEl.scrollTop > 0) return; e.preventDefault(); el.style.transform = `translateY(${diff}px)`; currentY = diff; }
            }, { passive: false });
            el.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                el.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
                if (currentY > 150) closeCallback(); else el.style.transform = '';
                currentY = 0;
            });
        }
        enableSwipeToClose(document.getElementById('modal-content'), document.getElementById('modal-scroll-area'), closeModal);
        enableSwipeToClose(document.getElementById('checkout-sheet'), document.getElementById('cart-list-container'), closeCheckout);
        enableSwipeToClose(document.getElementById('tickets-sheet'), document.getElementById('tickets-list'), closeMyTickets);

        document.getElementById('user-name').addEventListener('input', saveToLS);
    </script>
    <script>
        document.addEventListener('error', function(e) {
            if (e.target.tagName.toLowerCase() === 'img') {
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô
                e.target.src = 'https://cdn-icons-png.flaticon.com/512/135/135161.png'; // ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß generic
                e.target.alt = 'Image not found';
                e.target.classList.add('opacity-50'); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ó‡∏ô
            }
        }, true);
    </script>
</body>
</html>
