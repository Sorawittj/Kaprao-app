<!DOCTYPE html>
<html lang="th">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FEF9F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preconnect" href="https://static.line-scdn.net">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            brand: { purple: '#8B5CF6', yellow: '#FBBF24', text: '#1F2937' }
                        },
                        fontFamily: { sans: ['Kanit', 'sans-serif'], round: ['Kanit', 'sans-serif'] },
                        borderRadius: { '4xl': '2.5rem' },
                        animation: {
                            'bounce-slow': 'bounce 3s infinite',
                            'fade-in-down': 'fadeInDown 0.3s ease-out forwards',
                            'spin-fast': 'spin 0.8s linear infinite',
                            'heart-beat': 'heartBeat 0.3s ease-in-out',
                            'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        },
                        keyframes: {
                            fadeInDown: { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                            heartBeat: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.3)' }, '100%': { transform: 'scale(1)' } },
                            pulseGlow: { '0%, 100%': { boxShadow: '0 0 5px rgba(245, 158, 11, 0.3)' }, '50%': { boxShadow: '0 0 20px rgba(245, 158, 11, 0.6)' } }
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4FR74WPRNY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4FR74WPRNY');
    </script>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <title>Kaprao52 - APP</title> 
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #FEF9F3; --bg-secondary: #FFFFFF; --bg-tertiary: #F3F4F6;
            --text-primary: #1F2937; --text-secondary: #4B5563; --text-tertiary: #9CA3AF;
            --border-color: #E5E7EB;
            --glass-bg: rgba(255, 255, 255, 0.90); --glass-heavy-bg: rgba(255, 255, 255, 0.98);
            --card-bg: #FFFFFF; --card-hover: #FEF3C7;
            --shadow: rgba(0, 0, 0, 0.05); --shadow-hover: rgba(0, 0, 0, 0.1);
            --meat-option-bg: #FFFFFF; --meat-option-border: #E5E7EB; --meat-option-text: #4B5563;
            --meat-option-hover-bg: #F9FAFB; --meat-option-selected-bg: #FEF3C7;
            --meat-option-selected-border: #F59E0B; --meat-option-selected-text: #92400E;
        }
        body { color: var(--text-primary); -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; background: var(--bg-primary); transition: background-color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        body.scroll-locked { overflow: hidden; height: 100vh; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); scroll-behavior: smooth; }
        .safe-area-pt { padding-top: var(--sat); }
        .safe-area-pb { padding-bottom: var(--sab); }
        .safe-area-pb-plus { padding-bottom: calc(1rem + var(--sab)); }
        html { scroll-behavior: smooth; }
        ::selection { background-color: rgba(251, 191, 36, 0.3); color: var(--text-primary); }
        @media screen and (max-width: 768px) { input, textarea, select { font-size: 16px !important; } }
        #bg-canvas, #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #bg-canvas { z-index: -1; opacity: 0.6; }
        #confetti-canvas { z-index: 150; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-bottom: 1px solid var(--border-color); transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .fast-card { background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -1px var(--shadow); border-radius: 1.5rem; transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1); position: relative; z-index: 1; display: flex; flex-direction: column; }
        .fast-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px var(--shadow-hover), 0 4px 6px -2px var(--shadow-hover); border-color: #FCD34D; }
        .fast-card:active { transform: scale(0.98) translateY(-2px); background: var(--card-hover); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .glass-heavy { background: var(--glass-heavy-bg); backdrop-filter: blur(24px) saturate(180%); -webkit-backdrop-filter: blur(24px) saturate(180%); border-top: 1px solid var(--border-color); transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .btn-bounce { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-bounce:active { transform: scale(0.92); }
        .btn-press { transform-origin: center; }
        .btn-press.squash { transform: scaleX(1.12) scaleY(0.88); transition: transform 140ms cubic-bezier(0.2,0.8,0.2,1); }
        .btn-press.rebound { animation: squashRebound 480ms cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes squashRebound { 0% { transform: scaleX(1.12) scaleY(0.88); } 50% { transform: scaleX(0.92) scaleY(1.12); } 100% { transform: scaleX(1) scaleY(1); } }
        .heart-btn { transition: all 0.3s ease; }
        .heart-btn.active { color: #EF4444; animation: heartBeat 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .heart-btn:active { transform: scale(0.8); }
        .fly-item { position: fixed; z-index: 9999; pointer-events: none; font-size: 1.8rem; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; border-radius: 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9)); color: white; box-shadow: 0 12px 32px rgba(245, 158, 11, 0.4), 0 0 16px rgba(245, 158, 11, 0.2); will-change: transform, opacity; animation: flyUp 1.2s cubic-bezier(0.2, 0.8, 0.4, 1) forwards; }
        @keyframes flyUp { 0% { opacity: 1; transform: translate(0, 0) scale(1); } 100% { opacity: 0; transform: translate(0, -150px) scale(0.3); } }
        .stagger-item { opacity: 0; animation: fadeInUpSmooth 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes fadeInUpSmooth { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .skeleton { background: #F3F4F6; position: relative; overflow: hidden; }
        .skeleton::after { content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0) 100%); transform: translateX(-100%); animation: shimmerSmooth 2s infinite; }
        @keyframes shimmerSmooth { 100% { transform: translateX(100%); } }
        .page-out { animation: pageOut 0.2s cubic-bezier(0.4, 0, 1, 1) forwards; }
        .page-in { animation: pageIn 0.3s cubic-bezier(0, 0, 0.2, 1) forwards; }
        @keyframes pageOut { to { opacity: 0; transform: scale(0.96) translateY(10px); } }
        @keyframes pageIn { from { opacity: 0; transform: scale(0.96) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .category-pill { min-width: 85px; height: 85px; border-radius: 24px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; position: relative; }
        .category-pill:hover { transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .category-pill-active { background: linear-gradient(135deg, #FFB02E 0%, #F59E0B 100%); color: white; border: none; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); transform: scale(1.05); }
        .category-pill-inactive { background: #FFFFFF; color: #4B5563; border-color: #E5E7EB; box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .category-pill-inactive:hover { border-color: #FCD34D; background: #FFFEF5; }
        .category-pill-promotion.category-pill-active { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); box-shadow: 0 8px 20px -6px rgba(239, 68, 68, 0.4); }
        .category-pill-tray.category-pill-active { background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); box-shadow: 0 8px 20px -6px rgba(99, 102, 241, 0.4); }
        .category-pill-favorites.category-pill-active { background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%); box-shadow: 0 8px 20px -6px rgba(236, 72, 153, 0.4); }
        .tab-icon { font-size: 1.8rem; margin-bottom: 2px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .btn-gradient { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.35); border: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-gradient:hover { box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4); transform: translateY(-2px); }    
        .btn-gradient:active { transform: scale(0.96); }
        .btn-gradient-purple { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); box-shadow: 0 4px 10px rgba(139, 92, 246, 0.35); border: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-gradient-purple:hover { box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4); transform: translateY(-2px); }
        .btn-gradient-purple:active { transform: scale(0.96); }
        .tab-icon, .menu-icon { display: inline-block; transition: transform 400ms cubic-bezier(.2,.9,.2,1); transform-origin: center center; }
        .fast-card:hover .menu-icon { transform: rotate(15deg) scale(1.1); }
        #tabs-container button:hover .tab-icon { transform: rotate(15deg) scale(1.1); }
        #tabs-container button:active { transform: scale(0.94); }
        
        /* IMPROVED LOADER */
        #global-loader { position: fixed; inset: 0; z-index: 9999; background: var(--bg-primary); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.5s; }
        .loader-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .cooking-container { position: relative; width: 120px; height: 120px; }
        .cooking-pan { font-size: 4rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: panCookSmooth 2.5s infinite ease-in-out; filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1)); }
        .steam-particle { position: absolute; font-size: 1.5rem; opacity: 0; animation: steamRise 2s infinite ease-out; }
        .steam-1 { top: 10%; left: 30%; animation-delay: 0s; }
        .steam-2 { top: 5%; left: 50%; animation-delay: 0.6s; }
        .steam-3 { top: 15%; left: 70%; animation-delay: 1.2s; }
        @keyframes panCookSmooth { 0%, 100% { transform: translate(-50%, -50%) rotate(-5deg) translateY(0); } 25% { transform: translate(-50%, -50%) rotate(5deg) translateY(-3px); } 50% { transform: translate(-50%, -50%) rotate(-3deg) translateY(0); } 75% { transform: translate(-50%, -50%) rotate(3deg) translateY(-2px); } }
        @keyframes steamRise { 0% { opacity: 0; transform: translateY(0) scale(0.5); } 30% { opacity: 0.6; } 100% { opacity: 0; transform: translateY(-40px) scale(1.2); } }
        .loading-dots { display: flex; gap: 6px; margin-top: 16px; }
        .loading-dot { width: 8px; height: 8px; background: #F59E0B; border-radius: 50%; animation: dotBounce 1.4s infinite ease-in-out both; }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }
        @keyframes dotBounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        #wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto 20px auto; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }
        #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 9s cubic-bezier(0.05, 0.95, 0.05, 0.95); }
        .wheel-pointer { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 40px solid #F59E0B; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); z-index: 20; }
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: linear-gradient(135deg, #FFFFFF, #FEF3C7); border-radius: 50%; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 24px; transition: all 0.5s ease; border: 2px solid #FCD34D; }

        #receipt-capture { position: absolute; top: 0; left: 0; width: 400px; z-index: -100; visibility: hidden; background: #FFFFFF; padding: 0; border-radius: 0; font-family: 'Kanit', sans-serif; color: #1F2937; }
        .ticket-stub { background-image: radial-gradient(circle at 0 50%, transparent 8px, #FFFFFF 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, #FFFFFF 8.5px); background-position: 0 0, 0 0; background-size: 100% 100%; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); background-color: #FFFFFF; }
        .ticket-stub:hover { transform: scale(1.02); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08); }
        .ticket-stub:active { transform: scale(0.98); }
        .avatar-option { width: 72px; height: 72px; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #FFFFFF; padding: 6px; border: 2px solid #E5E7EB; }
        .avatar-option img { width: 100%; height: 100%; object-fit: contain; }
        .avatar-option:hover { transform: scale(1.15); border-color: #FCD34D; box-shadow: 0 8px 20px rgba(251, 191, 36, 0.2); }
        .avatar-selected { background: linear-gradient(135deg, #FEF3C7, #FFFBEB) !important; border: 2px solid #F59E0B; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); transform: scale(1.15); animation: avatarPulse 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes avatarPulse { 0% { transform: scale(0.9); } 50% { transform: scale(1.22); } 100% { transform: scale(1.15); } }
        input, textarea, select { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); background: #FFFFFF; color: #1F2937; border: 1.5px solid #E5E7EB; }
        input:focus, textarea:focus, select:focus { border-color: #F59E0B; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); outline: none; }
        .meat-option { background: var(--meat-option-bg); border: 2px solid var(--meat-option-border); color: var(--meat-option-text); border-radius: 1rem; padding: 0.75rem 1rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); text-align: center; min-width: 100px; flex-shrink: 0; }
        .meat-option:hover { background: var(--meat-option-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .meat-option.selected, input:checked + .meat-option { background: var(--meat-option-selected-bg); border: 2px solid var(--meat-option-selected-border); color: var(--meat-option-selected-text); font-weight: 700; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2); transform: translateY(-2px) scale(1.05); }
        .points-range { width: 100%; height: 6px; -webkit-appearance: none; appearance: none; background: linear-gradient(to right, #F59E0B, #D97706); border-radius: 10px; outline: none; }
        .points-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #FFFFFF; border: 3px solid #F59E0B; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.2s ease; }
        .points-range::-webkit-slider-thumb:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3); }
        .bg-slate-800 { background-color: #FFFFFF !important; border: 1px solid #E5E7EB; color: #1F2937; }
        .bg-slate-900 { background-color: #F9FAFB !important; color: #1F2937; }
        .bg-slate-700 { background-color: #F3F4F6 !important; color: #374151; }
        .text-slate-200, .text-slate-300, .text-slate-100 { color: #1F2937 !important; }
        .text-slate-400 { color: #6B7280 !important; }
        .text-slate-500 { color: #9CA3AF !important; }
        .border-slate-700 { border-color: #E5E7EB !important; }
        .border-slate-600 { border-color: #D1D5DB !important; }
        #modal-content .bg-slate-800 { background-color: #FFFFFF !important; border: 1px solid #E5E7EB; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #welcome-modal .bg-slate-800 { background-color: #FFFFFF !important; border: 1px solid #E5E7EB; color: #1F2937 !important; }
        #welcome-modal .text-slate-300 { color: #4B5563 !important; }
        #welcome-modal .text-slate-200 { color: #111827 !important; }
        .ticket-stub.bg-slate-800\/50 { background-color: #F3F4F6 !important; border-color: #D1D5DB !important; }
        #mini-cart-bar .bg-slate-800\/95 { background-color: #1F2937 !important; color: #FFFFFF !important; border-color: #374151; }
        #mini-cart-bar .text-slate-100 { color: #FFFFFF !important; }
        #mini-cart-bar .text-slate-400 { color: #9CA3AF !important; }
        .cart-item-title { font-size: 0.85rem !important; line-height: 1.2 !important; margin-bottom: 0.25rem !important; }
        .cart-item-details { font-size: 0.75rem !important; }
        
        /* IMPROVED TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); padding: 14px 24px; border-radius: 16px; display: flex; align-items: center; gap: 12px; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); opacity: 0; z-index: 9999; pointer-events: none; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); max-width: 90vw; min-width: 280px; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #toast-icon { font-size: 1.25rem; flex-shrink: 0; }
        #toast-msg { font-weight: 500; font-size: 0.9rem; line-height: 1.4; }
        .toast-success { background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95)); color: white; border: 1px solid rgba(16, 185, 129, 0.3); }
        .toast-error { background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95)); color: white; border: 1px solid rgba(239, 68, 68, 0.3); }
        .toast-warning { background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95)); color: white; border: 1px solid rgba(245, 158, 11, 0.3); }
        .toast-info { background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95)); color: white; border: 1px solid rgba(59, 130, 246, 0.3); }
        .price-pop { animation: pricePop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes pricePop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .vip-glow { animation: vipGlow 2s ease-in-out infinite; }
        @keyframes vipGlow { 0%, 100% { box-shadow: 0 0 5px rgba(245, 158, 11, 0.3); } 50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); } }
        
        /* NEW: Order Status Badge */
        .order-status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; }
        .status-pending { background: #FEF3C7; color: #92400E; }
        .status-preparing { background: #DBEAFE; color: #1E40AF; }
        .status-ready { background: #D1FAE5; color: #065F46; }
        .status-completed { background: #E5E7EB; color: #374151; }
        
        /* NEW: Quick Reorder Button */
        .quick-reorder-btn { position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #10B981, #059669); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4); transition: all 0.2s ease; z-index: 20; }
        .quick-reorder-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5); }
        .quick-reorder-btn:active { transform: scale(0.95); }
        
        /* NEW: Recommended Section */
        .recommended-section { background: linear-gradient(135deg, #FEF3C7, #FFFBEB); border-radius: 1.5rem; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #FCD34D; }
        
        /* NEW: Next Draw Countdown */
        .countdown-timer { display: flex; gap: 8px; justify-content: center; margin-top: 8px; }
        .countdown-box { background: linear-gradient(135deg, #1F2937, #374151); color: white; padding: 8px 12px; border-radius: 12px; text-align: center; min-width: 50px; }
        .countdown-box .number { font-size: 1.25rem; font-weight: 800; line-height: 1; }
        .countdown-box .label { font-size: 0.6rem; opacity: 0.8; margin-top: 2px; }
        
        /* NEW: Lottery Status Indicator */
        .lottery-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .lottery-status.waiting { background: #FEF3C7; color: #92400E; }
        .lottery-status.drawn { background: #D1FAE5; color: #065F46; }
        .lottery-status.expired { background: #E5E7EB; color: #6B7280; }
        
        /* NEW: Floating Promo Badge */
        .promo-float { position: fixed; top: 80px; right: 10px; z-index: 100; animation: floatPromo 3s ease-in-out infinite; }
        @keyframes floatPromo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* ===== GALAXY-LEVEL COSMIC FEATURES ===== */
        
        /* 3D Parallax Background Layers */
        .cosmic-bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
        }
        
        .stars-layer {
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #FCD34D, transparent),
                radial-gradient(2px 2px at 40px 70px, #F59E0B, transparent),
                radial-gradient(1px 1px at 90px 40px, #FBBF24, transparent),
                radial-gradient(2px 2px at 130px 80px, #FCD34D, transparent),
                radial-gradient(1px 1px at 160px 20px, #F59E0B, transparent);
            background-size: 200px 100px;
            animation: twinkle 4s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }
        
        /* Floating Food Particles */
        .food-particle {
            position: fixed;
            font-size: 2rem;
            pointer-events: none;
            z-index: -1;
            opacity: 0.15;
            animation: floatParticle 20s linear infinite;
        }
        
        @keyframes floatParticle {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.15; }
            90% { opacity: 0.15; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        /* Holographic Card Effect */
        .holographic-card {
            background: linear-gradient(
                135deg,
                rgba(255,255,255,0.9) 0%,
                rgba(255,255,255,0.95) 25%,
                rgba(254,243,199,0.9) 50%,
                rgba(255,255,255,0.95) 75%,
                rgba(255,255,255,0.9) 100%
            );
            background-size: 400% 400%;
            animation: holographicShift 8s ease infinite;
            border: 1px solid rgba(251,191,36,0.3);
        }
        
        @keyframes holographicShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 3D Flip Card Effect */
        .flip-card {
            perspective: 1000px;
            transform-style: preserve-3d;
        }
        
        .flip-card-inner {
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        
        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        /* Glow Effects */
        .cosmic-glow {
            box-shadow: 
                0 0 20px rgba(251,191,36,0.3),
                0 0 40px rgba(251,191,36,0.2),
                0 0 60px rgba(251,191,36,0.1);
        }
        
        .neon-glow {
            text-shadow: 
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 20px currentColor,
                0 0 40px rgba(251,191,36,0.5);
        }
        
        /* Achievement Badges */
        .achievement-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FCD34D, #F59E0B);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(245,158,11,0.4);
            position: relative;
            animation: badgePulse 2s ease-in-out infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(245,158,11,0.4); }
            50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(245,158,11,0.6); }
        }
        
        /* Streak Counter */
        .streak-flame {
            animation: flameFlicker 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes flameFlicker {
            0% { transform: scale(1) rotate(-2deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }
        
        /* Level Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
        }
        
        /* Particle Burst Animation */
        .particle-burst {
            position: absolute;
            pointer-events: none;
        }
        
        .burst-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: burstOut 1s ease-out forwards;
        }
        
        @keyframes burstOut {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        
        /* Voice Wave Animation */
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 30px;
        }
        
        .voice-wave-bar {
            width: 4px;
            background: linear-gradient(to top, #F59E0B, #FCD34D);
            border-radius: 2px;
            animation: waveBar 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes waveBar {
            0% { height: 10%; }
            100% { height: 100%; }
        }
        
        /* AR Preview Container */
        .ar-preview {
            perspective: 1000px;
            transform-style: preserve-3d;
        }
        
        .ar-card {
            transform: rotateX(10deg) rotateY(-10deg);
            transition: transform 0.5s ease;
            box-shadow: 
                20px 20px 60px rgba(0,0,0,0.1),
                -5px -5px 20px rgba(255,255,255,0.5);
        }
        
        .ar-card:hover {
            transform: rotateX(0) rotateY(0) scale(1.05);
        }
        
        /* Seasonal Theme Transitions */
        .seasonal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        /* Morphing Blob Background */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: blobMorph 20s ease-in-out infinite;
        }
        
        @keyframes blobMorph {
            0%, 100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; transform: translate(0, 0) scale(1); }
            25% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; transform: translate(50px, -30px) scale(1.1); }
            50% { border-radius: 50% 60% 30% 60% / 30% 60% 70% 40%; transform: translate(-30px, 50px) scale(0.9); }
            75% { border-radius: 60% 40% 60% 30% / 70% 30% 50% 60%; transform: translate(-50px, -20px) scale(1.05); }
        }
        
        /* 3D Tilt Effect */
        .tilt-card {
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }
        
        .tilt-content {
            transform: translateZ(20px);
        }
        
        /* Magnetic Button Effect */
        .magnetic-btn {
            transition: transform 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        /* Text Scramble Effect */
        .scramble-text {
            font-family: monospace;
        }
        
        /* Liquid Button Effect */
        .liquid-btn {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .liquid-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
            z-index: -1;
        }
        
        .liquid-btn:hover::before {
            width: 300%;
            height: 300%;
        }
        
        /* Shimmer Text Effect */
        .shimmer-text {
            background: linear-gradient(90deg, #1F2937 0%, #F59E0B 50%, #1F2937 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerText 3s linear infinite;
        }
        
        @keyframes shimmerText {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }
        
        /* Aurora Background Effect */
        .aurora {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                120deg,
                rgba(252,211,77,0) 0%,
                rgba(252,211,77,0.3) 25%,
                rgba(245,158,11,0.3) 50%,
                rgba(252,211,77,0) 75%
            );
            filter: blur(60px);
            animation: auroraMove 15s ease-in-out infinite;
        }
        
        @keyframes auroraMove {
            0%, 100% { transform: translateX(-50%) rotate(0deg); opacity: 0.5; }
            50% { transform: translateX(50%) rotate(5deg); opacity: 0.8; }
        }
        
        /* Floating Animation Variants */
        .float-slow { animation: floatSlow 6s ease-in-out infinite; }
        .float-medium { animation: floatMedium 4s ease-in-out infinite; }
        .float-fast { animation: floatFast 2s ease-in-out infinite; }
        
        @keyframes floatSlow {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(2deg); }
        }
        
        @keyframes floatMedium {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(-2deg); }
        }
        
        @keyframes floatFast {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(1deg); }
        }
        
        /* Glitch Effect */
        .glitch {
            position: relative;
        }
        
        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .glitch::before {
            animation: glitch-1 0.3s infinite linear alternate-reverse;
            color: #F59E0B;
            z-index: -1;
        }
        
        .glitch::after {
            animation: glitch-2 0.3s infinite linear alternate-reverse;
            color: #8B5CF6;
            z-index: -2;
        }
        
        @keyframes glitch-1 {
            0%, 100% { clip-path: inset(0 0 0 0); transform: translate(0); }
            20% { clip-path: inset(20% 0 60% 0); transform: translate(-2px, 2px); }
            40% { clip-path: inset(40% 0 40% 0); transform: translate(2px, -2px); }
            60% { clip-path: inset(60% 0 20% 0); transform: translate(-2px, -2px); }
            80% { clip-path: inset(80% 0 0 0); transform: translate(2px, 2px); }
        }
        
        @keyframes glitch-2 {
            0%, 100% { clip-path: inset(0 0 0 0); transform: translate(0); }
            20% { clip-path: inset(60% 0 20% 0); transform: translate(2px, -2px); }
            40% { clip-path: inset(40% 0 40% 0); transform: translate(-2px, 2px); }
            60% { clip-path: inset(20% 0 60% 0); transform: translate(2px, 2px); }
            80% { clip-path: inset(0 0 80% 0); transform: translate(-2px, -2px); }
        }
        
        /* Pulse Ring Animation */
        .pulse-ring {
            position: relative;
        }
        
        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: inherit;
            border: 2px solid rgba(245,158,11,0.5);
            animation: pulseRing 2s ease-out infinite;
        }
        
        @keyframes pulseRing {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.2); opacity: 0; }
        }
        
        /* Gradient Border Animation */
        .gradient-border {
            position: relative;
            background: white;
            border-radius: 1rem;
            z-index: 1;
        }
        
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: linear-gradient(45deg, #F59E0B, #8B5CF6, #F59E0B);
            background-size: 200% 200%;
            animation: gradientRotate 3s linear infinite;
            z-index: -1;
        }
        
        @keyframes gradientRotate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255,255,255,0.3) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
        }
        
        .ripple:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }
        
        /* Scan Lines Effect */
        .scan-lines {
            position: relative;
        }
        
        .scan-lines::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.02) 50%,
                rgba(0,0,0,0.02)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Neon Border Animation */
        .neon-border {
            position: relative;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        .neon-border::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #F59E0B, #8B5CF6, #EC4899, #F59E0B);
            background-size: 400% 400%;
            border-radius: inherit;
            z-index: -1;
            animation: neonBorder 3s ease infinite;
        }
        
        @keyframes neonBorder {
            0%, 100% { background-position: 0% 50%; box-shadow: 0 0 5px #F59E0B, 0 0 10px #F59E0B; }
            50% { background-position: 100% 50%; box-shadow: 0 0 20px #8B5CF6, 0 0 30px #8B5CF6; }
        }
        
        /* Floating Label Animation */
        .floating-label {
            position: relative;
        }
        
        .floating-label input:focus ~ label,
        .floating-label input:not(:placeholder-shown) ~ label {
            transform: translateY(-100%) scale(0.85);
            color: #F59E0B;
        }
        
        /* Glowing Text */
        .glow-text {
            text-shadow: 0 0 10px rgba(245,158,11,0.5), 0 0 20px rgba(245,158,11,0.3), 0 0 30px rgba(245,158,11,0.1);
            animation: glowPulse 2s ease-in-out infinite;
        }
        
        @keyframes glowPulse {
            0%, 100% { text-shadow: 0 0 10px rgba(245,158,11,0.5), 0 0 20px rgba(245,158,11,0.3); }
            50% { text-shadow: 0 0 20px rgba(245,158,11,0.8), 0 0 40px rgba(245,158,11,0.5), 0 0 60px rgba(245,158,11,0.3); }
        }
        
        /* Matrix Rain Effect */
        .matrix-bg {
            font-family: monospace;
            font-size: 14px;
            line-height: 14px;
            color: rgba(245,158,11,0.15);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Heat Wave Effect */
        .heat-wave {
            animation: heatWave 0.5s ease-in-out infinite;
        }
        
        @keyframes heatWave {
            0%, 100% { transform: translateY(0); filter: blur(0); }
            25% { transform: translateY(-2px); filter: blur(0.5px); }
            75% { transform: translateY(2px); filter: blur(0.5px); }
        }
        
        /* Vignette Effect */
        .vignette {
            position: relative;
        }
        
        .vignette::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.1) 100%);
            pointer-events: none;
        }
        
        /* Dust Particles */
        .dust-particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(251,191,36,0.3);
            border-radius: 50%;
            animation: dustFloat 10s ease-in-out infinite;
        }
        
        @keyframes dustFloat {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(50px); opacity: 0; }
        }
        
        /* Smooth Reveal Animation */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s cubic-bezier(0.5, 0, 0, 1);
        }
        
        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Stagger Children Animation */
        .stagger-children > * {
            opacity: 0;
            transform: translateY(20px);
        }
        
        .stagger-children.active > * {
            animation: staggerIn 0.5s ease forwards;
        }
        
        .stagger-children.active > *:nth-child(1) { animation-delay: 0s; }
        .stagger-children.active > *:nth-child(2) { animation-delay: 0.1s; }
        .stagger-children.active > *:nth-child(3) { animation-delay: 0.2s; }
        .stagger-children.active > *:nth-child(4) { animation-delay: 0.3s; }
        .stagger-children.active > *:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes staggerIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Elastic Bounce Animation */
        .elastic-bounce {
            animation: elasticBounce 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes elasticBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        
        /* Wobble Animation */
        .wobble {
            animation: wobble 1s ease-in-out;
        }
        
        @keyframes wobble {
            0%, 100% { transform: translateX(0) rotate(0); }
            15% { transform: translateX(-25px) rotate(-5deg); }
            30% { transform: translateX(20px) rotate(3deg); }
            45% { transform: translateX(-15px) rotate(-3deg); }
            60% { transform: translateX(10px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-1deg); }
        }
        
        /* Mini Cart positioned above bottom nav */
        #mini-cart-bar {
            z-index: 40;
            bottom: calc(85px + env(safe-area-inset-bottom));
            transition: bottom 0.3s ease, transform 0.3s ease;
        }
        
        /* When cart is empty and hidden, no extra space needed */
        #mini-cart-bar.hidden {
            transform: translateY(100px);
            opacity: 0;
            pointer-events: none;
        }
        
        /* Bottom Nav with Glassmorphism */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 
                0 -8px 32px rgba(0, 0, 0, 0.08),
                0 -1px 3px rgba(0, 0, 0, 0.05);
            transform: translateZ(0);
            will-change: transform;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
        }
        
        /* Hide bottom nav initially */
        .bottom-nav.hidden {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
        }
        
        /* Show bottom nav with slide-up animation */
        .bottom-nav.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .bottom-nav-container {
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
            gap: 8px;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-width: 72px;
            -webkit-tap-highlight-color: transparent;
            background: transparent;
        }
        
        .bottom-nav-item:active {
            transform: scale(0.92);
        }
        
        .bottom-nav-item:hover {
            background: rgba(245, 158, 11, 0.08);
        }
        
        .bottom-nav-item.active {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(251, 191, 36, 0.15) 100%);
            box-shadow: 
                0 2px 8px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }
        
        .bottom-nav-item.active .bottom-nav-icon {
            color: #F59E0B;
            transform: translateY(-3px) scale(1.1);
            filter: drop-shadow(0 2px 4px rgba(245, 158, 11, 0.3));
        }
        
        .bottom-nav-item.active .bottom-nav-label {
            color: #F59E0B;
            font-weight: 700;
            transform: translateY(-1px);
        }
        
        .bottom-nav-icon {
            font-size: 22px;
            color: #9CA3AF;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 4px;
        }
        
        .bottom-nav-label {
            font-size: 11px;
            color: #6B7280;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .bottom-nav-badge {
            position: absolute;
            top: 2px;
            right: 12px;
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            box-shadow: 
                0 2px 8px rgba(239, 68, 68, 0.4),
                0 0 0 2px rgba(255, 255, 255, 0.8);
            animation: badgePop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2;
        }
        
        @keyframes badgePop {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Ripple effect for nav items */
        .bottom-nav-item::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 20px;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.2) 0%, transparent 70%);
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
        }
        
        .bottom-nav-item:active::after {
            opacity: 1;
            transform: scale(1);
            transition: 0s;
        }
        
        /* Hide mini cart when bottom nav is present */
        body:has(.bottom-nav) #mini-cart-bar {
            bottom: calc(85px + env(safe-area-inset-bottom));
        }
        
        /* Add extra padding to main content for bottom nav */
        .max-w-md.mx-auto.px-5.relative.z-10:last-of-type {
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
        }
    </style>
<base target="_blank">
<base target="_blank">
</head>
<body class="pb-40 font-sans select-none relative overflow-x-hidden safe-area-pt">

    <canvas id="bg-canvas"></canvas>
    <canvas id="confetti-canvas"></canvas>
    
    <!-- COSMIC BACKGROUND LAYERS -->
    <div class="cosmic-bg-layer stars-layer"></div>
    <div id="food-particles-container"></div>
    <div id="blob-container" class="cosmic-bg-layer">
        <div class="blob" style="width: 400px; height: 400px; background: #FCD34D; top: 10%; left: -10%;"></div>
        <div class="blob" style="width: 300px; height: 300px; background: #F59E0B; bottom: 20%; right: -5%; animation-delay: -5s;"></div>
        <div class="blob" style="width: 250px; height: 250px; background: #FBBF24; top: 50%; left: 60%; animation-delay: -10s;"></div>
    </div>

    <!-- LOADER -->
    <div id="global-loader">
        <div class="cooking-container mb-4">
            <div class="steam-particle steam-1"></div>
            <div class="steam-particle steam-2"></div>
            <div class="steam-particle steam-3"></div>
            <div class="absolute inset-0 bg-yellow-200 rounded-full blur-xl opacity-40 animate-pulse"></div>
            <div class="cooking-pan"></div>
        </div>
        <h2 class="text-2xl font-black text-gray-800 tracking-wider">KAPRAO<span class="text-yellow-500">52</span></h2>
        <p id="loader-text" class="text-sm text-gray-500 mt-2 font-medium">...</p>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 z-[100] bg-black/30 backdrop-blur-sm flex items-center justify-center p-6 stagger-item">
        <div class="glass-heavy rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden border border-white/50">
            <button onclick="closeWelcome()" class="btn-bounce absolute top-4 right-4 z-50 w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-all">
                <i class="fas fa-times text-sm"></i>
            </button>
            <div class="relative z-10">
                <div class="w-24 h-24 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-4 text-5xl shadow-sm border border-yellow-100 animate-bounce-slow">
                    
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">!</h2>
                <p class="text-gray-600 mb-4 leading-relaxed text-sm">
                    <span class="font-bold text-indigo-500 text-base"> !</span><br>
                     Order ID <br>
                    <span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded font-bold border border-yellow-200"> 2  </span><br>
                    ! 
                </p>
                <!-- NEW: Next Draw Countdown -->
                <div class="bg-gray-50 rounded-xl p-3 mb-4 border border-gray-200">
                    <p class="text-xs text-gray-500 mb-2"> </p>
                    <div id="next-draw-countdown" class="countdown-timer">
                        <div class="countdown-box"><div class="number" id="cd-days">--</div><div class="label"></div></div>
                        <div class="countdown-box"><div class="number" id="cd-hours">--</div><div class="label">.</div></div>
                        <div class="countdown-box"><div class="number" id="cd-minutes">--</div><div class="label"></div></div>
                    </div>
                    <p id="next-draw-date" class="text-xs text-indigo-600 font-bold mt-2"></p>
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="requestNotifPermission()" class="btn-bounce w-full bg-white text-indigo-500 font-bold py-3 rounded-xl shadow-sm border border-indigo-100 transition-all text-sm hover:bg-indigo-50">
                        <i class="fas fa-bell mr-2"></i> 
                    </button>
                    <button onclick="closeWelcome()" class="btn-bounce w-full btn-gradient-purple text-white font-bold py-4 rounded-xl shadow-lg transition-all text-lg hover:scale-[1.02]">
                        !  
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Modal -->
    <div id="avatar-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[120] hidden transition-opacity opacity-0 flex items-center justify-center p-6">
        <div class="glass-heavy rounded-[2rem] p-6 max-w-sm w-full shadow-2xl stagger-item border border-white/60 relative">
            <button onclick="closeAvatarModal()" class="btn-bounce absolute top-4 right-4 z-50 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-all">
                <i class="fas fa-times text-sm"></i>
            </button>
            <h3 class="text-xl font-bold text-center mb-4 text-gray-800"> </h3>
            <div class="grid grid-cols-4 gap-4 mb-6" id="avatar-grid"></div>
            <div class="mb-6">
                 <label class="text-sm font-bold text-gray-600 mb-2 block pl-1"> </label>
                 <input type="text" id="pet-name-input" maxlength="12" placeholder=" " class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-center font-bold text-indigo-600 focus:border-indigo-500 outline-none transition-all placeholder-gray-400">
            </div>
            <button onclick="closeAvatarModal()" class="btn-bounce w-full btn-gradient text-white font-bold py-3 rounded-xl shadow-lg transition-all text-lg"></button>
        </div>
    </div>

    <!-- NEW: Quick Order History Modal -->
    <div id="quick-order-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[125] hidden transition-opacity opacity-0 flex items-center justify-center p-6">
        <div class="glass-heavy rounded-[2rem] p-6 max-w-sm w-full shadow-2xl stagger-item border border-white/60 relative max-h-[80vh] flex flex-col">
            <button onclick="closeQuickOrderModal()" class="btn-bounce absolute top-4 right-4 z-50 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-all">
                <i class="fas fa-times text-sm"></i>
            </button>
            <h3 class="text-xl font-bold text-center mb-2 text-gray-800"> </h3>
            <p class="text-xs text-gray-500 text-center mb-4"></p>
            <div id="quick-order-list" class="flex-1 overflow-y-auto hide-scroll space-y-3">
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-history text-3xl mb-2 opacity-30"></i>
                    <p class="text-sm"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <div class="px-6 pt-6 pb-2 bg-transparent relative z-10">
        <div class="flex justify-between items-start mb-6">
            <div class="flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-1">
                    <p id="greeting-text" class="text-xs text-gray-500 font-medium">, ?</p>
                    <button id="line-login-btn" onclick="handleLogin()" class="hidden bg-[#06C755] hover:bg-[#05b34c] text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm transition-all flex items-center gap-1 btn-bounce">
                        <i class="fab fa-line"></i> 
                    </button>
                </div>
                <h1 class="text-4xl sm:text-5xl font-black leading-none tracking-tighter mb-2 relative z-10 pt-1 drop-shadow-sm whitespace-nowrap flex items-baseline">
                    <span class="text-gray-800">KAPRAO</span>
                    <span class="text-yellow-500 ml-1">52</span>
                </h1>
            </div>
            <div class="flex flex-col items-center">
                 <div id="header-avatar-btn" onclick="openAvatarModal()" class="btn-bounce w-24 h-24 rounded-full bg-white border-2 border-gray-100 shadow-md flex items-center justify-center relative cursor-pointer overflow-hidden hover:border-yellow-400 transition-colors">
                      <img id="avatar-img" src="" class="w-full h-full object-cover" alt="">
                      <div class="absolute bottom-0 right-0 bg-indigo-500 rounded-full w-7 h-7 flex items-center justify-center shadow-md border-2 border-white z-30" style="bottom: 5px; right: 5px;">
                          <i class="fas fa-pen text-xs text-white"></i>
                      </div>
                </div>
                <div class="flex items-center gap-2 mt-3">
                    <p id="avatar-name-display" class="text-xs font-round font-bold text-indigo-500 tracking-wide bg-white px-4 py-1 rounded-full shadow-sm border border-gray-100 text-gray-700"></p>
                    <div id="vip-badge" class="hidden text-[10px] font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full border border-yellow-200 vip-glow">VIP</div>
                </div>
            </div>
        </div>

        <!-- NEW: Active Orders Button -->
        <div id="active-orders-container" class="hidden mb-3">
            <button onclick="showActiveOrdersList()" class="w-full btn-bounce bg-gradient-to-r from-green-500 to-emerald-600 text-white p-3 rounded-xl shadow-lg flex items-center justify-between group">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-fire animate-pulse"></i>
                    </div>
                    <div class="text-left">
                        <p class="text-sm font-bold"></p>
                        <p class="text-xs opacity-80" id="active-order-count">1 </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs"></span>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </button>
        </div>

        <!-- Points Card -->
        <div class="glass-panel p-4 rounded-xl shadow-sm mb-1 flex items-center gap-4 stagger-item" style="animation-delay: 0.1s;">
            <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-inner border-2 border-yellow-100 bg-gradient-to-br from-yellow-50 to-orange-50"></div>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-gray-700">KAPRAO POINTS</span>
                    <button onclick="openPointsHistory()" class="px-3 py-1.5 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-xs font-medium rounded-lg shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 flex items-center gap-1">
                         
                    </button>
                </div>
                <div class="flex items-baseline gap-2">
                    <span id="points-count" class="text-3xl font-black text-yellow-500">0</span>
                    <span class="text-sm text-gray-400"></span>
                </div>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] text-gray-400">100   10 </span>
                    <button id="refresh-points-btn" onclick="manualRefreshPoints()" class="text-indigo-500 hover:text-indigo-700 p-1 transition-transform" aria-label="">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 mt-2">
            <p class="text-[10px] text-gray-400">!</p>
            <div class="flex items-center gap-2">
                <!-- NEW: Quick Order Button -->
                <button onclick="openQuickOrderModal()" class="btn-bounce bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm flex items-center gap-2 text-xs font-bold text-gray-700 active:bg-gray-50 transition-all">
                    <span> </span>
                </button>
                <button onclick="openMyTickets()" class="btn-bounce bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm flex items-center gap-2 text-xs font-bold text-gray-700 active:bg-gray-50 transition-all">
                    <span> </span>
                    <div id="unread-ticket-dot" class="w-2 h-2 bg-red-500 rounded-full hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto px-5 relative z-10">
        
        <!-- NEW: Recommended Section (Smart Suggestions) -->
        <div id="recommended-section" class="recommended-section hidden stagger-item" style="animation-delay: 0.05s;">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-xl"></span>
                    <h3 class="font-bold text-gray-800 text-sm"></h3>
                </div>
                <span class="text-[10px] text-gray-500 bg-white/70 px-2 py-1 rounded-full"></span>
            </div>
            <div id="recommended-items" class="flex gap-3 overflow-x-auto hide-scroll pb-1">
                <!-- Dynamic content -->
            </div>
        </div>
        
        <!-- Randomizer Button -->
        <div class="mb-6">
            <button onclick="openRandomizer()" class="w-full btn-bounce bg-white border-2 border-dashed border-gray-300 rounded-2xl p-4 flex items-center justify-between group hover:border-yellow-400 transition-all shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="text-3xl animate-bounce-slow"></div>
                    <div class="text-left">
                        <h3 class="text-gray-800 font-bold text-sm group-hover:text-yellow-600 transition-colors">?</h3>
                        <p class="text-gray-400 text-xs"> </p>
                    </div>
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 group-hover:bg-yellow-400 group-hover:text-white transition-all">
                    <i class="fas fa-chevron-right text-xs"></i>
                </div>
            </button>
        </div>

        <!-- Search & Categories -->
        <div class="mb-3">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2"></h3>
                     <button onclick="toggleSearch()" class="btn-bounce w-9 h-9 rounded-full bg-white border border-gray-200 shadow-sm flex items-center justify-center text-gray-500 hover:text-indigo-500 transition-colors">
                        <i class="fas fa-search text-xs"></i>
                     </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="scrollTabs(-100)" class="btn-bounce bg-white w-9 h-9 rounded-full flex items-center justify-center text-gray-400 hover:text-indigo-500 transition-all border border-gray-200 shadow-sm"><i class="fas fa-chevron-left text-xs"></i></button>
                    <button onclick="scrollTabs(100)" class="btn-bounce bg-white w-9 h-9 rounded-full flex items-center justify-center text-gray-400 hover:text-indigo-500 transition-all border border-gray-200 shadow-sm"><i class="fas fa-chevron-right text-xs"></i></button>
                </div>
            </div>
            
            <div id="search-container" class="hidden mb-4 animate-fade-in-down">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="  ( , , )" 
                           class="w-full bg-white border-2 border-indigo-100 rounded-2xl py-3 pl-12 pr-10 text-sm font-bold text-gray-700 focus:border-indigo-500 focus:ring-0 shadow-sm transition-all"
                           onkeyup="handleSearch(this.value)" autocomplete="off" aria-label="">
                    <div class="absolute left-4 top-3.5 text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                    <button onclick="toggleSearch()" class="absolute right-3 top-2 bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200" aria-label="">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tab Container -->
        <div id="tabs-container" class="sticky top-0 z-30 pt-2 pb-4 -mx-5 px-5 flex gap-3 snap-x scroll-smooth overflow-x-auto hide-scroll transition-all">
            <button onclick="switchCategory('favorites')" id="tab-favorites" class="category-pill category-pill-favorites category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs font-bold"></span>
            </button>
            <button onclick="switchCategory('kaprao')" id="tab-kaprao" class="category-pill category-pill-active snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs"></span>
            </button>
            <button onclick="switchCategory('tray')" id="tab-tray" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs font-bold"></span>
            </button>
            <button onclick="switchCategory('garlic')" id="tab-garlic" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs"></span>
            </button>
             <button onclick="switchCategory('curry')" id="tab-curry" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs"></span>
            </button>
            <button onclick="switchCategory('noodle')" id="tab-noodle" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs"></span>
            </button>
            <button onclick="switchCategory('soup')" id="tab-soup" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs">/</span>
            </button>
            <button onclick="switchCategory('others')" id="tab-others" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs"></span>
            </button>
            <button onclick="switchCategory('dessert')" id="tab-dessert" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs"></span>
            </button>
            <button onclick="switchCategory('promotion')" id="tab-promotion" class="category-pill category-pill-promotion snap-start">
                <span class="text-xl tab-icon"></span><span class="text-xs font-bold"></span>
            </button>
        </div>

        <div class="mb-4 mt-2">
            <h3 id="section-title" class="font-bold text-gray-800 text-lg"></h3>
        </div>

        <div id="dessert-msg" class="hidden mb-6 stagger-item">
            <div class="bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center text-center shadow-sm">
                <div class="text-3xl mb-2"> </div>
                <h4 class="font-bold text-indigo-500 text-sm">  </h4>
                <p class="text-xs text-gray-400 mt-1"></p>
            </div>
        </div>

        <div id="menu-grid" class="grid grid-cols-2 gap-4 mb-20" role="grid" aria-label=""></div>
        
        <div class="text-center mt-12 mb-20 opacity-50">
            <p class="text-[10px] font-bold tracking-widest text-gray-400 uppercase">DEVELOPED BY SORAWIT THUNTHAKIJ | Version 24.2.0 COSMIC EDITION</p>
        </div>
    </div>
    
    <!-- Tickets Sheet -->
    <div id="tickets-modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden transition-opacity opacity-0" onclick="closeMyTickets()"></div>
    <div id="tickets-sheet" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-[111] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[80vh] flex flex-col safe-area-pb">
        <div class="w-full flex justify-center pt-4 pb-2"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
        <div class="px-6 py-2 border-b border-gray-100 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-800"> </h2>
                <p class="text-xs text-gray-400 mt-0.5"> 1  16 </p>
            </div>
            <button onclick="closeMyTickets()" class="btn-bounce w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times text-sm"></i></button>
        </div>
        <!-- NEW: Lottery Status Header -->
        <div class="px-4 py-3 bg-gradient-to-r from-indigo-50 to-purple-50 border-b border-indigo-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500"></p>
                    <p id="next-lottery-date" class="text-sm font-bold text-indigo-600">--</p>
                </div>
                <div id="lottery-status-badge" class="lottery-status waiting">
                    <i class="fas fa-clock"></i>
                    <span></span>
                </div>
            </div>
        </div>
        <div id="tickets-list" class="flex-1 overflow-y-auto p-4 space-y-3 hide-scroll"></div>
    </div>

    <!-- Mini Cart -->
    <div id="mini-cart-bar" class="fixed bottom-[calc(2.5rem+env(safe-area-inset-bottom))] left-5 right-5 z-[60] hidden stagger-item">
        <div onclick="openCheckout()" class="btn-bounce bg-gray-900 text-white p-4 rounded-full shadow-2xl flex justify-between items-center cursor-pointer border border-gray-800">
            <div class="flex items-center gap-3 pl-2">
                <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-gray-900 font-bold shadow-lg" id="mini-count">0</div>
                <div class="flex flex-col">
                    <span class="text-xs text-gray-400"></span>
                    <span class="font-bold text-lg leading-none text-indigo-300" id="mini-total">0 </span>
                </div>
            </div>
            <div class="flex items-center gap-2 pr-4 text-indigo-300 font-bold text-sm">
                <span></span>
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>

    <!-- Checkout Sheet -->
    <div id="checkout-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0" onclick="closeCheckout()"></div>
    <div id="checkout-sheet" class="fixed bottom-0 w-full h-[95vh] flex flex-col max-w-md mx-auto z-[70] transform translate-y-full transition-transform duration-300 bg-gray-50/95 backdrop-blur-xl rounded-t-[2rem] overflow-hidden shadow-2xl border-t border-white/20">
        <div class="flex-none pt-5 pb-3 px-6 bg-white border-b border-gray-100 shadow-sm relative z-20">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-black text-gray-800 leading-none"></h2>
                    <p class="text-xs text-gray-400 mt-1 font-medium"></p>
                </div>
                <button onclick="closeCheckout()" class="btn-bounce w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </div>
        <div id="checkout-scrollable" class="flex-1 overflow-y-auto hide-scroll p-5 space-y-5 pb-32">
            <div id="order-id-banner" class="hidden"></div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2"><i class="fas fa-utensils"></i> </h3>
                <div id="cart-list-container" class="space-y-4"></div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2"><i class="fas fa-user"></i> </h3>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-pen text-indigo-400"></i></div>
                    <input type="text" id="user-name" maxlength="20" placeholder=" / Note ..." class="block w-full pl-10 pr-3 py-3 border-2 border-gray-100 rounded-xl leading-5 bg-gray-50 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-indigo-500 focus:ring-0 transition-colors sm:text-sm font-bold text-gray-700">
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2"><i class="fas fa-tags"></i>  & </h3>
                <div class="flex gap-2 mb-3">
                    <div id="code-input-container" class="flex-1 bg-gray-50 rounded-xl px-3 py-2 flex items-center gap-2 border border-gray-100">
                        <i class="fas fa-ticket-alt text-gray-400" id="code-icon"></i>
                        <input type="text" id="discount-code" placeholder="" class="bg-transparent w-full text-sm outline-none text-gray-800 placeholder:text-gray-400 uppercase font-bold">
                    </div>
                    <button onclick="applyDiscount()" id="btn-apply-code" class="btn-bounce bg-gray-800 text-white font-bold px-4 rounded-xl text-xs shadow-lg hover:bg-gray-700 transition-all"></button>
                </div>
                <p id="discount-msg" class="text-[10px] font-medium text-gray-500 pl-1 mb-3 min-h-[1.25rem]"></p>
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-3 border border-yellow-100 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2 relative z-10">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-white shadow-sm font-bold text-xs"><i class="fas fa-star"></i></div>
                            <div>
                                <div class="text-[10px] text-yellow-700 font-bold uppercase tracking-wider">Kaprao Points</div>
                                <div class="text-xs font-bold text-gray-800" id="user-points-balance"> <span id="available-points">0</span> </div>
                            </div>
                        </div>
                        <button id="points-toggle-btn" onclick="togglePointsUsage()" class="text-[10px] bg-white text-yellow-600 border border-yellow-200 px-3 py-1.5 rounded-lg font-bold shadow-sm active:scale-95 transition-transform"></button>
                    </div>
                    <div id="points-controls-container" class="hidden pt-2 border-t border-yellow-200/50 mt-2 relative z-10 animate-fade-in-down">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] text-yellow-700">: <span id="points-used-display" class="font-bold text-indigo-600">0</span> </span>
                            <span class="text-xs font-bold text-red-500"> <span id="points-discount-display">0</span> </span>
                        </div>
                        <div class="points-range-container mb-2">
                            <input type="range" id="points-range" min="0" max="100" value="0" step="10" class="points-range w-full h-1.5 bg-yellow-200 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                            <div class="flex justify-between text-[9px] text-yellow-600 mt-1"><span>0</span><span id="points-max">100</span></div>
                        </div>
                        <div class="flex gap-2">
                            <input type="hidden" id="points-input" value="0">
                            <div class="flex-1 text-[9px] text-yellow-600 flex items-center justify-end">*100  = 10 </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3"></h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between text-gray-500"><span> (Subtotal)</span><span id="summary-subtotal" class="font-medium">0.-</span></div>
                    <div id="discount-summary" class="flex justify-between text-green-500 hidden"><span><i class="fas fa-ticket-alt mr-1"></i> </span><span class="font-bold">-0.-</span></div>
                    <div id="points-summary" class="flex justify-between text-yellow-500 hidden"><span><i class="fas fa-coins mr-1"></i> </span><span class="font-bold">-0.-</span></div>
                    <div class="border-t border-gray-100 my-2 pt-2 flex justify-between items-end"><span class="font-bold text-gray-800 text-lg"></span><span id="summary-grand-total" class="font-black text-2xl text-indigo-600 leading-none">0.-</span></div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-100 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] safe-area-pb-plus z-30">
            <button onclick="submitOrderToLine()" id="btn-submit-order" class="btn-bounce w-full bg-gradient-to-r from-gray-900 to-gray-800 text-white font-bold text-lg py-4 rounded-2xl shadow-xl shadow-gray-300 flex justify-between items-center px-6 group hover:shadow-2xl transition-all">
                <span class="flex items-center gap-2 text-sm font-medium opacity-80"><i class="fab fa-line text-green-400 text-lg"></i> </span>
                <div class="flex items-center gap-2 group-active:scale-95 transition-transform"><span></span><i class="fas fa-arrow-right bg-white/20 rounded-full w-6 h-6 flex items-center justify-center text-xs"></i></div>
            </button>
        </div>
    </div>

    <!-- Points History Modal -->
    <div id="points-history-modal" class="fixed inset-0 z-[130] bg-black/30 backdrop-blur-sm flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-[2rem] p-1 w-full max-w-sm shadow-2xl relative overflow-hidden border border-gray-200">
            <div class="bg-white/95 backdrop-blur-sm rounded-[1.8rem] p-6 text-center relative z-10">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm border-4 border-white"></div>
                <h2 class="text-2xl font-black text-gray-800 mb-1"></h2>
                <p class="text-indigo-500 font-bold text-sm mb-4">KAPRAO POINTS HISTORY</p>
                <div id="points-history-list" class="max-h-60 overflow-y-auto mb-4">
                    <div class="text-center text-gray-400 py-8"><i class="fas fa-history text-3xl mb-2 opacity-30"></i><p class="text-sm"></p></div>
                </div>
                <button onclick="closePointsHistory()" class="btn-bounce w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all border-2 border-indigo-500"></button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0" onclick="closeModal()"></div>
    <div id="modal-content" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-[70] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[85vh] flex flex-col touch-pan-y safe-area-pb">
        <div id="modal-drag-handle" class="w-full flex justify-center pt-4 pb-2 cursor-grab active:cursor-grabbing z-50"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
        <button onclick="closeModal()" class="btn-bounce absolute top-4 right-4 z-50 close-button w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times text-sm"></i></button>

        <div id="modal-scroll-area" class="flex-1 overflow-y-auto hide-scroll px-6 pb-24 pt-4">
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 bg-white rounded-full overflow-hidden flex items-center justify-center text-6xl shadow-sm border-4 border-gray-100">
                    <img id="modal-image" src="" alt="" class="w-full h-full object-cover hidden">
                    <span id="modal-icon"></span>
                </div>
            </div>
            <div class="text-center mb-8">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-1 font-round"></h3>
                <div class="flex justify-center items-center gap-2">
                    <span id="modal-kcal" class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-bold transition-all">0 kcal</span>
                    <span class="text-gray-300">|</span>
                    <span id="modal-price" class="text-xl font-bold text-indigo-500">50</span>
                    <span class="text-sm text-gray-400"></span>
                </div>
            </div>
            <div class="flex items-center justify-center gap-6 mb-6">
                <button onclick="adjustQty(-1)" class="btn-bounce w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center font-bold shadow-sm border border-gray-200 active:bg-gray-200 transition-all text-lg">-</button>
                <span id="modal-qty" class="text-2xl font-bold text-gray-800 w-8 text-center">1</span>
                <button onclick="adjustQty(1)" class="btn-bounce w-12 h-12 rounded-full btn-gradient text-white flex items-center justify-center font-bold shadow-md active:scale-95 transition-all text-lg">+</button>
            </div>
            <div id="modal-meat-section" class="mb-6 hidden">
                <h4 class="font-bold text-gray-700 mb-3 text-sm"></h4>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scroll p-1" id="meat-options-container"></div>
            </div>
            <div id="tray-options-container" class="mb-6 hidden"></div>
            <div class="mb-6" id="addons-section">
                <h4 class="font-bold text-gray-700 mb-3 text-sm"></h4>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 hover:border-yellow-400 cursor-pointer transition-all has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 btn-bounce shadow-sm">
                        <div class="flex items-center gap-3"><span class="text-sm font-medium text-gray-700"> </span></div>
                        <div class="flex items-center gap-3"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-special" class="accent-yellow-500 w-5 h-5 rounded" value="10"></div>
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700"> </span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaikhon" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700"> </span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaidao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700"> </span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaijiao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700"> </span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaiyiewma" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700"> </span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaitom" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <h4 class="font-bold text-gray-700 mb-2 text-sm">Note</h4>
                <textarea id="modal-note" rows="2" maxlength="100" class="w-full bg-white border border-gray-200 rounded-2xl p-4 text-base text-gray-700 focus:ring-2 focus:ring-indigo-500 resize-none shadow-inner placeholder:text-gray-400" placeholder=" , ..."></textarea>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-100 rounded-t-[2rem] safe-area-pb-plus">
            <button onclick="addToCart()" class="btn-bounce w-full btn-gradient-purple text-white font-bold text-lg py-4 rounded-full shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
                <span></span>
                <i class="fas fa-plus bg-white/20 rounded-full w-6 h-6 flex items-center justify-center text-xs"></i>
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast">
        <i id="toast-icon" class="fas fa-info-circle"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-result-modal" class="fixed inset-0 z-[140] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 hidden">
        <div class="bg-transparent w-full max-w-sm flex flex-col items-center">
            <div class="bg-white p-2 rounded-lg shadow-2xl mb-4 overflow-hidden">
                <img id="receipt-result-img" class="w-full h-auto rounded" src="" alt="Receipt">
            </div>
            <div class="flex flex-col gap-2 w-full px-4">
                <button onclick="downloadReceiptImage()" class="btn-bounce bg-gradient-to-r from-yellow-400 to-orange-500 text-white w-full py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 text-lg">
                    <i class="fas fa-save"></i> 
                </button>
                <p class="text-white/70 text-xs text-center mb-2">(  )</p>
                <button onclick="document.getElementById('receipt-result-modal').classList.add('hidden')" class="btn-bounce bg-white/20 hover:bg-white/30 text-white w-full py-3 rounded-xl font-bold border border-white/50 backdrop-blur-md"></button>
            </div>
        </div>
    </div>

    <div id="receipt-capture">
        <div class="bg-white p-6 relative">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm relative overflow-hidden">
                    <img id="receipt-avatar-img" src="" class="w-full h-full object-cover" crossorigin="anonymous">
                </div>
                <h2 class="text-2xl font-black text-gray-800 tracking-wider">KAPRAO52</h2>
                <p class="text-[10px] text-gray-500 tracking-widest uppercase mt-1">Authentic Thai Street Food</p>
                <div class="mt-4 inline-block px-4 py-1 bg-gray-100 rounded-full border border-gray-200">
                    <p class="text-xs font-bold text-gray-600">RECEIPT / </p>
                </div>
            </div>
            <div class="border-t-2 border-dashed border-gray-300 my-4"></div>
            <div class="flex justify-between items-center mb-1"><span class="text-xs text-gray-500">Order ID</span><span class="font-bold text-gray-800 tracking-wide receipt-id">KP-XX99</span></div>
            <div class="flex justify-between items-center mb-1"><span class="text-xs text-gray-500">Date</span><span class="font-medium text-xs text-gray-500 receipt-date">01/01/2024 12:00</span></div>
            <div class="flex justify-between items-center mb-4"><span class="text-xs text-gray-500">Customer</span><span class="font-bold text-sm text-gray-800 receipt-name">Customer</span></div>
            <div class="bg-gray-50 rounded-lg p-3 mb-4 space-y-2 receipt-items border border-gray-100"></div>
            <div class="space-y-1">
                <div class="flex justify-between text-xs text-gray-500"><span>Subtotal</span><span class="receipt-subtotal">0.-</span></div>
                <div class="flex justify-between text-xs text-green-600"><span>Discount</span><span class="receipt-discount">-0.-</span></div>
                <div class="flex justify-between items-end mt-2 pt-2 border-t border-gray-300">
                    <span class="font-bold text-gray-800">TOTAL</span>
                    <span class="font-black text-3xl text-indigo-600 receipt-total">0.-</span>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t-2 border-dotted border-gray-300 text-center">
                <div class="flex justify-center gap-1 text-2xl text-yellow-400 mb-2"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></div>
                <p class="text-[10px] text-gray-400">THANK YOU FOR YOUR ORDER</p>
                <div class="mt-4 flex justify-center opacity-50"><img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" class="w-16 h-16 mix-blend-multiply"></div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 h-4 bg-white" style="background: linear-gradient(45deg, transparent 33.333%, #F3F4F6 33.333%, #F3F4F6 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #F3F4F6 33.333%, #F3F4F6 66.667%, transparent 66.667%); background-size: 20px 40px; transform: translateY(10px);"></div>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = '2008781875-6whmY1cf'; 
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykr-x76heMf1sebbvCYGfcwNsH2b3GUxp-piaO-BgHYejnMiMD3Whdoo5_5IydKpVS/exec'; 

        // --- GLOBAL UTILITIES & STATE ---
        let cart = [];
        let currentItem = null;
        let activeCategory = 'kaprao';
        let discountValue = 0;
        let modalQty = 1;
        let userStats = { points: 0, history: [], orderHistory: [] }; 
        let lottoHistory = []; 
        let isSubmitting = false; 
        let pointsRedeemed = 0;
        let isPointsActive = false; 
        let searchQuery = "";
        let favoriteItems = new Set();
        
        const addonIds = ['special', 'kaikhon', 'kaidao', 'kaijiao', 'kaitom', 'kaiyiewma'];
        const addonCalories = { 'special': 80, 'kaikhon': 150, 'kaidao': 120, 'kaijiao': 200, 'kaitom': 75, 'kaiyiewma': 100 };
        const KEYS = { USER: 'kaprao52_user', HISTORY: 'kaprao_lotto_history', STATS: 'kaprao_stats', VERSION: 'kaprao_ver', FAVORITES: 'kaprao_favorites' };
        
        const CURRENT_VERSION = '24.2.0'; 

        // --- THAI LOTTERY SYSTEM (CORRECTED) ---
        //  1  16 
        //  14:30-16:00 .
        
        function getThaiLotteryDrawDate(referenceDate = new Date()) {
            const year = referenceDate.getFullYear();
            const month = referenceDate.getMonth();
            const day = referenceDate.getDate();
            
            //  1  16
            let drawDay = 1;
            if (day > 1 && day < 16) {
                drawDay = 16;
            } else if (day >= 16) {
                //  (  1)
                return new Date(year, month + 1, 1);
            }
            
            return new Date(year, month, drawDay);
        }
        
        function getLastThaiLotteryDrawDate(referenceDate = new Date()) {
            const year = referenceDate.getFullYear();
            const month = referenceDate.getMonth();
            const day = referenceDate.getDate();
            
            // 
            if (day >= 16) {
                return new Date(year, month, 16);
            } else if (day > 1) {
                return new Date(year, month, 1);
            } else {
                //  1   (16 )
                return new Date(year, month - 1, 16);
            }
        }
        
        function isLotteryDrawn(drawDate) {
            const now = new Date();
            const drawDateTime = new Date(drawDate);
            //  ~16:00 .
            drawDateTime.setHours(16, 0, 0, 0);
            return now >= drawDateTime;
        }
        
        function getLotteryStatus(ticket) {
            const drawDate = new Date(ticket.drawDateTimestamp);
            const now = new Date();
            
            // 
            if (!isLotteryDrawn(drawDate)) {
                return { status: 'waiting', text: '', class: 'waiting' };
            }
            
            //  
            if (ticket.status === 'won') {
                return { status: 'won', text: '!', class: 'drawn' };
            } else if (ticket.status === 'lost') {
                return { status: 'lost', text: '', class: 'expired' };
            }
            
            // 
            return { status: 'pending', text: '', class: 'waiting' };
        }
        
        function formatThaiDate(date) {
            const d = new Date(date);
            const months = ['..', '..', '..', '..', '..', '..', '..', '..', '..', '..', '..', '..'];
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
        }
        
        function updateLotteryCountdown() {
            const nextDraw = getThaiLotteryDrawDate();
            const now = new Date();
            const diff = nextDraw - now;
            
            //  16:00
            if (diff < 0) {
                const nextNextDraw = getThaiLotteryDrawDate(new Date(now.getTime() + 86400000 * 5));
                const newDiff = nextNextDraw - now;
                updateCountdownDisplay(newDiff);
                document.getElementById('next-draw-date').textContent = formatThaiDate(nextNextDraw);
            } else {
                updateCountdownDisplay(diff);
                document.getElementById('next-draw-date').textContent = formatThaiDate(nextDraw);
            }
        }
        
        function updateCountdownDisplay(diff) {
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            const daysEl = document.getElementById('cd-days');
            const hoursEl = document.getElementById('cd-hours');
            const minutesEl = document.getElementById('cd-minutes');
            
            if (daysEl) daysEl.textContent = String(days).padStart(2, '0');
            if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
            if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
        }
        
        function updateTicketsLotteryStatus() {
            const nextDraw = getThaiLotteryDrawDate();
            const lastDraw = getLastThaiLotteryDrawDate();
            
            // 
            const nextDateEl = document.getElementById('next-lottery-date');
            const statusBadge = document.getElementById('lottery-status-badge');
            
            if (nextDateEl) {
                nextDateEl.textContent = formatThaiDate(nextDraw);
            }
            
            if (statusBadge) {
                if (isLotteryDrawn(lastDraw)) {
                    statusBadge.className = 'lottery-status drawn';
                    statusBadge.innerHTML = '<i class="fas fa-check-circle"></i><span></span>';
                } else {
                    statusBadge.className = 'lottery-status waiting';
                    statusBadge.innerHTML = '<i class="fas fa-clock"></i><span></span>';
                }
            }
        }

        // --- CANVAS BACKGROUND & CONFETTI ---
        function initCanvasBackground() {
            const canvas = document.getElementById('bg-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let width, height;
            const bubbles = [];
            const icons = ['', '', '', '', ''];
            let isTabActive = true;
            document.addEventListener('visibilitychange', () => { isTabActive = !document.hidden; });
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
            window.addEventListener('resize', resize); resize();
            class Bubble {
                constructor() { this.init(); }
                init() { this.icon = icons[Math.floor(Math.random() * icons.length)]; this.size = Math.random() * 20 + 20; this.x = Math.random() * width; this.y = height + this.size + (Math.random() * 100); this.speed = Math.random() * 0.5 + 0.2; this.opacity = Math.random() * 0.3 + 0.1; this.swingCounter = Math.random() * 10; this.rotation = Math.random() * 360; this.rotationSpeed = (Math.random() - 0.5) * 0.02; }
                draw() { ctx.save(); ctx.globalAlpha = this.opacity; ctx.font = `${this.size}px sans-serif`; ctx.translate(this.x, this.y); ctx.rotate(this.rotation); ctx.fillText(this.icon, -this.size/2, this.size/2); ctx.restore(); }
                update() { this.y -= this.speed; this.swingCounter += 0.02; this.x += Math.sin(this.swingCounter) * 0.5; this.rotation += this.rotationSpeed; if (this.y < -this.size) this.init(); this.draw(); }
            }
            for (let i = 0; i < 5; i++) bubbles.push(new Bubble());
            let frameCount = 0;
            function animate() { 
                if (!isTabActive) { 
                    requestAnimationFrame(animate); 
                    return; 
                }
                // Skip every other frame for 30fps instead of 60fps
                frameCount++;
                if (frameCount % 2 === 0) {
                    ctx.clearRect(0, 0, width, height); 
                    bubbles.forEach(b => b.update()); 
                }
                requestAnimationFrame(animate); 
            }
            animate();
        }

        function confetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const pieces = [];
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
            for(let i=0; i<150; i++) {
                pieces.push({
                    x: window.innerWidth / 2, y: window.innerHeight / 2,
                    w: Math.random() * 10 + 5, h: Math.random() * 10 + 5,
                    vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20 - 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rot: Math.random() * 360, rotSpeed: (Math.random() - 0.5) * 10
                });
            }
            let animId;
            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                pieces.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.rot += p.rotSpeed;
                    if(p.y < canvas.height) active = true;
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
                    ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                });
                if(active) animId = requestAnimationFrame(loop);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            loop();
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            let text = ", ?";
            if (hour >= 5 && hour < 12) text = " ! ?";
            else if (hour >= 12 && hour < 16) text = " ! ";
            else if (hour >= 16 && hour < 21) text = " !  ";
            else if (hour >= 21 || hour < 5) text = "  ? !";
            document.getElementById('greeting-text').innerText = text;
        }

        function calculateItemUnitPrice(item, options = {}) {
            let total = item.price;
            if (item.isTray) { total += (options.meatPrice || 0); total += (options.eggPrice || 0); }
            if (options.addons && options.addons.length > 0) { total += options.addons.length * 10; }
            return total;
        }

        const menuItems = [
            { id: 201, name: "Set 1: Solo Tray ()", price: 89, icon: "", category: "tray", reqMeat: false, isTray: true, trayType: 1, kcal: 750, image: "images/solo-tray.jpg" },
            { id: 202, name: "Set 2: Buddy Tray ()", price: 149, icon: "", category: "tray", reqMeat: false, isTray: true, trayType: 2, kcal: 1400, image: "images/buddy-tray.jpg" },
            { id: 2, name: "", price: 55, icon: "", category: "kaprao", reqMeat: true, kcal: 350, image: "images/kaprao-nor-mai.jpg" },
            { id: 3, name: "", price: 50, icon: "", category: "kaprao", reqMeat: false, kcal: 520, image: "images/kaprao-moo-sap.jpg" },
            { id: 4, name: "", price: 50, icon: "", category: "kaprao", reqMeat: false, kcal: 550, image: "images/kaprao-moo-deng.jpg" },
            { id: 5, name: "", price: 50, icon: "", category: "kaprao", reqMeat: false, kcal: 600, image: "images/kaprao-san-ko.jpg" },
            { id: 6, name: "", price: 60, icon: "", category: "kaprao", reqMeat: false, kcal: 650, image: "images/kaprao-kai-yiao-ma.jpg" },
            { id: 102, name: "", price: 60, icon: "", category: "kaprao", reqMeat: false, kcal: 450, isNew: true, image: "images/kaprao-kung.jpg" },
            { id: 105, name: "", price: 50, icon: "", category: "kaprao", reqMeat: false, kcal: 450, isNew: true, image: "images/kaprao-kai.jpg" },
            { id: 108, name: "", price: 60, icon: "", category: "kaprao", reqMeat: false, kcal: 480, isNew: true, image: "images/kaprao-pla-muek.jpg" },
            { id: 109, name: "", price: 65, icon: "", category: "kaprao", reqMeat: false, kcal: 620, isNew: true, image: "images/kaprao-moo-krob.jpg" },
            { id: 301, name: "()", price: 50, icon: "", category: "curry", reqMeat: false, kcal: 550, isNew: true, image: "images/prik-kang-moo-chin.jpg" },
            { id: 302, name: "", price: 50, icon: "", category: "curry", reqMeat: false, kcal: 520, isNew: true, image: "images/prik-kang-moo-sap.jpg" },
            { id: 303, name: "", price: 50, icon: "", category: "curry", reqMeat: false, kcal: 540, isNew: true, image: "images/prik-kang-moo-deng.jpg" },
            { id: 304, name: "", price: 60, icon: "", category: "curry", reqMeat: false, kcal: 480, isNew: true, image: "images/prik-kang-kung.jpg" },
            { id: 305, name: "", price: 60, icon: "", category: "curry", reqMeat: false, kcal: 470, isNew: true, image: "images/prik-kang-pla-muek.jpg" },
            { id: 306, name: "", price: 50, icon: "", category: "curry", reqMeat: false, kcal: 450, isNew: true, image: "images/prik-kang-kai.jpg" },
            { id: 10, name: "", price: 50, icon: "", category: "noodle", reqMeat: true, kcal: 450, image: "images/mama-pad-kaprao.jpg" },
            { id: 1, name: "", price: 55, icon: "", category: "noodle", reqMeat: true, kcal: 400, image: "images/kaprao-wun-sen.jpg" },
            { id: 7, name: "", price: 50, icon: "", category: "garlic", reqMeat: false, kcal: 500, image: "images/moo-sap-kra-thiam.jpg" },
            { id: 8, name: "", price: 50, icon: "", category: "garlic", reqMeat: false, kcal: 580, image: "images/san-ko-kra-thiam.jpg" },
            { id: 9, name: "", price: 50, icon: "", category: "garlic", reqMeat: false, kcal: 530, image: "images/moo-deng-kra-thiam.jpg" },
            { id: 103, name: "", price: 60, icon: "", category: "garlic", reqMeat: false, kcal: 480, isNew: true, image: "images/kung-kra-thiam.jpg" },
            { id: 101, name: " ()", price: 40, icon: "", category: "soup", reqMeat: false, kcal: 350, isNew: true, image: "images/tom-jued-kai-nam.jpg" },
            { id: 11, name: "", price: 40, icon: "", category: "others", reqMeat: false, desc: " 2 ", kcal: 450, image: "images/khai-khon-prik-pao.jpg" },
            { id: 12, name: "", price: 40, icon: "", category: "others", reqMeat: false, desc: " 2 ", kcal: 380, image: "images/khai-khon.jpg" },
            { id: 13, name: "", price: 50, icon: "", category: "others", reqMeat: false, kcal: 420, image: "images/khai-jiao-prik-sot.jpg" },
            { id: 14, name: " 3 ", price: 50, icon: "", category: "others", reqMeat: false, kcal: 480, image: "images/khai-dao-3-fong.jpg" },
            { id: 15, name: "", price: 50, icon: "", category: "others", reqMeat: true, kcal: 300, image: "images/nor-mai-pad-khai.jpg" },
            { id: 104, name: "", price: 60, icon: "", category: "others", reqMeat: false, kcal: 550, isNew: true, image: "images/khai-khon-kung.jpg" },
            { id: 106, name: "", price: 50, icon: "", category: "others", reqMeat: false, kcal: 520, isNew: true, image: "images/khao-pad-khai.jpg" },
            { id: 107, name: " ()", price: 50, icon: "", category: "others", reqMeat: false, kcal: 600, isNew: true, image: "images/khao-pad-moo-chin.jpg" },
            { id: 110, name: "", price: 65, icon: "", category: "others", reqMeat: false, kcal: 420, isNew: true, image: "images/kung-rod-sot-makham.jpg" },
            { id: 111, name: "", price: 50, icon: "", category: "others", reqMeat: false, kcal: 380, isNew: true, image: "images/khai-dao-rod-sot-makham.jpg" },
            { id: 20, name: "", price: 30, icon: "", category: "dessert", reqMeat: false, kcal: 150, image: "images/cha-kuey-nom-sot.jpg" },
            { id: 21, name: "", price: 25, icon: "", category: "dessert", reqMeat: false, kcal: 220, image: "images/kluay-chueam.jpg" },
        ];
        
        const promotions = [
            { code: "SAVE10", title: "Set  (Value) ", desc: " 150.-  10 ", minOrder: 150, type: "discount", value: 10, color: "bg-orange-400", icon: "" },
            { code: "SAVE25", title: "Set  (Gang) ", desc: " 300.-  25 ", minOrder: 300, type: "discount", value: 25, color: "bg-blue-500", icon: "" },
            { code: "SAVE50", title: "Set  (Grand) ", desc: " 500.-  50 ", minOrder: 500, type: "discount", value: 50, color: "bg-brand-purple", icon: "" },
            { code: "SORRY20", title: "", desc: "", minOrder: 0, type: "discount", value: 20, isHidden: true },
            { code: "SORRY30", title: "", desc: "", minOrder: 0, type: "discount", value: 30, isHidden: true },
        ];

        let isSyncing = false;
        let currentOpenModal = null;
        function pushModalState(modalId) { currentOpenModal = modalId; window.history.pushState({ modal: modalId }, null, ""); lockScroll(); }
        function lockScroll() { document.body.classList.add('scroll-locked'); }
        function unlockScroll() { document.body.classList.remove('scroll-locked'); }

        window.addEventListener('popstate', function(event) {
            if (currentOpenModal) {
                if (currentOpenModal === 'menu') closeModal(true);
                else if (currentOpenModal === 'checkout') closeCheckout(true);
                else if (currentOpenModal === 'tickets') closeMyTickets(true);
                else if (currentOpenModal === 'avatar') closeAvatarModal(true);
                else if (currentOpenModal === 'points-history') closePointsHistory(true);
                else if (currentOpenModal === 'quick-order') closeQuickOrderModal(true);
                currentOpenModal = null;
                unlockScroll();
            }
        });

        function playSound(type) { /* Sound disabled */ }
        function triggerHaptic(intensity = 'light') { if (navigator.vibrate) navigator.vibrate(intensity === 'heavy' ? [80, 40, 80] : 15); }

        function showGlobalLoader(text = "...") { document.getElementById('loader-text').innerText = text; document.getElementById('global-loader').classList.remove('loader-hidden'); }
        function hideGlobalLoader() { document.getElementById('global-loader').classList.add('loader-hidden'); }
        
        function requestNotifPermission() {
            if (!("Notification" in window)) { showToast("Browser ", 'warning'); return; }
            Notification.requestPermission().then(permission => { if (permission === "granted") showToast("! ", 'success'); });
        }
        
        let toastTimeout;
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast'); 
            const msg = document.getElementById('toast-msg'); 
            const icon = document.getElementById('toast-icon');
            if (toastTimeout) clearTimeout(toastTimeout);
            toast.className = '';
            switch(type) {
                case 'success': icon.className = 'fas fa-check-circle'; toast.classList.add('toast-success'); break;
                case 'error': icon.className = 'fas fa-exclamation-circle'; toast.classList.add('toast-error'); break;
                case 'warning': icon.className = 'fas fa-exclamation-triangle'; toast.classList.add('toast-warning'); break;
                default: icon.className = 'fas fa-info-circle'; toast.classList.add('toast-info');
            }
            msg.innerText = message; 
            toast.classList.add('show');
            triggerHaptic(type === 'error' ? 'heavy' : 'light'); 
            toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3500);
        }
        
        setTimeout(() => hideGlobalLoader(), 3000);

        const avatarOptions = ['https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Dog%20face/3D/dog_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Cat%20face/3D/cat_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Tiger%20face/3D/tiger_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Lion/3D/lion_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Monkey%20face/3D/monkey_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Elephant/3D/elephant_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Pig%20face/3D/pig_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Chicken/3D/chicken_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Panda/3D/panda_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Frog/3D/frog_3d.png'];
        let userAvatar = { image: avatarOptions[0], hat: false, name: '', userId: null };

        function openAvatarModal() {
            pushModalState('avatar'); 
            const grid = document.getElementById('avatar-grid'); grid.innerHTML = '';
            avatarOptions.forEach(imgSrc => {
                const el = document.createElement('div'); el.className = `avatar-option ${userAvatar.image === imgSrc ? 'avatar-selected' : ''}`;
                el.innerHTML = `<img src="${imgSrc}" alt="avatar">`; el.onclick = () => selectAvatar(imgSrc); grid.appendChild(el);
            });
            document.getElementById('pet-name-input').value = userAvatar.name || '';
            const modal = document.getElementById('avatar-modal'); modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        function closeAvatarModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'avatar') { history.back(); return; }
            const modal = document.getElementById('avatar-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300);
            const nameInput = document.getElementById('pet-name-input').value.trim();
            if(nameInput) { userAvatar.name = escapeHtml(nameInput); const orderNameInput = document.getElementById('user-name'); if(orderNameInput) orderNameInput.value = userAvatar.name; }
            saveToLS(); updateAvatarDisplay(); currentOpenModal = null; unlockScroll();
        }
        function selectAvatar(imgSrc) {
            userAvatar.image = imgSrc;
            document.querySelectorAll('.avatar-option').forEach(opt => { const img = opt.querySelector('img'); if (img && img.src === imgSrc) opt.classList.add('avatar-selected'); else opt.classList.remove('avatar-selected'); });
            triggerHaptic();
        }
        function updateAvatarDisplay() {
            document.getElementById('avatar-img').src = userAvatar.image;
            document.getElementById('avatar-name-display').innerText = userAvatar.name || '';
        }
        function closeWelcome() {
            const modal = document.getElementById('welcome-modal'); modal.style.opacity = '0'; modal.style.transition = 'opacity 0.5s ease';
            setTimeout(() => modal.classList.add('hidden'), 500); triggerHaptic();
            
            // Show bottom nav after welcome modal closes
            const bottomNav = document.getElementById('bottom-nav');
            if (bottomNav) {
                bottomNav.classList.remove('hidden');
                bottomNav.classList.add('show');
            }
        }

        // --- NEW: Quick Order Modal ---
        function openQuickOrderModal() {
            pushModalState('quick-order');
            const modal = document.getElementById('quick-order-modal');
            const list = document.getElementById('quick-order-list');
            list.innerHTML = '';
            
            const orderHistory = userStats.orderHistory || [];
            if (orderHistory.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-history text-3xl mb-2 opacity-30"></i>
                        <p class="text-sm"></p>
                    </div>
                `;
            } else {
                //  5  
                const uniqueOrders = [];
                const seen = new Set();
                for (const order of orderHistory) {
                    const key = order.items.map(i => i.name).join(',');
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueOrders.push(order);
                        if (uniqueOrders.length >= 5) break;
                    }
                }
                
                uniqueOrders.forEach((order, index) => {
                    const el = document.createElement('div');
                    el.className = 'bg-white border border-gray-200 rounded-xl p-3 flex justify-between items-center cursor-pointer hover:border-yellow-400 transition-all';
                    const itemNames = order.items.slice(0, 2).map(i => i.name).join(', ');
                    const moreItems = order.items.length > 2 ? ` +${order.items.length - 2}` : '';
                    el.innerHTML = `
                        <div class="flex-1">
                            <p class="text-sm font-bold text-gray-800 truncate">${itemNames}${moreItems}</p>
                            <p class="text-xs text-gray-400">${order.date}  ${order.total} </p>
                        </div>
                        <button onclick="quickReorder(${index})" class="ml-3 w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 text-white flex items-center justify-center shadow-lg hover:scale-110 transition-transform">
                            <i class="fas fa-plus"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        
        function closeQuickOrderModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'quick-order') { history.back(); return; }
            const modal = document.getElementById('quick-order-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            currentOpenModal = null;
            unlockScroll();
        }
        
        function quickReorder(index) {
            const orderHistory = userStats.orderHistory || [];
            const order = orderHistory[index];
            if (order && order.items) {
                order.items.forEach(item => {
                    cart.push({
                        id: Date.now() + Math.random(),
                        name: item.name,
                        price: item.price,
                        meat: item.meat || null,
                        addons: item.addons || [],
                        note: item.note || '',
                        image: item.image
                    });
                });
                saveToLS();
                updateMiniCart();
                closeQuickOrderModal();
                showToast(` ${order.items.length} !`, 'success');
                triggerHaptic('heavy');
            }
        }
        
        // --- NEW: Smart Recommendations ---
        function updateRecommendations() {
            const orderHistory = userStats.orderHistory || [];
            const section = document.getElementById('recommended-section');
            const container = document.getElementById('recommended-items');
            
            if (orderHistory.length < 2) {
                section.classList.add('hidden');
                return;
            }
            
            // 
            const itemCounts = {};
            orderHistory.forEach(order => {
                order.items.forEach(item => {
                    itemCounts[item.name] = (itemCounts[item.name] || 0) + 1;
                });
            });
            
            const topItems = Object.entries(itemCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([name]) => menuItems.find(m => m.name === name))
                .filter(Boolean);
            
            if (topItems.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            container.innerHTML = '';
            
            topItems.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex-shrink-0 bg-white rounded-xl p-3 border border-gray-200 cursor-pointer hover:border-yellow-400 hover:shadow-md transition-all';
                el.style.width = '140px';
                el.onclick = () => openModal(item);
                el.innerHTML = `
                    <div class="text-3xl text-center mb-2">${item.icon}</div>
                    <p class="text-xs font-bold text-gray-800 text-center line-clamp-2">${item.name}</p>
                    <p class="text-xs text-indigo-500 text-center font-bold mt-1">${item.price} </p>
                `;
                container.appendChild(el);
            });
        }

        function calculatePoints(netTotal) {
            if (netTotal < 60) return 0; if (netTotal < 100) return 10; if (netTotal < 150) return 20; if (netTotal < 200) return 30; if (netTotal < 250) return 40; if (netTotal < 300) return 50; return 60;
        }

        function updatePointsDisplay() {
            const points = userStats.points || 0;
            document.getElementById('points-count').innerText = points; 
            document.getElementById('available-points').innerText = points; 
            updateCheckoutPointsInfo();
        }
        function updateCheckoutPointsInfo() {
            const subtotal = cart.reduce((sum, i) => sum + i.price, 0); 
            const userPointsBalance = document.getElementById('user-points-balance');
            if (userPointsBalance) userPointsBalance.innerHTML = ` <span id="available-points">${userStats.points || 0}</span> `;
        }

        function togglePointsUsage() {
            const controlsContainer = document.getElementById('points-controls-container'); 
            const toggleBtn = document.getElementById('points-toggle-btn'); 
            const userPoints = userStats.points || 0;
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            const code = document.getElementById('discount-code').value.trim().toUpperCase(); 
            const promo = promotions.find(p => p.code === code); 
            let discountFromCode = 0;
            if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value;
            let netTotalBeforePoints = Math.max(0, subtotal - discountFromCode);

            if (controlsContainer.classList.contains('hidden')) {
                if (userPoints < 100) { showToast(` ${userPoints}  ( 100 )`, 'error'); return; }
                controlsContainer.classList.remove('hidden'); isPointsActive = true;
                toggleBtn.innerHTML = '<i class="fas fa-times mr-2"></i> '; 
                toggleBtn.classList.remove('bg-white', 'text-yellow-600', 'border-yellow-200'); 
                toggleBtn.classList.add('bg-red-500', 'text-white', 'border-red-500');
                const maxPointsByPrice = netTotalBeforePoints * 10; 
                const maxPoints = Math.min(userPoints, maxPointsByPrice); 
                const finalMaxPoints = Math.floor(maxPoints / 100) * 100;
                document.getElementById('points-range').max = finalMaxPoints; 
                document.getElementById('points-max').textContent = finalMaxPoints; 
                document.getElementById('points-input').max = finalMaxPoints;
                const initialPoints = finalMaxPoints; 
                document.getElementById('points-range').value = initialPoints; 
                document.getElementById('points-input').value = initialPoints;
                updatePointsDiscount(initialPoints); 
                showToast('', 'success');
            } else {
                controlsContainer.classList.add('hidden'); isPointsActive = false; pointsRedeemed = 0;
                toggleBtn.innerHTML = ''; 
                toggleBtn.classList.remove('bg-red-500', 'text-white', 'border-red-500'); 
                toggleBtn.classList.add('bg-white', 'text-yellow-600', 'border-yellow-200');
                updateTotalSummary(); 
                showToast('', 'info');
            }
            triggerHaptic();
        }

        function updatePointsFromUI(value) {
            const userPoints = userStats.points || 0; 
            let pointsValue = parseInt(value) || 0; 
            pointsValue = Math.round(pointsValue / 100) * 100;
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0); 
            const code = document.getElementById('discount-code').value.trim().toUpperCase(); 
            const promo = promotions.find(p => p.code === code); 
            let discountFromCode = 0; 
            if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value; 
            let netTotalBeforePoints = Math.max(0, subtotal - discountFromCode);
            const maxPointsByPrice = netTotalBeforePoints * 10; 
            const finalMax = Math.min(userPoints, maxPointsByPrice);
            if (pointsValue > finalMax) pointsValue = Math.floor(finalMax / 100) * 100;
            document.getElementById('points-range').value = pointsValue; 
            document.getElementById('points-input').value = pointsValue; 
            updatePointsDiscount(pointsValue);
        }

        function updatePointsDiscount(pointsAmount) {
            pointsAmount = pointsAmount || parseInt(document.getElementById('points-input').value) || 0;
            const discountAmount = Math.floor(pointsAmount / 100) * 10;
            const discountDisplay = document.getElementById('points-discount-display'); 
            if (discountDisplay) discountDisplay.textContent = `${discountAmount}`;
            const usedDisplay = document.getElementById('points-used-display'); 
            if (usedDisplay) usedDisplay.textContent = `${pointsAmount}`;
            pointsRedeemed = pointsAmount; 
            discountValue = discountAmount; 
            updateTotalSummary();
        }

        function resetPointsDiscount() {
            const controlsContainer = document.getElementById('points-controls-container'); 
            const toggleBtn = document.getElementById('points-toggle-btn');
            if (controlsContainer) controlsContainer.classList.add('hidden'); 
            isPointsActive = false; pointsRedeemed = 0;
            if (toggleBtn) { 
                toggleBtn.innerHTML = ''; 
                toggleBtn.classList.remove('bg-red-500', 'text-white', 'border-red-500'); 
                toggleBtn.classList.add('bg-white', 'text-yellow-600', 'border-yellow-200'); 
            }
            updateTotalSummary();
        }

        function openPointsHistory() {
            pushModalState('points-history');
            const modal = document.getElementById('points-history-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            const historyList = document.getElementById('points-history-list'); 
            historyList.innerHTML = '';
            const history = userStats.history || [];
            if (history.length === 0) { 
                historyList.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fas fa-history text-3xl mb-2 opacity-30"></i><p class="text-sm"></p></div>`; 
            } else {
                history.forEach(item => {
                    const dateObj = new Date(item.date); 
                    const dateStr = `${getStandardDate(dateObj)} ${formatTime(dateObj)}`;
                    let icon, title, amountClass, amountSign, bgClass;
                    if (item.type === 'earn') { 
                        icon = 'fa-plus-circle'; title = ''; amountClass = 'text-green-500'; amountSign = '+'; bgClass = 'bg-white border-gray-200'; 
                    } else { 
                        icon = 'fa-minus-circle'; title = ''; amountClass = 'text-red-500'; amountSign = '-'; bgClass = 'bg-white border-gray-200'; 
                    }
                    const el = document.createElement('div'); 
                    el.className = `flex justify-between items-center p-3 mb-2 rounded-xl border ${bgClass}`;
                    el.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center ${amountClass}"><i class="fas ${icon}"></i></div><div class="text-left"><div class="text-xs font-bold text-gray-800">${title}</div><div class="text-[10px] text-gray-400">${dateStr} #${item.orderId ? item.orderId.slice(-4) : 'PROMO'}</div></div></div><div class="font-black text-lg ${amountClass}">${amountSign}${item.amount}</div>`;
                    historyList.appendChild(el);
                });
            }
        }
        function closePointsHistory(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'points-history') { history.back(); return; }
            const modal = document.getElementById('points-history-modal'); 
            modal.classList.add('opacity-0'); 
            setTimeout(() => modal.classList.add('hidden'), 300);
            currentOpenModal = null; 
            unlockScroll();
        }

        function escapeHtml(text) { 
            if (!text) return text; 
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // --- ENHANCED SECURITY UTILITIES ---
        function sanitizeInput(input, options = {}) {
            const { 
                maxLength = 200, 
                allowHTML = false, 
                allowedTags = [],
                trim = true 
            } = options;
            
            if (typeof input !== 'string') return '';
            
            let sanitized = input;
            
            // Trim whitespace
            if (trim) {
                sanitized = sanitized.trim();
            }
            
            // Limit length
            if (sanitized.length > maxLength) {
                sanitized = sanitized.substring(0, maxLength);
            }
            
            // Remove or escape HTML
            if (!allowHTML) {
                sanitized = sanitized
                    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                    .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');
                
                // If no allowed tags, escape all HTML
                if (allowedTags.length === 0) {
                    sanitized = escapeHtml(sanitized);
                }
            }
            
            // Remove potential SQL injection patterns
            const sqlPattern = /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|SCRIPT)\b)|(--)|(\/\*)|(\*\/)/gi;
            sanitized = sanitized.replace(sqlPattern, '');
            
            // Remove null bytes
            sanitized = sanitized.replace(/\0/g, '');
            
            return sanitized;
        }
        
        function validateOrderId(orderId) {
            // Order ID format: KP-XXXXXX (must match pattern)
            const pattern = /^KP-[A-Z0-9]{6}$/;
            return pattern.test(orderId);
        }
        
        function validatePrice(price) {
            // Price must be a positive number, max 10,000
            const num = parseFloat(price);
            return !isNaN(num) && num >= 0 && num <= 10000;
        }
        
        function sanitizeJSON(data) {
            try {
                // Parse and stringify to remove any non-serializable data
                return JSON.parse(JSON.stringify(data));
            } catch (e) {
                console.error('JSON sanitization failed:', e);
                return null;
            }
        }
        
        function getStandardDate(dateObj) { if(!dateObj) dateObj = new Date(); const d = dateObj.getDate().toString().padStart(2, '0'); const m = (dateObj.getMonth() + 1).toString().padStart(2, '0'); const y = dateObj.getFullYear(); return `${d}/${m}/${y}`; }
        function formatTime(dateObj) { if(!dateObj) dateObj = new Date(); const h = dateObj.getHours().toString().padStart(2, '0'); const m = dateObj.getMinutes().toString().padStart(2, '0'); return `${h}:${m}`; }

        function loadUserDataSafe() {
            try {
                const savedUser = localStorage.getItem(KEYS.USER);
                if (savedUser) { 
                    const u = JSON.parse(savedUser); 
                    cart = u.cart || []; 
                    userAvatar = u.avatar || { image: avatarOptions[0], hat: false, name: '' }; 
                    if(u.name) document.getElementById('user-name').value = u.name; 
                    if (u.userId) userAvatar.userId = u.userId; 
                }
                const savedHistory = localStorage.getItem(KEYS.HISTORY); 
                if (savedHistory) lottoHistory = JSON.parse(savedHistory) || []; 
                if (!Array.isArray(lottoHistory)) lottoHistory = [];
                const savedStats = localStorage.getItem(KEYS.STATS); 
                if (savedStats) {
                    const parsed = JSON.parse(savedStats) || { points: 0 };
                    userStats = { ...userStats, ...parsed };
                }
                const savedFav = localStorage.getItem(KEYS.FAVORITES); 
                if (savedFav) favoriteItems = new Set(JSON.parse(savedFav));
            } catch (error) { 
                userStats = { points: 0, history: [], orderHistory: [] }; 
                lottoHistory = []; 
            }
        }

        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        const saveToLS = debounce(function() {
            let safeNameElement = document.getElementById('user-name'); 
            let safeName = safeNameElement ? escapeHtml(safeNameElement.value) : '';
            let oldData = {}; 
            try { oldData = JSON.parse(localStorage.getItem(KEYS.USER)) || {}; } catch (e) {}
            const userState = { ...oldData, cart: cart, name: safeName, avatar: userAvatar };
            localStorage.setItem(KEYS.USER, JSON.stringify(userState));
            localStorage.setItem(KEYS.FAVORITES, JSON.stringify([...favoriteItems]));
            localStorage.setItem(KEYS.STATS, JSON.stringify(userStats));
        }, 500);
        
        async function checkForUpdate() {
            try {
                const response = await fetch(window.location.href + '?t=' + new Date().getTime()); 
                const text = await response.text();
                const serverVerMatch = text.match(/const CURRENT_VERSION = '([\d.]+)'/);
                if (serverVerMatch && serverVerMatch[1]) { 
                    const serverVer = serverVerMatch[1]; 
                    if (serverVer !== CURRENT_VERSION) window.location.reload(); 
                }
            } catch (err) {}
        }

        async function syncTicketHistory(userId) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getHistory&userId=' + userId); 
                if (!response.ok) throw new Error('Network response was not ok');
                const serverTickets = await response.json(); 
                if (!Array.isArray(serverTickets) || serverTickets.length === 0) return;
                let updated = false;
                serverTickets.forEach(serverT => {
                    const exists = lottoHistory.some(localT => localT.id === serverT.id);
                    if (!exists) {
                        const drawDateObj = getThaiLotteryDrawDate(new Date(serverT.date));
                        const newTicket = { 
                            id: serverT.id, 
                            number: serverT.id.slice(-2), 
                            date: serverT.date, 
                            drawDate: getStandardDate(drawDateObj), 
                            drawDateTimestamp: drawDateObj.getTime(), 
                            timestamp: Date.now(), 
                            price: serverT.price, 
                            status: 'pending', 
                            checkedDate: null, 
                            items: [{ name: serverT.itemsStr, price: serverT.price }], 
                            customerName: 'Synced' 
                        };
                        lottoHistory.push(newTicket); 
                        updated = true;
                    }
                });
                if (updated) { 
                    lottoHistory.sort((a, b) => b.timestamp - a.timestamp); 
                    if(lottoHistory.length > 20) lottoHistory = lottoHistory.slice(0, 20); 
                    localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory)); 
                    updateTicketBadge(); 
                    autoCheckLottery(); 
                }
            } catch (e) { console.error("Sync History Error:", e); }
        }

        async function syncUserStatsFromServer(userId) {
            if(!userId) return; 
            isSyncing = true; 
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getUserStats&userId=' + userId); 
                if (!response.ok) throw new Error('Network response was not ok');
                const serverData = await response.json();
                if(serverData && serverData.points !== undefined) { 
                    userStats.points = serverData.points; 
                    localStorage.setItem(KEYS.STATS, JSON.stringify(userStats)); 
                    updatePointsDisplay(); 
                }
            } catch (error) { console.error("Sync Stats Error:", error); } 
            finally { isSyncing = false; }
        }

        async function manualRefreshPoints() {
            const btn = document.getElementById('refresh-points-btn'); 
            if(isSyncing) return;
            btn.classList.add('animate-spin-fast');
            if (userAvatar.userId) { 
                await syncUserStatsFromServer(userAvatar.userId); 
                showToast('! ', 'success'); 
            } else { 
                showToast('', 'warning'); 
            }
            setTimeout(() => btn.classList.remove('animate-spin-fast'), 1000);
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (liff.isLoggedIn()) {
                    const vip = document.getElementById('vip-badge'); 
                    if (vip) { vip.classList.remove('hidden'); vip.innerText = 'VIP'; }
                    const profile = await liff.getProfile(); 
                    const loginBtn = document.getElementById('line-login-btn'); 
                    if(loginBtn) loginBtn.classList.add('hidden');
                    
                    let savedUser = {}; 
                    try { savedUser = JSON.parse(localStorage.getItem(KEYS.USER)) || {}; } catch(e) {}
                    savedUser.userId = profile.userId; 
                    userAvatar.userId = profile.userId;
                    savedUser.name = profile.displayName;
                    userAvatar.name = profile.displayName;
                    const nameInput = document.getElementById('user-name'); 
                    if(nameInput) nameInput.value = profile.displayName;
                    if(profile.pictureUrl && (avatarOptions.includes(userAvatar.image) || !userAvatar.image)) { 
                        userAvatar.image = profile.pictureUrl; 
                    }
                    savedUser.avatar = userAvatar;
                    updateAvatarDisplay(); 
                    localStorage.setItem(KEYS.USER, JSON.stringify(savedUser));
                    
                    if (cart.length === 0 && savedUser.cart && savedUser.cart.length > 0) { 
                        cart = savedUser.cart; 
                        updateMiniCart(); 
                        renderCheckoutList(); 
                    }
                    const localHistoryIds = lottoHistory.map(t => t.id);
                    if (localHistoryIds.length > 0) { 
                        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'claim_orders', userId: profile.userId, orderIds: localHistoryIds }) }).then(() => { syncUserStatsFromServer(profile.userId); syncTicketHistory(profile.userId); }); 
                    } else { 
                        syncUserStatsFromServer(profile.userId); 
                        syncTicketHistory(profile.userId); 
                    }
                } else { 
                    document.getElementById('vip-badge').classList.add('hidden'); 
                    const loginBtn = document.getElementById('line-login-btn'); 
                    if (!liff.isInClient() && loginBtn) loginBtn.classList.remove('hidden'); 
                    else liff.login(); 
                }
            } catch (err) {}
        }
        
        function handleLogin() { 
            const btn = document.getElementById('line-login-btn'); 
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ...'; 
            btn.classList.add('opacity-75'); 
            if (liff.ready) liff.login(); 
            else liff.init({ liffId: MY_LIFF_ID }).then(() => liff.login()); 
        }

        function createMeatOptions() {
            const container = document.getElementById('meat-options-container'); 
            container.innerHTML = '';
            const meatOptions = [{ value: '', label: '' }, { value: '', label: '' }, { value: '', label: '' }];
            meatOptions.forEach((meat, index) => {
                const label = document.createElement('label'); 
                label.className = 'cursor-pointer flex-shrink-0';
                const input = document.createElement('input'); 
                input.type = 'radio'; 
                input.name = 'modal-meat'; 
                input.value = meat.value; 
                input.className = 'peer sr-only'; 
                if (index === 0) input.checked = true;
                const optionDiv = document.createElement('div'); 
                optionDiv.className = 'meat-option'; 
                optionDiv.textContent = meat.label;
                label.appendChild(input); 
                label.appendChild(optionDiv); 
                container.appendChild(label);
                input.addEventListener('change', function() { 
                    document.querySelectorAll('.meat-option').forEach(opt => opt.classList.remove('selected')); 
                    if (this.checked) { this.nextElementSibling.classList.add('selected'); triggerHaptic(); } 
                });
            });
            if (container.firstChild) { 
                container.firstChild.querySelector('input').checked = true; 
                container.firstChild.querySelector('.meat-option').classList.add('selected'); 
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCanvasBackground();
            initPullToRefresh();
            initAccessibility();
            loadActiveOrders();
            
            const savedVer = localStorage.getItem(KEYS.VERSION); 
            if(savedVer !== CURRENT_VERSION) localStorage.setItem(KEYS.VERSION, CURRENT_VERSION);
            loadUserDataSafe(); 
            fetchLottoResults(); 
            initLIFF(); 
            
            // Start lottery countdown
            updateLotteryCountdown();
            setInterval(updateLotteryCountdown, 60000); // Update every minute
            
            setTimeout(autoCheckLottery, 1000); 
            updateTicketBadge(); 
            updateAvatarDisplay(); 
            updatePointsDisplay(); 
            updateMiniCart(); 
            renderCheckoutList(); 
            updateGreeting();
            updateRecommendations();
            
            setTimeout(checkForUpdate, 2000); 
            document.addEventListener('visibilitychange', () => { 
                if (document.visibilityState === 'visible') {
                    checkForUpdate();
                    updateLotteryCountdown();
                    loadActiveOrders(); // Check for order updates
                }
            });
            
            const inputs = document.querySelectorAll('input[type="text"], textarea'); 
            inputs.forEach(input => { 
                input.addEventListener('focus', () => { setTimeout(() => input.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300); }); 
            });
            renderMenu(); 
            try { setupMicroInteractions(); } catch(e) {}
            
            const pointsRange = document.getElementById('points-range'); 
            const pointsInput = document.getElementById('points-input');
            if (pointsRange) pointsRange.addEventListener('input', function() { updatePointsFromUI(this.value); });
            if (pointsInput) { 
                pointsInput.addEventListener('input', function() { updatePointsFromUI(this.value); }); 
                pointsInput.addEventListener('change', function() { updatePointsFromUI(this.value); }); 
            }
            const userNameInput = document.getElementById('user-name'); 
            if(userNameInput) userNameInput.addEventListener('input', saveToLS);
        });
        
        // --- WHEEL ---
        let wheelSpinning = false;
        const wheelSegments = [ { text: " 5 ", color: "#FFFFFF", type: "discount_5" }, { text: "", color: "#F3F4F6", type: "none" }, { text: " 40.", color: "#FBBF24", type: "free_40" }, { text: "", color: "#FFFFFF", type: "none" }, { text: "", color: "#F3F4F6", type: "free_egg" }, { text: " 10 ", color: "#FBBF24", type: "discount_10" } ];
        function drawWheel() {
            const canvas = document.getElementById('wheel-canvas'); 
            if(!canvas) return;
            const ctx = canvas.getContext('2d'); 
            const size = canvas.width; 
            const center = size / 2; 
            const sliceAngle = (2 * Math.PI) / wheelSegments.length;
            wheelSegments.forEach((seg, i) => {
                const startAngle = i * sliceAngle - (Math.PI / 2); 
                const endAngle = startAngle + sliceAngle;
                ctx.beginPath(); 
                ctx.moveTo(center, center); 
                ctx.arc(center, center, center, startAngle, endAngle);
                ctx.fillStyle = seg.color; 
                ctx.fill(); 
                ctx.strokeStyle = "#E5E7EB"; 
                ctx.lineWidth = 1; 
                ctx.stroke();
                ctx.save(); 
                ctx.translate(center, center); 
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right"; 
                ctx.fillStyle = "#1F2937"; 
                ctx.font = "bold 14px Kanit"; 
                ctx.fillText(seg.text, center - 20, 5); 
                ctx.restore();
            });
        }
        function spinWheel() {
            if (wheelSpinning) return;
            const today = getStandardDate(new Date()); 
            const lastDate = localStorage.getItem('kaprao_spin_date');
            let count = parseInt(localStorage.getItem('kaprao_spin_count') || '0');
            if (lastDate !== today) { count = 0; localStorage.setItem('kaprao_spin_date', today); }
            if (count >= 3) { showToast("  3  !", 'warning'); return; }
            localStorage.setItem('kaprao_spin_count', count + 1);
            wheelSpinning = true; 
            triggerHaptic('heavy');
            const box = document.getElementById('wheel-canvas'); 
            const fullSpins = 360 * 8; 
            const targetDegree = 150; 
            const randomVariance = Math.floor(Math.random() * 40) - 20; 
            const nextRotation = fullSpins + targetDegree + randomVariance;
            box.style.transform = `rotate(${nextRotation}deg)`;
            setTimeout(() => {
                wheelSpinning = false; 
                box.style.transform = `rotate(${targetDegree}deg)`; 
                box.style.transition = 'none';
                handleReward(wheelSegments[3]); 
                confetti();
                setTimeout(() => box.style.transition = 'transform 8s cubic-bezier(0.1, 0.99, 0.1, 0.99)', 50);
            }, 8000); 
        }
        function handleReward(reward) { 
            if(reward.type === 'none') showToast("! ", 'warning'); 
            else showToast(`!  ${reward.text}`, 'success'); 
        }

        function scrollTabs(amount) { document.getElementById('tabs-container').scrollBy({ left: amount, behavior: 'smooth' }); }

        function renderSkeletonLoader() {
            const grid = document.getElementById('menu-grid'); 
            grid.innerHTML = '';
            for(let i=0; i<6; i++) {
                const el = document.createElement('div'); 
                el.className = "fast-card p-4 flex flex-col shadow-sm";
                el.innerHTML = `<div class="flex flex-col items-center mb-3"><div class="w-20 h-20 rounded-2xl skeleton mb-3"></div><div class="h-4 w-full skeleton rounded mb-2"></div><div class="h-3 w-2/3 skeleton rounded"></div></div><div class="mt-auto pt-3 border-t border-slate-700/50"><div class="h-4 w-1/2 skeleton rounded mb-2"></div><div class="h-10 w-full skeleton rounded"></div></div>`;
                grid.appendChild(el);
            }
        }

        function toggleSearch() {
            const container = document.getElementById('search-container');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden'); 
                document.getElementById('search-input').focus();
            } else {
                container.classList.add('hidden'); 
                searchQuery = ""; 
                document.getElementById('search-input').value = ""; 
                renderMenu();
            }
            triggerHaptic();
        }
        
        // --- OPTIMIZED SEARCH WITH DEBOUNCING ---
        let searchTimeout = null;
        let searchAbortController = null;
        const searchDebounceMs = 150;
        
        function handleSearch(val) {
            // Cancel any pending search
            if (searchTimeout) {
                clearTimeout(searchTimeout);
                searchTimeout = null;
            }
            if (searchAbortController) {
                searchAbortController.abort();
            }
            
            const query = val.toLowerCase().trim();
            
            // Immediate update for empty query
            if (query === '') {
                searchQuery = '';
                renderMenu();
                return;
            }
            
            // Debounced search for non-empty queries
            searchAbortController = new AbortController();
            searchTimeout = setTimeout(() => {
                if (!searchAbortController.signal.aborted) {
                    searchQuery = query;
                    renderMenu();
                    
                    // Track search analytics (non-blocking)
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'search', {
                            search_term: query,
                            category: activeCategory
                        });
                    }
                }
            }, searchDebounceMs);
        }
        
        // --- PULL TO REFRESH FUNCTIONALITY ---
        let pullStartY = 0;
        let pullCurrentY = 0;
        let isPulling = false;
        let pullThreshold = 80;
        let refreshIndicator = null;
        
        function initPullToRefresh() {
            const mainContent = document.querySelector('.max-w-md.mx-auto');
            if (!mainContent) return;
            
            // Create refresh indicator
            refreshIndicator = document.createElement('div');
            refreshIndicator.id = 'pull-refresh-indicator';
            refreshIndicator.className = 'fixed top-0 left-0 right-0 z-40 flex items-center justify-center pointer-events-none transition-all duration-300';
            refreshIndicator.style.height = '0px';
            refreshIndicator.style.opacity = '0';
            refreshIndicator.innerHTML = `
                <div class="bg-white/90 backdrop-blur-md rounded-full px-4 py-2 shadow-lg border border-gray-200 flex items-center gap-2">
                    <i class="fas fa-sync-alt text-indigo-500 transition-transform duration-300" id="refresh-icon"></i>
                    <span class="text-sm font-medium text-gray-700" id="refresh-text"></span>
                </div>
            `;
            document.body.appendChild(refreshIndicator);
            
            // Touch events
            document.addEventListener('touchstart', handlePullStart, { passive: true });
            document.addEventListener('touchmove', handlePullMove, { passive: false });
            document.addEventListener('touchend', handlePullEnd, { passive: true });
        }
        
        function handlePullStart(e) {
            // Only trigger if at top of page
            if (window.scrollY > 10) return;
            if (document.body.classList.contains('scroll-locked')) return;
            
            pullStartY = e.touches[0].clientY;
            isPulling = true;
        }
        
        function handlePullMove(e) {
            if (!isPulling) return;
            if (window.scrollY > 10) {
                isPulling = false;
                return;
            }
            
            pullCurrentY = e.touches[0].clientY;
            const diff = pullCurrentY - pullStartY;
            
            if (diff > 0 && diff < pullThreshold * 2) {
                e.preventDefault();
                const progress = Math.min(diff / pullThreshold, 1);
                
                refreshIndicator.style.height = `${diff}px`;
                refreshIndicator.style.opacity = progress;
                
                const icon = document.getElementById('refresh-icon');
                const text = document.getElementById('refresh-text');
                
                if (icon) {
                    icon.style.transform = `rotate(${progress * 360}deg)`;
                }
                if (text) {
                    text.textContent = progress >= 1 ? '' : '';
                }
            }
        }
        
        function handlePullEnd() {
            if (!isPulling) return;
            isPulling = false;
            
            const diff = pullCurrentY - pullStartY;
            
            if (diff >= pullThreshold) {
                // Trigger refresh
                refreshIndicator.style.height = '60px';
                document.getElementById('refresh-text').textContent = '...';
                document.getElementById('refresh-icon').classList.add('animate-spin');
                
                performRefresh();
            } else {
                // Cancel refresh
                refreshIndicator.style.height = '0px';
                refreshIndicator.style.opacity = '0';
            }
            
            pullStartY = 0;
            pullCurrentY = 0;
        }
        
        async function performRefresh() {
            try {
                // Sync data
                if (userAvatar.userId) {
                    await Promise.all([
                        syncUserStatsFromServer(userAvatar.userId),
                        syncTicketHistory(userAvatar.userId),
                        fetchLottoResults()
                    ]);
                } else {
                    await fetchLottoResults();
                }
                
                // Update UI
                updatePointsDisplay();
                updateTicketBadge();
                renderMenu();
                updateRecommendations();
                
                showToast('! ', 'success');
            } catch (error) {
                showToast(' ', 'error');
            } finally {
                // Reset indicator
                refreshIndicator.style.height = '0px';
                refreshIndicator.style.opacity = '0';
                const icon = document.getElementById('refresh-icon');
                if (icon) icon.classList.remove('animate-spin');
            }
        }

        // --- DATA EXPORT/IMPORT FUNCTIONALITY ---
        function exportUserData() {
            try {
                const exportData = {
                    version: CURRENT_VERSION,
                    exportDate: new Date().toISOString(),
                    user: JSON.parse(localStorage.getItem(KEYS.USER) || '{}'),
                    stats: JSON.parse(localStorage.getItem(KEYS.STATS) || '{}'),
                    history: JSON.parse(localStorage.getItem(KEYS.HISTORY) || '[]'),
                    favorites: JSON.parse(localStorage.getItem(KEYS.FAVORITES) || '[]')
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kaprao52-backup-${getStandardDate(new Date()).replace(/\//g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('! ', 'success');
            } catch (error) {
                showToast('', 'error');
                console.error('Export error:', error);
            }
        }
        
        function importUserData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.version || !data.exportDate) {
                        throw new Error('Invalid backup file');
                    }
                    
                    // Confirm import
                    if (confirm(` ${data.exportDate} ?\n`)) {
                        if (data.user) localStorage.setItem(KEYS.USER, JSON.stringify(data.user));
                        if (data.stats) localStorage.setItem(KEYS.STATS, JSON.stringify(data.stats));
                        if (data.history) localStorage.setItem(KEYS.HISTORY, JSON.stringify(data.history));
                        if (data.favorites) localStorage.setItem(KEYS.FAVORITES, JSON.stringify(data.favorites));
                        
                        // Reload page to apply changes
                        showToast('! ...', 'success');
                        setTimeout(() => location.reload(), 1500);
                    }
                } catch (error) {
                    showToast('', 'error');
                }
            };
            reader.readAsText(file);
        }

        function toggleFavorite(e, id) {
            e.stopPropagation();
            if (favoriteItems.has(id)) { 
                favoriteItems.delete(id); 
                showToast(''); 
            } else { 
                favoriteItems.add(id); 
                showToast(' ', 'success'); 
            }
            saveToLS();
            const btn = e.currentTarget; 
            btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 500);
            renderMenu(); 
            triggerHaptic();
        }

        // --- ORDER TRACKING SYSTEM ---
        const ORDER_STATUS = {
            PENDING: { code: 'pending', label: '', icon: 'fa-clock', color: 'text-yellow-600', bgColor: 'bg-yellow-50' },
            CONFIRMED: { code: 'confirmed', label: '', icon: 'fa-check-circle', color: 'text-blue-600', bgColor: 'bg-blue-50' },
            PREPARING: { code: 'preparing', label: '', icon: 'fa-fire', color: 'text-orange-600', bgColor: 'bg-orange-50' },
            READY: { code: 'ready', label: '', icon: 'fa-utensils', color: 'text-green-600', bgColor: 'bg-green-50' },
            COMPLETED: { code: 'completed', label: '', icon: 'fa-star', color: 'text-gray-600', bgColor: 'bg-gray-50' }
        };
        
        let activeOrders = new Map();
        
        function startOrderTracking(orderId, items) {
            const order = {
                id: orderId,
                items: items,
                status: ORDER_STATUS.PENDING,
                startTime: Date.now(),
                estimatedTime: items.length * 3 + 5, // ~3 mins per item + 5 base
                updates: []
            };
            
            activeOrders.set(orderId, order);
            saveActiveOrders();
            
            // Simulate status progression
            simulateOrderProgress(orderId);
            
            // Show order status modal
            showOrderStatusModal(orderId);
        }
        
        function simulateOrderProgress(orderId) {
            const order = activeOrders.get(orderId);
            if (!order) return;
            
            const transitions = [
                { status: ORDER_STATUS.CONFIRMED, delay: 30000 },     // 30s
                { status: ORDER_STATUS.PREPARING, delay: 60000 },      // 1min
                { status: ORDER_STATUS.READY, delay: order.estimatedTime * 60000 * 0.8 }, // 80% of estimated
                { status: ORDER_STATUS.COMPLETED, delay: (order.estimatedTime * 60000) + 300000 } // +5min
            ];
            
            transitions.forEach(({ status, delay }) => {
                setTimeout(() => {
                    if (activeOrders.has(orderId)) {
                        const order = activeOrders.get(orderId);
                        order.status = status;
                        order.updates.push({
                            status: status,
                            time: Date.now()
                        });
                        
                        saveActiveOrders();
                        updateOrderStatusModal(orderId);
                        
                        // Send notification if permitted
                        if (status === ORDER_STATUS.READY && Notification.permission === 'granted') {
                            new Notification('! ', {
                                body: `Order ${orderId} `,
                                icon: 'https://cdn-icons-png.flaticon.com/512/3448/3448609.png'
                            });
                        }
                    }
                }, delay);
            });
        }
        
        function saveActiveOrders() {
            const ordersArray = Array.from(activeOrders.entries());
            localStorage.setItem('kaprao_active_orders', JSON.stringify(ordersArray));
        }
        
        function loadActiveOrders() {
            try {
                const saved = localStorage.getItem('kaprao_active_orders');
                if (saved) {
                    const ordersArray = JSON.parse(saved);
                    activeOrders = new Map(ordersArray);
                    
                    // Clean up completed orders older than 24h
                    const now = Date.now();
                    for (const [id, order] of activeOrders) {
                        if (order.status.code === 'completed' && (now - order.startTime) > 86400000) {
                            activeOrders.delete(id);
                        }
                    }
                }
            } catch (e) {
                activeOrders = new Map();
            }
        }
        
        function showOrderStatusModal(orderId) {
            const order = activeOrders.get(orderId);
            if (!order) return;
            
            // Create modal if not exists
            let modal = document.getElementById('order-status-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'order-status-modal';
                modal.className = 'fixed inset-0 z-[150] bg-black/40 backdrop-blur-sm flex items-center justify-center p-6 hidden';
                document.body.appendChild(modal);
            }
            
            updateOrderStatusModal(orderId);
            modal.classList.remove('hidden');
        }
        
        function updateOrderStatusModal(orderId) {
            const order = activeOrders.get(orderId);
            if (!order) return;
            
            const modal = document.getElementById('order-status-modal');
            const progress = calculateOrderProgress(order);
            const elapsed = Math.floor((Date.now() - order.startTime) / 60000);
            const remaining = Math.max(0, order.estimatedTime - elapsed);
            
            modal.innerHTML = `
                <div class="bg-white rounded-[2rem] p-6 w-full max-w-sm shadow-2xl relative overflow-hidden">
                    <button onclick="closeOrderStatusModal()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-all">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                    
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 ${order.status.bgColor} rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas ${order.status.icon} text-3xl ${order.status.color}"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">${order.status.label}</h2>
                        <p class="text-sm text-gray-500">Order ID: ${order.id}</p>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 transition-all duration-1000" style="width: ${progress}%"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs text-gray-500">
                            <span>: ${elapsed} </span>
                            <span>: ${remaining} </span>
                        </div>
                    </div>
                    
                    <!-- Status Timeline -->
                    <div class="space-y-3 mb-6">
                        ${Object.values(ORDER_STATUS).map(status => {
                            const isActive = order.status.code === status.code;
                            const isPast = Object.values(ORDER_STATUS).indexOf(status) <= Object.values(ORDER_STATUS).indexOf(order.status);
                            return `
                                <div class="flex items-center gap-3 ${isPast ? '' : 'opacity-40'}">
                                    <div class="w-8 h-8 rounded-full ${isActive ? status.bgColor : isPast ? 'bg-gray-100' : 'bg-gray-50'} flex items-center justify-center">
                                        <i class="fas ${status.icon} text-sm ${isActive ? status.color : isPast ? 'text-gray-600' : 'text-gray-400'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold ${isActive ? 'text-gray-800' : 'text-gray-600'}">${status.label}</p>
                                    </div>
                                    ${isActive ? '<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Items Summary -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-4">
                        <p class="text-xs text-gray-500 mb-2"></p>
                        <div class="space-y-1">
                            ${order.items.map(item => `
                                <div class="flex justify-between text-sm">
                                    <span class="font-medium text-gray-700">${item.name}</span>
                                    <span class="text-gray-500">x1</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button onclick="closeOrderStatusModal()" class="w-full btn-gradient text-white font-bold py-3 rounded-xl shadow-lg">
                        
                    </button>
                </div>
            `;
        }
        
        function calculateOrderProgress(order) {
            const statuses = Object.values(ORDER_STATUS);
            const currentIndex = statuses.findIndex(s => s.code === order.status.code);
            return ((currentIndex + 1) / statuses.length) * 100;
        }
        
        function closeOrderStatusModal() {
            const modal = document.getElementById('order-status-modal');
            if (modal) modal.classList.add('hidden');
        }
        
        function showActiveOrdersList() {
            const nonCompletedOrders = Array.from(activeOrders.values())
                .filter(o => o.status.code !== 'completed')
                .sort((a, b) => b.startTime - a.startTime);
            
            if (nonCompletedOrders.length === 0) {
                showToast('', 'info');
                return;
            }
            
            // Show the most recent active order
            showOrderStatusModal(nonCompletedOrders[0].id);
        }
        
        function updateActiveOrdersButton() {
            const container = document.getElementById('active-orders-container');
            const countEl = document.getElementById('active-order-count');
            
            const nonCompletedOrders = Array.from(activeOrders.values())
                .filter(o => o.status.code !== 'completed');
            
            if (nonCompletedOrders.length > 0) {
                container.classList.remove('hidden');
                countEl.textContent = `${nonCompletedOrders.length} `;
            } else {
                container.classList.add('hidden');
            }
        }

        // --- ACCESSIBILITY ENHANCEMENTS ---
        function initAccessibility() {
            // Add skip to main content link
            const skipLink = document.createElement('a');
            skipLink.href = '#main-content';
            skipLink.className = 'sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[9999] focus:bg-white focus:text-gray-800 focus:px-4 focus:py-2 focus:rounded-lg focus:shadow-lg';
            skipLink.textContent = '';
            document.body.insertBefore(skipLink, document.body.firstChild);
            
            // Add aria-live region for toast announcements
            const liveRegion = document.createElement('div');
            liveRegion.id = 'aria-live-region';
            liveRegion.setAttribute('aria-live', 'polite');
            liveRegion.setAttribute('aria-atomic', 'true');
            liveRegion.className = 'sr-only';
            document.body.appendChild(liveRegion);
            
            // Enhance focus management
            document.querySelectorAll('button, a, input, textarea, [tabindex]:not([tabindex="-1"])').forEach(el => {
                if (!el.hasAttribute('aria-label') && !el.textContent.trim()) {
                    const icon = el.querySelector('i');
                    if (icon) {
                        // Derive label from icon classes
                        const iconClass = Array.from(icon.classList).find(c => c.startsWith('fa-') && c !== 'fas' && c !== 'far' && c !== 'fab');
                        if (iconClass) {
                            el.setAttribute('aria-label', iconClass.replace('fa-', '').replace(/-/g, ' '));
                        }
                    }
                }
            });
            
            // Add role attributes to main sections
            const menuGrid = document.getElementById('menu-grid');
            if (menuGrid) {
                menuGrid.setAttribute('role', 'list');
                menuGrid.setAttribute('aria-label', '');
            }
            
            // Add keyboard shortcuts help
            document.addEventListener('keydown', (e) => {
                // ? key for help
                if (e.key === '?' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }
                
                // / key for search
                if (e.key === '/' && !document.body.classList.contains('scroll-locked')) {
                    e.preventDefault();
                    const searchContainer = document.getElementById('search-container');
                    if (searchContainer.classList.contains('hidden')) {
                        toggleSearch();
                    }
                    document.getElementById('search-input')?.focus();
                }
                
                // ESC to close any open modal
                if (e.key === 'Escape') {
                    const modals = ['modal-content', 'checkout-sheet', 'tickets-sheet', 'avatar-modal', 'points-history-modal'];
                    const anyOpen = modals.some(id => {
                        const el = document.getElementById(id);
                        return el && !el.classList.contains('hidden') && !el.classList.contains('translate-y-full');
                    });
                    if (anyOpen) {
                        e.preventDefault();
                        // Close the topmost modal
                        if (currentOpenModal) {
                            if (currentOpenModal === 'menu') closeModal();
                            else if (currentOpenModal === 'checkout') closeCheckout();
                            else if (currentOpenModal === 'tickets') closeMyTickets();
                            else if (currentOpenModal === 'avatar') closeAvatarModal();
                            else if (currentOpenModal === 'points-history') closePointsHistory();
                        }
                    }
                }
            });
        }
        
        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: '?', action: '' },
                { key: '/', action: '' },
                { key: 'ESC', action: '' },
                { key: '/', action: '/ ()' },
                { key: 'Enter', action: '/' }
            ];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[200] bg-black/50 backdrop-blur-sm flex items-center justify-center p-6';
            modal.innerHTML = `
                <div class="bg-white rounded-[2rem] p-6 w-full max-w-sm shadow-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800"> </h2>
                        <button onclick="this.closest('.fixed').remove()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${shortcuts.map(s => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                <span class="text-sm text-gray-600">${s.action}</span>
                                <kbd class="px-3 py-1 bg-white rounded-lg text-sm font-bold text-gray-800 border border-gray-200 shadow-sm">${s.key}</kbd>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Override showToast to announce to screen readers
        const originalShowToast = showToast;
        showToast = function(message, type = 'info') {
            // Call original
            originalShowToast(message, type);
            
            // Announce to screen readers
            const liveRegion = document.getElementById('aria-live-region');
            if (liveRegion) {
                liveRegion.textContent = message;
                setTimeout(() => { liveRegion.textContent = ''; }, 1000);
            }
        };

        function renderTrayOptions(type) {
            const container = document.getElementById('tray-options-container');
            let html = '';
            if (type === 1) {
                html += `<h4 class="font-bold text-gray-700 mb-2 text-sm">1. </h4><div class="grid grid-cols-2 gap-3 mb-4">`;
                const meats = [{n:'', p:0, i:''}, {n:'', p:0, i:''}, {n:'-', p:0, i:''}, {n:'', p:10, i:''}, {n:'', p:10, i:''}, {n:' (/)', p:20, i:''}];
                meats.forEach((m, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-meat" value="${m.n}" data-price="${m.p}" aria-label="${m.n}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-3 flex flex-col items-center justify-center gap-2 transition-all" tabindex="0" role="radio" aria-checked="${i===0?'true':'false'}"><div class="text-3xl filter group-hover:scale-110 transition-transform">${m.i}</div><div class="text-xs font-bold text-center leading-tight">${m.n}</div>${m.p>0?`<div class="text-[10px] text-white bg-orange-500 px-2 py-0.5 rounded-full font-bold">+${m.p}</div>`:''}<div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 text-yellow-400 transition-opacity"><i class="fas fa-check-circle"></i></div></div></label>`; });
                html += `</div><h4 class="font-bold text-gray-700 mb-2 text-sm">2. </h4><div class="grid grid-cols-3 gap-2 mb-4">`;
                const eggs = [{n:'', p:0, i:''}, {n:'', p:5, i:''}, {n:'', p:10, i:''}];
                eggs.forEach((e, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-egg" value="${e.n}" data-price="${e.p}" aria-label="${e.n}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-2 flex flex-col items-center justify-center gap-1 transition-all" tabindex="0" role="radio" aria-checked="${i===0?'true':'false'}"><div class="text-2xl">${e.i}</div><div class="text-xs font-bold text-center">${e.n}</div>${e.p>0?`<div class="text-[9px] text-orange-400 font-bold">+${e.p}</div>`:''}</div></label>`; });
                html += `</div>`;
            } else if (type === 2) {
                html += `<h4 class="font-bold text-gray-700 mb-2 text-sm">1.  ()</h4><div class="grid grid-cols-2 gap-3 mb-4">`;
                const meats = [{n:'', p:0, i:''}, {n:'', p:0, i:''}, {n:'-', p:0, i:''}, {n:'', p:20, i:''}, {n:'', p:20, i:''}, {n:'', p:30, i:''}, {n:' (+)', p:10, i:''}];
                meats.forEach((m, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-meat" value="${m.n}" data-price="${m.p}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-3 flex flex-col items-center justify-center gap-2 transition-all"><div class="text-3xl filter group-hover:scale-110 transition-transform">${m.i}</div><div class="text-xs font-bold text-center leading-tight">${m.n}</div>${m.p>0?`<div class="text-[10px] text-white bg-orange-500 px-2 py-0.5 rounded-full font-bold">+${m.p}</div>`:''}<div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 text-yellow-400 transition-opacity"><i class="fas fa-check-circle"></i></div></div></label>`; });
                html += `</div><h4 class="font-bold text-gray-700 mb-2 text-sm">2.  ( 2 )</h4><div class="grid grid-cols-3 gap-2 mb-4">`;
                const eggs = [{n:'', p:0, i:''}, {n:'', p:0, i:''}, {n:'', p:15, i:''}];
                eggs.forEach((e, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-egg" value="${e.n}" data-price="${e.p}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-2 flex flex-col items-center justify-center gap-1 transition-all"><div class="text-2xl">${e.i}</div><div class="text-xs font-bold text-center">${e.n}</div>${e.p>0?`<div class="text-[9px] text-orange-400 font-bold">+${e.p}</div>`:''}</div></label>`; });
                html += `</div>`;
            }
            html += `<div class="mt-6 p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100"><div class="flex items-center gap-2 mb-2"><span class="text-lg"></span><h4 class="text-sm font-bold text-indigo-400">:</h4></div><p id="tray-summary-text" class="text-sm text-gray-600 leading-relaxed pl-1"></p><div class="mt-3 pt-2 border-t border-indigo-500/30 flex items-center gap-2 text-[10px] text-indigo-400"><i class="fas fa-utensils"></i><span>!</span></div></div>`;
            container.innerHTML = html;
            setTimeout(() => document.querySelectorAll('.meat-option')[0]?.classList.add('selected'), 50);
        }

        function updateTraySummary() {
            if(!currentItem || !currentItem.isTray) return;
            const meat = document.querySelector('input[name="tray-meat"]:checked');
            const egg = document.querySelector('input[name="tray-egg"]:checked');
            const txt = document.getElementById('tray-summary-text');
            if(meat && egg && txt) { 
                txt.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="text-gray-500">1. :</span><span class="font-bold text-gray-800">${meat.value}</span></div><div class="flex justify-between items-center"><span class="text-gray-500">2. :</span><span class="font-bold text-gray-800">${egg.value}</span></div>`; 
            }
        }

        function switchCategory(cat) {
            if(activeCategory === cat) return;
            activeCategory = cat; 
            triggerHaptic();
            const grid = document.getElementById('menu-grid'); 
            const msg = document.getElementById('dessert-msg');
            grid.classList.add('page-out'); 
            if(!msg.classList.contains('hidden')) msg.classList.add('page-out');
            
            const categories = ['favorites', 'kaprao', 'tray', 'garlic', 'curry', 'noodle', 'soup', 'others', 'dessert', 'promotion'];
            categories.forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                let extraClass = '';
                if (c === 'promotion') extraClass = 'category-pill-promotion'; 
                else if (c === 'tray') extraClass = 'category-pill-tray'; 
                else if (c === 'favorites') extraClass = 'category-pill-favorites';
                
                if (c === cat) btn.className = `category-pill snap-start category-pill-active ${extraClass}`;
                else {
                    if (extraClass) extraClass += ' opacity-60';
                    btn.className = `category-pill snap-start category-pill-inactive ${extraClass}`;
                }
            });

            setTimeout(() => {
                const title = document.getElementById('section-title');
                msg.classList.add('hidden'); 
                msg.classList.remove('page-out'); 
                grid.classList.remove('page-out'); 
                renderSkeletonLoader();
                setTimeout(() => {
                    if (cat === 'promotion') { title.innerText = " & "; renderPromotions(); } 
                    else if (cat === 'dessert') { title.innerText = ""; msg.classList.remove('hidden'); renderMenu(); } 
                    else if (cat === 'soup') { title.innerText = "/"; renderMenu(); } 
                    else if (cat === 'tray') { title.innerText = ""; renderMenu(); } 
                    else if (cat === 'favorites') { title.innerText = " "; renderMenu(); }
                    else if (cat === 'curry') { title.innerText = ""; renderMenu(); }
                    else { title.innerText = ""; renderMenu(); }
                    document.getElementById('section-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    grid.classList.add('page-in'); 
                    setTimeout(() => grid.classList.remove('page-in'), 300);
                }, 50);
            }, 150);
        }
                
        let menuObserver = null;
        let lazyImageObserver = null;
        
        function initLazyLoading() {
            // Lazy load menu items with Intersection Observer
            const grid = document.getElementById('menu-grid');
            if (!grid) return;
            
            // Disconnect existing observer
            if (menuObserver) menuObserver.disconnect();
            
            menuObserver = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                        menuObserver.unobserve(entry.target);
                    }
                });
            }, {
                root: null,
                rootMargin: '50px',
                threshold: 0.1
            });
            
            // Observe all menu cards
            const cards = grid.querySelectorAll('.fast-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = `opacity 0.4s ease ${index * 0.03}s, transform 0.4s ease ${index * 0.03}s`;
                menuObserver.observe(card);
            });
        }
        
        function initImageLazyLoading() {
            // Lazy load images
            if (lazyImageObserver) lazyImageObserver.disconnect();
            
            lazyImageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                        }
                        img.classList.add('loaded');
                        lazyImageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '100px'
            });
            
            document.querySelectorAll('img[data-src]').forEach(img => {
                lazyImageObserver.observe(img);
            });
        }

        // --- VIRTUAL SCROLLING FOR LARGE LISTS ---
        let virtualScrollState = {
            itemHeight: 120,
            visibleCount: 10,
            startIndex: 0,
            endIndex: 10
        };

        function renderMenu() {
            const grid = document.getElementById('menu-grid'); 
            grid.innerHTML = '';
            let filteredItems = [];
            if (searchQuery.length > 0) {
                filteredItems = menuItems.filter(i => i.name.toLowerCase().includes(searchQuery));
                document.getElementById('section-title').innerText = `: "${searchQuery}" (${filteredItems.length})`;
            } 
            else if (activeCategory === 'favorites') {
                filteredItems = menuItems.filter(i => favoriteItems.has(i.id));
                if (filteredItems.length === 0) { 
                    grid.innerHTML = `<div class="col-span-2 text-center text-gray-400 mt-10"><div class="text-4xl mb-2"></div><p> </p></div>`; 
                    return; 
                }
            } 
            else { filteredItems = menuItems.filter(i => i.category === activeCategory); }
            
            if(filteredItems.length === 0 && searchQuery.length > 0) { 
                grid.innerHTML = `<div class="col-span-2 text-center text-gray-400 mt-10"> </div>`; 
                return; 
            }

            filteredItems.forEach((item, index) => {
                const isDessert = item.category === 'dessert'; 
                const isSoldOut = item.soldOut || false; 
                const isTrayWait = (item.id === 201 || item.id === 202); 
                const el = document.createElement('div'); 
                el.style.animationDelay = `${index * 0.05}s`;
                const grayscaleClass = (isSoldOut || isTrayWait) ? 'grayscale opacity-70' : '';
                const pointerClass = (isDessert || isSoldOut || isTrayWait) ? '' : 'cursor-pointer';
                el.className = `fast-card p-4 flex flex-col stagger-item group ${pointerClass} ${grayscaleClass} relative overflow-hidden`;
                
                el.onclick = () => {
                    if (isTrayWait) { showToast(' ', 'warning'); triggerHaptic('medium'); return; }
                    if (isSoldOut) { showToast(' ', 'error'); triggerHaptic('heavy'); }
                    else if (isDessert) { showToast('  ', 'info'); triggerHaptic(); }
                    else openModal(item);
                };
                
                let statusBadge = '';
                if (isTrayWait) statusBadge = `<div class="absolute top-2 right-2 bg-indigo-500/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20"></div>`;
                else if (isSoldOut) statusBadge = `<div class="absolute top-2 right-2 bg-red-500/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20"></div>`;
                else if (isDessert) statusBadge = `<div class="absolute top-2 right-2 bg-gray-600/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20"> </div>`;
                
                const isFav = favoriteItems.has(item.id);
                const heartIcon = `<button onclick="toggleFavorite(event, ${item.id})" class="absolute top-2 right-2 z-30 heart-btn w-8 h-8 flex items-center justify-center rounded-full bg-white/80 backdrop-blur-sm shadow-sm hover:scale-110 active:scale-90 ${isFav ? 'text-red-500' : 'text-gray-300'}"><i class="fas fa-heart text-lg"></i></button>`;

                const priceDisplay = (isDessert || isSoldOut || isTrayWait) ? `<span class="font-bold text-gray-400 text-base line-through decoration-transparent">${item.price} </span>` : `<span class="font-bold text-indigo-500 text-xl">${item.price} <span class="text-sm text-gray-400"></span></span>`;
                const newBadge = item.isNew && !isSoldOut ? `<div class="absolute top-2 left-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[8px] font-black px-2 py-1 rounded-full shadow-lg z-20 animate-pulse border border-white/30">NEW</div>` : '';
                const actionButton = (!isDessert && !isSoldOut && !isTrayWait) ? `<button onclick="event.stopPropagation(); const item = menuItems.find(i => i.id === ${item.id}); if(item) openModal(item);" class="mt-3 w-full btn-gradient text-white font-bold py-2.5 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 text-sm group-hover:scale-105"><i class="fas fa-plus text-xs"></i><span></span></button>` : `<div class="mt-3 w-full bg-gray-100 text-gray-400 font-medium py-2.5 rounded-xl text-center text-sm"></div>`;
                
                el.innerHTML = `${newBadge}${isTrayWait || isSoldOut || isDessert ? statusBadge : heartIcon}<div class="flex flex-col items-center mb-3 ${(isDessert||isSoldOut||isTrayWait)?'opacity-60 grayscale-[50%]':''}"><div class="relative w-20 h-20 rounded-2xl bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center text-4xl mb-3 shadow-sm border border-gray-100 group-hover:scale-110 transition-transform"><img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover rounded-2xl" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<span class=\\'text-4xl\\'>${item.icon}</span>';"></div><h3 class="font-bold text-gray-700 text-sm text-center leading-tight group-hover:text-indigo-500 transition-colors mb-2 line-clamp-2 min-h-[2.5rem]" title="${item.name}">${item.name}</h3><div class="flex flex-wrap items-center justify-center gap-1.5 mb-2"><span class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">${item.kcal} kcal</span>${item.reqMeat ? '<span class="text-[9px] text-yellow-600 border border-yellow-200 bg-yellow-50 px-1.5 py-0.5 rounded-full"></span>' : ''}</div></div><div class="mt-auto pt-3 border-t border-gray-100"><div class="flex items-center justify-between mb-2"><span class="text-xs text-gray-400"></span>${priceDisplay}</div>${actionButton}</div>`;
                grid.appendChild(el);
            });
            
            // Initialize lazy loading for new menu items
            requestAnimationFrame(() => {
                initLazyLoading();
            });
        }
        
        function renderPromotions() {
            const grid = document.getElementById('menu-grid'); 
            grid.innerHTML = '';
            promotions.filter(p => !p.isHidden).forEach((promo, index) => {
                const el = document.createElement('div'); 
                el.style.animationDelay = `${index * 0.1}s`;
                el.className = "fast-card p-4 flex flex-col cursor-pointer shadow-sm btn-bounce stagger-item col-span-2";
                el.onclick = () => {
                    const input = document.getElementById('discount-code'); 
                    if(input) { input.value = promo.code; applyDiscount(); }
                    if(navigator.clipboard) navigator.clipboard.writeText(promo.code);
                    showToast(` ${promo.code} !`, 'success'); 
                    triggerHaptic();
                };
                el.innerHTML = `<div class="flex items-center gap-4"><div class="w-16 h-16 ${promo.color} rounded-2xl flex items-center justify-center text-3xl shadow-lg">${promo.icon}</div><div class="flex-1"><h3 class="font-bold text-gray-800 text-base mb-1">${promo.title}</h3><p class="text-xs text-gray-500 mb-2">${promo.desc}</p><div class="bg-gray-100 inline-block px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 tracking-wider border border-gray-200 shadow-sm">${promo.code}</div></div><div class="text-gray-400 text-xs"></div></div>`;
                grid.appendChild(el);
            });
            const wheelDiv = document.createElement('div');
            wheelDiv.className = "w-full fast-card p-6 mt-4 mb-6 shadow-sm flex flex-col items-center stagger-item col-span-2"; 
            wheelDiv.style.animationDelay = "0.3s";
            wheelDiv.innerHTML = `<h3 class="font-bold text-gray-800 text-lg mb-1">! </h3><p class="text-xs text-gray-500 mb-4"> 40   (3 /)</p><div id="wheel-container"><div class="wheel-pointer"></div><canvas id="wheel-canvas" width="300" height="300"></canvas><div class="wheel-center text-2xl"></div></div><button onclick="spinWheel()" class="btn-bounce btn-gradient-purple text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all hover:scale-105">!</button>`;
            grid.appendChild(wheelDiv); 
            setTimeout(drawWheel, 100);
        }

        function updateModalPrice() {
            if (!currentItem) return;
            const options = { meatPrice: 0, eggPrice: 0, addons: [] };
            if(currentItem.isTray) {
                const meatOpt = document.querySelector('input[name="tray-meat"]:checked');
                const eggOpt = document.querySelector('input[name="tray-egg"]:checked');
                if(meatOpt) options.meatPrice = parseInt(meatOpt.getAttribute('data-price') || 0);
                if(eggOpt) options.eggPrice = parseInt(eggOpt.getAttribute('data-price') || 0);
                updateTraySummary();
            }
            addonIds.forEach(id => { if(document.getElementById(`modal-opt-${id}`).checked) options.addons.push(id); });
            const unitPrice = calculateItemUnitPrice(currentItem, options);
            const total = unitPrice * modalQty;
            let totalKcal = (currentItem.kcal || 0) * modalQty; 
            options.addons.forEach(id => totalKcal += (addonCalories[id] || 0) * modalQty);
            const priceEl = document.getElementById('modal-price'); 
            priceEl.innerText = total;
            priceEl.classList.remove('price-pop'); 
            void priceEl.offsetWidth; 
            priceEl.classList.add('price-pop');
            document.getElementById('modal-kcal').innerText = totalKcal + ' kcal';
        }

        addonIds.forEach(id => { const el = document.getElementById(`modal-opt-${id}`); if (el) el.addEventListener('change', updateModalPrice); });

        function openModal(item) {
            pushModalState('menu'); 
            triggerHaptic();
            currentItem = item; 
            modalQty = 1; 
            document.getElementById('modal-qty').innerText = modalQty; 
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-icon').innerText = item.icon;
            const modalImage = document.getElementById('modal-image');
            const modalIcon = document.getElementById('modal-icon');
            if (item.image) {
                modalImage.src = item.image;
                modalImage.alt = item.name;
                modalImage.classList.remove('hidden');
                modalIcon.classList.add('hidden');
            } else {
                modalImage.classList.add('hidden');
                modalIcon.classList.remove('hidden');
            }
            document.getElementById('modal-note').value = '';
            document.querySelectorAll('input[name="modal-meat"]').forEach(el => el.checked = false); 
            addonIds.forEach(id => document.getElementById(`modal-opt-${id}`).checked = false);
            const meatSec = document.getElementById('modal-meat-section'); 
            const traySec = document.getElementById('tray-options-container'); 
            const addonsSec = document.getElementById('addons-section');
            document.getElementById('meat-options-container').classList.remove('animate-shake', 'border', 'border-red-500', 'rounded-xl');
            if(item.isTray) { 
                meatSec.classList.add('hidden'); 
                traySec.classList.remove('hidden'); 
                addonsSec.classList.add('hidden'); 
                renderTrayOptions(item.trayType); 
                updateTraySummary(); 
            } else { 
                traySec.classList.add('hidden'); 
                addonsSec.classList.remove('hidden'); 
                if(item.reqMeat) { meatSec.classList.remove('hidden'); createMeatOptions(); } 
                else meatSec.classList.add('hidden'); 
            }
            updateModalPrice();
            const overlay = document.getElementById('modal-overlay'); 
            const content = document.getElementById('modal-content');
            content.style.transform = ''; 
            overlay.classList.remove('hidden'); 
            setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('translate-y-full'); }, 10);
        }

        function closeModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'menu') { history.back(); return; }
            const overlay = document.getElementById('modal-overlay'); 
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0'); 
            content.classList.add('translate-y-full');
            setTimeout(() => { overlay.classList.add('hidden'); currentItem = null; content.style.transform = ''; }, 300);
            currentOpenModal = null; 
            unlockScroll();
        }

        function adjustQty(n) { 
            modalQty += n; 
            if(modalQty < 1) modalQty = 1; 
            document.getElementById('modal-qty').innerText = modalQty; 
            triggerHaptic(); 
            updateModalPrice(); 
        }

        function animateFlyToCart(sourceEl, emoji = '') {
            try {
                const target = document.getElementById('mini-count') || document.getElementById('mini-cart-bar'); 
                if (!sourceEl || !target) return Promise.resolve();
                const srcRect = sourceEl.getBoundingClientRect(); 
                const tgtRect = target.getBoundingClientRect();
                const fly = document.createElement('div'); 
                fly.className = 'fly-item'; 
                fly.innerText = emoji; 
                document.body.appendChild(fly);
                const startX = srcRect.left + srcRect.width / 2; 
                const startY = srcRect.top + srcRect.height / 2; 
                const endX = tgtRect.left + tgtRect.width / 2; 
                const endY = tgtRect.top + tgtRect.height / 2;
                const midX = (startX + endX) / 2 + (Math.random() * 80 - 40); 
                const midY = Math.min(startY, endY) - 140;
                const keyframes = [
                    { transform: `translate(0px, 0px) scale(1)`, opacity: 1 }, 
                    { transform: `translate(${midX - startX}px, ${midY - startY}px) scale(0.95) rotate(${(Math.random()*20)-10}deg)`, opacity: 1, offset: 0.55 }, 
                    { transform: `translate(${endX - startX}px, ${endY - startY}px) scale(0.6) rotate(20deg)`, opacity: 0.0 }
                ];
                const anim = fly.animate(keyframes, { duration: 700 + Math.random()*200, easing: 'cubic-bezier(0.2,0.8,0.2,1)' });
                return new Promise(resolve => { anim.onfinish = () => { fly.remove(); resolve(); }; });
            } catch (e) { return Promise.resolve(); }
        }

        function setupMicroInteractions() {
            const buttons = Array.from(document.querySelectorAll('.btn-bounce'));
            buttons.forEach(btn => {
                btn.classList.add('btn-press'); 
                let pointerDown = false;
                const onDown = () => { if (btn.disabled) return; pointerDown = true; btn.classList.remove('rebound'); btn.classList.add('squash'); };
                const onUp = () => { if (!pointerDown) return; pointerDown = false; btn.classList.remove('squash'); btn.classList.add('rebound'); btn.addEventListener('animationend', function _end() { btn.classList.remove('rebound'); btn.removeEventListener('animationend', _end); }); };
                btn.addEventListener('pointerdown', onDown, { passive: true }); 
                ['pointerup','pointercancel','pointerleave'].forEach(ev => btn.addEventListener(ev, onUp));
            });
        }

        function addToCart() {
            if (!currentItem) return;
            let meat = null; 
            let noteExtra = "";
            if (currentItem.isTray) { 
                const meatOpt = document.querySelector('input[name="tray-meat"]:checked'); 
                const eggOpt = document.querySelector('input[name="tray-egg"]:checked'); 
                meat = meatOpt ? meatOpt.value : ''; 
                noteExtra = `[${eggOpt ? eggOpt.value : ''}]`; 
            } else if (currentItem.reqMeat) { 
                const r = document.querySelector('input[name="modal-meat"]:checked'); 
                if(!r) { 
                    const meatContainer = document.getElementById('meat-options-container'); 
                    meatContainer.classList.remove('animate-shake'); 
                    void meatContainer.offsetWidth; 
                    meatContainer.classList.add('animate-shake', 'border', 'border-red-500', 'rounded-xl'); 
                    triggerHaptic('heavy'); 
                    showToast('', 'warning'); 
                    return; 
                } 
                meat = r.value; 
            }
            const addonNames = {special:'', kaikhon:'', kaidao:'', kaijiao:'', kaitom:'', kaiyiewma:''};
            const selectedAddonIds = []; 
            const selectedAddonNames = [];
            addonIds.forEach(id => { 
                if(document.getElementById(`modal-opt-${id}`).checked) { 
                    selectedAddonIds.push(id); 
                    selectedAddonNames.push(addonNames[id]); 
                } 
            });
            const options = { meatPrice: 0, eggPrice: 0, addons: selectedAddonIds };
            if(currentItem.isTray) { 
                const meatOpt = document.querySelector('input[name="tray-meat"]:checked'); 
                const eggOpt = document.querySelector('input[name="tray-egg"]:checked'); 
                if(meatOpt) options.meatPrice = parseInt(meatOpt.getAttribute('data-price') || 0); 
                if(eggOpt) options.eggPrice = parseInt(eggOpt.getAttribute('data-price') || 0); 
            }
            const unitPrice = calculateItemUnitPrice(currentItem, options);
            let noteSafe = escapeHtml(document.getElementById('modal-note').value.trim()); 
            if(noteExtra) noteSafe = (noteSafe ? noteSafe + " " : "") + noteExtra;
            for(let i=0; i<modalQty; i++){
                cart.push({
                    id: Date.now() + i,
                    name: currentItem.name,
                    price: unitPrice,
                    meat: meat,
                    addons: selectedAddonNames,
                    note: noteSafe,
                    image: currentItem.image
                });
            }
            triggerHaptic();
            try { 
                const modalIconEl = document.getElementById('modal-icon'); 
                const srcEl = modalIconEl ? modalIconEl.parentElement : null; 
                animateFlyToCart(srcEl, currentItem.icon || (modalIconEl ? modalIconEl.innerText : '')); 
            } catch (e) {}
            const cartBtn = document.getElementById('mini-cart-bar'); 
            if(cartBtn) { 
                cartBtn.classList.remove('hidden'); 
                cartBtn.style.animation = 'bounce 0.5s ease-out'; 
                setTimeout(() => cartBtn.style.animation = '', 500); 
            }
            closeModal(); 
            updateMiniCart(); 
            saveToLS(); 
            showToast(` ${modalQty} !`, 'success');
        }

        // --- CORRECTED LOTTERY SYSTEM ---
        let currentOrderId = "";
        
        function generateOrderId() { 
            const now = Date.now().toString(); 
            const timePart = now.slice(-2); 
            const myPendingNumbers = lottoHistory.filter(t => t.status === 'pending').map(t => t.number); 
            let randomPart; 
            let isDuplicate = true; 
            let attempts = 0; 
            while (isDuplicate && attempts < 500) { 
                randomPart = Math.floor(Math.random() * 100).toString().padStart(2, '0'); 
                if (!myPendingNumbers.includes(randomPart) || myPendingNumbers.length >= 100) isDuplicate = false; 
                attempts++; 
            } 
            currentOrderId = `KP-${timePart}${randomPart}`; 
            return currentOrderId; 
        }
        
        function saveTicketToHistory(orderId, totalPrice) {
            const today = new Date(); 
            const drawDateObj = getThaiLotteryDrawDate(today);
            const todayStr = getStandardDate(today); 
            const drawDateStr = getStandardDate(drawDateObj); 
            const name = document.getElementById('user-name').value || '';
            
            const ticket = { 
                id: orderId, 
                number: orderId.slice(-2), 
                date: todayStr, 
                drawDate: drawDateStr, 
                drawDateTimestamp: drawDateObj.getTime(), 
                timestamp: Date.now(), 
                price: totalPrice, 
                status: 'pending', 
                checkedDate: null, 
                items: JSON.parse(JSON.stringify(cart)), 
                customerName: name 
            };
            
            lottoHistory.unshift(ticket); 
            if (lottoHistory.length > 20) lottoHistory = lottoHistory.slice(0, 20); 
            localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory)); 
            updateTicketBadge();
        }
        
        let OFFICIAL_RESULTS = {};
        
        async function fetchLottoResults() { 
            try { 
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getLotto'); 
                if (response.ok) { 
                    const data = await response.json(); 
                    OFFICIAL_RESULTS = data; 
                    autoCheckLottery(); 
                } 
            } catch (error) { console.error("Lotto Error:", error); } 
        }
        
        function getWinningNumberForDate(dateStr) { 
            return OFFICIAL_RESULTS[dateStr] || "NotSet"; 
        }
        
        function autoCheckLottery() {
            if (!lottoHistory || !Array.isArray(lottoHistory) || lottoHistory.length === 0) return;
            
            let updated = false; 
            lottoHistory.forEach(t => { 
                const drawDate = new Date(t.drawDateTimestamp);
                const winningNum = getWinningNumberForDate(t.drawDate);
                
                //  ()
                if (!isLotteryDrawn(drawDate)) {
                    if (t.status !== 'pending') { 
                        t.status = 'pending'; 
                        updated = true; 
                    }
                    return;
                }
                
                //  
                if (winningNum === "NotSet") {
                    //  server
                    if (t.status !== 'pending') { 
                        t.status = 'pending'; 
                        updated = true; 
                    }
                } else {
                    if (t.number === winningNum) { 
                        if (t.status !== 'won') { 
                            t.status = 'won'; 
                            updated = true; 
                            confetti(); 
                            if (Notification.permission === "granted") {
                                new Notification("! ", { 
                                    body: ` ${t.drawDate}: Order ${t.id} !`, 
                                    icon: 'https://cdn-icons-png.flaticon.com/512/3170/3170733.png' 
                                }); 
                            }
                        } 
                    } else { 
                        if (t.status !== 'lost') { 
                            t.status = 'lost'; 
                            updated = true; 
                        } 
                    } 
                    t.checkedDate = getStandardDate(new Date()); 
                }
            });
            
            if (updated) { 
                localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory)); 
                updateTicketBadge(); 
            }
        }
        
        function updateTicketBadge() { 
            if (!lottoHistory) return; 
            const pending = lottoHistory.filter(t => {
                const drawDate = new Date(t.drawDateTimestamp);
                return !isLotteryDrawn(drawDate) && t.status === 'pending';
            }).length; 
            const dot = document.getElementById('unread-ticket-dot'); 
            if(pending > 0) dot.classList.remove('hidden'); 
            else dot.classList.add('hidden'); 
        }

        function openMyTickets() {
            try {
                pushModalState('tickets'); 
                triggerHaptic();
                updateTicketsLotteryStatus();
                
                if (!lottoHistory || !Array.isArray(lottoHistory)) { 
                    lottoHistory = []; 
                    try { lottoHistory = JSON.parse(localStorage.getItem(KEYS.HISTORY)) || []; } catch(e) {}
                }
                
                const list = document.getElementById('tickets-list'); 
                list.innerHTML = '';
                
                if(lottoHistory.length === 0) { 
                    list.innerHTML = `<div class="text-center text-gray-400 mt-10"><div class="text-4xl mb-2 opacity-30"></div><p class="text-sm"></p></div>`; 
                } else {
                    lottoHistory.forEach((t, index) => {
                        const status = getLotteryStatus(t);
                        const isExpired = status.status === 'lost';
                        
                        const item = document.createElement('div'); 
                        item.className = `ticket-stub p-4 rounded-lg shadow-sm border border-gray-200 mb-3 flex justify-between items-center relative overflow-hidden cursor-pointer active:scale-95 transition-transform btn-bounce ${status.class === 'waiting' ? 'border-l-4 border-l-indigo-500 bg-indigo-50/30' : status.class === 'drawn' ? 'border-l-4 border-l-yellow-500 bg-yellow-50' : 'border-l-4 border-l-gray-400 bg-gray-100 opacity-70'}`;
                        item.onclick = function() { reprintReceipt(index); };
                        
                        item.innerHTML = `
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] text-gray-500">Order ID: ${t.id}</span>
                                </div>
                                <div class="flex items-baseline gap-2 mt-1">
                                    <span class="text-xs text-gray-400">:</span>
                                    <span class="text-2xl font-black ${status.status === 'won' ? 'text-yellow-500' : 'text-indigo-500'} tracking-widest">${t.number}</span>
                                </div>
                                <div class="text-[10px] text-gray-500 mt-1">
                                    : ${t.date}  : ${t.drawDate}
                                </div>
                                <div class="text-[10px] text-indigo-500 font-bold mt-2">
                                    <i class="fas fa-print"></i> 
                                </div>
                            </div>
                            <div class="text-right flex flex-col items-end">
                                <div class="lottery-status ${status.class} mb-2">
                                    ${status.status === 'won' ? '<i class="fas fa-trophy"></i>' : status.status === 'lost' ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-clock"></i>'}
                                    <span>${status.text}</span>
                                </div>
                                ${status.status === 'won' ? '<button class="text-[10px] bg-yellow-500 text-white font-bold px-2 py-1 rounded shadow-sm animate-pulse"></button>' : ''}
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
                
                const overlay = document.getElementById('tickets-modal-overlay'); 
                const sheet = document.getElementById('tickets-sheet'); 
                sheet.style.transform = ''; 
                overlay.classList.remove('hidden'); 
                setTimeout(() => { overlay.classList.remove('opacity-0'); sheet.classList.remove('translate-y-full'); }, 10);
            } catch(e) { 
                console.error(e); 
                showToast("", 'error'); 
            }
        }
        
        function closeMyTickets(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'tickets') { history.back(); return; }
            const overlay = document.getElementById('tickets-modal-overlay'); 
            const sheet = document.getElementById('tickets-sheet'); 
            overlay.classList.add('opacity-0'); 
            sheet.classList.add('translate-y-full'); 
            setTimeout(() => { overlay.classList.add('hidden'); sheet.style.transform = ''; }, 300); 
            currentOpenModal = null; 
            unlockScroll();
        }

        function openCheckout() {
            try {
                pushModalState('checkout'); 
                triggerHaptic(); 
                renderCheckoutList();
                if(document.getElementById('discount-code').value.trim() !== '' && discountValue > 0) applyDiscount();
                
                const bannerContainer = document.getElementById('order-id-banner');
                if(cart.length > 0) {
                    const lottoId = generateOrderId(); 
                    const nextDraw = getThaiLotteryDrawDate();
                    bannerContainer.classList.remove('hidden');
                    bannerContainer.innerHTML = `
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 p-4 rounded-xl mb-3 shadow-sm relative overflow-hidden stagger-item">
                            <div class="absolute -right-4 -top-4 bg-indigo-100 opacity-50 w-20 h-20 rounded-full"></div>
                            <div class="flex flex-col z-10">
                                <span class="text-[10px] text-gray-500 uppercase tracking-wider">Order ID </span>
                                <div class="flex items-baseline gap-1">
                                    <span class="font-bold text-xl text-gray-800">${lottoId.slice(0, -2)}</span>
                                    <span class="font-black text-3xl text-yellow-500 drop-shadow-sm">${lottoId.slice(-2)}</span>
                                </div>
                                <div class="mt-2 text-xs text-indigo-600">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                     ${formatThaiDate(nextDraw)}
                                </div>
                            </div>
                            <div class="absolute top-4 right-4 z-10 text-3xl"></div>
                        </div>
                    `;
                } else bannerContainer.classList.add('hidden');
                
                resetPointsDiscount();
                const overlay = document.getElementById('checkout-overlay'); 
                const sheet = document.getElementById('checkout-sheet'); 
                sheet.style.transform = ''; 
                overlay.classList.remove('hidden'); 
                setTimeout(() => { overlay.classList.remove('opacity-0'); sheet.classList.remove('translate-y-full'); }, 10);
            } catch (error) { console.error('openCheckout error:', error); }
        }
        
        function closeCheckout(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'checkout') { history.back(); return; }
            const overlay = document.getElementById('checkout-overlay'); 
            const sheet = document.getElementById('checkout-sheet'); 
            overlay.classList.add('opacity-0'); 
            sheet.classList.add('translate-y-full'); 
            setTimeout(() => { overlay.classList.add('hidden'); sheet.style.transform = ''; }, 300); 
            currentOpenModal = null; 
            unlockScroll();
        }

        function updateMiniCart() {
            const miniBar = document.getElementById('mini-cart-bar');
            if(cart.length > 0) { 
                miniBar.classList.remove('hidden'); 
                let total = cart.reduce((sum, i) => sum + i.price, 0); 
                document.getElementById('mini-count').innerText = cart.length; 
                document.getElementById('mini-total').innerText = total + " "; 
            } else { 
                miniBar.classList.add('hidden'); 
                document.getElementById('mini-count').innerText = '0'; 
                document.getElementById('mini-total').innerText = '0 '; 
            }
        }
        
        function removeFromCart(id) {
            const index = cart.findIndex(item => item.id === id);
            if (index !== -1) {
                cart.splice(index, 1); 
                saveToLS();
                if(cart.length === 0) { removeDiscount(); resetPointsDiscount(); } 
                else if(discountValue > 0) applyDiscount();
                renderCheckoutList(); 
                updateMiniCart(); 
                if(cart.length === 0) closeCheckout(); 
                showToast('', 'success'); 
                triggerHaptic();
            }
        }
        
        function renderCheckoutList() {
            const container = document.getElementById('cart-list-container'); 
            container.innerHTML = '';
            cart.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-start stagger-item";
                let detail = item.meat ? `<span class="text-orange-600 text-xs bg-orange-100 px-1 rounded">${item.meat}</span> ` : '';
                if(item.addons.length) detail += `<span class="text-gray-500 text-xs">+${item.addons.join(',')}</span>`;
                el.innerHTML = `
    <div class="flex items-start gap-3">
        <img src="${item.image || ''}" alt="${item.name}"
             class="w-16 h-16 rounded-xl object-cover flex-shrink-0"
             onerror="this.style.display='none'">
        <div>
            <h4 class="cart-item-title font-bold text-gray-800">${item.name}</h4>
            <div class="cart-item-details mt-1">${detail}</div>
            ${item.note ? `<div class="text-[10px] text-gray-400 mt-1">Note: ${item.note}</div>` : ''}
        </div>
    </div>
    <div class="flex flex-col items-end gap-2">
        <span class="font-bold text-gray-800">${item.price}.-</span>
        <button onclick="removeFromCart(${item.id})" class="text-xs text-red-500 bg-red-50 w-9 h-9 rounded flex items-center justify-center border border-red-100 btn-bounce">
            <i class="fas fa-trash"></i>
        </button>
    </div>`;
                container.appendChild(el);
            });
            updateTotalSummary();
        }
        
        function updateTotalSummary() {
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0); 
            let discountFromCode = 0; 
            let discountFromPoints = 0; 
            const code = document.getElementById('discount-code').value.trim().toUpperCase(); 
            const promo = promotions.find(p => p.code === code);
            if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value; 
            if (pointsRedeemed > 0) discountFromPoints = Math.floor(pointsRedeemed / 100) * 10;
            const netTotal = Math.max(0, subtotal - discountFromCode - discountFromPoints);
            document.getElementById('summary-subtotal').textContent = `${subtotal}.-`; 
            document.getElementById('summary-grand-total').textContent = `${netTotal}.-`;
            const discountSummary = document.getElementById('discount-summary'); 
            const pointsSummary = document.getElementById('points-summary');
            if (discountFromCode > 0) { 
                discountSummary.classList.remove('hidden'); 
                discountSummary.querySelector('span:last-child').textContent = `-${discountFromCode}.-`; 
            } else discountSummary.classList.add('hidden');
            if (discountFromPoints > 0) { 
                pointsSummary.classList.remove('hidden'); 
                pointsSummary.querySelector('span:last-child').textContent = `-${discountFromPoints}.-`; 
            } else pointsSummary.classList.add('hidden');
            updateCheckoutPointsInfo();
        }
        
        function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim().toUpperCase(); 
            let total = cart.reduce((sum, i) => sum + i.price, 0); 
            const msg = document.getElementById('discount-msg'); 
            const btn = document.getElementById('btn-apply-code'); 
            discountValue = 0;
            if (code === '') { 
                msg.innerText = ''; 
                btn.innerHTML = ''; 
                btn.className = 'btn-bounce bg-gray-800 text-white font-bold px-4 rounded-xl text-xs shadow-lg hover:bg-gray-700 transition-all'; 
                btn.onclick = applyDiscount; 
                updateTotalSummary(); 
                return; 
            }
            const promo = promotions.find(p => p.code === code);
            if (promo && total >= promo.minOrder) { 
                discountValue = promo.value; 
                msg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i>  ${promo.value} </span>`; 
                btn.innerHTML = '<i class="fas fa-times"></i> '; 
                btn.className = 'btn-bounce bg-red-500 hover:bg-red-600 text-white font-bold px-4 rounded-xl text-xs shadow-lg transition-all'; 
                btn.onclick = removeDiscount; 
            } else { 
                msg.innerHTML = `<span class="text-red-500">${promo ? ' '+promo.minOrder : ''}</span>`; 
                btn.innerHTML = ''; 
                btn.className = 'btn-bounce bg-gray-500 hover:bg-gray-600 text-white font-bold px-4 rounded-xl text-xs shadow-lg transition-all'; 
                btn.onclick = applyDiscount; 
            }
            updateTotalSummary();
        }
        
        function removeDiscount() { 
            document.getElementById('discount-code').value = ''; 
            document.getElementById('discount-msg').innerText = ''; 
            discountValue = 0; 
            applyDiscount(); 
        }

        function openReceiptResult(imgData) { 
            const modal = document.getElementById('receipt-result-modal'); 
            const img = document.getElementById('receipt-result-img'); 
            img.src = imgData; 
            modal.classList.remove('hidden'); 
        }
        
        function downloadReceiptImage() { 
            const img = document.getElementById('receipt-result-img'); 
            const link = document.createElement('a'); 
            link.href = img.src; 
            link.download = 'kaprao52-receipt-' + Date.now() + '.png'; 
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            showToast('...', 'info'); 
        }

        function reprintReceipt(ticketIndex) {
            triggerHaptic();
            if (typeof html2canvas === 'undefined') { 
                showToast("  2 ", "error"); 
                return; 
            }
            if (!lottoHistory || !lottoHistory[ticketIndex]) { 
                showToast(" ", 'error'); 
                return; 
            }
            
            const ticket = lottoHistory[ticketIndex];
            showGlobalLoader("...");
            
            const name = ticket.customerName || ''; 
            const subtotal = ticket.items ? ticket.items.reduce((sum, i) => sum + i.price, 0) : ticket.price; 
            const netTotal = ticket.price; 
            const discount = subtotal - netTotal; 
            const tDate = new Date(ticket.timestamp); 
            const dateStr = `${getStandardDate(tDate)} ${formatTime(tDate)}`;
            
            document.querySelector('.receipt-id').innerText = ticket.id; 
            document.querySelector('.receipt-date').innerText = dateStr; 
            document.querySelector('.receipt-name').innerText = escapeHtml(name); 
            document.querySelector('.receipt-subtotal').innerText = subtotal + '.-'; 
            document.querySelector('.receipt-discount').innerText = '-' + discount + '.-'; 
            document.querySelector('.receipt-total').innerText = netTotal + '.-';
            
            const receiptAvatar = document.getElementById('receipt-avatar-img'); 
            receiptAvatar.crossOrigin = "Anonymous"; 
            receiptAvatar.src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            
            const itemsContainer = document.querySelector('.receipt-items'); 
            itemsContainer.innerHTML = '';
            if (ticket.items) { 
                ticket.items.forEach((i, index) => { 
                    let detail = `${i.name}`; 
                    if(i.meat) detail += ` (${i.meat})`; 
                    if(i.addons.length) detail += ` +${i.addons.join(',')}`; 
                    const row = document.createElement('div'); 
                    row.className = "flex justify-between text-xs"; 
                    row.innerHTML = `<div class="flex gap-1 text-gray-400"><span class="w-4">${index+1}.</span><span>${detail}</span></div><span class="font-bold text-gray-700">${i.price}.-</span>`; 
                    itemsContainer.appendChild(row); 
                }); 
            }
            
            const div = document.getElementById('receipt-capture'); 
            div.style.visibility = 'visible'; 
            div.style.zIndex = '-100';
            
            setTimeout(() => { 
                html2canvas(div, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false }).then(canvas => { 
                    div.style.visibility = 'hidden'; 
                    hideGlobalLoader(); 
                    openReceiptResult(canvas.toDataURL('image/png')); 
                    showToast('! ', 'success'); 
                }).catch((e) => { 
                    div.style.visibility = 'hidden'; 
                    console.error(e); 
                    hideGlobalLoader(); 
                    showToast('', 'error'); 
                }); 
            }, 800);
        }

        async function submitOrderToLine() {
            if (isSyncing) { showToast("  ...", 'info'); return; }
            if (isSubmitting) return;
            
            const name = document.getElementById('user-name').value.trim(); 
            if (!name) return showToast('', 'warning');
            
            isSubmitting = true;
            const btn = document.getElementById('btn-submit-order'); 
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ...'; 
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                showGlobalLoader("...");
                
                let subtotal = cart.reduce((sum, i) => sum + i.price, 0); 
                let discountFromCode = 0;
                const code = document.getElementById('discount-code').value.trim().toUpperCase(); 
                const promo = promotions.find(p => p.code === code); 
                if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value;
                
                let discountFromPoints = 0; 
                if (pointsRedeemed > 0) discountFromPoints = Math.floor(pointsRedeemed / 100) * 10;
                
                const netTotal = Math.max(0, subtotal - discountFromCode - discountFromPoints);
                const pointsEarned = calculatePoints(netTotal); 
                const currentPoints = userStats.points || 0; 
                const newPointsBalance = currentPoints + pointsEarned - pointsRedeemed;
                
                if (!userStats.history) userStats.history = []; 
                if (!userStats.orderHistory) userStats.orderHistory = [];
                
                const historyTimestamp = new Date().toISOString();
                
                if (pointsRedeemed > 0) { 
                    userStats.history.unshift({ type: 'redeem', amount: pointsRedeemed, date: historyTimestamp, orderId: currentOrderId }); 
                }
                if (pointsEarned > 0) { 
                    userStats.history.unshift({ type: 'earn', amount: pointsEarned, date: historyTimestamp, orderId: currentOrderId }); 
                }
                
                // Save order to history for quick reorder
                userStats.orderHistory.unshift({
                    date: getStandardDate(new Date()),
                    total: netTotal,
                    items: cart.map(item => ({
                        name: item.name,
                        price: item.price,
                        meat: item.meat,
                        addons: item.addons,
                        note: item.note
                    }))
                });
                
                // Keep only last 20 orders
                if (userStats.orderHistory.length > 20) {
                    userStats.orderHistory = userStats.orderHistory.slice(0, 20);
                }
                if (userStats.history.length > 20) {
                    userStats.history = userStats.history.slice(0, 20);
                }
                
                userStats.points = newPointsBalance; 
                localStorage.setItem(KEYS.STATS, JSON.stringify(userStats)); 
                updatePointsDisplay();
                updateRecommendations(); // Update recommendations after order
                
                const allNotes = cart.filter(i => i.note).map(i => i.note).join(", ");
                if(!currentOrderId) generateOrderId(); 
                const nowStr = `${getStandardDate(new Date())} ${formatTime(new Date())}`;
                const nextDraw = getThaiLotteryDrawDate();
                
                let msg = ` ! [${currentOrderId}]\n : ${currentOrderId.slice(-2)} ( ${formatThaiDate(nextDraw)})\n ${nowStr}\n  ${name}\n : +${pointsEarned} \n------------------------\n`;
                cart.forEach((i, index) => { 
                    let detail = `${i.name} ${i.meat ? '('+i.meat+')' : ''}`; 
                    if(i.addons.length) detail += ` +${i.addons.join('+')}`; 
                    if(i.note) detail += ` [${i.note}]`; 
                    msg += `${index + 1}. ${detail} (${i.price}.-)\n`; 
                });
                msg += `------------------------\n : ${subtotal} \n`; 
                if (discountFromCode > 0) msg += ` : -${discountFromCode} \n`; 
                if (discountFromPoints > 0) msg += ` : -${discountFromPoints} \n`; 
                if (pointsRedeemed > 0) msg += ` : ${pointsRedeemed} \n`; 
                msg += ` : ${netTotal} \n`;

                const sheetData = { 
                    orderId: currentOrderId, 
                    name: name, 
                    items: cart, 
                    totalPrice: subtotal, 
                    discountCode: discountFromCode, 
                    discountPoints: discountFromPoints, 
                    netTotal: netTotal, 
                    pointsEarned: pointsEarned, 
                    pointsRedeemed: pointsRedeemed, 
                    pointsBalance: newPointsBalance, 
                    allNotes: allNotes, 
                    userId: userAvatar.userId 
                };
                
                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) { 
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sheetData), keepalive: true }).catch(err => console.error("Sheet Error:", err)); 
                }

                saveTicketToHistory(currentOrderId, netTotal); 
                const lineOAId = "@772ysswn"; 
                const encodedMsg = encodeURIComponent(msg);
                confetti();
                
                // Start order tracking
                startOrderTracking(currentOrderId, cart);
                updateActiveOrdersButton();
                
                setTimeout(() => {
                    cart = []; 
                    discountValue = 0; 
                    pointsRedeemed = 0; 
                    isPointsActive = false; 
                    currentOrderId = "";
                    saveToLS(); 
                    updateMiniCart(); 
                    closeCheckout(); 
                    hideGlobalLoader();
                    window.location.href = `https://line.me/R/oaMessage/${lineOAId}/?${encodedMsg}`;
                    isSubmitting = false; 
                    btn.innerHTML = originalText; 
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }, 1000);
            } catch (error) {
                hideGlobalLoader(); 
                showToast(" ", 'error'); 
                isSubmitting = false; 
                btn.innerHTML = originalText; 
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function openRandomizer() {
            const mainDishes = menuItems.filter(i => i.category !== 'dessert' && i.category !== 'promotion' && !i.soldOut && !i.isTray);
            if(mainDishes.length === 0) return showToast("", "error");
            showGlobalLoader("...");
            setTimeout(() => {
                hideGlobalLoader(); 
                const randomIndex = Math.floor(Math.random() * mainDishes.length); 
                const selectedItem = mainDishes[randomIndex];
                openModal(selectedItem); 
                showToast(` ... ${selectedItem.name}!`, "success"); 
                triggerHaptic('heavy');
            }, 1500);
        }

        function enableSwipeToClose(el, scrollEl, closeCallback) {
            let startY = 0; 
            let currentY = 0; 
            let isDragging = false;
            el.addEventListener('touchstart', (e) => { 
                if (scrollEl.scrollTop <= 0) { 
                    startY = e.touches[0].clientY; 
                    isDragging = true; 
                    el.style.transition = 'none'; 
                } 
            }, { passive: true });
            el.addEventListener('touchmove', (e) => { 
                if (!isDragging) return; 
                const diff = e.touches[0].clientY - startY; 
                if (diff > 0) { 
                    if (scrollEl.scrollTop > 0) return; 
                    e.preventDefault(); 
                    el.style.transform = `translateY(${diff}px)`; 
                    currentY = diff; 
                } 
            }, { passive: false });
            el.addEventListener('touchend', () => { 
                if (!isDragging) return; 
                isDragging = false; 
                el.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)'; 
                if (currentY > 150) closeCallback(); 
                else el.style.transform = ''; 
                currentY = 0; 
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const _modalContent = document.getElementById('modal-content'); 
                const _modalScroll = document.getElementById('modal-scroll-area'); 
                if (_modalContent && _modalScroll) enableSwipeToClose(_modalContent, _modalScroll, closeModal);
                const _checkoutSheet = document.getElementById('checkout-sheet'); 
                const _cartList = document.getElementById('checkout-scrollable'); 
                if (_checkoutSheet && _cartList) enableSwipeToClose(_checkoutSheet, _cartList, closeCheckout);
                const _ticketsSheet = document.getElementById('tickets-sheet'); 
                const _ticketsList = document.getElementById('tickets-list'); 
                if (_ticketsSheet && _ticketsList) enableSwipeToClose(_ticketsSheet, _ticketsList, closeMyTickets);
            }, 500);
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                triggerHaptic();
                if (currentOpenModal === 'menu') closeModal(true); 
                else if (currentOpenModal === 'checkout') closeCheckout(true); 
                else if (currentOpenModal === 'tickets') closeMyTickets(true); 
                else if (currentOpenModal === 'avatar') closeAvatarModal(true); 
                else if (currentOpenModal === 'points-history') closePointsHistory(true); 
                else if (currentOpenModal === 'quick-order') closeQuickOrderModal(true);
                else if (!document.getElementById('welcome-modal').classList.contains('hidden')) closeWelcome();
            }
            if (e.key === 'Enter') {
                const activeElement = document.activeElement; 
                triggerHaptic();
                if (activeElement && activeElement.id === 'user-name') { 
                    const submitBtn = document.getElementById('btn-submit-order'); 
                    if (submitBtn && !submitBtn.disabled) submitOrderToLine(); 
                }
                if (currentOpenModal === 'menu' && currentItem) addToCart();
                if (activeElement && activeElement.id === 'discount-code') applyDiscount();
            }
            if (currentOpenModal === 'menu' && currentItem) { 
                if (e.key === 'ArrowUp') { e.preventDefault(); triggerHaptic(); adjustQty(1); } 
                else if (e.key === 'ArrowDown') { e.preventDefault(); triggerHaptic(); adjustQty(-1); } 
            }
        });
        
        window.addEventListener('error', function(e) { console.error('Global error caught:', e.error); e.preventDefault(); });
        document.addEventListener('error', function(e) { 
            if (e.target.tagName.toLowerCase() === 'img') { 
                e.target.src = 'https://cdn-icons-png.flaticon.com/512/135/135161.png'; 
                e.target.alt = 'Image not found'; 
                e.target.classList.add('opacity-50'); 
            } 
        }, true);

        // ===== GALAXY-LEVEL COSMIC FEATURES =====
        
        // --- Food Particles Animation System --- OPTIMIZED for performance ---
        const foodEmojis = ['', '', '', '', '', '', '', '', ''];
        let particlesEnabled = true;
        let activeParticles = 0;
        const maxParticles = 5; // Limit concurrent particles
        
        function createFoodParticle(x, y) {
            if (!particlesEnabled || activeParticles >= maxParticles) return;
            
            activeParticles++;
            const particle = document.createElement('div');
            particle.textContent = foodEmojis[Math.floor(Math.random() * foodEmojis.length)];
            particle.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                font-size: 20px;
                pointer-events: none;
                z-index: 9998;
                animation: floatUp 1.5s ease-out forwards;
            `;
            document.body.appendChild(particle);
            
            setTimeout(() => {
                particle.remove();
                activeParticles--;
            }, 1500);
        }
        
        // Create particles occasionally (every 2 seconds instead of 300ms)
        setInterval(() => {
            if (!particlesEnabled) return;
            const btn = document.querySelector('.add-to-cart-btn');
            if (btn) {
                const rect = btn.getBoundingClientRect();
                createFoodParticle(rect.left + rect.width / 2, rect.top);
            }
        }, 2000);
        
        // --- Gamification System ---
        const GAMIFICATION_KEY = 'kaprao_gamification';
        
        const ACHIEVEMENTS = {
            FIRST_ORDER: { id: 'first_order', name: '', desc: '', icon: '', points: 10 },
            REGULAR: { id: 'regular', name: '', desc: ' 5 ', icon: '', points: 25 },
            VIP: { id: 'vip', name: 'VIP ', desc: ' 20 ', icon: '', points: 50 },
            BIG_SPENDER: { id: 'big_spender', name: '', desc: ' 1,000 ', icon: '', points: 30 },
            SAVER: { id: 'saver', name: '', desc: ' 500+', icon: '', points: 40 },
            EARLY_BIRD: { id: 'early_bird', name: '', desc: ' 8 ', icon: '', points: 15 },
            NIGHT_OWL: { id: 'night_owl', name: '', desc: ' 5 ', icon: '', points: 15 },
            WEEKEND_WARRIOR: { id: 'weekend', name: '', desc: '-', icon: '', points: 20 },
            TRAY_MASTER: { id: 'tray', name: '', desc: ' 3 ', icon: '', points: 35 },
            LUCKY_WINNER: { id: 'lucky', name: '', desc: '', icon: '', points: 100 }
        };
        
        let gamificationData = {
            level: 1,
            xp: 0,
            streak: 0,
            lastOrderDate: null,
            achievements: [],
            totalOrders: 0,
            totalSpent: 0
        };
        
        function loadGamificationData() {
            try {
                const saved = localStorage.getItem(GAMIFICATION_KEY);
                if (saved) {
                    gamificationData = { ...gamificationData, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.error('Failed to load gamification data:', e);
            }
        }
        
        function saveGamificationData() {
            localStorage.setItem(GAMIFICATION_KEY, JSON.stringify(gamificationData));
        }
        
        function checkAndAwardAchievements(orderData) {
            const newAchievements = [];
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay(); // 0 = Sunday, 6 = Saturday
            
            // Check each achievement
            if (!hasAchievement('FIRST_ORDER') && gamificationData.totalOrders === 0) {
                awardAchievement('FIRST_ORDER');
                newAchievements.push(ACHIEVEMENTS.FIRST_ORDER);
            }
            
            if (!hasAchievement('REGULAR') && gamificationData.totalOrders >= 4) {
                awardAchievement('REGULAR');
                newAchievements.push(ACHIEVEMENTS.REGULAR);
            }
            
            if (!hasAchievement('VIP') && gamificationData.totalOrders >= 19) {
                awardAchievement('VIP');
                newAchievements.push(ACHIEVEMENTS.VIP);
            }
            
            if (!hasAchievement('BIG_SPENDER') && gamificationData.totalSpent + orderData.total >= 1000) {
                awardAchievement('BIG_SPENDER');
                newAchievements.push(ACHIEVEMENTS.BIG_SPENDER);
            }
            
            if (!hasAchievement('EARLY_BIRD') && hour < 8) {
                awardAchievement('EARLY_BIRD');
                newAchievements.push(ACHIEVEMENTS.EARLY_BIRD);
            }
            
            if (!hasAchievement('NIGHT_OWL') && hour >= 23) {
                awardAchievement('NIGHT_OWL');
                newAchievements.push(ACHIEVEMENTS.NIGHT_OWL);
            }
            
            if (!hasAchievement('WEEKEND') && (day === 0 || day === 6)) {
                awardAchievement('WEEKEND');
                newAchievements.push(ACHIEVEMENTS.WEEKEND);
            }
            
            // Show notifications for new achievements
            newAchievements.forEach((ach, index) => {
                setTimeout(() => {
                    showAchievementNotification(ach);
                    triggerConfettiBurst();
                }, index * 1500);
            });
            
            return newAchievements;
        }
        
        function hasAchievement(id) {
            return gamificationData.achievements.includes(id);
        }
        
        function awardAchievement(id) {
            if (!hasAchievement(id)) {
                gamificationData.achievements.push(id);
                gamificationData.xp += ACHIEVEMENTS[id].points;
                checkLevelUp();
                saveGamificationData();
            }
        }
        
        function checkLevelUp() {
            const newLevel = Math.floor(gamificationData.xp / 100) + 1;
            if (newLevel > gamificationData.level) {
                gamificationData.level = newLevel;
                showToast(` Level Up!  ${newLevel} !`, 'success');
            }
        }
        
        function updateStreak() {
            const today = new Date().toDateString();
            const lastOrder = gamificationData.lastOrderDate;
            
            if (lastOrder) {
                const lastDate = new Date(lastOrder);
                const todayDate = new Date();
                const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    gamificationData.streak++;
                    if (gamificationData.streak >= 3) {
                        showToast(` Streak ${gamificationData.streak} ! !`, 'success');
                    }
                } else if (diffDays > 1) {
                    gamificationData.streak = 1;
                }
            } else {
                gamificationData.streak = 1;
            }
            
            gamificationData.lastOrderDate = today;
        }
        
        function showAchievementNotification(achievement) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-[9999] animate-fade-in-down';
            toast.innerHTML = `
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4">
                    <div class="text-4xl">${achievement.icon}</div>
                    <div>
                        <p class="font-bold text-lg"> !</p>
                        <p class="font-bold">${achievement.name}</p>
                        <p class="text-sm opacity-90">${achievement.desc} +${achievement.points} XP</p>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }
        
        function triggerConfettiBurst() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#FCD34D', '#F59E0B', '#FBBF24', '#FFFFFF']
            });
        }
        
        // --- Particle Burst Effect ---
        function createParticleBurst(x, y, colors = ['#FCD34D', '#F59E0B', '#FBBF24']) {
            const burst = document.createElement('div');
            burst.className = 'particle-burst';
            burst.style.left = x + 'px';
            burst.style.top = y + 'px';
            document.body.appendChild(burst);
            
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'burst-particle';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                const angle = (i / 12) * Math.PI * 2;
                const distance = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                
                burst.appendChild(particle);
            }
            
            setTimeout(() => burst.remove(), 1000);
        }
        
        // --- Voice Ordering Simulation ---
        let voiceRecognitionActive = false;
        
        function toggleVoiceOrder() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('', 'warning');
                return;
            }
            
            if (voiceRecognitionActive) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        }
        
        function startVoiceRecognition() {
            voiceRecognitionActive = true;
            showVoiceModal();
            
            // Simulate voice recognition with animation
            setTimeout(() => {
                // Mock recognition result
                processVoiceCommand('');
            }, 3000);
        }
        
        function stopVoiceRecognition() {
            voiceRecognitionActive = false;
            const modal = document.getElementById('voice-modal');
            if (modal) modal.remove();
        }
        
        function showVoiceModal() {
            const modal = document.createElement('div');
            modal.id = 'voice-modal';
            modal.className = 'fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center">
                    <div class="voice-wave justify-center mb-6">
                        ${Array(8).fill(0).map((_, i) => `
                            <div class="voice-wave-bar" style="height: 100%; animation-delay: ${i * 0.1}s"></div>
                        `).join('')}
                    </div>
                    <p class="text-xl font-bold text-gray-800 mb-2"> ...</p>
                    <p class="text-gray-500 text-sm">  ""</p>
                    <button onclick="stopVoiceRecognition()" class="mt-6 w-full py-3 bg-gray-100 rounded-xl text-gray-600 font-bold">
                        
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function processVoiceCommand(command) {
            stopVoiceRecognition();
            
            // Simple matching logic
            const match = menuItems.find(item => 
                command.toLowerCase().includes(item.name.toLowerCase()) ||
                command.toLowerCase().includes(item.name.replace('', '').toLowerCase())
            );
            
            if (match) {
                showToast(` : ${match.name}`, 'success');
                openModal(match);
                
                // Auto-add options based on command
                if (command.includes('')) {
                    setTimeout(() => {
                        const eggCheckbox = document.getElementById('modal-opt-kaidao');
                        if (eggCheckbox) eggCheckbox.checked = true;
                    }, 500);
                }
                if (command.includes('')) {
                    setTimeout(() => {
                        const specialCheckbox = document.getElementById('modal-opt-special');
                        if (specialCheckbox) specialCheckbox.checked = true;
                    }, 500);
                }
            } else {
                showToast(' ', 'warning');
            }
        }
        
        // --- AR Preview Feature ---
        function showARPreview(item) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[200] bg-black/70 backdrop-blur-md flex items-center justify-center p-6';
            modal.innerHTML = `
                <div class="ar-preview relative">
                    <div class="ar-card bg-white rounded-[2rem] p-6 w-80 text-center relative overflow-hidden">
                        <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center z-10">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <div class="text-8xl mb-4 animate-bounce-slow">${item.icon}</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${item.name}</h3>
                        <p class="text-3xl font-black text-yellow-500 mb-4">${item.price} </p>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-fire text-orange-500"></i>
                                <span>${item.kcal} kcal</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-clock text-blue-500"></i>
                                <span> 5-10 </span>
                            </div>
                        </div>
                        
                        <button onclick="this.closest('.fixed').remove(); openModal(menuItems.find(i => i.id === ${item.id}));" 
                                class="w-full btn-gradient text-white font-bold py-3 rounded-xl">
                            !
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // --- Social Share Features ---
        function shareOrder(orderData) {
            const shareText = `  ${orderData.items.length}  Kaprao52!\n  ${orderData.total} \n  ${gamificationData.totalOrders} !\n\n! `;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Kaprao52 Order',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // Copy to clipboard
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('!', 'success');
                });
            }
        }
        
        // --- Seasonal Themes ---
        const SEASONAL_THEMES = {
            SONGKRAN: { month: 3, colors: ['#60A5FA', '#93C5FD'], emoji: '' },
            LOYKRATHONG: { month: 10, colors: ['#F472B6', '#FBBF24'], emoji: '' },
            CHRISTMAS: { month: 11, colors: ['#EF4444', '#10B981'], emoji: '' },
            NEWYEAR: { month: 0, colors: ['#FCD34D', '#F59E0B'], emoji: '' }
        };
        
        function checkSeasonalTheme() {
            const month = new Date().getMonth();
            for (const [name, theme] of Object.entries(SEASONAL_THEMES)) {
                if (theme.month === month) {
                    applySeasonalTheme(theme);
                    return;
                }
            }
        }
        
        function applySeasonalTheme(theme) {
            const blob1 = document.querySelector('#blob-container .blob:nth-child(1)');
            const blob2 = document.querySelector('#blob-container .blob:nth-child(2)');
            if (blob1) blob1.style.background = theme.colors[0];
            if (blob2) blob2.style.background = theme.colors[1];
            
            // Show seasonal greeting
            setTimeout(() => {
                showToast(` ${theme.emoji} ! `);
            }, 2000);
        }
        
        // --- Smart Notifications ---
        function scheduleSmartNotifications() {
            // Lunch reminder at 11:30
            const lunchTime = new Date();
            lunchTime.setHours(11, 30, 0);
            
            // Dinner reminder at 17:30
            const dinnerTime = new Date();
            dinnerTime.setHours(17, 30, 0);
            
            // Check if user hasn't ordered today
            const today = new Date().toDateString();
            if (gamificationData.lastOrderDate !== today) {
                // Would schedule notifications here if permissions granted
                console.log('Smart notifications scheduled');
            }
        }
        
        // --- 3D Tilt Effect --- OPTIMIZED with throttling ---
        function initTiltEffect() {
            const tiltCards = document.querySelectorAll('.tilt-card');
            
            tiltCards.forEach(card => {
                let ticking = false;
                card.addEventListener('mousemove', (e) => {
                    if (ticking) return;
                    ticking = true;
                    
                    requestAnimationFrame(() => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;
                        
                        const rotateX = (y - centerY) / 10;
                        const rotateY = (centerX - x) / 10;
                        
                        card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                        ticking = false;
                    });
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
                });
            });
        }
        
        // --- Magnetic Button Effect --- OPTIMIZED with throttling ---
        function initMagneticButtons() {
            const magneticBtns = document.querySelectorAll('.magnetic-btn');
            
            magneticBtns.forEach(btn => {
                let ticking = false;
                btn.addEventListener('mousemove', (e) => {
                    if (ticking) return;
                    ticking = true;
                    
                    requestAnimationFrame(() => {
                        const rect = btn.getBoundingClientRect();
                        const x = e.clientX - rect.left - rect.width / 2;
                        const y = e.clientY - rect.top - rect.height / 2;
                        
                        btn.style.transform = `translate(${x * 0.3}px, ${y * 0.3}px)`;
                        ticking = false;
                    });
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translate(0, 0)';
                });
            });
        }
        
        // --- Text Scramble Effect ---
        class TextScramble {
            constructor(el) {
                this.el = el;
                this.chars = '!<>-_\\/[]{}=+*^?#________';
                this.update = this.update.bind(this);
            }
            
            setText(newText) {
                const oldText = this.el.innerText;
                const length = Math.max(oldText.length, newText.length);
                const promise = new Promise(resolve => this.resolve = resolve);
                this.queue = [];
                
                for (let i = 0; i < length; i++) {
                    const from = oldText[i] || '';
                    const to = newText[i] || '';
                    const start = Math.floor(Math.random() * 40);
                    const end = start + Math.floor(Math.random() * 40);
                    this.queue.push({ from, to, start, end });
                }
                
                cancelAnimationFrame(this.frameRequest);
                this.frame = 0;
                this.update();
                return promise;
            }
            
            update() {
                let output = '';
                let complete = 0;
                
                for (let i = 0, n = this.queue.length; i < n; i++) {
                    let { from, to, start, end, char } = this.queue[i];
                    
                    if (this.frame >= end) {
                        complete++;
                        output += to;
                    } else if (this.frame >= start) {
                        if (!char || Math.random() < 0.28) {
                            char = this.randomChar();
                            this.queue[i].char = char;
                        }
                        output += `<span class="opacity-50">${char}</span>`;
                    } else {
                        output += from;
                    }
                }
                
                this.el.innerHTML = output;
                
                if (complete === this.queue.length) {
                    this.resolve();
                } else {
                    this.frameRequest = requestAnimationFrame(this.update);
                    this.frame++;
                }
            }
            
            randomChar() {
                return this.chars[Math.floor(Math.random() * this.chars.length)];
            }
        }
        
        // --- Parallax Effect on Scroll ---
        function initParallax() {
            const parallaxElements = document.querySelectorAll('.parallax');
            if (!parallaxElements.length) return;
            
            let ticking = false;
            window.addEventListener('scroll', () => {
                if (!ticking) {
                    window.requestAnimationFrame(() => {
                        const scrolled = window.pageYOffset;
                        parallaxElements.forEach(el => {
                            const speed = el.dataset.speed || 0.5;
                            el.style.transform = `translateY(${scrolled * speed}px)`;
                        });
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });
        }
        
        // --- Mouse Trail Effect --- DISABLED for performance ---
        function initMouseTrail() {
            // DISABLED: Too heavy for mobile performance
            return;
        }
        
        // --- Interactive Spotlight Effect --- DISABLED for performance ---
        function initSpotlight() {
            // DISABLED: Too heavy for mobile performance
            return;
        }
        
        // --- Floating Elements Randomizer ---
        function initFloatingElements() {
            const floats = document.querySelectorAll('.float-random');
            floats.forEach((el, i) => {
                el.style.animationDelay = `${Math.random() * 5}s`;
                el.style.animationDuration = `${3 + Math.random() * 4}s`;
            });
        }
        
        // --- Enhanced Confetti with Shapes ---
        function enhancedConfetti(options = {}) {
            const shapes = ['square', 'circle', 'triangle'];
            const colors = options.colors || ['#FCD34D', '#F59E0B', '#FBBF24', '#8B5CF6', '#EC4899'];
            
            for (let i = 0; i < (options.count || 50); i++) {
                const particle = document.createElement('div');
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                particle.style.cssText = `
                    position: fixed;
                    width: ${8 + Math.random() * 8}px;
                    height: ${8 + Math.random() * 8}px;
                    background: ${color};
                    left: ${options.origin ? options.origin.x * 100 : 50}%;
                    top: ${options.origin ? options.origin.y * 100 : 50}%;
                    pointer-events: none;
                    z-index: 9999;
                    border-radius: ${shape === 'circle' ? '50%' : shape === 'triangle' ? '0' : '2px'};
                `;
                
                if (shape === 'triangle') {
                    particle.style.background = 'transparent';
                    particle.style.borderLeft = '6px solid transparent';
                    particle.style.borderRight = '6px solid transparent';
                    particle.style.borderBottom = `10px solid ${color}`;
                    particle.style.width = '0';
                    particle.style.height = '0';
                }
                
                document.body.appendChild(particle);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 200 + Math.random() * 300;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity - 200;
                
                particle.animate([
                    { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${vx}px, ${window.innerHeight}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                ], {
                    duration: 1500 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                    fill: 'forwards'
                }).onfinish = () => particle.remove();
            }
        }
        
        // --- Typewriter Effect ---
        function typewriterEffect(element, text, speed = 50) {
            let i = 0;
            element.innerHTML = '';
            element.classList.add('border-r-2', 'border-yellow-500', 'animate-pulse');
            
            return new Promise(resolve => {
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    } else {
                        element.classList.remove('border-r-2', 'border-yellow-500', 'animate-pulse');
                        resolve();
                    }
                }
                type();
            });
        }
        
        // --- Breathing Animation for Cards ---
        function initBreathingAnimation() {
            const cards = document.querySelectorAll('.breathing-card');
            
            cards.forEach((card, index) => {
                card.style.animation = `breathe 4s ease-in-out ${index * 0.5}s infinite`;
            });
        }
        
        // Initialize all cosmic effects
        document.addEventListener('DOMContentLoaded', () => {
            loadGamificationData();
            initFoodParticles();
            checkSeasonalTheme();
            scheduleSmartNotifications();
            initTiltEffect();
            initMagneticButtons();
            initParallax();
            initFloatingElements();
            initBreathingAnimation();
            updateBottomNavBadge();
            
            // Show bottom nav if welcome modal is already hidden (returning users)
            const welcomeModal = document.getElementById('welcome-modal');
            const bottomNav = document.getElementById('bottom-nav');
            if (welcomeModal && welcomeModal.classList.contains('hidden') && bottomNav) {
                bottomNav.classList.remove('hidden');
                bottomNav.classList.add('show');
            }
            
            // initMouseTrail(); // Optional - uncomment if desired
            // initSpotlight(); // Optional - uncomment if desired
        });
        
        // --- BOTTOM NAVIGATION FUNCTIONS ---
        let currentPage = 'home';
        
        function setActiveNav(page) {
            currentPage = page;
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });
        }
        
        function navigateTo(page) {
            setActiveNav(page);
            
            switch(page) {
                case 'home':
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    closeAllModals();
                    break;
                case 'orders':
                    if (cart.length > 0) {
                        openCheckout();
                    } else {
                        showToast(' ', 'info');
                        // Show active orders if any
                        if (activeOrders.size > 0) {
                            showActiveOrdersList();
                        }
                    }
                    break;
                case 'more':
                    openMoreModal();
                    break;
            }
        }
        
        function updateBottomNavBadge() {
            const badge = document.getElementById('nav-cart-badge');
            if (badge) {
                const count = cart.reduce((sum, item) => sum + item.qty, 0);
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }
        
        function closeAllModals() {
            closeModal(true);
            closeCheckout(true);
            closeMyTickets(true);
            closeAvatarModal(true);
            closePointsHistory(true);
            closeQuickOrderModal(true);
        }
        
        function openMoreModal() {
            const modal = document.createElement('div');
            modal.id = 'more-modal';
            modal.className = 'fixed inset-0 z-[200] bg-black/50 backdrop-blur-sm flex items-end justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-t-[2rem] w-full max-w-md p-6 animate-slide-up" onclick="event.stopPropagation()">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4"></h2>
                    
                    <div class="space-y-3">
                        <button onclick="openWheelOfFortune(); closeMoreModal();" class="w-full flex items-center gap-4 p-4 rounded-xl bg-gradient-to-r from-pink-50 to-purple-50 border border-pink-100 hover:shadow-md transition-all">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-xl"></div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800"></p>
                                <p class="text-xs text-gray-500"></p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
                        </button>
                        
                        <button onclick="openMyTickets(); closeMoreModal();" class="w-full flex items-center gap-4 p-4 rounded-xl bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-100 hover:shadow-md transition-all">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-400 to-blue-500 flex items-center justify-center text-white text-xl"></div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800"></p>
                                <p class="text-xs text-gray-500"></p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
                        </button>
                        
                        <button onclick="openPointsHistory(); closeMoreModal();" class="w-full flex items-center gap-4 p-4 rounded-xl bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100 hover:shadow-md transition-all">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-white text-xl"></div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800"></p>
                                <p class="text-xs text-gray-500"></p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
                        </button>
                        
                        <button onclick="openQuickOrderModal(); closeMoreModal();" class="w-full flex items-center gap-4 p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 border border-green-100 hover:shadow-md transition-all">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-white text-xl"></div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800"></p>
                                <p class="text-xs text-gray-500"></p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
                        </button>
                    </div>
                    
                    <button onclick="closeMoreModal()" class="w-full mt-6 py-3 bg-gray-100 rounded-xl font-bold text-gray-600 hover:bg-gray-200 transition-all">
                        
                    </button>
                </div>
            `;
            modal.onclick = () => closeMoreModal();
            document.body.appendChild(modal);
        }
        
        function closeMoreModal() {
            const modal = document.getElementById('more-modal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        // Override addToCart to update badge
        const originalAddToCart = addToCart;
        addToCart = function() {
            originalAddToCart.apply(this, arguments);
            updateBottomNavBadge();
        };
        
        // Override removeFromCart to update badge
        const originalRemoveFromCart = removeFromCart;
        removeFromCart = function(index) {
            originalRemoveFromCart(index);
            updateBottomNavBadge();
        };
        
        // Override updateMiniCart to also update badge
        const originalUpdateMiniCart = updateMiniCart;
        updateMiniCart = function() {
            originalUpdateMiniCart.apply(this, arguments);
            updateBottomNavBadge();
        };
        
        // Override submitOrderToLine to include gamification
        const originalSubmitOrder = submitOrderToLine;
        submitOrderToLine = async function() {
            const result = await originalSubmitOrder.apply(this, arguments);
            
            // Update gamification after successful order
            gamificationData.totalOrders++;
            gamificationData.totalSpent += cart.reduce((sum, i) => sum + i.price, 0);
            updateStreak();
            
            const orderData = {
                total: cart.reduce((sum, i) => sum + i.price, 0),
                items: cart,
                date: new Date()
            };
            
            checkAndAwardAchievements(orderData);
            saveGamificationData();
            updateBottomNavBadge(); // Reset badge after order
            
            return result;
        };
    </script>

    <!-- BOTTOM NAVIGATION BAR -->
    <nav class="bottom-nav hidden" id="bottom-nav">
        <div class="bottom-nav-container">
            <div class="bottom-nav-item active" data-page="home" onclick="navigateTo('home')">
                <i class="fas fa-home bottom-nav-icon"></i>
                <span class="bottom-nav-label"></span>
            </div>
            
            <div class="bottom-nav-item" data-page="orders" onclick="navigateTo('orders')">
                <i class="fas fa-shopping-bag bottom-nav-icon"></i>
                <span class="bottom-nav-badge hidden" id="nav-cart-badge">0</span>
                <span class="bottom-nav-label"></span>
            </div>
            
            <div class="bottom-nav-item" data-page="more" onclick="navigateTo('more')">
                <i class="fas fa-th-large bottom-nav-icon"></i>
                <span class="bottom-nav-label"></span>
            </div>
        </div>
    </nav>
</body>
</html>
