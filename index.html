<!DOCTYPE html>
<html lang="th">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FEF9F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preconnect" href="https://static.line-scdn.net">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <!-- 1. TAILWIND CONFIG -->
    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            brand: {
                                purple: '#8B5CF6', 
                                yellow: '#FBBF24',
                                text: '#1F2937',        
                            }
                        },
                        fontFamily: {
                            sans: ['Kanit', 'sans-serif'],
                            round: ['Kanit', 'sans-serif'] 
                        },
                        borderRadius: {
                            '4xl': '2.5rem',
                        },
                        animation: {
                            'bounce-slow': 'bounce 3s infinite',
                            'fade-in-down': 'fadeInDown 0.3s ease-out forwards',
                            'spin-fast': 'spin 0.8s linear infinite',
                            'heart-beat': 'heartBeat 0.3s ease-in-out',
                        },
                        keyframes: {
                            fadeInDown: {
                                '0%': { opacity: '0', transform: 'translateY(-10px)' },
                                '100%': { opacity: '1', transform: 'translateY(0)' },
                            },
                            heartBeat: {
                                '0%': { transform: 'scale(1)' },
                                '50%': { transform: 'scale(1.3)' },
                                '100%': { transform: 'scale(1)' },
                            }
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4FR74WPRNY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4FR74WPRNY');
    </script>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    
    <title>Kaprao52 - APP</title> 
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* === THEME VARIABLES === */
        :root {
            --bg-primary: #FEF9F3;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F3F4F6;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-tertiary: #9CA3AF;
            --border-color: #E5E7EB;
            
            --glass-bg: rgba(255, 255, 255, 0.90);
            --glass-heavy-bg: rgba(255, 255, 255, 0.98);
            
            --card-bg: #FFFFFF;
            --card-hover: #FEF3C7;
            
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(0, 0, 0, 0.1);

            --meat-option-bg: #FFFFFF;
            --meat-option-border: #E5E7EB;
            --meat-option-text: #4B5563;
            --meat-option-hover-bg: #F9FAFB;
            --meat-option-selected-bg: #FEF3C7;
            --meat-option-selected-border: #F59E0B;
            --meat-option-selected-text: #92400E;
        }

        /* Base Styles */
        body { 
            color: var(--text-primary); 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            background: var(--bg-primary);
            transition: background-color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.scroll-locked { overflow: hidden; height: 100vh; }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
            scroll-behavior: smooth;
        }
        .safe-area-pt { padding-top: var(--sat); }
        .safe-area-pb { padding-bottom: var(--sab); }
        .safe-area-pb-plus { padding-bottom: calc(1rem + var(--sab)); }
        
        html { scroll-behavior: smooth; }
        
        ::selection {
            background-color: rgba(251, 191, 36, 0.3);
            color: var(--text-primary);
        }
        
        @media screen and (max-width: 768px) {
            input, textarea, select { font-size: 16px !important; }
        }

        /* --- BACKGROUND & CONFETTI --- */
        #bg-canvas, #confetti-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        #bg-canvas { z-index: -1; opacity: 0.6; }
        #confetti-canvas { z-index: 150; }

        /* --- COMPONENTS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-color);
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .fast-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -1px var(--shadow);
            border-radius: 1.5rem;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }
        .fast-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px var(--shadow-hover), 0 4px 6px -2px var(--shadow-hover);
            border-color: #FCD34D;
        }
        .fast-card:active {
            transform: scale(0.98) translateY(-2px);
            background: var(--card-hover);
        }
        .line-clamp-2 {
            display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden;
        }

        .glass-heavy {
            background: var(--glass-heavy-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-top: 1px solid var(--border-color);
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* --- ANIMATIONS --- */
        .btn-bounce { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-bounce:active { transform: scale(0.92); }

        .btn-press { transform-origin: center; }
        .btn-press.squash { transform: scaleX(1.12) scaleY(0.88); transition: transform 140ms cubic-bezier(0.2,0.8,0.2,1); }
        .btn-press.rebound { animation: squashRebound 480ms cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes squashRebound {
            0% { transform: scaleX(1.12) scaleY(0.88); }
            50% { transform: scaleX(0.92) scaleY(1.12); }
            100% { transform: scaleX(1) scaleY(1); }
        }

        .heart-btn { transition: all 0.3s ease; }
        .heart-btn.active { color: #EF4444; animation: heartBeat 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .heart-btn:active { transform: scale(0.8); }

        .fly-item {
            position: fixed; z-index: 9999; pointer-events: none;
            font-size: 1.8rem; width: 56px; height: 56px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            color: white;
            box-shadow: 0 12px 32px rgba(245, 158, 11, 0.4), 0 0 16px rgba(245, 158, 11, 0.2);
            will-change: transform, opacity;
            animation: flyUp 1.2s cubic-bezier(0.2, 0.8, 0.4, 1) forwards;
        }
        @keyframes flyUp {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(0, -150px) scale(0.3); }
        }

        .stagger-item { opacity: 0; animation: fadeInUpSmooth 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes fadeInUpSmooth { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .skeleton { background: #F3F4F6; position: relative; overflow: hidden; }
        .skeleton::after {
            content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-100%); animation: shimmerSmooth 2s infinite;
        }
        @keyframes shimmerSmooth { 100% { transform: translateX(100%); } }

        .page-out { animation: pageOut 0.2s cubic-bezier(0.4, 0, 1, 1) forwards; }
        .page-in { animation: pageIn 0.3s cubic-bezier(0, 0, 0.2, 1) forwards; }
        @keyframes pageOut { to { opacity: 0; transform: scale(0.96) translateY(10px); } }
        @keyframes pageIn { from { opacity: 0; transform: scale(0.96) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* Category Pills */
        .category-pill {
            min-width: 85px; height: 85px;
            border-radius: 24px;
            font-size: 0.75rem; font-weight: 600; 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid transparent; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 0.25rem;
            position: relative;
        }
        .category-pill:hover { transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .category-pill-active {
            background: linear-gradient(135deg, #FFB02E 0%, #F59E0B 100%);
            color: white; border: none;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
            transform: scale(1.05);
        }
        .category-pill-inactive {
            background: #FFFFFF; color: #4B5563; border-color: #E5E7EB;
            box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .category-pill-inactive:hover { border-color: #FCD34D; background: #FFFEF5; }

        .category-pill-promotion.category-pill-active {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            box-shadow: 0 8px 20px -6px rgba(239, 68, 68, 0.4);
        }
        .category-pill-tray.category-pill-active {
            background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
            box-shadow: 0 8px 20px -6px rgba(99, 102, 241, 0.4);
        }
        /* Favorites Tab Style */
        .category-pill-favorites.category-pill-active {
            background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%);
            box-shadow: 0 8px 20px -6px rgba(236, 72, 153, 0.4);
        }

        .tab-icon {
            font-size: 1.8rem; margin-bottom: 2px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        .btn-gradient {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.35); border: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-gradient:hover { box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4); transform: translateY(-2px); }    
        .btn-gradient:active { transform: scale(0.96); }
        .btn-gradient-purple {
            background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.35); border: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-gradient-purple:hover { box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4); transform: translateY(-2px); }
        .btn-gradient-purple:active { transform: scale(0.96); }

        .tab-icon, .menu-icon { display: inline-block; transition: transform 400ms cubic-bezier(.2,.9,.2,1); transform-origin: center center; }
        .fast-card:hover .menu-icon { transform: rotate(15deg) scale(1.1); }
        #tabs-container button:hover .tab-icon { transform: rotate(15deg) scale(1.1); }
        #tabs-container button:active { transform: scale(0.94); }

        /* Loader - IMPROVED */
        #global-loader { 
            position: fixed; inset: 0; z-index: 9999; 
            background: var(--bg-primary); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.5s; 
        }
        .loader-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        /* New smooth cooking animation */
        .cooking-container {
            position: relative;
            width: 120px;
            height: 120px;
        }
        .cooking-pan { 
            font-size: 4rem; 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: panCookSmooth 2.5s infinite ease-in-out;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        .steam-particle {
            position: absolute;
            font-size: 1.5rem;
            opacity: 0;
            animation: steamRise 2s infinite ease-out;
        }
        .steam-1 { top: 10%; left: 30%; animation-delay: 0s; }
        .steam-2 { top: 5%; left: 50%; animation-delay: 0.6s; }
        .steam-3 { top: 15%; left: 70%; animation-delay: 1.2s; }
        
        @keyframes panCookSmooth { 
            0%, 100% { transform: translate(-50%, -50%) rotate(-5deg) translateY(0); } 
            25% { transform: translate(-50%, -50%) rotate(5deg) translateY(-3px); } 
            50% { transform: translate(-50%, -50%) rotate(-3deg) translateY(0); }
            75% { transform: translate(-50%, -50%) rotate(3deg) translateY(-2px); } 
        }
        @keyframes steamRise {
            0% { opacity: 0; transform: translateY(0) scale(0.5); }
            30% { opacity: 0.6; }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
        
        /* Loading dots */
        .loading-dots {
            display: flex;
            gap: 6px;
            margin-top: 16px;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background: #F59E0B;
            border-radius: 50%;
            animation: dotBounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }
        @keyframes dotBounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Wheel */
        #wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto 20px auto; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }
        #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 9s cubic-bezier(0.05, 0.95, 0.05, 0.95); }
        .wheel-pointer { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 40px solid #F59E0B; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); z-index: 20; }
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: linear-gradient(135deg, #FFFFFF, #FEF3C7); border-radius: 50%; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 24px; transition: all 0.5s ease; border: 2px solid #FCD34D; }

        #receipt-capture { position: absolute; top: 0; left: 0; width: 400px; z-index: -100; visibility: hidden; background: #FFFFFF; padding: 0; border-radius: 0; font-family: 'Kanit', sans-serif; color: #1F2937; }
        
        .ticket-stub {
            background-image: radial-gradient(circle at 0 50%, transparent 8px, #FFFFFF 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, #FFFFFF 8.5px);
            background-position: 0 0, 0 0; background-size: 100% 100%; 
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            background-color: #FFFFFF;
        }
        .ticket-stub:hover { transform: scale(1.02); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08); }
        .ticket-stub:active { transform: scale(0.98); }
        
        /* Avatar */
        .avatar-option { 
            width: 72px; height: 72px; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            position: relative; display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; background: #FFFFFF; padding: 6px; border: 2px solid #E5E7EB; 
        }
        .avatar-option img { width: 100%; height: 100%; object-fit: contain; }
        .avatar-option:hover { transform: scale(1.15); border-color: #FCD34D; box-shadow: 0 8px 20px rgba(251, 191, 36, 0.2); }
        .avatar-selected { 
            background: linear-gradient(135deg, #FEF3C7, #FFFBEB) !important; 
            border: 2px solid #F59E0B; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); 
            transform: scale(1.15); animation: avatarPulse 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes avatarPulse { 0% { transform: scale(0.9); } 50% { transform: scale(1.22); } 100% { transform: scale(1.15); } }

        /* Inputs */
        input, textarea, select {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: #FFFFFF; color: #1F2937; border: 1.5px solid #E5E7EB;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #F59E0B; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); outline: none;
        }

        /* Meat Option */
        .meat-option {
            background: var(--meat-option-bg); border: 2px solid var(--meat-option-border); color: var(--meat-option-text);
            border-radius: 1rem; padding: 0.75rem 1rem; font-size: 0.85rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); text-align: center; min-width: 100px; flex-shrink: 0;
        }
        .meat-option:hover { background: var(--meat-option-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .meat-option.selected, input:checked + .meat-option {
            background: var(--meat-option-selected-bg); border: 2px solid var(--meat-option-selected-border);
            color: var(--meat-option-selected-text); font-weight: 700; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
            transform: translateY(-2px) scale(1.05);
        }

        /* Points Range */
        .points-range {
            width: 100%; height: 6px; -webkit-appearance: none; appearance: none;
            background: linear-gradient(to right, #F59E0B, #D97706); border-radius: 10px; outline: none;
        }
        .points-range::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%;
            background: #FFFFFF; border: 3px solid #F59E0B; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer; transition: all 0.2s ease;
        }
        .points-range::-webkit-slider-thumb:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3); }

        /* THEME OVERRIDES (Resetting Dark Mode classes to Light) */
        .bg-slate-800 { background-color: #FFFFFF !important; border: 1px solid #E5E7EB; color: #1F2937; }
        .bg-slate-900 { background-color: #F9FAFB !important; color: #1F2937; }
        .bg-slate-700 { background-color: #F3F4F6 !important; color: #374151; }
        .text-slate-200, .text-slate-300, .text-slate-100 { color: #1F2937 !important; }
        .text-slate-400 { color: #6B7280 !important; }
        .text-slate-500 { color: #9CA3AF !important; }
        .border-slate-700 { border-color: #E5E7EB !important; }
        .border-slate-600 { border-color: #D1D5DB !important; }
        
        #modal-content .bg-slate-800 { background-color: #FFFFFF !important; border: 1px solid #E5E7EB; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #welcome-modal .bg-slate-800 { background-color: #FFFFFF !important; border: 1px solid #E5E7EB; color: #1F2937 !important; }
        #welcome-modal .text-slate-300 { color: #4B5563 !important; }
        #welcome-modal .text-slate-200 { color: #111827 !important; }
        
        .ticket-stub.bg-slate-800\/50 { background-color: #F3F4F6 !important; border-color: #D1D5DB !important; }
        
        /* Cart Bar */
        #mini-cart-bar .bg-slate-800\/95 { background-color: #1F2937 !important; color: #FFFFFF !important; border-color: #374151; }
        #mini-cart-bar .text-slate-100 { color: #FFFFFF !important; }
        #mini-cart-bar .text-slate-400 { color: #9CA3AF !important; }

        .cart-item-title { font-size: 0.85rem !important; line-height: 1.2 !important; margin-bottom: 0.25rem !important; }
        .cart-item-details { font-size: 0.75rem !important; }
        
        /* IMPROVED: Toast notification */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 14px 24px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            opacity: 0;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            max-width: 90vw;
            min-width: 280px;
        }
        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        #toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        #toast-msg {
            font-weight: 500;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* Toast types */
        .toast-success { background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95)); color: white; border: 1px solid rgba(16, 185, 129, 0.3); }
        .toast-error { background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95)); color: white; border: 1px solid rgba(239, 68, 68, 0.3); }
        .toast-warning { background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95)); color: white; border: 1px solid rgba(245, 158, 11, 0.3); }
        .toast-info { background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95)); color: white; border: 1px solid rgba(59, 130, 246, 0.3); }
        
        /* Price pop animation */
        .price-pop {
            animation: pricePop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes pricePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Shake animation for error */
        .animate-shake {
            animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Pulse glow for VIP */
        .vip-glow {
            animation: vipGlow 2s ease-in-out infinite;
        }
        @keyframes vipGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); }
        }
    </style>
<base target="_blank">
</head>
<body class="pb-40 font-sans select-none relative overflow-x-hidden safe-area-pt">

    <!-- CANVAS LAYERS -->
    <canvas id="bg-canvas"></canvas>
    <canvas id="confetti-canvas"></canvas>

    <!-- IMPROVED LOADER -->
    <div id="global-loader">
        <div class="cooking-container mb-4">
            <div class="steam-particle steam-1">üí®</div>
            <div class="steam-particle steam-2">üí®</div>
            <div class="steam-particle steam-3">üí®</div>
            <div class="absolute inset-0 bg-yellow-200 rounded-full blur-xl opacity-40 animate-pulse"></div>
            <div class="cooking-pan">üç≥</div>
        </div>
        <h2 class="text-2xl font-black text-gray-800 tracking-wider">KAPRAO<span class="text-yellow-500">52</span></h2>
        <p id="loader-text" class="text-sm text-gray-500 mt-2 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡πâ‡∏≤‡∏ô...</p>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 z-[100] bg-black/30 backdrop-blur-sm flex items-center justify-center p-6 stagger-item">
        <div class="glass-heavy rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden border border-white/50">
            <button onclick="closeWelcome()" class="btn-bounce absolute top-4 right-4 z-50 w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-all">
                <i class="fas fa-times text-sm"></i>
            </button>
            <div class="relative z-10">
                <div class="w-24 h-24 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-4 text-5xl shadow-sm border border-yellow-100 animate-bounce-slow">
                    üéüÔ∏è
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î!</h2>
                <p class="text-gray-600 mb-6 leading-relaxed text-sm">
                    <span class="font-bold text-indigo-500 text-base">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á!</span><br>
                    ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ (‡∏ô‡πâ‡∏≠‡∏¢‡πÜ) ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô<br>
                    ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ Order ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö<br>
                    <span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded font-bold border border-yellow-200">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•</span><br>
                    ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! üéÅ
                </p>
                <div class="flex flex-col gap-3">
                      <button onclick="requestNotifPermission()" class="btn-bounce w-full bg-white text-indigo-500 font-bold py-3 rounded-xl shadow-sm border border-indigo-100 transition-all text-sm hover:bg-indigo-50" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏´‡∏ß‡∏¢">
                        <i class="fas fa-bell mr-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏´‡∏ß‡∏¢
                    </button>
                    <button onclick="closeWelcome()" class="btn-bounce w-full btn-gradient-purple text-white font-bold py-4 rounded-xl shadow-lg transition-all text-lg hover:scale-[1.02]" aria-label="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
                        ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢! ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î üé∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Modal -->
    <div id="avatar-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[120] hidden transition-opacity opacity-0 flex items-center justify-center p-6">
        <div class="glass-heavy rounded-[2rem] p-6 max-w-sm w-full shadow-2xl stagger-item border border-white/60 relative">
            <button onclick="closeAvatarModal()" class="btn-bounce absolute top-4 right-4 z-50 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-all">
                <i class="fas fa-times text-sm"></i>
            </button>
            <h3 class="text-xl font-bold text-center mb-4 text-gray-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß üë§</h3>
            <div class="grid grid-cols-4 gap-4 mb-6" id="avatar-grid"></div>
            <div class="mb-6">
                 <label class="text-sm font-bold text-gray-600 mb-2 block pl-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üí¨</label>
                 <input type="text" id="pet-name-input" maxlength="12" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-center font-bold text-indigo-600 focus:border-indigo-500 outline-none transition-all placeholder-gray-400">
            </div>
            <button onclick="closeAvatarModal()" class="btn-bounce w-full btn-gradient text-white font-bold py-3 rounded-xl shadow-lg transition-all text-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <!-- Main Header -->
    <div class="px-6 pt-6 pb-2 bg-transparent relative z-10">
        <div class="flex justify-between items-start mb-6">
            <div class="flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-1">
                    <p id="greeting-text" class="text-xs text-gray-500 font-medium">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ?</p>
                    <button id="line-login-btn" onclick="handleLogin()" class="hidden bg-[#06C755] hover:bg-[#05b34c] text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm transition-all flex items-center gap-1 btn-bounce">
                        <i class="fab fa-line"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
                <h1 class="text-4xl sm:text-5xl font-black leading-none tracking-tighter mb-2 relative z-10 pt-1 drop-shadow-sm whitespace-nowrap flex items-baseline">
                    <span class="text-gray-800">KAPRAO</span>
                    <span class="text-yellow-500 ml-1">52</span>
                </h1>
            </div>
            <div class="flex flex-col items-center">
                 <div id="header-avatar-btn" onclick="openAvatarModal()" class="btn-bounce w-24 h-24 rounded-full bg-white border-2 border-gray-100 shadow-md flex items-center justify-center relative cursor-pointer overflow-hidden hover:border-yellow-400 transition-colors">
                      <img id="avatar-img" src="" class="w-full h-full object-cover">
                      <div class="absolute bottom-0 right-0 bg-indigo-500 rounded-full w-7 h-7 flex items-center justify-center shadow-md border-2 border-white z-30" style="bottom: 5px; right: 5px;">
                          <i class="fas fa-pen text-xs text-white"></i>
                      </div>
                </div>
                <!-- VIP BADGE -->
                <div class="flex items-center gap-2 mt-3">
                    <p id="avatar-name-display" class="text-xs font-round font-bold text-indigo-500 tracking-wide bg-white px-4 py-1 rounded-full shadow-sm border border-gray-100 text-gray-700">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                    <div id="vip-badge" class="hidden text-[10px] font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full border border-yellow-200 vip-glow">VIP</div>
                </div>
            </div>
        </div>

        <div class="glass-panel p-4 rounded-xl shadow-sm mb-1 flex items-center gap-4 stagger-item" style="animation-delay: 0.1s;">
            <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-inner border-2 border-yellow-100 bg-gradient-to-br from-yellow-50 to-orange-50">ü™ô</div>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-gray-700">KAPRAO POINTS</span>
                    <button onclick="openPointsHistory()" class="px-3 py-1.5 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-xs font-medium rounded-lg shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 flex items-center gap-1">
                        üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    </button>
                </div>
                <div class="flex items-baseline gap-2">
                    <span id="points-count" class="text-3xl font-black text-yellow-500">0</span>
                    <span class="text-sm text-gray-400">‡∏û‡∏≠‡∏¢‡∏ï‡πå</span>
                </div>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] text-gray-400">100 ‡∏û‡∏≠‡∏¢‡∏ï‡πå ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡πÄ‡∏á‡∏¥‡∏ô 10 ‡∏ö‡∏≤‡∏ó</span>
                    <button id="refresh-points-btn" onclick="manualRefreshPoints()" class="text-indigo-500 hover:text-indigo-700 p-1 transition-transform" aria-label="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏û‡∏≠‡∏¢‡∏ï‡πå">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 mt-2">
            <p class="text-[10px] text-gray-400">‡∏™‡∏∞‡∏™‡∏°‡∏û‡∏≠‡∏¢‡∏ï‡πå‡πÅ‡∏•‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°!</p>
            <div class="flex items-center gap-2">
                <button onclick="openMyTickets()" class="btn-bounce bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm flex items-center gap-2 text-xs font-bold text-gray-700 active:bg-gray-50 transition-all">
                    <span>üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                    <div id="unread-ticket-dot" class="w-2 h-2 bg-red-500 rounded-full hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto px-5 relative z-10">
        
        <!-- Randomizer Button -->
        <div class="mb-6">
            <button onclick="openRandomizer()" class="w-full btn-bounce bg-white border-2 border-dashed border-gray-300 rounded-2xl p-4 flex items-center justify-between group hover:border-yellow-400 transition-all shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="text-3xl animate-bounce-slow">üé≤</div>
                    <div class="text-left">
                        <h3 class="text-gray-800 font-bold text-sm group-hover:text-yellow-600 transition-colors">‡∏Ñ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å?</h3>
                        <p class="text-gray-400 text-xs">‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡πá‡∏î‡πÜ ‡πÉ‡∏´‡πâ</p>
                    </div>
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 group-hover:bg-yellow-400 group-hover:text-white transition-all">
                    <i class="fas fa-chevron-right text-xs"></i>
                </div>
            </button>
        </div>

        <!-- Search Button -->
        <div class="mb-3">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                     <button onclick="toggleSearch()" class="btn-bounce w-9 h-9 rounded-full bg-white border border-gray-200 shadow-sm flex items-center justify-center text-gray-500 hover:text-indigo-500 transition-colors">
                        <i class="fas fa-search text-xs"></i>
                     </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="scrollTabs(-100)" class="btn-bounce bg-white w-9 h-9 rounded-full flex items-center justify-center text-gray-400 hover:text-indigo-500 transition-all border border-gray-200 shadow-sm"><i class="fas fa-chevron-left text-xs"></i></button>
                    <button onclick="scrollTabs(100)" class="btn-bounce bg-white w-9 h-9 rounded-full flex items-center justify-center text-gray-400 hover:text-indigo-500 transition-all border border-gray-200 shadow-sm"><i class="fas fa-chevron-right text-xs"></i></button>
                </div>
            </div>
            
            <!-- Smart Search Bar -->
            <div id="search-container" class="hidden mb-4 animate-fade-in-down">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π, ‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤, ‡πÑ‡∏Ç‡πà)" 
                           class="w-full bg-white border-2 border-indigo-100 rounded-2xl py-3 pl-12 pr-10 text-sm font-bold text-gray-700 focus:border-indigo-500 focus:ring-0 shadow-sm transition-all"
                           onkeyup="handleSearch(this.value)">
                    <div class="absolute left-4 top-3.5 text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                    <button onclick="toggleSearch()" class="absolute right-3 top-2 bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Updated Tab Container with Curry Category -->
        <div id="tabs-container" class="sticky top-0 z-30 pt-2 pb-4 -mx-5 px-5 flex gap-3 snap-x scroll-smooth overflow-x-auto hide-scroll transition-all">
            <button onclick="switchCategory('favorites')" id="tab-favorites" class="category-pill category-pill-favorites category-pill-inactive snap-start">
                <span class="text-xl tab-icon">‚ù§Ô∏è</span><span class="text-xs font-bold">‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</span>
            </button>
            <button onclick="switchCategory('kaprao')" id="tab-kaprao" class="category-pill category-pill-active snap-start">
                <span class="text-xl tab-icon">üå∂Ô∏è</span><span class="text-xs">‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤</span>
            </button>
            <button onclick="switchCategory('tray')" id="tab-tray" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon">üç±</span><span class="text-xs font-bold">‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î</span>
            </button>
            <button onclick="switchCategory('garlic')" id="tab-garlic" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon">üßÑ</span><span class="text-xs">‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</span>
            </button>
             <button onclick="switchCategory('curry')" id="tab-curry" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon">ü•ò</span><span class="text-xs">‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á</span>
            </button>
            <button onclick="switchCategory('noodle')" id="tab-noodle" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon">üçú</span><span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô</span>
            </button>
            <button onclick="switchCategory('soup')" id="tab-soup" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon">üç≤</span><span class="text-xs">‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°</span>
            </button>
            <button onclick="switchCategory('others')" id="tab-others" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon">üç≥</span><span class="text-xs">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
            </button>
            <button onclick="switchCategory('dessert')" id="tab-dessert" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon">üç®</span><span class="text-xs">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</span>
            </button>
            <button onclick="switchCategory('promotion')" id="tab-promotion" class="category-pill category-pill-promotion snap-start">
                <span class="text-xl tab-icon">üßß</span><span class="text-xs font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
            </button>
        </div>

        <div class="mb-4 mt-2">
            <h3 id="section-title" class="font-bold text-gray-800 text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
        </div>

        <div id="dessert-msg" class="hidden mb-6 stagger-item">
            <div class="bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center text-center shadow-sm">
                <div class="text-3xl mb-2">üç® ‚ú®</div>
                <h4 class="font-bold text-indigo-500 text-sm">‡∏£‡∏≠‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà‡πÜ ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</h4>
                <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏î‡∏™‡∏£‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô</p>
            </div>
        </div>

        <div id="menu-grid" class="grid grid-cols-2 gap-4 mb-20" role="grid" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£"></div>
        
        <div class="text-center mt-12 mb-20 opacity-50">
            <p class="text-[10px] font-bold tracking-widest text-gray-400 uppercase">DEVELOPED BY SORAWIT THUNTHAKIJ | Version 23.0.0</p>
        </div>
    </div>
    
    <!-- Tickets Sheet -->
    <div id="tickets-modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden transition-opacity opacity-0" onclick="closeMyTickets()"></div>
    <div id="tickets-sheet" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-[111] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[70vh] flex flex-col safe-area-pb">
        <div class="w-full flex justify-center pt-4 pb-2"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
        <div class="px-6 py-2 border-b border-gray-100 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏´‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <button onclick="closeMyTickets()" class="btn-bounce w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times text-sm"></i></button>
        </div>
        <div id="tickets-list" class="flex-1 overflow-y-auto p-4 space-y-3 hide-scroll"></div>
    </div>

    <!-- Mini Cart -->
    <div id="mini-cart-bar" class="fixed bottom-[calc(2.5rem+env(safe-area-inset-bottom))] left-5 right-5 z-[60] hidden stagger-item">
        <div onclick="openCheckout()" class="btn-bounce bg-gray-900 text-white p-4 rounded-full shadow-2xl flex justify-between items-center cursor-pointer border border-gray-800">
            <div class="flex items-center gap-3 pl-2">
                <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-gray-900 font-bold shadow-lg" id="mini-count">0</div>
                <div class="flex flex-col">
                    <span class="text-xs text-gray-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                    <span class="font-bold text-lg leading-none text-indigo-300" id="mini-total">0 ‡∏ø</span>
                </div>
            </div>
            <div class="flex items-center gap-2 pr-4 text-indigo-300 font-bold text-sm">
                <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>

    <!-- Checkout Sheet -->
    <div id="checkout-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0" onclick="closeCheckout()"></div>
    <div id="checkout-sheet" class="fixed bottom-0 w-full h-[95vh] flex flex-col max-w-md mx-auto z-[70] transform translate-y-full transition-transform duration-300 bg-gray-50/95 backdrop-blur-xl rounded-t-[2rem] overflow-hidden shadow-2xl border-t border-white/20">
        <div class="flex-none pt-5 pb-3 px-6 bg-white border-b border-gray-100 shadow-sm relative z-20">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-black text-gray-800 leading-none">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                    <p class="text-xs text-gray-400 mt-1 font-medium">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡πâ‡∏≤‡∏ö</p>
                </div>
                <button onclick="closeCheckout()" class="btn-bounce w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </div>
        <div id="checkout-scrollable" class="flex-1 overflow-y-auto hide-scroll p-5 space-y-5 pb-32">
            <div id="order-id-banner" class="hidden"></div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2"><i class="fas fa-utensils"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                <div id="cart-list-container" class="space-y-4"></div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2"><i class="fas fa-user"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á</h3>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-pen text-indigo-400"></i></div>
                    <input type="text" id="user-name" maxlength="20" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / Note ‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô..." class="block w-full pl-10 pr-3 py-3 border-2 border-gray-100 rounded-xl leading-5 bg-gray-50 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-indigo-500 focus:ring-0 transition-colors sm:text-sm font-bold text-gray-700">
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2"><i class="fas fa-tags"></i> ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á & ‡∏û‡∏≠‡∏¢‡∏ï‡πå</h3>
                <div class="flex gap-2 mb-3">
                    <div id="code-input-container" class="flex-1 bg-gray-50 rounded-xl px-3 py-2 flex items-center gap-2 border border-gray-100">
                        <i class="fas fa-ticket-alt text-gray-400" id="code-icon"></i>
                        <input type="text" id="discount-code" placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤" class="bg-transparent w-full text-sm outline-none text-gray-800 placeholder:text-gray-400 uppercase font-bold">
                    </div>
                    <button onclick="applyDiscount()" id="btn-apply-code" class="btn-bounce bg-gray-800 text-white font-bold px-4 rounded-xl text-xs shadow-lg hover:bg-gray-700 transition-all">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
                </div>
                <p id="discount-msg" class="text-[10px] font-medium text-gray-500 pl-1 mb-3 min-h-[1.25rem]"></p>
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-3 border border-yellow-100 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2 relative z-10">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-white shadow-sm font-bold text-xs"><i class="fas fa-star"></i></div>
                            <div>
                                <div class="text-[10px] text-yellow-700 font-bold uppercase tracking-wider">Kaprao Points</div>
                                <div class="text-xs font-bold text-gray-800" id="user-points-balance">‡∏°‡∏µ <span id="available-points">0</span> ‡πÅ‡∏ï‡πâ‡∏°</div>
                            </div>
                        </div>
                        <button id="points-toggle-btn" onclick="togglePointsUsage()" class="text-[10px] bg-white text-yellow-600 border border-yellow-200 px-3 py-1.5 rounded-lg font-bold shadow-sm active:scale-95 transition-transform">‡πÅ‡∏•‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                    </div>
                    <div id="points-controls-container" class="hidden pt-2 border-t border-yellow-200/50 mt-2 relative z-10 animate-fade-in-down">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] text-yellow-700">‡πÉ‡∏ä‡πâ: <span id="points-used-display" class="font-bold text-indigo-600">0</span> ‡∏û‡∏≠‡∏¢‡∏ï‡πå</span>
                            <span class="text-xs font-bold text-red-500">‡∏•‡∏î <span id="points-discount-display">0</span> ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        <div class="points-range-container mb-2">
                            <input type="range" id="points-range" min="0" max="100" value="0" step="10" class="points-range w-full h-1.5 bg-yellow-200 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                            <div class="flex justify-between text-[9px] text-yellow-600 mt-1"><span>0</span><span id="points-max">100</span></div>
                        </div>
                        <div class="flex gap-2">
                            <input type="hidden" id="points-input" value="0">
                            <div class="flex-1 text-[9px] text-yellow-600 flex items-center justify-end">*100 ‡πÅ‡∏ï‡πâ‡∏° = 10 ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-400 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between text-gray-500"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Subtotal)</span><span id="summary-subtotal" class="font-medium">0.-</span></div>
                    <div id="discount-summary" class="flex justify-between text-green-500 hidden"><span><i class="fas fa-ticket-alt mr-1"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î</span><span class="font-bold">-0.-</span></div>
                    <div id="points-summary" class="flex justify-between text-yellow-500 hidden"><span><i class="fas fa-coins mr-1"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏≠‡∏¢‡∏ï‡πå</span><span class="font-bold">-0.-</span></div>
                    <div class="border-t border-gray-100 my-2 pt-2 flex justify-between items-end"><span class="font-bold text-gray-800 text-lg">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span id="summary-grand-total" class="font-black text-2xl text-indigo-600 leading-none">0.-</span></div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-100 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] safe-area-pb-plus z-30">
            <button onclick="submitOrderToLine()" id="btn-submit-order" class="btn-bounce w-full bg-gradient-to-r from-gray-900 to-gray-800 text-white font-bold text-lg py-4 rounded-2xl shadow-xl shadow-gray-300 flex justify-between items-center px-6 group hover:shadow-2xl transition-all">
                <span class="flex items-center gap-2 text-sm font-medium opacity-80"><i class="fab fa-line text-green-400 text-lg"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
                <div class="flex items-center gap-2 group-active:scale-95 transition-transform"><span>‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢</span><i class="fas fa-arrow-right bg-white/20 rounded-full w-6 h-6 flex items-center justify-center text-xs"></i></div>
            </button>
        </div>
    </div>

    <!-- Points History Modal -->
    <div id="points-history-modal" class="fixed inset-0 z-[130] bg-black/30 backdrop-blur-sm flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-[2rem] p-1 w-full max-w-sm shadow-2xl relative overflow-hidden border border-gray-200">
            <div class="bg-white/95 backdrop-blur-sm rounded-[1.8rem] p-6 text-center relative z-10">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm border-4 border-white">ü™ô</div>
                <h2 class="text-2xl font-black text-gray-800 mb-1">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏≠‡∏¢‡∏ï‡πå</h2>
                <p class="text-indigo-500 font-bold text-sm mb-4">KAPRAO POINTS HISTORY</p>
                <div id="points-history-list" class="max-h-60 overflow-y-auto mb-4">
                    <div class="text-center text-gray-400 py-8"><i class="fas fa-history text-3xl mb-2 opacity-30"></i><p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå</p></div>
                </div>
                <button onclick="closePointsHistory()" class="btn-bounce w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all border-2 border-indigo-500">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0" onclick="closeModal()"></div>
    <div id="modal-content" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-[70] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[85vh] flex flex-col touch-pan-y safe-area-pb">
        <div id="modal-drag-handle" class="w-full flex justify-center pt-4 pb-2 cursor-grab active:cursor-grabbing z-50"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
        <button onclick="closeModal()" class="btn-bounce absolute top-4 right-4 z-50 close-button w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times text-sm"></i></button>

        <div id="modal-scroll-area" class="flex-1 overflow-y-auto hide-scroll px-6 pb-24 pt-4">
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-6xl shadow-sm border-4 border-gray-100"><span id="modal-icon">üçú</span></div>
            </div>
            <div class="text-center mb-8">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-1 font-round">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h3>
                <div class="flex justify-center items-center gap-2">
                    <span id="modal-kcal" class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-bold transition-all">0 kcal</span>
                    <span class="text-gray-300">|</span>
                    <span id="modal-price" class="text-xl font-bold text-indigo-500">50</span>
                    <span class="text-sm text-gray-400">‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>
            <div class="flex items-center justify-center gap-6 mb-6">
                <button onclick="adjustQty(-1)" class="btn-bounce w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center font-bold shadow-sm border border-gray-200 active:bg-gray-200 transition-all text-lg">-</button>
                <span id="modal-qty" class="text-2xl font-bold text-gray-800 w-8 text-center">1</span>
                <button onclick="adjustQty(1)" class="btn-bounce w-12 h-12 rounded-full btn-gradient text-white flex items-center justify-center font-bold shadow-md active:scale-95 transition-all text-lg">+</button>
            </div>
            <div id="modal-meat-section" class="mb-6 hidden">
                <h4 class="font-bold text-gray-700 mb-3 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scroll p-1" id="meat-options-container"></div>
            </div>
            <div id="tray-options-container" class="mb-6 hidden"></div>
            <div class="mb-6" id="addons-section">
                <h4 class="font-bold text-gray-700 mb-3 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢</h4>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 hover:border-yellow-400 cursor-pointer transition-all has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 btn-bounce shadow-sm">
                        <div class="flex items-center gap-3"><span class="text-sm font-medium text-gray-700">üíé ‡∏û‡∏¥‡πÄ‡∏®‡∏©</span></div>
                        <div class="flex items-center gap-3"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-special" class="accent-yellow-500 w-5 h-5 rounded" value="10"></div>
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">üç≥ ‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaikhon" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">ü•ö ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaidao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">ü•û ‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaijiao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">‚ö´ ‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaiyiewma" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-white border border-gray-200 has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-gray-700">ü•ö ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaitom" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <h4 class="font-bold text-gray-700 mb-2 text-sm">Note</h4>
                <textarea id="modal-note" rows="2" maxlength="100" class="w-full bg-white border border-gray-200 rounded-2xl p-4 text-base text-gray-700 focus:ring-2 focus:ring-indigo-500 resize-none shadow-inner placeholder:text-gray-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î, ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢..."></textarea>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-100 rounded-t-[2rem] safe-area-pb-plus">
            <button onclick="addToCart()" class="btn-bounce w-full btn-gradient-purple text-white font-bold text-lg py-4 rounded-full shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
                <span>‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                <i class="fas fa-plus bg-white/20 rounded-full w-6 h-6 flex items-center justify-center text-xs"></i>
            </button>
        </div>
    </div>

    <!-- IMPROVED TOAST -->
    <div id="toast">
        <i id="toast-icon" class="fas fa-info-circle"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <div id="receipt-result-modal" class="fixed inset-0 z-[140] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 hidden">
        <div class="bg-transparent w-full max-w-sm flex flex-col items-center">
            <div class="bg-white p-2 rounded-lg shadow-2xl mb-4 overflow-hidden">
                <img id="receipt-result-img" class="w-full h-auto rounded" src="" alt="Receipt">
            </div>
            <div class="flex flex-col gap-2 w-full px-4">
                <button onclick="downloadReceiptImage()" class="btn-bounce bg-gradient-to-r from-yellow-400 to-orange-500 text-white w-full py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 text-lg">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </button>
                <p class="text-white/70 text-xs text-center mb-2">(‡∏´‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üì∏)</p>
                <button onclick="document.getElementById('receipt-result-modal').classList.add('hidden')" class="btn-bounce bg-white/20 hover:bg-white/30 text-white w-full py-3 rounded-xl font-bold border border-white/50 backdrop-blur-md">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <div id="receipt-capture">
        <div class="bg-white p-6 relative">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm relative overflow-hidden">
                    <img id="receipt-avatar-img" src="" class="w-full h-full object-cover" crossorigin="anonymous">
                </div>
                <h2 class="text-2xl font-black text-gray-800 tracking-wider">KAPRAO52</h2>
                <p class="text-[10px] text-gray-500 tracking-widest uppercase mt-1">Authentic Thai Street Food</p>
                <div class="mt-4 inline-block px-4 py-1 bg-gray-100 rounded-full border border-gray-200">
                    <p class="text-xs font-bold text-gray-600">RECEIPT / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</p>
                </div>
            </div>
            <div class="border-t-2 border-dashed border-gray-300 my-4"></div>
            <div class="flex justify-between items-center mb-1"><span class="text-xs text-gray-500">Order ID</span><span class="font-bold text-gray-800 tracking-wide receipt-id">KP-XX99</span></div>
            <div class="flex justify-between items-center mb-1"><span class="text-xs text-gray-500">Date</span><span class="font-medium text-xs text-gray-500 receipt-date">01/01/2024 12:00</span></div>
            <div class="flex justify-between items-center mb-4"><span class="text-xs text-gray-500">Customer</span><span class="font-bold text-sm text-gray-800 receipt-name">Customer</span></div>
            <div class="bg-gray-50 rounded-lg p-3 mb-4 space-y-2 receipt-items border border-gray-100"></div>
            <div class="space-y-1">
                <div class="flex justify-between text-xs text-gray-500"><span>Subtotal</span><span class="receipt-subtotal">0.-</span></div>
                <div class="flex justify-between text-xs text-green-600"><span>Discount</span><span class="receipt-discount">-0.-</span></div>
                <div class="flex justify-between items-end mt-2 pt-2 border-t border-gray-300">
                    <span class="font-bold text-gray-800">TOTAL</span>
                    <span class="font-black text-3xl text-indigo-600 receipt-total">0.-</span>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t-2 border-dotted border-gray-300 text-center">
                <div class="flex justify-center gap-1 text-2xl text-yellow-400 mb-2"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></div>
                <p class="text-[10px] text-gray-400">THANK YOU FOR YOUR ORDER</p>
                <div class="mt-4 flex justify-center opacity-50"><img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" class="w-16 h-16 mix-blend-multiply"></div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 h-4 bg-white" style="background: linear-gradient(45deg, transparent 33.333%, #F3F4F6 33.333%, #F3F4F6 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #F3F4F6 33.333%, #F3F4F6 66.667%, transparent 66.667%); background-size: 20px 40px; transform: translateY(10px);"></div>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = '2008781875-6whmY1cf'; 
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJLm7apFr5a6tZc1OcPUT84JATeVlVMs_cWiDs3cdh7BepP78OAs-TsF-2WqCRh9pj/exec'; 

        // --- GLOBAL UTILITIES & STATE ---
        let cart = [];
        let currentItem = null;
        let activeCategory = 'kaprao';
        let discountValue = 0;
        let modalQty = 1;
        let userStats = { points: 0 }; 
        let lottoHistory = []; 
        let isSubmitting = false; 
        let pointsRedeemed = 0;
        let isPointsActive = false; 
        let searchQuery = "";
        let favoriteItems = new Set();
        
        const addonIds = ['special', 'kaikhon', 'kaidao', 'kaijiao', 'kaitom', 'kaiyiewma'];
        const addonCalories = { 'special': 80, 'kaikhon': 150, 'kaidao': 120, 'kaijiao': 200, 'kaitom': 75, 'kaiyiewma': 100 };
        const KEYS = { USER: 'kaprao52_user', HISTORY: 'kaprao_lotto_history', STATS: 'kaprao_stats', VERSION: 'kaprao_ver', FAVORITES: 'kaprao_favorites' };
        
        // UPDATED VERSION
        const CURRENT_VERSION = '23.0.0'; 

        // --- CANVAS BACKGROUND & CONFETTI ---
        function initCanvasBackground() {
            const canvas = document.getElementById('bg-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let width, height;
            const bubbles = [];
            const icons = ['üçÉ', 'üå∂Ô∏è', 'üç≥', 'üßÑ', 'ü•ì'];
            let isTabActive = true;
            document.addEventListener('visibilitychange', () => { isTabActive = !document.hidden; });
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
            window.addEventListener('resize', resize); resize();
            class Bubble {
                constructor() { this.init(); }
                init() { this.icon = icons[Math.floor(Math.random() * icons.length)]; this.size = Math.random() * 20 + 20; this.x = Math.random() * width; this.y = height + this.size + (Math.random() * 100); this.speed = Math.random() * 0.5 + 0.2; this.opacity = Math.random() * 0.3 + 0.1; this.swingCounter = Math.random() * 10; this.rotation = Math.random() * 360; this.rotationSpeed = (Math.random() - 0.5) * 0.02; }
                draw() { ctx.save(); ctx.globalAlpha = this.opacity; ctx.font = `${this.size}px sans-serif`; ctx.translate(this.x, this.y); ctx.rotate(this.rotation); ctx.fillText(this.icon, -this.size/2, this.size/2); ctx.restore(); }
                update() { this.y -= this.speed; this.swingCounter += 0.02; this.x += Math.sin(this.swingCounter) * 0.5; this.rotation += this.rotationSpeed; if (this.y < -this.size) this.init(); this.draw(); }
            }
            for (let i = 0; i < 10; i++) bubbles.push(new Bubble());
            function animate() { if (!isTabActive) { requestAnimationFrame(animate); return; } ctx.clearRect(0, 0, width, height); bubbles.forEach(b => b.update()); requestAnimationFrame(animate); }
            animate();
        }

        // Confetti Function
        function confetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const pieces = [];
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
            for(let i=0; i<150; i++) {
                pieces.push({
                    x: window.innerWidth / 2, y: window.innerHeight / 2,
                    w: Math.random() * 10 + 5, h: Math.random() * 10 + 5,
                    vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20 - 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rot: Math.random() * 360, rotSpeed: (Math.random() - 0.5) * 10
                });
            }
            let animId;
            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                pieces.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.rot += p.rotSpeed;
                    if(p.y < canvas.height) active = true;
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
                    ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                });
                if(active) animId = requestAnimationFrame(loop);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            loop();
        }

        // --- GREETING LOGIC ---
        function updateGreeting() {
            const hour = new Date().getHours();
            let text = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ?";
            if (hour >= 5 && hour < 12) text = "‚òÄÔ∏è ‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå! ‡∏£‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?";
            else if (hour >= 12 && hour < 16) text = "üå§Ô∏è ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏¢‡∏≤‡∏°‡∏ö‡πà‡∏≤‡∏¢! ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢";
            else if (hour >= 16 && hour < 21) text = "üåÜ ‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! ‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÜ ‡∏Å‡∏¥‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞";
            else if (hour >= 21 || hour < 5) text = "üåô ‡∏´‡∏¥‡∏ß‡∏î‡∏∂‡∏Å‡πÜ ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡πÄ‡∏£‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü!";
            document.getElementById('greeting-text').innerText = text;
        }

        // --- DATA & LOGIC ---
        function calculateItemUnitPrice(item, options = {}) {
            let total = item.price;
            if (item.isTray) { total += (options.meatPrice || 0); total += (options.eggPrice || 0); }
            if (options.addons && options.addons.length > 0) { total += options.addons.length * 10; }
            return total;
        }

        const menuItems = [
            { id: 201, name: "Set 1: Solo Tray (‡∏•‡∏∏‡∏¢‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß)", price: 89, icon: "üì¶", category: "tray", reqMeat: false, isTray: true, trayType: 1, kcal: 750 },
            { id: 202, name: "Set 2: Buddy Tray (‡∏Ñ‡∏π‡πà‡∏´‡∏π)", price: 149, icon: "üç±", category: "tray", reqMeat: false, isTray: true, trayType: 2, kcal: 1400 },
            { id: 2, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ", price: 55, icon: "üéç", category: "kaprao", reqMeat: true, kcal: 350 },
            { id: 3, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö", price: 50, icon: "üê∑", category: "kaprao", reqMeat: false, kcal: 520 },
            { id: 4, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á", price: 50, icon: "ü•ì", category: "kaprao", reqMeat: false, kcal: 550 },
            { id: 5, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠", price: 50, icon: "ü•©", category: "kaprao", reqMeat: false, kcal: 600 },
            { id: 6, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤", price: 60, icon: "‚ö´", category: "kaprao", reqMeat: false, kcal: 650 },
            { id: 102, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "ü¶ê", category: "kaprao", reqMeat: false, kcal: 450, isNew: true },
            { id: 105, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà", price: 50, icon: "üêî", category: "kaprao", reqMeat: false, kcal: 450, isNew: true }, 
            { id: 108, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å", price: 60, icon: "ü¶ë", category: "kaprao", reqMeat: false, kcal: 480, isNew: true }, 
            
            { id: 301, name: "‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏´‡∏°‡∏π‡∏ä‡∏¥‡πâ‡∏ô(‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠)", price: 50, icon: "ü•©", category: "curry", reqMeat: false, kcal: 550, isNew: true },
            { id: 302, name: "‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö", price: 50, icon: "üê∑", category: "curry", reqMeat: false, kcal: 520, isNew: true },
            { id: 303, name: "‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á", price: 50, icon: "ü•ì", category: "curry", reqMeat: false, kcal: 540, isNew: true },
            { id: 304, name: "‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "ü¶ê", category: "curry", reqMeat: false, kcal: 480, isNew: true },
            { id: 305, name: "‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å", price: 60, icon: "ü¶ë", category: "curry", reqMeat: false, kcal: 470, isNew: true },
            { id: 306, name: "‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡πÑ‡∏Å‡πà", price: 50, icon: "üêî", category: "curry", reqMeat: false, kcal: 450, isNew: true },

            { id: 10, name: "‡∏°‡∏≤‡∏°‡πà‡∏≤‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤", price: 50, icon: "üçú", category: "noodle", reqMeat: true, kcal: 450 },
            { id: 1, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô", price: 55, icon: "üçù", category: "noodle", reqMeat: true, kcal: 400 },
            { id: 7, name: "‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üßÑ", category: "garlic", reqMeat: false, kcal: 500 },
            { id: 8, name: "‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçñ", category: "garlic", reqMeat: false, kcal: 580 },
            { id: 9, name: "‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçò", category: "garlic", reqMeat: false, kcal: 530 },
            { id: 103, name: "‡∏Å‡∏∏‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 60, icon: "üç§", category: "garlic", reqMeat: false, kcal: 480, isNew: true },
            { id: 101, name: "‡∏ï‡πâ‡∏°‡∏à‡∏∑‡∏î‡πÑ‡∏Ç‡πà‡∏ô‡πâ‡∏≥ (‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß)", price: 40, icon: "ü•ò", category: "soup", reqMeat: false, kcal: 350, isNew: true },
            { id: 11, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏ú‡∏≤", price: 40, icon: "üå∂Ô∏è", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 450 },
            { id: 12, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô", price: 40, icon: "üçö", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 380 },
            { id: 13, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡∏¥‡∏Å‡∏™‡∏î", price: 50, icon: "ü•ò", category: "others", reqMeat: false, kcal: 420 },
            { id: 14, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß 3 ‡∏ü‡∏≠‡∏á", price: 50, icon: "üç≥", category: "others", reqMeat: false, kcal: 480 },
            { id: 15, name: "‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üéã", category: "others", reqMeat: true, kcal: 300 },
            { id: 104, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "üç≥", category: "others", reqMeat: false, kcal: 550, isNew: true },
            { id: 106, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 520, isNew: true }, 
            { id: 107, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏´‡∏°‡∏π‡∏ä‡∏¥‡πâ‡∏ô (‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠)", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 600, isNew: true }, 
            { id: 20, name: "‡πÄ‡∏â‡∏≤‡∏Å‡πä‡∏ß‡∏¢‡∏ô‡∏°‡∏™‡∏î", price: 30, icon: "üßä", category: "dessert", reqMeat: false, kcal: 150 },
            { id: 21, name: "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", price: 25, icon: "üçå", category: "dessert", reqMeat: false, kcal: 220 },
        ];
        
        const promotions = [
            { code: "SAVE10", title: "Set ‡∏≠‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏° (Value) ü•â", desc: "‡∏Ñ‡∏£‡∏ö 150.- ‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó", minOrder: 150, type: "discount", value: 10, color: "bg-orange-400", icon: "ü•°" },
            { code: "SAVE25", title: "Set ‡∏¢‡∏Å‡πÅ‡∏Å‡πä‡∏á (Gang) ü•à", desc: "‡∏Ñ‡∏£‡∏ö 300.- ‡∏•‡∏î 25 ‡∏ö‡∏≤‡∏ó", minOrder: 300, type: "discount", value: 25, color: "bg-blue-500", icon: "üõµ" },
            { code: "SAVE50", title: "Set ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏° (Grand) ü•á", desc: "‡∏Ñ‡∏£‡∏ö 500.- ‡∏•‡∏î 50 ‡∏ö‡∏≤‡∏ó", minOrder: 500, type: "discount", value: 50, color: "bg-brand-purple", icon: "üè¢" },
            { code: "SORRY20", title: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å", desc: "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©", minOrder: 0, type: "discount", value: 20, isHidden: true },
            { code: "SORRY30", title: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å", desc: "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©", minOrder: 0, type: "discount", value: 30, isHidden: true },
        ];

        let isSyncing = false;
        let currentOpenModal = null;
        function pushModalState(modalId) { currentOpenModal = modalId; window.history.pushState({ modal: modalId }, null, ""); lockScroll(); }
        function lockScroll() { document.body.classList.add('scroll-locked'); }
        function unlockScroll() { document.body.classList.remove('scroll-locked'); }

        window.addEventListener('popstate', function(event) {
            if (currentOpenModal) {
                if (currentOpenModal === 'menu') closeModal(true);
                else if (currentOpenModal === 'checkout') closeCheckout(true);
                else if (currentOpenModal === 'tickets') closeMyTickets(true);
                else if (currentOpenModal === 'avatar') closeAvatarModal(true);
                else if (currentOpenModal === 'points-history') closePointsHistory(true);
                currentOpenModal = null;
                unlockScroll();
            }
        });

        // SOUND EFFECTS - DISABLED (No more annoying sounds!)
        // The previous version had loud sound effects from soundjay.com
        // Now we only use haptic feedback for better UX
        
        function playSound(type) {
            // Sound effects disabled - no more annoying noises!
            // Only haptic feedback is used
        }
        
        function triggerHaptic(intensity = 'light') { 
            if (navigator.vibrate) navigator.vibrate(intensity === 'heavy' ? [80, 40, 80] : 15); 
        }

        function showGlobalLoader(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") { 
            document.getElementById('loader-text').innerText = text; 
            document.getElementById('global-loader').classList.remove('loader-hidden'); 
        }
        function hideGlobalLoader() { 
            document.getElementById('global-loader').classList.add('loader-hidden'); 
        }
        
        function requestNotifPermission() {
            if (!("Notification" in window)) { showToast("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", 'warning'); return; }
            Notification.requestPermission().then(permission => { 
                if (permission === "granted") showToast("‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üîî", 'success'); 
            });
        }
        
        // IMPROVED TOAST NOTIFICATION
        let toastTimeout;
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast'); 
            const msg = document.getElementById('toast-msg'); 
            const icon = document.getElementById('toast-icon');
            
            // Clear existing timeout
            if (toastTimeout) clearTimeout(toastTimeout);
            
            // Remove all type classes
            toast.className = '';
            
            // Set icon and type
            switch(type) {
                case 'success': 
                    icon.className = 'fas fa-check-circle'; 
                    toast.classList.add('toast-success');
                    break;
                case 'error': 
                    icon.className = 'fas fa-exclamation-circle'; 
                    toast.classList.add('toast-error');
                    break;
                case 'warning': 
                    icon.className = 'fas fa-exclamation-triangle'; 
                    toast.classList.add('toast-warning');
                    break;
                default: 
                    icon.className = 'fas fa-info-circle'; 
                    toast.classList.add('toast-info');
            }
            
            msg.innerText = message; 
            toast.classList.add('show');
            triggerHaptic(type === 'error' ? 'heavy' : 'light'); 
            
            toastTimeout = setTimeout(() => { 
                toast.classList.remove('show'); 
            }, 3500);
        }
        
        setTimeout(() => hideGlobalLoader(), 3000);

        const avatarOptions = ['https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Dog%20face/3D/dog_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Cat%20face/3D/cat_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Tiger%20face/3D/tiger_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Lion/3D/lion_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Monkey%20face/3D/monkey_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Elephant/3D/elephant_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Pig%20face/3D/pig_face_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Chicken/3D/chicken_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Panda/3D/panda_3d.png', 'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Frog/3D/frog_3d.png'];
        let userAvatar = { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î', userId: null };

        function openAvatarModal() {
            pushModalState('avatar'); 
            const grid = document.getElementById('avatar-grid'); grid.innerHTML = '';
            avatarOptions.forEach(imgSrc => {
                const el = document.createElement('div'); el.className = `avatar-option ${userAvatar.image === imgSrc ? 'avatar-selected' : ''}`;
                el.innerHTML = `<img src="${imgSrc}" alt="avatar">`; el.onclick = () => selectAvatar(imgSrc); grid.appendChild(el);
            });
            document.getElementById('pet-name-input').value = userAvatar.name || '';
            const modal = document.getElementById('avatar-modal'); modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        function closeAvatarModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'avatar') { history.back(); return; }
            const modal = document.getElementById('avatar-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300);
            const nameInput = document.getElementById('pet-name-input').value.trim();
            if(nameInput) { userAvatar.name = escapeHtml(nameInput); const orderNameInput = document.getElementById('user-name'); if(orderNameInput) orderNameInput.value = userAvatar.name; }
            saveToLS(); updateAvatarDisplay(); currentOpenModal = null; unlockScroll();
        }
        function selectAvatar(imgSrc) {
            userAvatar.image = imgSrc;
            document.querySelectorAll('.avatar-option').forEach(opt => { const img = opt.querySelector('img'); if (img && img.src === imgSrc) opt.classList.add('avatar-selected'); else opt.classList.remove('avatar-selected'); });
            triggerHaptic();
        }
        function updateAvatarDisplay() {
            document.getElementById('avatar-img').src = userAvatar.image;
            document.getElementById('avatar-name-display').innerText = userAvatar.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
        }
        function closeWelcome() {
            const modal = document.getElementById('welcome-modal'); modal.style.opacity = '0'; modal.style.transition = 'opacity 0.5s ease';
            setTimeout(() => modal.classList.add('hidden'), 500); triggerHaptic();
        }

        function calculatePoints(netTotal) {
            if (netTotal < 60) return 0; if (netTotal < 100) return 10; if (netTotal < 150) return 20; if (netTotal < 200) return 30; if (netTotal < 250) return 40; if (netTotal < 300) return 50; return 60;
        }

        function updatePointsDisplay() {
            const points = userStats.points || 0;
            document.getElementById('points-count').innerText = points; document.getElementById('available-points').innerText = points; updateCheckoutPointsInfo();
        }
        function updateCheckoutPointsInfo() {
            const subtotal = cart.reduce((sum, i) => sum + i.price, 0); const userPointsBalance = document.getElementById('user-points-balance');
            if (userPointsBalance) userPointsBalance.innerHTML = `‡∏°‡∏µ <span id="available-points">${userStats.points || 0}</span> ‡πÅ‡∏ï‡πâ‡∏°`;
        }

        function togglePointsUsage() {
            const controlsContainer = document.getElementById('points-controls-container'); const toggleBtn = document.getElementById('points-toggle-btn'); const userPoints = userStats.points || 0;
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            const code = document.getElementById('discount-code').value.trim().toUpperCase(); const promo = promotions.find(p => p.code === code); let discountFromCode = 0;
            if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value;
            let netTotalBeforePoints = Math.max(0, subtotal - discountFromCode);

            if (controlsContainer.classList.contains('hidden')) {
                if (userPoints < 100) { showToast(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${userPoints} ‡∏û‡∏≠‡∏¢‡∏ï‡πå (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 100 ‡∏û‡∏≠‡∏¢‡∏ï‡πå)`, 'error'); return; }
                controlsContainer.classList.remove('hidden'); isPointsActive = true;
                toggleBtn.innerHTML = '<i class="fas fa-times mr-2"></i> ‡∏õ‡∏¥‡∏î'; toggleBtn.classList.remove('bg-white', 'text-yellow-600', 'border-yellow-200'); toggleBtn.classList.add('bg-red-500', 'text-white', 'border-red-500');
                const maxPointsByPrice = netTotalBeforePoints * 10; const maxPoints = Math.min(userPoints, maxPointsByPrice); const finalMaxPoints = Math.floor(maxPoints / 100) * 100;
                document.getElementById('points-range').max = finalMaxPoints; document.getElementById('points-max').textContent = finalMaxPoints; document.getElementById('points-input').max = finalMaxPoints;
                const initialPoints = finalMaxPoints; document.getElementById('points-range').value = initialPoints; document.getElementById('points-input').value = initialPoints;
                updatePointsDiscount(initialPoints); showToast('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } else {
                controlsContainer.classList.add('hidden'); isPointsActive = false; pointsRedeemed = 0;
                toggleBtn.innerHTML = '‡πÅ‡∏•‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'; toggleBtn.classList.remove('bg-red-500', 'text-white', 'border-red-500'); toggleBtn.classList.add('bg-white', 'text-yellow-600', 'border-yellow-200');
                updateTotalSummary(); showToast('‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'info');
            }
            triggerHaptic();
        }

        function updatePointsFromUI(value) {
            const userPoints = userStats.points || 0; let pointsValue = parseInt(value) || 0; pointsValue = Math.round(pointsValue / 100) * 100;
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0); const code = document.getElementById('discount-code').value.trim().toUpperCase(); const promo = promotions.find(p => p.code === code); let discountFromCode = 0; if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value; let netTotalBeforePoints = Math.max(0, subtotal - discountFromCode);
            const maxPointsByPrice = netTotalBeforePoints * 10; const finalMax = Math.min(userPoints, maxPointsByPrice);
            if (pointsValue > finalMax) pointsValue = Math.floor(finalMax / 100) * 100;
            document.getElementById('points-range').value = pointsValue; document.getElementById('points-input').value = pointsValue; updatePointsDiscount(pointsValue);
        }

        function updatePointsDiscount(pointsAmount) {
            pointsAmount = pointsAmount || parseInt(document.getElementById('points-input').value) || 0;
            const discountAmount = Math.floor(pointsAmount / 100) * 10;
            const discountDisplay = document.getElementById('points-discount-display'); if (discountDisplay) discountDisplay.textContent = `${discountAmount}`;
            const usedDisplay = document.getElementById('points-used-display'); if (usedDisplay) usedDisplay.textContent = `${pointsAmount}`;
            pointsRedeemed = pointsAmount; discountValue = discountAmount; updateTotalSummary();
        }

        function resetPointsDiscount() {
            const controlsContainer = document.getElementById('points-controls-container'); const toggleBtn = document.getElementById('points-toggle-btn');
            if (controlsContainer) controlsContainer.classList.add('hidden'); isPointsActive = false; pointsRedeemed = 0;
            if (toggleBtn) { toggleBtn.innerHTML = '‡πÅ‡∏•‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'; toggleBtn.classList.remove('bg-red-500', 'text-white', 'border-red-500'); toggleBtn.classList.add('bg-white', 'text-yellow-600', 'border-yellow-200'); }
            updateTotalSummary();
        }

        function openPointsHistory() {
            pushModalState('points-history');
            const modal = document.getElementById('points-history-modal'); modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10);
            const historyList = document.getElementById('points-history-list'); historyList.innerHTML = '';
            const history = userStats.history || [];
            if (history.length === 0) { historyList.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fas fa-history text-3xl mb-2 opacity-30"></i><p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå</p></div>`; } 
            else {
                history.forEach(item => {
                    const dateObj = new Date(item.date); const dateStr = `${getStandardDate(dateObj)} ${formatTime(dateObj)}`;
                    let icon, title, amountClass, amountSign, bgClass;
                    if (item.type === 'earn') { icon = 'fa-plus-circle'; title = '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏≠‡∏¢‡∏ï‡πå'; amountClass = 'text-green-500'; amountSign = '+'; bgClass = 'bg-white border-gray-200'; } 
                    else { icon = 'fa-minus-circle'; title = '‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î'; amountClass = 'text-red-500'; amountSign = '-'; bgClass = 'bg-white border-gray-200'; }
                    const el = document.createElement('div'); el.className = `flex justify-between items-center p-3 mb-2 rounded-xl border ${bgClass}`;
                    el.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center ${amountClass}"><i class="fas ${icon}"></i></div><div class="text-left"><div class="text-xs font-bold text-gray-800">${title}</div><div class="text-[10px] text-gray-400">${dateStr} #${item.orderId ? item.orderId.slice(-4) : 'PROMO'}</div></div></div><div class="font-black text-lg ${amountClass}">${amountSign}${item.amount}</div>`;
                    historyList.appendChild(el);
                });
            }
        }
        function closePointsHistory(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'points-history') { history.back(); return; }
            const modal = document.getElementById('points-history-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300);
            currentOpenModal = null; unlockScroll();
        }

        function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function getStandardDate(dateObj) { if(!dateObj) dateObj = new Date(); const d = dateObj.getDate().toString().padStart(2, '0'); const m = (dateObj.getMonth() + 1).toString().padStart(2, '0'); const y = dateObj.getFullYear(); return `${d}/${m}/${y}`; }
        function formatTime(dateObj) { if(!dateObj) dateObj = new Date(); const h = dateObj.getHours().toString().padStart(2, '0'); const m = dateObj.getMinutes().toString().padStart(2, '0'); return `${h}:${m}`; }

        function loadUserDataSafe() {
            try {
                const savedUser = localStorage.getItem(KEYS.USER);
                if (savedUser) { const u = JSON.parse(savedUser); cart = u.cart || []; userAvatar = u.avatar || { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î' }; if(u.name) document.getElementById('user-name').value = u.name; if (u.userId) userAvatar.userId = u.userId; }
                const savedHistory = localStorage.getItem(KEYS.HISTORY); if (savedHistory) lottoHistory = JSON.parse(savedHistory) || []; if (!Array.isArray(lottoHistory)) lottoHistory = [];
                const savedStats = localStorage.getItem(KEYS.STATS); if (savedStats) userStats = JSON.parse(savedStats) || { points: 0 };
                const savedFav = localStorage.getItem(KEYS.FAVORITES); if (savedFav) favoriteItems = new Set(JSON.parse(savedFav));
            } catch (error) { userStats = { points: 0 }; lottoHistory = []; }
        }

        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        const saveToLS = debounce(function() {
            let safeNameElement = document.getElementById('user-name'); let safeName = safeNameElement ? escapeHtml(safeNameElement.value) : '';
            let oldData = {}; try { oldData = JSON.parse(localStorage.getItem(KEYS.USER)) || {}; } catch (e) {}
            const userState = { ...oldData, cart: cart, name: safeName, avatar: userAvatar };
            localStorage.setItem(KEYS.USER, JSON.stringify(userState));
            localStorage.setItem(KEYS.FAVORITES, JSON.stringify([...favoriteItems]));
        }, 500);
        
        async function checkForUpdate() {
            try {
                const response = await fetch(window.location.href + '?t=' + new Date().getTime()); const text = await response.text();
                const serverVerMatch = text.match(/const CURRENT_VERSION = '([\d.]+)'/);
                if (serverVerMatch && serverVerMatch[1]) { const serverVer = serverVerMatch[1]; if (serverVer !== CURRENT_VERSION) window.location.reload(); }
            } catch (err) {}
        }

        async function syncTicketHistory(userId) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getHistory&userId=' + userId); if (!response.ok) throw new Error('Network response was not ok');
                const serverTickets = await response.json(); if (!Array.isArray(serverTickets) || serverTickets.length === 0) return;
                let updated = false;
                serverTickets.forEach(serverT => {
                    const exists = lottoHistory.some(localT => localT.id === serverT.id);
                    if (!exists) {
                        const drawDateObj = getNextDrawDate(); 
                        const newTicket = { id: serverT.id, number: serverT.id.slice(-2), date: serverT.date, drawDate: getStandardDate(drawDateObj), drawDateTimestamp: drawDateObj.getTime(), timestamp: Date.now(), price: serverT.price, status: 'pending', checkedDate: null, items: [{ name: serverT.itemsStr, price: serverT.price }], customerName: 'Synced' };
                        lottoHistory.push(newTicket); updated = true;
                    }
                });
                if (updated) { lottoHistory.sort((a, b) => b.timestamp - a.timestamp); if(lottoHistory.length > 20) lottoHistory = lottoHistory.slice(0, 20); localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory)); updateTicketBadge(); autoCheckLottery(); }
            } catch (e) { console.error("Sync History Error:", e); }
        }

        async function syncUserStatsFromServer(userId) {
            if(!userId) return; isSyncing = true; 
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getUserStats&userId=' + userId); if (!response.ok) throw new Error('Network response was not ok');
                const serverData = await response.json();
                if(serverData && serverData.points !== undefined) { userStats.points = serverData.points; localStorage.setItem(KEYS.STATS, JSON.stringify(userStats)); updatePointsDisplay(); }
            } catch (error) { console.error("Sync Stats Error:", error); } finally { isSyncing = false; }
        }

        async function manualRefreshPoints() {
            const btn = document.getElementById('refresh-points-btn'); if(isSyncing) return;
            btn.classList.add('animate-spin-fast');
            if (userAvatar.userId) { await syncUserStatsFromServer(userAvatar.userId); showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏≠‡∏¢‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß! ü™ô', 'success'); } 
            else { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); }
            setTimeout(() => btn.classList.remove('animate-spin-fast'), 1000);
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (liff.isLoggedIn()) {
                    const vip = document.getElementById('vip-badge'); if (vip) { vip.classList.remove('hidden'); vip.innerText = 'VIP'; }
                    const profile = await liff.getProfile(); 
                    const loginBtn = document.getElementById('line-login-btn'); if(loginBtn) loginBtn.classList.add('hidden');
                    
                    let savedUser = {}; try { savedUser = JSON.parse(localStorage.getItem(KEYS.USER)) || {}; } catch(e) {}
                    savedUser.userId = profile.userId; 
                    userAvatar.userId = profile.userId;
                    
                    savedUser.name = profile.displayName;
                    userAvatar.name = profile.displayName;
                    const nameInput = document.getElementById('user-name'); 
                    if(nameInput) nameInput.value = profile.displayName;
                    
                    if(profile.pictureUrl && (avatarOptions.includes(userAvatar.image) || !userAvatar.image)) { 
                        userAvatar.image = profile.pictureUrl; 
                    }
                    savedUser.avatar = userAvatar;
                    updateAvatarDisplay(); 
                    localStorage.setItem(KEYS.USER, JSON.stringify(savedUser));
                    
                    if (cart.length === 0 && savedUser.cart && savedUser.cart.length > 0) { cart = savedUser.cart; updateMiniCart(); renderCheckoutList(); }
                    const localHistoryIds = lottoHistory.map(t => t.id);
                    if (localHistoryIds.length > 0) { fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'claim_orders', userId: profile.userId, orderIds: localHistoryIds }) }).then(() => { syncUserStatsFromServer(profile.userId); syncTicketHistory(profile.userId); }); } 
                    else { syncUserStatsFromServer(profile.userId); syncTicketHistory(profile.userId); }
                } else { document.getElementById('vip-badge').classList.add('hidden'); const loginBtn = document.getElementById('line-login-btn'); if (!liff.isInClient() && loginBtn) loginBtn.classList.remove('hidden'); else liff.login(); }
            } catch (err) {}
        }
        function handleLogin() { const btn = document.getElementById('line-login-btn'); btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...'; btn.classList.add('opacity-75'); if (liff.ready) liff.login(); else liff.init({ liffId: MY_LIFF_ID }).then(() => liff.login()); }

        function createMeatOptions() {
            const container = document.getElementById('meat-options-container'); container.innerHTML = '';
            const meatOptions = [{ value: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠', label: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠' }, { value: '‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', label: '‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö' }, { value: '‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á', label: '‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á' }];
            meatOptions.forEach((meat, index) => {
                const label = document.createElement('label'); label.className = 'cursor-pointer flex-shrink-0';
                const input = document.createElement('input'); input.type = 'radio'; input.name = 'modal-meat'; input.value = meat.value; input.className = 'peer sr-only'; if (index === 0) input.checked = true;
                const optionDiv = document.createElement('div'); optionDiv.className = 'meat-option'; optionDiv.textContent = meat.label;
                label.appendChild(input); label.appendChild(optionDiv); container.appendChild(label);
                input.addEventListener('change', function() { document.querySelectorAll('.meat-option').forEach(opt => opt.classList.remove('selected')); if (this.checked) { this.nextElementSibling.classList.add('selected'); triggerHaptic(); } });
            });
            if (container.firstChild) { container.firstChild.querySelector('input').checked = true; container.firstChild.querySelector('.meat-option').classList.add('selected'); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCanvasBackground();
            const savedVer = localStorage.getItem(KEYS.VERSION); if(savedVer !== CURRENT_VERSION) localStorage.setItem(KEYS.VERSION, CURRENT_VERSION);
            loadUserDataSafe(); fetchLottoResults(); initLIFF(); 
            setTimeout(autoCheckLottery, 1000); updateTicketBadge(); updateAvatarDisplay(); updatePointsDisplay(); updateMiniCart(); renderCheckoutList(); updateGreeting();
            setTimeout(checkForUpdate, 2000); document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') checkForUpdate(); });
            const inputs = document.querySelectorAll('input[type="text"], textarea'); inputs.forEach(input => { input.addEventListener('focus', () => { setTimeout(() => input.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300); }); });
            renderMenu(); try { setupMicroInteractions(); } catch(e) {}
            const pointsRange = document.getElementById('points-range'); const pointsInput = document.getElementById('points-input');
            if (pointsRange) pointsRange.addEventListener('input', function() { updatePointsFromUI(this.value); });
            if (pointsInput) { pointsInput.addEventListener('input', function() { updatePointsFromUI(this.value); }); pointsInput.addEventListener('change', function() { updatePointsFromUI(this.value); }); }
            const userNameInput = document.getElementById('user-name'); if(userNameInput) userNameInput.addEventListener('input', saveToLS);
        });
        
        // --- WHEEL ---
        let wheelSpinning = false;
        const wheelSegments = [ { text: "‡∏•‡∏î 5 ‡∏ö‡∏≤‡∏ó", color: "#FFFFFF", type: "discount_5" }, { text: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•", color: "#F3F4F6", type: "none" }, { text: "‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ 40‡∏ö.", color: "#FBBF24", type: "free_40" }, { text: "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", color: "#FFFFFF", type: "none" }, { text: "‡∏ü‡∏£‡∏µ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß", color: "#F3F4F6", type: "free_egg" }, { text: "‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó", color: "#FBBF24", type: "discount_10" } ];
        function drawWheel() {
            const canvas = document.getElementById('wheel-canvas'); if(!canvas) return;
            const ctx = canvas.getContext('2d'); const size = canvas.width; const center = size / 2; const sliceAngle = (2 * Math.PI) / wheelSegments.length;
            wheelSegments.forEach((seg, i) => {
                const startAngle = i * sliceAngle - (Math.PI / 2); const endAngle = startAngle + sliceAngle;
                ctx.beginPath(); ctx.moveTo(center, center); ctx.arc(center, center, center, startAngle, endAngle);
                ctx.fillStyle = seg.color; ctx.fill(); ctx.strokeStyle = "#E5E7EB"; ctx.lineWidth = 1; ctx.stroke();
                ctx.save(); ctx.translate(center, center); ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right"; ctx.fillStyle = "#1F2937"; ctx.font = "bold 14px Kanit"; ctx.fillText(seg.text, center - 20, 5); ctx.restore();
            });
        }
        function spinWheel() {
            if (wheelSpinning) return;
            const today = getStandardDate(new Date()); const lastDate = localStorage.getItem('kaprao_spin_date');
            let count = parseInt(localStorage.getItem('kaprao_spin_count') || '0');
            if (lastDate !== today) { count = 0; localStorage.setItem('kaprao_spin_date', today); }
            if (count >= 3) { showToast("‚õî ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!", 'warning'); return; }
            localStorage.setItem('kaprao_spin_count', count + 1);
            wheelSpinning = true; triggerHaptic('heavy');
            const box = document.getElementById('wheel-canvas'); const fullSpins = 360 * 8; const targetDegree = 150; const randomVariance = Math.floor(Math.random() * 40) - 20; const nextRotation = fullSpins + targetDegree + randomVariance;
            box.style.transform = `rotate(${nextRotation}deg)`;
            setTimeout(() => {
                wheelSpinning = false; box.style.transform = `rotate(${targetDegree}deg)`; box.style.transition = 'none';
                handleReward(wheelSegments[3]); confetti();
                setTimeout(() => box.style.transition = 'transform 8s cubic-bezier(0.1, 0.99, 0.1, 0.99)', 50);
            }, 8000); 
        }
        function handleReward(reward) { if(reward.type === 'none') showToast("‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡∏µ‡∏¢‡∏ß! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞", 'warning'); else showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${reward.text}`, 'success'); }

        function scrollTabs(amount) { document.getElementById('tabs-container').scrollBy({ left: amount, behavior: 'smooth' }); }

        function renderSkeletonLoader() {
            const grid = document.getElementById('menu-grid'); grid.innerHTML = '';
            for(let i=0; i<6; i++) {
                const el = document.createElement('div'); el.className = "fast-card p-4 flex flex-col shadow-sm";
                el.innerHTML = `<div class="flex flex-col items-center mb-3"><div class="w-20 h-20 rounded-2xl skeleton mb-3"></div><div class="h-4 w-full skeleton rounded mb-2"></div><div class="h-3 w-2/3 skeleton rounded"></div></div><div class="mt-auto pt-3 border-t border-slate-700/50"><div class="h-4 w-1/2 skeleton rounded mb-2"></div><div class="h-10 w-full skeleton rounded"></div></div>`;
                grid.appendChild(el);
            }
        }

        function toggleSearch() {
            const container = document.getElementById('search-container');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden'); document.getElementById('search-input').focus();
            } else {
                container.classList.add('hidden'); searchQuery = ""; document.getElementById('search-input').value = ""; renderMenu();
            }
            triggerHaptic();
        }
        
        function handleSearch(val) {
            searchQuery = val.toLowerCase().trim();
            renderMenu();
        }

        function toggleFavorite(e, id) {
            e.stopPropagation();
            if (favoriteItems.has(id)) { favoriteItems.delete(id); showToast('‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏•‡πâ‡∏ß'); } 
            else { favoriteItems.add(id); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚ù§Ô∏è', 'success'); }
            saveToLS();
            const btn = e.currentTarget; btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 500);
            renderMenu(); 
            triggerHaptic();
        }

        function renderTrayOptions(type) {
            const container = document.getElementById('tray-options-container');
            let html = '';
            if (type === 1) {
                html += `<h4 class="font-bold text-gray-700 mb-2 text-sm">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏•‡∏±‡∏Å</h4><div class="grid grid-cols-2 gap-3 mb-4">`;
                const meats = [{n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üê∑'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô', p:0, i:'üêî'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ-‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üéç'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á', p:10, i:'ü•ì'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠', p:10, i:'ü•©'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ó‡∏∞‡πÄ‡∏• (‡∏Å‡∏∏‡πâ‡∏á/‡∏´‡∏°‡∏∂‡∏Å)', p:20, i:'ü¶ê'}];
                meats.forEach((m, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-meat" value="${m.n}" data-price="${m.p}" aria-label="${m.n}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-3 flex flex-col items-center justify-center gap-2 transition-all" tabindex="0" role="radio" aria-checked="${i===0?'true':'false'}"><div class="text-3xl filter group-hover:scale-110 transition-transform">${m.i}</div><div class="text-xs font-bold text-center leading-tight">${m.n}</div>${m.p>0?`<div class="text-[10px] text-white bg-orange-500 px-2 py-0.5 rounded-full font-bold">+${m.p}</div>`:''}<div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 text-yellow-400 transition-opacity"><i class="fas fa-check-circle"></i></div></div></label>`; });
                html += `</div><h4 class="font-bold text-gray-700 mb-2 text-sm">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏Ç‡πà‡∏Ñ‡∏π‡πà‡πÉ‡∏à</h4><div class="grid grid-cols-3 gap-2 mb-4">`;
                const eggs = [{n:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', p:0, i:'üç≥'}, {n:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', p:5, i:'ü•û'}, {n:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô', p:10, i:'ü•ò'}];
                eggs.forEach((e, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-egg" value="${e.n}" data-price="${e.p}" aria-label="${e.n}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-2 flex flex-col items-center justify-center gap-1 transition-all" tabindex="0" role="radio" aria-checked="${i===0?'true':'false'}"><div class="text-2xl">${e.i}</div><div class="text-xs font-bold text-center">${e.n}</div>${e.p>0?`<div class="text-[9px] text-orange-400 font-bold">+${e.p}</div>`:''}</div></label>`; });
                html += `</div>`;
            } else if (type === 2) {
                html += `<h4 class="font-bold text-gray-700 mb-2 text-sm">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏≤‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå)</h4><div class="grid grid-cols-2 gap-3 mb-4">`;
                const meats = [{n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üê∑'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô', p:0, i:'üêî'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ-‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üéç'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á', p:20, i:'ü•ì'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠', p:20, i:'ü•©'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ó‡∏∞‡πÄ‡∏•', p:30, i:'ü¶ê'}, {n:'‡∏ó‡∏π‡πÇ‡∏ó‡∏ô (‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö+‡πÑ‡∏Å‡πà)', p:10, i:'‚ú®'}];
                meats.forEach((m, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-meat" value="${m.n}" data-price="${m.p}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-3 flex flex-col items-center justify-center gap-2 transition-all"><div class="text-3xl filter group-hover:scale-110 transition-transform">${m.i}</div><div class="text-xs font-bold text-center leading-tight">${m.n}</div>${m.p>0?`<div class="text-[10px] text-white bg-orange-500 px-2 py-0.5 rounded-full font-bold">+${m.p}</div>`:''}<div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 text-yellow-400 transition-opacity"><i class="fas fa-check-circle"></i></div></div></label>`; });
                html += `</div><h4 class="font-bold text-gray-700 mb-2 text-sm">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏Ç‡πà‡∏Ñ‡∏π‡πà‡πÉ‡∏à (‡πÑ‡∏î‡πâ 2 ‡∏ü‡∏≠‡∏á)</h4><div class="grid grid-cols-3 gap-2 mb-4">`;
                const eggs = [{n:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß‡∏Ñ‡∏π‡πà', p:0, i:'üç≥üç≥'}, {n:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡πÅ‡∏ú‡πà‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå', p:0, i:'ü•û'}, {n:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏£‡∏≤‡∏î‡∏Ç‡πâ‡∏≤‡∏ß', p:15, i:'ü•ò'}];
                eggs.forEach((e, i) => { html += `<label class="cursor-pointer group relative"><input type="radio" name="tray-egg" value="${e.n}" data-price="${e.p}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only"><div class="h-full meat-option peer-checked:selected rounded-2xl p-2 flex flex-col items-center justify-center gap-1 transition-all"><div class="text-2xl">${e.i}</div><div class="text-xs font-bold text-center">${e.n}</div>${e.p>0?`<div class="text-[9px] text-orange-400 font-bold">+${e.p}</div>`:''}</div></label>`; });
                html += `</div>`;
            }
            html += `<div class="mt-6 p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100"><div class="flex items-center gap-2 mb-2"><span class="text-lg">üç±</span><h4 class="text-sm font-bold text-indigo-400">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ñ‡∏≤‡∏î:</h4></div><p id="tray-summary-text" class="text-sm text-gray-600 leading-relaxed pl-1"></p><div class="mt-3 pt-2 border-t border-indigo-500/30 flex items-center gap-2 text-[10px] text-indigo-400"><i class="fas fa-utensils"></i><span>‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏ã‡∏∏‡∏õ‡∏ü‡∏£‡∏µ!</span></div></div>`;
            container.innerHTML = html;
            setTimeout(() => document.querySelectorAll('.meat-option')[0]?.classList.add('selected'), 50);
        }

        function updateTraySummary() {
            if(!currentItem || !currentItem.isTray) return;
            const meat = document.querySelector('input[name="tray-meat"]:checked');
            const egg = document.querySelector('input[name="tray-egg"]:checked');
            const txt = document.getElementById('tray-summary-text');
            if(meat && egg && txt) { txt.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="text-gray-500">1. ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å:</span><span class="font-bold text-gray-800">${meat.value}</span></div><div class="flex justify-between items-center"><span class="text-gray-500">2. ‡πÑ‡∏Ç‡πà‡∏Ñ‡∏π‡πà‡πÉ‡∏à:</span><span class="font-bold text-gray-800">${egg.value}</span></div>`; }
        }

        function switchCategory(cat) {
            if(activeCategory === cat) return;
            activeCategory = cat; triggerHaptic();
            const grid = document.getElementById('menu-grid'); const msg = document.getElementById('dessert-msg');
            grid.classList.add('page-out'); if(!msg.classList.contains('hidden')) msg.classList.add('page-out');
            
            const categories = ['favorites', 'kaprao', 'tray', 'garlic', 'curry', 'noodle', 'soup', 'others', 'dessert', 'promotion'];
            categories.forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                let extraClass = '';
                if (c === 'promotion') extraClass = 'category-pill-promotion'; else if (c === 'tray') extraClass = 'category-pill-tray'; else if (c === 'favorites') extraClass = 'category-pill-favorites';
                
                if (c === cat) btn.className = `category-pill snap-start category-pill-active ${extraClass}`;
                else {
                    if (extraClass) extraClass += ' opacity-60';
                    btn.className = `category-pill snap-start category-pill-inactive ${extraClass}`;
                }
            });

            setTimeout(() => {
                const title = document.getElementById('section-title');
                msg.classList.add('hidden'); msg.classList.remove('page-out'); grid.classList.remove('page-out'); renderSkeletonLoader();
                setTimeout(() => {
                    if (cat === 'promotion') { title.innerText = "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á & ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô"; renderPromotions(); } 
                    else if (cat === 'dessert') { title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô"; msg.classList.remove('hidden'); renderMenu(); } 
                    else if (cat === 'soup') { title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°"; renderMenu(); } 
                    else if (cat === 'tray') { title.innerText = "‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°"; renderMenu(); } 
                    else if (cat === 'favorites') { title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö ‚ù§Ô∏è"; renderMenu(); }
                    else if (cat === 'curry') { title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á"; renderMenu(); }
                    else { title.innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"; renderMenu(); }
                    document.getElementById('section-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    grid.classList.add('page-in'); setTimeout(() => grid.classList.remove('page-in'), 300);
                }, 50);
            }, 150);
        }
                
        function renderMenu() {
            const grid = document.getElementById('menu-grid'); grid.innerHTML = '';
            let filteredItems = [];
            if (searchQuery.length > 0) {
                filteredItems = menuItems.filter(i => i.name.toLowerCase().includes(searchQuery));
                document.getElementById('section-title').innerText = `‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: "${searchQuery}" (${filteredItems.length})`;
            } 
            else if (activeCategory === 'favorites') {
                filteredItems = menuItems.filter(i => favoriteItems.has(i.id));
                if (filteredItems.length === 0) { grid.innerHTML = `<div class="col-span-2 text-center text-gray-400 mt-10"><div class="text-4xl mb-2">üíî</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÇ‡∏õ‡∏£‡∏î ‡∏Å‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p></div>`; return; }
            } 
            else { filteredItems = menuItems.filter(i => i.category === activeCategory); }
            
            if(filteredItems.length === 0 && searchQuery.length > 0) { grid.innerHTML = `<div class="col-span-2 text-center text-gray-400 mt-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö üòÖ</div>`; return; }

            filteredItems.forEach((item, index) => {
                const isDessert = item.category === 'dessert'; const isSoldOut = item.soldOut || false; const isTrayWait = (item.id === 201 || item.id === 202); 
                const el = document.createElement('div'); el.style.animationDelay = `${index * 0.05}s`;
                const grayscaleClass = (isSoldOut || isTrayWait) ? 'grayscale opacity-70' : '';
                const pointerClass = (isDessert || isSoldOut || isTrayWait) ? '' : 'cursor-pointer';
                el.className = `fast-card p-4 flex flex-col stagger-item group ${pointerClass} ${grayscaleClass} relative overflow-hidden`;
                
                el.onclick = () => {
                    if (isTrayWait) { showToast('‚ö†Ô∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); triggerHaptic('medium'); return; }
                    if (isSoldOut) { showToast('‚õî ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö', 'error'); triggerHaptic('heavy'); }
                    else if (isDessert) { showToast('‚è≥ ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö', 'info'); triggerHaptic(); }
                    else openModal(item);
                };
                
                let statusBadge = '';
                if (isTrayWait) statusBadge = `<div class="absolute top-2 right-2 bg-indigo-500/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20">‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</div>`;
                else if (isSoldOut) statusBadge = `<div class="absolute top-2 right-2 bg-red-500/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20">‡∏´‡∏°‡∏î</div>`;
                else if (isDessert) statusBadge = `<div class="absolute top-2 right-2 bg-gray-600/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20">‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</div>`;
                
                const isFav = favoriteItems.has(item.id);
                const heartIcon = `<button onclick="toggleFavorite(event, ${item.id})" class="absolute top-2 right-2 z-30 heart-btn w-8 h-8 flex items-center justify-center rounded-full bg-white/80 backdrop-blur-sm shadow-sm hover:scale-110 active:scale-90 ${isFav ? 'text-red-500' : 'text-gray-300'}"><i class="fas fa-heart text-lg"></i></button>`;

                const priceDisplay = (isDessert || isSoldOut || isTrayWait) ? `<span class="font-bold text-gray-400 text-base line-through decoration-transparent">${item.price} ‡∏ø</span>` : `<span class="font-bold text-indigo-500 text-xl">${item.price} <span class="text-sm text-gray-400">‡∏ø</span></span>`;
                const newBadge = item.isNew && !isSoldOut ? `<div class="absolute top-2 left-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[8px] font-black px-2 py-1 rounded-full shadow-lg z-20 animate-pulse border border-white/30">NEW</div>` : '';
                const actionButton = (!isDessert && !isSoldOut && !isTrayWait) ? `<button onclick="event.stopPropagation(); const item = menuItems.find(i => i.id === ${item.id}); if(item) openModal(item);" class="mt-3 w-full btn-gradient text-white font-bold py-2.5 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 text-sm group-hover:scale-105"><i class="fas fa-plus text-xs"></i><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span></button>` : `<div class="mt-3 w-full bg-gray-100 text-gray-400 font-medium py-2.5 rounded-xl text-center text-sm">‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</div>`;
                
                el.innerHTML = `${newBadge}${isTrayWait || isSoldOut || isDessert ? statusBadge : heartIcon}<div class="flex flex-col items-center mb-3 ${(isDessert||isSoldOut||isTrayWait)?'opacity-60 grayscale-[50%]':''}"><div class="relative w-20 h-20 rounded-2xl bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center text-4xl mb-3 shadow-sm border border-gray-100 group-hover:scale-110 transition-transform"><span class="menu-icon" aria-hidden="true" loading="lazy">${item.icon}</span></div><h3 class="font-bold text-gray-700 text-sm text-center leading-tight group-hover:text-indigo-500 transition-colors mb-2 line-clamp-2 min-h-[2.5rem]">${item.name}</h3><div class="flex flex-wrap items-center justify-center gap-1.5 mb-2"><span class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">${item.kcal} kcal</span>${item.reqMeat ? '<span class="text-[9px] text-yellow-600 border border-yellow-200 bg-yellow-50 px-1.5 py-0.5 rounded-full">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</span>' : ''}</div></div><div class="mt-auto pt-3 border-t border-gray-100"><div class="flex items-center justify-between mb-2"><span class="text-xs text-gray-400">‡∏£‡∏≤‡∏Ñ‡∏≤</span>${priceDisplay}</div>${actionButton}</div>`;
                grid.appendChild(el);
            });
        }
        
        function renderPromotions() {
            const grid = document.getElementById('menu-grid'); grid.innerHTML = '';
            promotions.filter(p => !p.isHidden).forEach((promo, index) => {
                const el = document.createElement('div'); el.style.animationDelay = `${index * 0.1}s`;
                el.className = "fast-card p-4 flex flex-col cursor-pointer shadow-sm btn-bounce stagger-item col-span-2";
                el.onclick = () => {
                    const input = document.getElementById('discount-code'); if(input) { input.value = promo.code; applyDiscount(); }
                    if(navigator.clipboard) navigator.clipboard.writeText(promo.code);
                    showToast(`‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î ${promo.code} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success'); triggerHaptic();
                };
                el.innerHTML = `<div class="flex items-center gap-4"><div class="w-16 h-16 ${promo.color} rounded-2xl flex items-center justify-center text-3xl shadow-lg">${promo.icon}</div><div class="flex-1"><h3 class="font-bold text-gray-800 text-base mb-1">${promo.title}</h3><p class="text-xs text-gray-500 mb-2">${promo.desc}</p><div class="bg-gray-100 inline-block px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 tracking-wider border border-gray-200 shadow-sm">${promo.code}</div></div><div class="text-gray-400 text-xs">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ</div></div>`;
                grid.appendChild(el);
            });
            const wheelDiv = document.createElement('div');
            wheelDiv.className = "w-full fast-card p-6 mt-4 mb-6 shadow-sm flex flex-col items-center stagger-item col-span-2"; wheelDiv.style.animationDelay = "0.3s";
            wheelDiv.innerHTML = `<h3 class="font-bold text-gray-800 text-lg mb-1">‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ! üé°</h3><p class="text-xs text-gray-500 mb-4">‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤ 40 ‡∏ö‡∏≤‡∏ó ‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô)</p><div id="wheel-container"><div class="wheel-pointer"></div><canvas id="wheel-canvas" width="300" height="300"></canvas><div class="wheel-center text-2xl">üòã</div></div><button onclick="spinWheel()" class="btn-bounce btn-gradient-purple text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all hover:scale-105">‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡∏¢!</button>`;
            grid.appendChild(wheelDiv); setTimeout(drawWheel, 100);
        }

        function updateModalPrice() {
            if (!currentItem) return;
            const options = { meatPrice: 0, eggPrice: 0, addons: [] };
            if(currentItem.isTray) {
                const meatOpt = document.querySelector('input[name="tray-meat"]:checked');
                const eggOpt = document.querySelector('input[name="tray-egg"]:checked');
                if(meatOpt) options.meatPrice = parseInt(meatOpt.getAttribute('data-price') || 0);
                if(eggOpt) options.eggPrice = parseInt(eggOpt.getAttribute('data-price') || 0);
                updateTraySummary();
            }
            addonIds.forEach(id => { if(document.getElementById(`modal-opt-${id}`).checked) options.addons.push(id); });
            const unitPrice = calculateItemUnitPrice(currentItem, options);
            const total = unitPrice * modalQty;
            let totalKcal = (currentItem.kcal || 0) * modalQty; options.addons.forEach(id => totalKcal += (addonCalories[id] || 0) * modalQty);
            const priceEl = document.getElementById('modal-price'); priceEl.innerText = total;
            priceEl.classList.remove('price-pop'); void priceEl.offsetWidth; priceEl.classList.add('price-pop');
            document.getElementById('modal-kcal').innerText = totalKcal + ' kcal';
        }

        addonIds.forEach(id => { const el = document.getElementById(`modal-opt-${id}`); if (el) el.addEventListener('change', updateModalPrice); });

        function openModal(item) {
            pushModalState('menu'); triggerHaptic();
            currentItem = item; modalQty = 1; 
            document.getElementById('modal-qty').innerText = modalQty; document.getElementById('modal-title').innerText = item.name; document.getElementById('modal-icon').innerText = item.icon; document.getElementById('modal-note').value = '';
            document.querySelectorAll('input[name="modal-meat"]').forEach(el => el.checked = false); addonIds.forEach(id => document.getElementById(`modal-opt-${id}`).checked = false);
            const meatSec = document.getElementById('modal-meat-section'); const traySec = document.getElementById('tray-options-container'); const addonsSec = document.getElementById('addons-section');
            document.getElementById('meat-options-container').classList.remove('animate-shake', 'border', 'border-red-500', 'rounded-xl');
            if(item.isTray) { meatSec.classList.add('hidden'); traySec.classList.remove('hidden'); addonsSec.classList.add('hidden'); renderTrayOptions(item.trayType); updateTraySummary(); } 
            else { traySec.classList.add('hidden'); addonsSec.classList.remove('hidden'); if(item.reqMeat) { meatSec.classList.remove('hidden'); createMeatOptions(); } else meatSec.classList.add('hidden'); }
            updateModalPrice();
            const overlay = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content');
            content.style.transform = ''; overlay.classList.remove('hidden'); setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('translate-y-full'); }, 10);
        }

        function closeModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'menu') { history.back(); return; }
            const overlay = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0'); content.classList.add('translate-y-full');
            setTimeout(() => { overlay.classList.add('hidden'); currentItem = null; content.style.transform = ''; }, 300);
            currentOpenModal = null; unlockScroll();
        }

        function adjustQty(n) { modalQty += n; if(modalQty < 1) modalQty = 1; document.getElementById('modal-qty').innerText = modalQty; triggerHaptic(); updateModalPrice(); }

        function animateFlyToCart(sourceEl, emoji = 'üç±') {
            try {
                const target = document.getElementById('mini-count') || document.getElementById('mini-cart-bar'); if (!sourceEl || !target) return Promise.resolve();
                const srcRect = sourceEl.getBoundingClientRect(); const tgtRect = target.getBoundingClientRect();
                const fly = document.createElement('div'); fly.className = 'fly-item'; fly.innerText = emoji; document.body.appendChild(fly);
                const startX = srcRect.left + srcRect.width / 2; const startY = srcRect.top + srcRect.height / 2; const endX = tgtRect.left + tgtRect.width / 2; const endY = tgtRect.top + tgtRect.height / 2;
                fly.style.left = startX - 24 + 'px'; fly.style.top = startY - 24 + 'px';
                const midX = (startX + endX) / 2 + (Math.random() * 80 - 40); const midY = Math.min(startY, endY) - 140;
                const keyframes = [{ transform: `translate(0px, 0px) scale(1)`, opacity: 1 }, { transform: `translate(${midX - startX}px, ${midY - startY}px) scale(0.95) rotate(${(Math.random()*20)-10}deg)`, opacity: 1, offset: 0.55 }, { transform: `translate(${endX - startX}px, ${endY - startY}px) scale(0.6) rotate(20deg)`, opacity: 0.0 }];
                const anim = fly.animate(keyframes, { duration: 700 + Math.random()*200, easing: 'cubic-bezier(0.2,0.8,0.2,1)' });
                return new Promise(resolve => { anim.onfinish = () => { fly.remove(); resolve(); }; });
            } catch (e) { return Promise.resolve(); }
        }

        function setupMicroInteractions() {
            const buttons = Array.from(document.querySelectorAll('.btn-bounce'));
            buttons.forEach(btn => {
                btn.classList.add('btn-press'); let pointerDown = false;
                const onDown = () => { if (btn.disabled) return; pointerDown = true; btn.classList.remove('rebound'); btn.classList.add('squash'); };
                const onUp = () => { if (!pointerDown) return; pointerDown = false; btn.classList.remove('squash'); btn.classList.add('rebound'); btn.addEventListener('animationend', function _end() { btn.classList.remove('rebound'); btn.removeEventListener('animationend', _end); }); };
                btn.addEventListener('pointerdown', onDown, { passive: true }); ['pointerup','pointercancel','pointerleave'].forEach(ev => btn.addEventListener(ev, onUp));
            });
        }

        function addToCart() {
            if (!currentItem) return;
            let meat = null; let noteExtra = "";
            if (currentItem.isTray) { const meatOpt = document.querySelector('input[name="tray-meat"]:checked'); const eggOpt = document.querySelector('input[name="tray-egg"]:checked'); meat = meatOpt ? meatOpt.value : '‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö'; noteExtra = `[${eggOpt ? eggOpt.value : ''}]`; } 
            else if (currentItem.reqMeat) { const r = document.querySelector('input[name="modal-meat"]:checked'); if(!r) { const meatContainer = document.getElementById('meat-options-container'); meatContainer.classList.remove('animate-shake'); void meatContainer.offsetWidth; meatContainer.classList.add('animate-shake', 'border', 'border-red-500', 'rounded-xl'); triggerHaptic('heavy'); showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', 'warning'); return; } meat = r.value; }
            const addonNames = {special:'‡∏û‡∏¥‡πÄ‡∏®‡∏©', kaikhon:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô', kaidao:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', kaijiao:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', kaitom:'‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°', kaiyiewma:'‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤'};
            const selectedAddonIds = []; const selectedAddonNames = [];
            addonIds.forEach(id => { if(document.getElementById(`modal-opt-${id}`).checked) { selectedAddonIds.push(id); selectedAddonNames.push(addonNames[id]); } });
            const options = { meatPrice: 0, eggPrice: 0, addons: selectedAddonIds };
            if(currentItem.isTray) { const meatOpt = document.querySelector('input[name="tray-meat"]:checked'); const eggOpt = document.querySelector('input[name="tray-egg"]:checked'); if(meatOpt) options.meatPrice = parseInt(meatOpt.getAttribute('data-price') || 0); if(eggOpt) options.eggPrice = parseInt(eggOpt.getAttribute('data-price') || 0); }
            const unitPrice = calculateItemUnitPrice(currentItem, options);
            let noteSafe = escapeHtml(document.getElementById('modal-note').value.trim()); if(noteExtra) noteSafe = (noteSafe ? noteSafe + " " : "") + noteExtra;
            for(let i=0; i<modalQty; i++){ cart.push({ id: Date.now() + i, name: currentItem.name, price: unitPrice, meat: meat, addons: selectedAddonNames, note: noteSafe }); }
            triggerHaptic();
            try { const modalIconEl = document.getElementById('modal-icon'); const srcEl = modalIconEl ? modalIconEl.parentElement : null; animateFlyToCart(srcEl, currentItem.icon || (modalIconEl ? modalIconEl.innerText : 'üç±')); } catch (e) {}
            const cartBtn = document.getElementById('mini-cart-bar'); if(cartBtn) { cartBtn.classList.remove('hidden'); cartBtn.style.animation = 'bounce 0.5s ease-out'; setTimeout(() => cartBtn.style.animation = '', 500); }
            closeModal(); updateMiniCart(); saveToLS(); showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${modalQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
        }

        function getNextDrawDate() { const today = new Date(); const day = today.getDate(); const month = today.getMonth(); const year = today.getFullYear(); let drawDate = new Date(); if (day <= 1) drawDate = new Date(year, month, 1); else if (day <= 16) drawDate = new Date(year, month, 16); else drawDate = new Date(year, month + 1, 1); return drawDate; }
        let OFFICIAL_RESULTS = {};
        async function fetchLottoResults() { try { const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getLotto'); if (response.ok) { const data = await response.json(); OFFICIAL_RESULTS = data; autoCheckLottery(); } } catch (error) { console.error("Lotto Error:", error); } }
        function getWinningNumberForDate(dateStr) { return OFFICIAL_RESULTS[dateStr] || "NotSet"; }
        let currentOrderId = "";
        function generateOrderId() { const now = Date.now().toString(); const timePart = now.slice(-2); const myPendingNumbers = lottoHistory.filter(t => t.status === 'pending').map(t => t.number); let randomPart; let isDuplicate = true; let attempts = 0; while (isDuplicate && attempts < 500) { randomPart = Math.floor(Math.random() * 100).toString().padStart(2, '0'); if (!myPendingNumbers.includes(randomPart) || myPendingNumbers.length >= 100) isDuplicate = false; attempts++; } currentOrderId = `KP-${timePart}${randomPart}`; return currentOrderId; }
        function saveTicketToHistory(orderId, totalPrice) {
            const today = new Date(); const drawDateObj = getNextDrawDate(); const todayStr = getStandardDate(today); const drawDateStr = getStandardDate(drawDateObj); const name = document.getElementById('user-name').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            const ticket = { id: orderId, number: orderId.slice(-2), date: todayStr, drawDate: drawDateStr, drawDateTimestamp: drawDateObj.getTime(), timestamp: Date.now(), price: totalPrice, status: 'pending', checkedDate: null, items: JSON.parse(JSON.stringify(cart)), customerName: name };
            lottoHistory.unshift(ticket); if (lottoHistory.length > 20) lottoHistory = lottoHistory.slice(0, 20); localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory)); updateTicketBadge();
        }
        function autoCheckLottery() {
            if (!lottoHistory || !Array.isArray(lottoHistory) || lottoHistory.length === 0) return;
            let updated = false; 
            lottoHistory.forEach(t => { const winningNum = getWinningNumberForDate(t.drawDate); if (winningNum === "NotSet") { if (t.status !== 'pending') { t.status = 'pending'; updated = true; } } else { if (t.number === winningNum) { if (t.status !== 'won') { t.status = 'won'; updated = true; confetti(); if (Notification.permission === "granted") new Notification("‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ü§ë", { body: `‡∏á‡∏ß‡∏î ${t.drawDate}: Order ${t.id} ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ!`, icon: 'https://cdn-icons-png.flaticon.com/512/3170/3170733.png' }); } } else { if (t.status !== 'lost') { t.status = 'lost'; updated = true; } } t.checkedDate = getStandardDate(new Date()); } });
            if (updated) { localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory)); updateTicketBadge(); }
        }
        function updateTicketBadge() { if (!lottoHistory) return; const pending = lottoHistory.filter(t => t.status === 'pending').length; const dot = document.getElementById('unread-ticket-dot'); if(pending > 0) dot.classList.remove('hidden'); else dot.classList.add('hidden'); }

        function openMyTickets() {
            try {
                pushModalState('tickets'); triggerHaptic();
                if (!lottoHistory || !Array.isArray(lottoHistory)) { lottoHistory = []; try { lottoHistory = JSON.parse(localStorage.getItem(KEYS.HISTORY)) || []; } catch(e) {} }
                const list = document.getElementById('tickets-list'); list.innerHTML = '';
                if(lottoHistory.length === 0) { list.innerHTML = `<div class="text-center text-gray-400 mt-10"><div class="text-4xl mb-2 opacity-30">üéüÔ∏è</div><p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p></div>`; } 
                else {
                    lottoHistory.forEach((t, index) => {
                        let statusHtml = ''; let statusClass = '';
                        if(t.status === 'pending') { statusHtml = `<span class="text-indigo-600 font-bold"><i class="far fa-clock"></i> ‡∏£‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏á‡∏ß‡∏î ${t.drawDate || '‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ'}</span>`; statusClass = 'border-l-4 border-indigo-500 bg-indigo-50/50'; } 
                        else if(t.status === 'won') { statusHtml = '<span class="text-yellow-500 font-bold"><i class="fas fa-trophy"></i> ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!</span>'; statusClass = 'border-l-4 border-yellow-500 bg-yellow-500/20'; } 
                        else { statusHtml = '<span class="text-gray-400 font-bold"><i class="fas fa-times-circle"></i> ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>'; statusClass = 'border-l-4 border-gray-400 bg-gray-100 opacity-70 grayscale'; }
                        const item = document.createElement('div'); item.className = `ticket-stub p-4 rounded-lg shadow-sm border border-gray-200 mb-3 flex justify-between items-center relative overflow-hidden cursor-pointer active:scale-95 transition-transform btn-bounce ${statusClass}`;
                        item.onclick = function() { reprintReceipt(index); };
                        item.innerHTML = `<div><div class="text-[10px] text-gray-500">Order ID: ${t.id}</div><div class="flex items-baseline gap-2 mt-1"><span class="text-xs text-gray-400">‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô:</span><span class="text-2xl font-black text-indigo-500 tracking-widest">${t.number}</span></div><div class="text-[10px] text-gray-500 mt-1">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${t.date}</div><div class="text-[10px] text-indigo-500 font-bold mt-2"><i class="fas fa-print"></i> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div></div><div class="text-right flex flex-col items-end"><div class="text-xs mb-1 bg-white px-2 py-1 rounded-full shadow-sm whitespace-nowrap border border-gray-100">${statusHtml}</div>${t.status === 'won' ? '<button class="text-[10px] bg-yellow-500 text-white font-bold px-2 py-1 rounded shadow-sm mt-1 animate-pulse">‡πÅ‡∏Ñ‡∏õ‡∏à‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>' : ''}</div>`;
                        list.appendChild(item);
                    });
                }
                const overlay = document.getElementById('tickets-modal-overlay'); const sheet = document.getElementById('tickets-sheet'); sheet.style.transform = ''; overlay.classList.remove('hidden'); setTimeout(() => { overlay.classList.remove('opacity-0'); sheet.classList.remove('translate-y-full'); }, 10);
            } catch(e) { console.error(e); showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡πã‡∏ß", 'error'); }
        }
        function closeMyTickets(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'tickets') { history.back(); return; }
            const overlay = document.getElementById('tickets-modal-overlay'); const sheet = document.getElementById('tickets-sheet'); overlay.classList.add('opacity-0'); sheet.classList.add('translate-y-full'); setTimeout(() => { overlay.classList.add('hidden'); sheet.style.transform = ''; }, 300); currentOpenModal = null; unlockScroll();
        }

        function openCheckout() {
            try {
                pushModalState('checkout'); triggerHaptic(); renderCheckoutList();
                if(document.getElementById('discount-code').value.trim() !== '' && discountValue > 0) applyDiscount();
                const bannerContainer = document.getElementById('order-id-banner');
                if(cart.length > 0) {
                    const lottoId = generateOrderId(); 
                    bannerContainer.classList.remove('hidden');
                    bannerContainer.innerHTML = `<div class="bg-gray-50 border border-gray-200 p-4 rounded-xl mb-3 flex justify-between items-center shadow-sm relative overflow-hidden stagger-item"><div class="absolute -right-4 -top-4 bg-indigo-100 opacity-50 w-20 h-20 rounded-full"></div><div class="flex flex-col z-10"><span class="text-[10px] text-gray-500 uppercase tracking-wider">Order ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span><div class="flex items-baseline gap-1"><span class="font-bold text-xl text-gray-800">${lottoId.slice(0, -2)}</span><span class="font-black text-3xl text-yellow-500 drop-shadow-sm">${lottoId.slice(-2)}</span></div></div><div class="z-10 text-right"><div class="text-2xl">üéüÔ∏è</div><span class="text-[10px] font-bold text-gray-500">‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ!</span></div></div>`;
                } else bannerContainer.classList.add('hidden');
                resetPointsDiscount();
                const overlay = document.getElementById('checkout-overlay'); const sheet = document.getElementById('checkout-sheet'); sheet.style.transform = ''; overlay.classList.remove('hidden'); setTimeout(() => { overlay.classList.remove('opacity-0'); sheet.classList.remove('translate-y-full'); }, 10);
            } catch (error) { console.error('openCheckout error:', error); }
        }
        function closeCheckout(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'checkout') { history.back(); return; }
            const overlay = document.getElementById('checkout-overlay'); const sheet = document.getElementById('checkout-sheet'); overlay.classList.add('opacity-0'); sheet.classList.add('translate-y-full'); setTimeout(() => { overlay.classList.add('hidden'); sheet.style.transform = ''; }, 300); currentOpenModal = null; unlockScroll();
        }

        function updateMiniCart() {
            const miniBar = document.getElementById('mini-cart-bar');
            if(cart.length > 0) { miniBar.classList.remove('hidden'); let total = cart.reduce((sum, i) => sum + i.price, 0); document.getElementById('mini-count').innerText = cart.length; document.getElementById('mini-total').innerText = total + " ‡∏ø"; } 
            else { miniBar.classList.add('hidden'); document.getElementById('mini-count').innerText = '0'; document.getElementById('mini-total').innerText = '0 ‡∏ø'; }
        }
        function removeFromCart(id) {
            const index = cart.findIndex(item => item.id === id);
            if (index !== -1) {
                cart.splice(index, 1); saveToLS();
                if(cart.length === 0) { removeDiscount(); resetPointsDiscount(); } else if(discountValue > 0) applyDiscount();
                renderCheckoutList(); updateMiniCart(); if(cart.length === 0) closeCheckout(); showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); triggerHaptic();
            }
        }
        function renderCheckoutList() {
            const container = document.getElementById('cart-list-container'); container.innerHTML = '';
            cart.forEach(item => {
                const el = document.createElement('div'); el.className = "bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-start stagger-item";
                let detail = item.meat ? `<span class="text-orange-600 text-xs bg-orange-100 px-1 rounded">${item.meat}</span> ` : ''; if(item.addons.length) detail += `<span class="text-gray-500 text-xs">+${item.addons.join(',')}</span>`;
                el.innerHTML = `<div><h4 class="cart-item-title font-bold text-gray-800">${item.name}</h4><div class="cart-item-details mt-1">${detail}</div>${item.note ? `<div class="text-[10px] text-gray-400 mt-1">Note: ${item.note}</div>` : ''}</div><div class="flex flex-col items-end gap-2"><span class="font-bold text-gray-800">${item.price}.-</span><button onclick="removeFromCart(${item.id})" class="text-xs text-red-500 bg-red-50 w-9 h-9 rounded flex items-center justify-center border border-red-100 btn-bounce"><i class="fas fa-trash"></i></button></div>`;
                container.appendChild(el);
            });
            updateTotalSummary();
        }
        function updateTotalSummary() {
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0); let discountFromCode = 0; let discountFromPoints = 0; const code = document.getElementById('discount-code').value.trim().toUpperCase(); const promo = promotions.find(p => p.code === code);
            if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value; if (pointsRedeemed > 0) discountFromPoints = Math.floor(pointsRedeemed / 100) * 10;
            const netTotal = Math.max(0, subtotal - discountFromCode - discountFromPoints);
            document.getElementById('summary-subtotal').textContent = `${subtotal}.-`; document.getElementById('summary-grand-total').textContent = `${netTotal}.-`;
            const discountSummary = document.getElementById('discount-summary'); const pointsSummary = document.getElementById('points-summary');
            if (discountFromCode > 0) { discountSummary.classList.remove('hidden'); discountSummary.querySelector('span:last-child').textContent = `-${discountFromCode}.-`; } else discountSummary.classList.add('hidden');
            if (discountFromPoints > 0) { pointsSummary.classList.remove('hidden'); pointsSummary.querySelector('span:last-child').textContent = `-${discountFromPoints}.-`; } else pointsSummary.classList.add('hidden');
            updateCheckoutPointsInfo();
        }
        function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim().toUpperCase(); let total = cart.reduce((sum, i) => sum + i.price, 0); const msg = document.getElementById('discount-msg'); const btn = document.getElementById('btn-apply-code'); discountValue = 0;
            if (code === '') { msg.innerText = ''; btn.innerHTML = '‡πÉ‡∏ä‡πâ'; btn.className = 'btn-bounce bg-gray-800 text-white font-bold px-4 rounded-xl text-xs shadow-lg hover:bg-gray-700 transition-all'; btn.onclick = applyDiscount; updateTotalSummary(); return; }
            const promo = promotions.find(p => p.code === code);
            if (promo && total >= promo.minOrder) { discountValue = promo.value; msg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏î ${promo.value} ‡∏ö‡∏≤‡∏ó</span>`; btn.innerHTML = '<i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'; btn.className = 'btn-bounce bg-red-500 hover:bg-red-600 text-white font-bold px-4 rounded-xl text-xs shadow-lg transition-all'; btn.onclick = removeDiscount; } 
            else { msg.innerHTML = `<span class="text-red-500">${promo ? '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö '+promo.minOrder : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î'}</span>`; btn.innerHTML = '‡πÉ‡∏ä‡πâ'; btn.className = 'btn-bounce bg-gray-500 hover:bg-gray-600 text-white font-bold px-4 rounded-xl text-xs shadow-lg transition-all'; btn.onclick = applyDiscount; }
            updateTotalSummary();
        }
        function removeDiscount() { document.getElementById('discount-code').value = ''; document.getElementById('discount-msg').innerText = ''; discountValue = 0; applyDiscount(); }

        function openReceiptResult(imgData) { const modal = document.getElementById('receipt-result-modal'); const img = document.getElementById('receipt-result-img'); img.src = imgData; modal.classList.remove('hidden'); }
        function downloadReceiptImage() { const img = document.getElementById('receipt-result-img'); const link = document.createElement('a'); link.href = img.src; link.download = 'kaprao52-receipt-' + Date.now() + '.png'; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 'info'); }

        function reprintReceipt(ticketIndex) {
            triggerHaptic();
            if (typeof html2canvas === 'undefined') { showToast("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ", "error"); return; }
            if (!lottoHistory || !lottoHistory[ticketIndex]) { showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤ üò¢", 'error'); return; }
            const ticket = lottoHistory[ticketIndex];
            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏Å‡πà‡∏≤...");
            const name = ticket.customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'; const subtotal = ticket.items ? ticket.items.reduce((sum, i) => sum + i.price, 0) : ticket.price; const netTotal = ticket.price; const discount = subtotal - netTotal; const tDate = new Date(ticket.timestamp); const dateStr = `${getStandardDate(tDate)} ${formatTime(tDate)}`;
            document.querySelector('.receipt-id').innerText = ticket.id; document.querySelector('.receipt-date').innerText = dateStr; document.querySelector('.receipt-name').innerText = escapeHtml(name); document.querySelector('.receipt-subtotal').innerText = subtotal + '.-'; document.querySelector('.receipt-discount').innerText = '-' + discount + '.-'; document.querySelector('.receipt-total').innerText = netTotal + '.-';
            const receiptAvatar = document.getElementById('receipt-avatar-img'); receiptAvatar.crossOrigin = "Anonymous"; receiptAvatar.src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            const itemsContainer = document.querySelector('.receipt-items'); itemsContainer.innerHTML = '';
            if (ticket.items) { ticket.items.forEach((i, index) => { let detail = `${i.name}`; if(i.meat) detail += ` (${i.meat})`; if(i.addons.length) detail += ` +${i.addons.join(',')}`; const row = document.createElement('div'); row.className = "flex justify-between text-xs"; row.innerHTML = `<div class="flex gap-1 text-gray-400"><span class="w-4">${index+1}.</span><span>${detail}</span></div><span class="font-bold text-gray-700">${i.price}.-</span>`; itemsContainer.appendChild(row); }); }
            const div = document.getElementById('receipt-capture'); div.style.visibility = 'visible'; div.style.zIndex = '-100';
            setTimeout(() => { html2canvas(div, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false }).then(canvas => { div.style.visibility = 'hidden'; hideGlobalLoader(); openReceiptResult(canvas.toDataURL('image/png')); showToast('‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success'); }).catch((e) => { div.style.visibility = 'hidden'; console.error(e); hideGlobalLoader(); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û', 'error'); }); }, 800);
        }

        async function submitOrderToLine() {
            if (isSyncing) { showToast("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...", 'info'); return; }
            if (isSubmitting) return;
            const name = document.getElementById('user-name').value.trim(); if (!name) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á', 'warning');
            isSubmitting = true;
            const btn = document.getElementById('btn-submit-order'); const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...'; btn.classList.add('opacity-50', 'cursor-not-allowed');
            try {
                showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå...");
                let subtotal = cart.reduce((sum, i) => sum + i.price, 0); let discountFromCode = 0;
                const code = document.getElementById('discount-code').value.trim().toUpperCase(); const promo = promotions.find(p => p.code === code); if (promo && subtotal >= promo.minOrder) discountFromCode = promo.value;
                let discountFromPoints = 0; if (pointsRedeemed > 0) discountFromPoints = Math.floor(pointsRedeemed / 100) * 10;
                const netTotal = Math.max(0, subtotal - discountFromCode - discountFromPoints);
                const pointsEarned = calculatePoints(netTotal); const currentPoints = userStats.points || 0; const newPointsBalance = currentPoints + pointsEarned - pointsRedeemed;
                if (!userStats.history) userStats.history = []; const historyTimestamp = new Date().toISOString();
                if (pointsRedeemed > 0) { userStats.history.unshift({ type: 'redeem', amount: pointsRedeemed, date: historyTimestamp, orderId: currentOrderId }); }
                if (pointsEarned > 0) { userStats.history.unshift({ type: 'earn', amount: pointsEarned, date: historyTimestamp, orderId: currentOrderId }); }
                if (userStats.history.length > 20) userStats.history = userStats.history.slice(0, 20);
                userStats.points = newPointsBalance; localStorage.setItem(KEYS.STATS, JSON.stringify(userStats)); updatePointsDisplay();
                
                const allNotes = cart.filter(i => i.note).map(i => i.note).join(", ");
                if(!currentOrderId) generateOrderId(); const nowStr = `${getStandardDate(new Date())} ${formatTime(new Date())}`;
                
                let msg = `üî• ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà! [${currentOrderId}]\nüéüÔ∏è ‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢: ${currentOrderId.slice(-2)}\nüìÖ ${nowStr}\nüë§ ‡∏Ñ‡∏∏‡∏ì ${name}\nü™ô ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ: +${pointsEarned} ‡∏û‡∏≠‡∏¢‡∏ï‡πå\n------------------------\n`;
                cart.forEach((i, index) => { let detail = `${i.name} ${i.meat ? '('+i.meat+')' : ''}`; if(i.addons.length) detail += ` +${i.addons.join('+')}`; if(i.note) detail += ` [${i.note}]`; msg += `${index + 1}. ${detail} (${i.price}.-)\n`; });
                msg += `------------------------\nüíµ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${subtotal} ‡∏ö‡∏≤‡∏ó\n`; if (discountFromCode > 0) msg += `üè∑Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î: -${discountFromCode} ‡∏ö‡∏≤‡∏ó\n`; if (discountFromPoints > 0) msg += `ü™ô ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏≠‡∏¢‡∏ï‡πå: -${discountFromPoints} ‡∏ö‡∏≤‡∏ó\n`; if (pointsRedeemed > 0) msg += `ü™ô ‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå: ${pointsRedeemed} ‡∏û‡∏≠‡∏¢‡∏ï‡πå\n`; msg += `üí∞ ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${netTotal} ‡∏ö‡∏≤‡∏ó\n`;

                const sheetData = { orderId: currentOrderId, name: name, items: cart, totalPrice: subtotal, discountCode: discountFromCode, discountPoints: discountFromPoints, netTotal: netTotal, pointsEarned: pointsEarned, pointsRedeemed: pointsRedeemed, pointsBalance: newPointsBalance, allNotes: allNotes, userId: userAvatar.userId };
                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) { fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sheetData), keepalive: true }).catch(err => console.error("Sheet Error:", err)); }

                saveTicketToHistory(currentOrderId, netTotal); const lineOAId = "@772ysswn"; const encodedMsg = encodeURIComponent(msg);
                confetti();
                
                setTimeout(() => {
                    cart = []; discountValue = 0; pointsRedeemed = 0; isPointsActive = false; currentOrderId = "";
                    saveToLS(); updateMiniCart(); closeCheckout(); hideGlobalLoader();
                    window.location.href = `https://line.me/R/oaMessage/${lineOAId}/?${encodedMsg}`;
                    isSubmitting = false; btn.innerHTML = originalText; btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }, 1000);
            } catch (error) {
                hideGlobalLoader(); showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", 'error'); isSubmitting = false; btn.innerHTML = originalText; btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function openRandomizer() {
            const mainDishes = menuItems.filter(i => i.category !== 'dessert' && i.category !== 'promotion' && !i.soldOut && !i.isTray);
            if(mainDishes.length === 0) return showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°‡∏à‡πâ‡∏≤", "error");
            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢...");
            setTimeout(() => {
                hideGlobalLoader(); const randomIndex = Math.floor(Math.random() * mainDishes.length); const selectedItem = mainDishes[randomIndex];
                openModal(selectedItem); showToast(`üéâ ‡∏î‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠... ${selectedItem.name}!`, "success"); triggerHaptic('heavy');
            }, 1500);
        }

        function enableSwipeToClose(el, scrollEl, closeCallback) {
            let startY = 0; let currentY = 0; let isDragging = false;
            el.addEventListener('touchstart', (e) => { if (scrollEl.scrollTop <= 0) { startY = e.touches[0].clientY; isDragging = true; el.style.transition = 'none'; } }, { passive: true });
            el.addEventListener('touchmove', (e) => { if (!isDragging) return; const diff = e.touches[0].clientY - startY; if (diff > 0) { if (scrollEl.scrollTop > 0) return; e.preventDefault(); el.style.transform = `translateY(${diff}px)`; currentY = diff; } }, { passive: false });
            el.addEventListener('touchend', () => { if (!isDragging) return; isDragging = false; el.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)'; if (currentY > 150) closeCallback(); else el.style.transform = ''; currentY = 0; });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const _modalContent = document.getElementById('modal-content'); const _modalScroll = document.getElementById('modal-scroll-area'); if (_modalContent && _modalScroll) enableSwipeToClose(_modalContent, _modalScroll, closeModal);
                const _checkoutSheet = document.getElementById('checkout-sheet'); const _cartList = document.getElementById('checkout-scrollable'); if (_checkoutSheet && _cartList) enableSwipeToClose(_checkoutSheet, _cartList, closeCheckout);
                const _ticketsSheet = document.getElementById('tickets-sheet'); const _ticketsList = document.getElementById('tickets-list'); if (_ticketsSheet && _ticketsList) enableSwipeToClose(_ticketsSheet, _ticketsList, closeMyTickets);
            }, 500);
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                triggerHaptic();
                if (currentOpenModal === 'menu') closeModal(true); else if (currentOpenModal === 'checkout') closeCheckout(true); else if (currentOpenModal === 'tickets') closeMyTickets(true); else if (currentOpenModal === 'avatar') closeAvatarModal(true); else if (currentOpenModal === 'points-history') closePointsHistory(true); else if (!document.getElementById('welcome-modal').classList.contains('hidden')) closeWelcome();
            }
            if (e.key === 'Enter') {
                const activeElement = document.activeElement; triggerHaptic();
                if (activeElement && activeElement.id === 'user-name') { const submitBtn = document.getElementById('btn-submit-order'); if (submitBtn && !submitBtn.disabled) submitOrderToLine(); }
                if (currentOpenModal === 'menu' && currentItem) addToCart();
                if (activeElement && activeElement.id === 'discount-code') applyDiscount();
            }
            if (currentOpenModal === 'menu' && currentItem) { if (e.key === 'ArrowUp') { e.preventDefault(); triggerHaptic(); adjustQty(1); } else if (e.key === 'ArrowDown') { e.preventDefault(); triggerHaptic(); adjustQty(-1); } }
        });
        window.addEventListener('error', function(e) { console.error('Global error caught:', e.error); e.preventDefault(); });
        document.addEventListener('error', function(e) { if (e.target.tagName.toLowerCase() === 'img') { e.target.src = 'https://cdn-icons-png.flaticon.com/512/135/135161.png'; e.target.alt = 'Image not found'; e.target.classList.add('opacity-50'); } }, true);
    </script>
</body>
</html>
