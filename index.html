<!DOCTYPE html>
<html lang="th">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FEF9F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preconnect" href="https://static.line-scdn.net">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4FR74WPRNY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4FR74WPRNY');
    </script>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    
    <title>Kaprao52 - APP</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script defer src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            purple: '#8B5CF6', 
                            yellow: '#FBBF24',
                            text: '#1F2937',        
                        }
                    },
                    fontFamily: {
                        sans: ['Kanit', 'sans-serif'],
                        round: ['Kanit', 'sans-serif'] 
                    },
                    borderRadius: {
                        '4xl': '2.5rem',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* === THEME VARIABLES === */
        :root {
            --bg-primary: #FEF9F3;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #FFF8F0;
            --text-primary: #1A1A1A;
            --text-secondary: #4A4A4A;
            --text-tertiary: #6B6B6B;
            --border-color: rgba(212, 175, 55, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-heavy-bg: rgba(255, 255, 255, 0.98);
            --card-bg: #FFFFFF;
            --card-hover: #FFF8F0;
            --shadow: rgba(212, 175, 55, 0.15);
            --shadow-hover: rgba(212, 175, 55, 0.25);
            --close-btn-bg: #F5F5F5;
            --close-btn-color: #4A4A4A;

            /* ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå - Light Theme */
            --meat-option-bg: #FFFFFF;
            --meat-option-border: rgba(212, 175, 55, 0.3);
            --meat-option-text: #4A4A4A;
            --meat-option-hover-bg: #FFF8F0;
            --meat-option-selected-bg: rgba(212, 175, 55, 0.25);
            --meat-option-selected-border: #D4AF37;
            --meat-option-selected-text: #8B6914;
            --meat-option-icon-color: #D4AF37;

            /* Enhanced light theme colors */
            --accent-primary: #D4AF37;
            --accent-secondary: #8B6914;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --info-color: #3B82F6;
        }
        
        

        /* Base Styles */
        body { 
            color: var(--text-primary); 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            background: var(--bg-primary);
            transition: background-color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
            scroll-behavior: smooth;
        }
        .safe-area-pt { padding-top: var(--sat); }
        .safe-area-pb { padding-bottom: var(--sab); }
        .safe-area-pb-plus { padding-bottom: calc(1rem + var(--sab)); }
        
        /* === SMOOTH SCROLL & TEXT SELECTION === */
        html {
            scroll-behavior: smooth;
        }
        
        ::selection {
            background-color: rgba(212, 175, 55, 0.3);
            color: var(--text-primary);
        }

        /* --- BACKGROUND ANIMATION --- */
        #bubbles-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        .bubble {
            position: absolute;
            bottom: -100px;
            background-color: rgba(212, 175, 55, 0.12);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUpSmooth linear infinite;
            z-index: -1;
        }
        .bubble.purple {
            background-color: rgba(184, 134, 11, 0.08);
        }
        
        @keyframes floatUpSmooth {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            8% { opacity: 0.8; }
            92% { opacity: 0.8; }
            100% { transform: translateY(-110vh) translateX(20px); opacity: 0; }
        }

        /* --- NEO-GLASS COMPONENTS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-color);
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .fast-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.12), 0 2px 8px rgba(212, 175, 55, 0.08);
            border-radius: 1.5rem;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }
        .fast-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(212, 175, 55, 0.2), 0 8px 16px rgba(212, 175, 55, 0.12);
            border-color: rgba(251, 191, 36, 0.4);
        }
        .fast-card:active {
            transform: scale(0.96) translateY(-2px);
            background: var(--card-hover);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .glass-heavy {
            background: var(--glass-heavy-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-top: 1px solid var(--border-color);
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* --- ANIMATIONS --- */
        .btn-bounce { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-bounce:active { transform: scale(0.92); }

        /* === Micro-interaction: Squash & Stretch === */
        .btn-press { transform-origin: center; }
        .btn-press.squash { transform: scaleX(1.12) scaleY(0.88); transition: transform 140ms cubic-bezier(0.2,0.8,0.2,1); }
        .btn-press.rebound { animation: squashRebound 480ms cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes squashRebound {
            0% { transform: scaleX(1.12) scaleY(0.88); }
            50% { transform: scaleX(0.92) scaleY(1.12); }
            100% { transform: scaleX(1) scaleY(1); }
        }

        /* === Add-to-Cart flying icon === */
        .fly-item {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            font-size: 1.8rem;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            color: white;
            box-shadow: 0 12px 32px rgba(245, 158, 11, 0.4), 0 0 16px rgba(245, 158, 11, 0.2);
            will-change: transform, opacity;
            animation: flyUp 1.2s cubic-bezier(0.2, 0.8, 0.4, 1) forwards;
        }
        
        @keyframes flyUp {
            0% { 
                opacity: 1; 
                transform: translate(0, 0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translate(0, -150px) scale(0.3); 
            }
        }

        .stagger-item { 
            opacity: 0; 
            animation: fadeInUpSmooth 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; 
        }
        @keyframes fadeInUpSmooth { 
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        .skeleton {
            background: var(--card-bg);
            position: relative; overflow: hidden;
        }
        .skeleton::after {
            content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-100%); animation: shimmerSmooth 2s infinite;
        }
        @keyframes shimmerSmooth { 100% { transform: translateX(100%); } }

        .page-out { animation: pageOut 0.2s cubic-bezier(0.4, 0, 1, 1) forwards; }
        .page-in { animation: pageIn 0.3s cubic-bezier(0, 0, 0.2, 1) forwards; }
        @keyframes pageOut { to { opacity: 0; transform: scale(0.96) translateY(10px); } }
        @keyframes pageIn { from { opacity: 0; transform: scale(0.96) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .category-pill-active {
            background: linear-gradient(135deg, #FFF8F0 0%, rgba(212, 175, 55, 0.15) 100%);
            border: 2px solid #D4AF37;
            color: var(--text-primary);
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.25);
            transform: scale(1.06);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .category-pill-inactive {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .category-pill-inactive:hover {
            border-color: rgba(251, 191, 36, 0.3);
            transform: translateY(-1px);
        }

        .text-gradient {
            background: linear-gradient(to right, #7C3AED, #DB2777);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-gradient {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.35);
            border: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-gradient:hover {
            box-shadow: 0 12px 30px rgba(245, 158, 11, 0.4);
            transform: translateY(-2px);
        }
        .btn-gradient:active {
            transform: scale(0.96);
        }
        .btn-gradient-purple {
            background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.35);
            border: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-gradient-purple:hover {
            box-shadow: 0 12px 30px rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }
        .btn-gradient-purple:active {
            transform: scale(0.96);
        }

        /* Icon rotation on hover for menu and tabs */
        .tab-icon, .menu-icon {
            display: inline-block;
            transition: transform 400ms cubic-bezier(.2,.9,.2,1);
            transform-origin: center center;
        }
        .fast-card:hover .menu-icon {
            transform: rotate(15deg) scale(1.1);
        }
        #tabs-container button:hover .tab-icon {
            transform: rotate(18deg) scale(1.12);
        }
        #tabs-container button:active {
            transform: scale(0.94);
        }
        #tabs-container button:active .tab-icon {
            transform: rotate(18deg) scale(1.05);
        }

        #global-loader { 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            background: var(--bg-primary); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.5s, background 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); 
        }
        .loader-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .cooking-pan { 
            font-size: 5rem; 
            animation: panFlipSmooth 2s infinite cubic-bezier(0.3, 0.7, 0.3, 1); 
            transform-origin: center bottom; 
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }
        @keyframes panFlipSmooth { 
            0%, 100% { transform: rotate(0deg); } 
            25% { transform: rotate(-12deg); } 
            50% { transform: rotate(0deg); }
            75% { transform: rotate(12deg); } 
        }

        #wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto 20px auto; filter: drop-shadow(0 16px 24px rgba(0,0,0,0.2)); }
        #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 9s cubic-bezier(0.05, 0.95, 0.05, 0.95); }
        .wheel-pointer { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 40px solid #F59E0B; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.25)); z-index: 20; }
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: linear-gradient(135deg, var(--card-bg), rgba(251, 191, 36, 0.1)); border-radius: 50%; z-index: 10; box-shadow: 0 8px 24px var(--shadow), 0 0 16px rgba(251, 191, 36, 0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; transition: all 0.5s ease; border: 2px solid rgba(251, 191, 36, 0.3); }

        #receipt-capture { position: fixed; top: -9999px; left: -9999px; width: 400px; background: var(--card-bg); padding: 0; border-radius: 0; font-family: 'Kanit', sans-serif; color: var(--text-primary); transition: background 0.5s ease, color 0.5s ease; }

        .xp-bar-bg { background-color: var(--bg-tertiary); border-radius: 9999px; overflow: hidden; height: 10px; transition: background 0.5s ease; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); }
        .xp-bar-fill { background: linear-gradient(90deg, #F59E0B, #D97706, #F59E0B); height: 100%; transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); border-radius: 9999px; }
        
        .ticket-stub {
            background-image: radial-gradient(circle at 0 50%, transparent 8px, var(--card-bg) 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, var(--card-bg) 8.5px);
            background-position: 0 0, 0 0; 
            background-size: 100% 100%; 
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .ticket-stub:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .ticket-stub:active {
            transform: scale(0.98);
        }
        
        .avatar-option { 
            width: 72px; 
            height: 72px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            background: var(--card-bg); 
            padding: 6px; 
            border: 2px solid var(--border-color); 
        }
        .avatar-option img { width: 100%; height: 100%; object-fit: contain; }
        .avatar-option:hover { 
            transform: scale(1.15); 
            border-color: rgba(251, 191, 36, 0.7);
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.2);
        }
        .avatar-option:active {
            transform: scale(0.95);
        }
        .avatar-selected { 
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1)) !important; 
            border: 2px solid #F59E0B; 
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5); 
            transform: scale(1.15); 
            animation: avatarPulse 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes avatarPulse {
            0% { transform: scale(0.9); }
            50% { transform: scale(1.22); }
            100% { transform: scale(1.15); }
        }

        /* === ACCESSIBILITY FEATURES === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .focus-visible:focus {
            outline: 2px solid #D4AF37;
            outline-offset: 3px;
        }
        
        /* === SMOOTH INPUT STYLES === */
        input, textarea, select {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: rgba(251, 191, 36, 0.6);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1), 0 8px 16px rgba(251, 191, 36, 0.1);
            outline: none;
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-tertiary);
            transition: color 0.3s ease;
        }
        
        input:focus::placeholder, textarea:focus::placeholder {
            color: var(--text-secondary);
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .fast-card {
                border-width: 2px;
            }
            .btn-bounce {
                border-width: 2px;
            }
            /* stronger focus outlines for accessibility */
            .btn-bounce:focus, button:focus, input:focus, textarea:focus, .meat-option:focus {
                outline: 3px solid var(--accent-primary, #FBBF24);
                outline-offset: 3px;
                box-shadow: none;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* === PERFORMANCE OPTIMIZATIONS === */
        .menu-item-container {
            contain: layout style paint;
        }
        
        .will-change-transform {
            will-change: transform;
        }
        
        .gpu-accelerated {
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        /* === VIRTUAL SCROLLING CONTAINER === */
        .virtual-scroll-container {
            height: 600px;
            overflow-y: auto;
            position: relative;
        }
        
        .virtual-scroll-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }
        
        .virtual-scroll-item {
            position: absolute;
            left: 0;
            right: 0;
            height: 200px;
        }
        
        /* === CLOSE BUTTON STYLING === */
        .close-button {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .close-button:hover {
            background: var(--card-hover);
            border-color: rgba(212, 175, 55, 0.4);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .close-button:active {
            transform: scale(0.95);
            background: var(--card-bg);
        }

        /* === THEME OVERRIDES === */
        .text-slate-100,
        .text-slate-200,
        .text-slate-300,
        .text-slate-400,
        .text-slate-500 {
            color: var(--text-primary) !important;
        }
        .text-slate-400 {
            color: var(--text-secondary) !important;
        }
        .text-slate-500 {
            color: var(--text-tertiary) !important;
        }
        .bg-slate-800,
        .bg-slate-700,
        .bg-slate-900 {
            background-color: var(--card-bg) !important;
        }
        .border-slate-700,
        .border-slate-600 {
            border-color: var(--border-color) !important;
        }
        .bg-slate-800\/50,
        .bg-slate-800\/80,
        .bg-slate-800\/90 {
            background-color: rgba(255, 255, 255, 0.9) !important;
        }
        .text-indigo-400 {
            color: #8B5CF6 !important;
        }
        .bg-indigo-500 {
            background-color: #8B5CF6 !important;
        }
        .bg-indigo-600 {
            background-color: #7C3AED !important;
        }
        body {
            background: linear-gradient(135deg, #FEF9F3 0%, #FFFBF5 50%, #FEF9F3 100%);
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .fast-card {
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFEF9 100%);
            border: 1px solid rgba(212, 175, 55, 0.15);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(212, 175, 55, 0.12);
        }
        .glass-heavy {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(24px) saturate(180%);
            border-top: 1px solid rgba(212, 175, 55, 0.15);
        }

        /* === STYLES FOR MEAT SELECTION OPTIONS === */
        .meat-option {
            background: var(--meat-option-bg);
            border: 2px solid var(--meat-option-border);
            color: var(--meat-option-text);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            min-width: 100px;
            flex-shrink: 0;
        }
        
        .meat-option:hover {
            background: var(--meat-option-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .meat-option.selected {
            background: var(--meat-option-selected-bg);
            border: 2px solid var(--meat-option-selected-border);
            color: var(--meat-option-selected-text);
            font-weight: 700;
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.25);
            transform: translateY(-2px) scale(1.05);
        }
        
        /* === STYLES FOR POINTS SYSTEM === */
        .points-discount-active {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }
        
        /* === STYLES FOR CHECKOUT LAYOUT === */
        #checkout-sheet {
            display: flex;
            flex-direction: column;
        }
        
        #cart-list-container {
            flex: 1;
            min-height: 0;
            padding-top: 1rem;
        }
        
        .checkout-fixed-section {
            flex-shrink: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
        }
        
        /* === ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠ 4: ‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á === */
        .cart-item-title {
            font-size: 0.85rem !important;
            line-height: 1.2 !important;
            margin-bottom: 0.25rem !important;
        }
        
        .cart-item-details {
            font-size: 0.75rem !important;
        }
        
        
        /* === ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î === */
        .price-breakdown {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .price-line {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 0.25rem 0;
        }
        
        .discount-line {
            color: #10B981;
        }
        
        .points-line {
            color: #F59E0B;
        }

        /* === ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠ 4) === */
        .category-pill {
            min-width: 100px;
            padding: 0.75rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .category-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .category-pill-active {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            border-color: #B45309;
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        .category-pill-inactive {
            background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
            color: #4B5563;
            border-color: #E5E7EB;
        }

        .category-pill-inactive:hover {
            background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
            border-color: #D1D5DB;
        }

        .category-pill-promotion {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: #92400E;
            border-color: #F59E0B;
        }

        .category-pill-promotion:hover {
            background: linear-gradient(135deg, #FDE68A 0%, #FCD34D 100%);
        }

        .category-pill-tray {
            background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
            color: #3730A3;
            border-color: #818CF8;
        }

        .category-pill-tray:hover {
            background: linear-gradient(135deg, #C7D2FE 0%, #A5B4FC 100%);
        }

        /* === New Stepper Styles === */
        .stepper-container {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
            height: 40px;
        }
        
        .stepper-btn {
            width: 40px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .stepper-btn:hover {
            background: var(--card-hover);
        }
        
        .stepper-btn:active {
            transform: scale(0.95);
        }
        
        .stepper-decrease {
            border-right: 1px solid var(--border-color);
        }
        
        .stepper-increase {
            border-left: 1px solid var(--border-color);
        }
        
        .stepper-input {
            flex: 1;
            text-align: center;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            outline: none;
            padding: 0 0.5rem;
        }
        
        /* === Toggle Switch Styles === */
        .toggle-switch {
            position: relative;
            width: 52px;
            height: 26px;
            flex-shrink: 0;
        }
        
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .toggle-checkbox:checked + .toggle-slider {
            background-color: #F59E0B;
        }
        
        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-checkbox:focus + .toggle-slider {
            box-shadow: 0 0 1px #F59E0B;
        }

        /* === NEW: Range Slider Styles === */
        .points-range-container {
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .points-range {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #F59E0B, #D97706);
            border-radius: 10px;
            outline: none;
        }
        
        .points-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 3px solid #F59E0B;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .points-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .points-range::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 3px solid #F59E0B;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        
        .points-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .points-input {
            flex: 1;
            background: var(--card-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            outline: none;
        }
        
        .points-input:focus {
            border-color: rgba(251, 191, 36, 0.6);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }
        
        .points-input-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .points-display {
            font-size: 0.85rem;
            color: #F59E0B;
            font-weight: 600;
            margin-top: 0.25rem;
            text-align: center;
        }

    </style>
</head>
<body class="pb-40 font-sans select-none relative overflow-x-hidden safe-area-pt">

    <div id="bubbles-container"></div>


    <div id="global-loader">
        <div class="relative mb-4">
            <div class="absolute inset-0 bg-yellow-200 rounded-full blur-xl opacity-50 animate-pulse"></div>
            <div class="cooking-pan relative z-10">üç≥</div>
        </div>
        <h2 class="text-xl font-bold text-slate-200 tracking-wider">KAPRAO<span class="text-yellow-500">52</span></h2>
        <p id="loader-text" class="text-xs text-slate-400 mt-2 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡πâ‡∏≤‡∏ô...</p>
    </div>

    <div id="welcome-modal" class="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm flex items-center justify-center p-6 stagger-item">
        <div class="glass-heavy rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden border border-slate-700/50">
            <button onclick="closeWelcome()" class="btn-bounce absolute top-4 right-4 z-50 close-button w-11 h-11 rounded-full flex items-center justify-center shadow-lg active:bg-slate-900 transition-all border-2">
                <i class="fas fa-times text-sm"></i>
            </button>
            <div class="relative z-10">
                <div class="w-24 h-24 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-4 text-5xl shadow-lg border border-slate-700 animate-bounce-slow">
                    üéüÔ∏è
                </div>
                <h2 class="text-2xl font-black text-slate-200 mb-2">‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î!</h2>
                <p class="text-slate-300 mb-6 leading-relaxed text-sm">
                    <span class="font-bold text-indigo-400 text-base">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á!</span><br>
                    ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ (‡∏ô‡πâ‡∏≠‡∏¢‡πÜ) ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô<br>
                    ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ Order ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö<br>
                    <span class="bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded font-bold border border-yellow-500/30">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•</span><br>
                    ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! üéÅ
                </p>
                <div class="flex flex-col gap-3">
                      <button onclick="requestNotifPermission()" class="btn-bounce w-full bg-slate-800 text-indigo-400 font-bold py-3 rounded-xl shadow-sm border border-indigo-500/30 transition-all text-sm focus-visible" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏´‡∏ß‡∏¢">
                        <i class="fas fa-bell mr-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏´‡∏ß‡∏¢
                    </button>
                    <button onclick="closeWelcome()" class="btn-bounce w-full btn-gradient-purple text-white font-bold py-4 rounded-xl shadow-lg transition-all text-lg hover:scale-[1.02] focus-visible" aria-label="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
                        ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢! ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î üé∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="avatar-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[120] hidden transition-opacity opacity-0 flex items-center justify-center p-6">
        <div class="glass-heavy rounded-[2rem] p-6 max-w-sm w-full shadow-2xl stagger-item border border-slate-700/60">
            <h3 class="text-xl font-bold text-center mb-4 text-slate-200">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß üë§</h3>
            
            <div class="grid grid-cols-4 gap-4 mb-6" id="avatar-grid"></div>

            <div class="mb-6">
                 <label class="text-sm font-bold text-slate-300 mb-2 block pl-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üí¨</label>
                 <input type="text" id="pet-name-input" maxlength="12" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-center font-bold text-indigo-400 focus:border-indigo-500 outline-none transition-all text-slate-200">
            </div>

            <button onclick="closeAvatarModal()" class="btn-bounce w-full btn-gradient text-white font-bold py-3 rounded-xl shadow-lg transition-all text-lg">
                ‡∏ï‡∏Å‡∏•‡∏á
            </button>
        </div>
    </div>

    <div class="px-6 pt-6 pb-2 bg-transparent relative z-10">
        
        <div class="flex justify-between items-start mb-6">
            <div class="flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-1">
                    <p class="text-xs text-slate-400 font-medium">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ?</p>
                    <button id="line-login-btn" onclick="handleLogin()" class="hidden bg-[#06C755] hover:bg-[#05b34c] text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm transition-all flex items-center gap-1 btn-bounce">
                        <i class="fab fa-line"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
                
                <h1 class="text-4xl sm:text-5xl font-black leading-none tracking-tighter mb-2 relative z-10 pt-1 drop-shadow-sm whitespace-nowrap flex items-baseline">
                    <span class="text-slate-100">KAPRAO</span>
                    <span class="text-yellow-500 ml-1">52</span>
                </h1>
            </div>

            <div class="flex flex-col items-center">
                 <div id="header-avatar-btn" onclick="openAvatarModal()" class="btn-bounce w-24 h-24 rounded-full bg-slate-800 border border-slate-700 shadow-lg flex items-center justify-center relative cursor-pointer overflow-hidden">
                      <img id="avatar-img" src="" class="w-full h-full object-cover">
                      <div class="absolute bottom-0 right-0 bg-indigo-500 rounded-full w-7 h-7 flex items-center justify-center shadow-md border-2 border-slate-700 z-30" style="bottom: 5px; right: 5px;">
                          <i class="fas fa-pen text-xs text-white"></i>
                      </div>
                </div>
                <p id="avatar-name-display" class="text-xs font-round font-bold text-indigo-400 mt-3 tracking-wide bg-slate-800/90 px-4 py-1 rounded-full shadow-sm border border-slate-700/50 text-slate-200">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                <div id="vip-badge" class="hidden mt-2 text-[10px] font-bold text-yellow-400 bg-yellow-600/10 px-2 py-0.5 rounded-full border border-yellow-500/30">VIP</div>
            </div>
        </div>

        <div class="glass-panel p-4 rounded-xl shadow-sm mb-1 flex items-center gap-4 stagger-item" style="animation-delay: 0.1s;">
            <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-inner border-2 border-yellow-500/30 bg-gradient-to-br from-yellow-500/20 to-orange-500/10">
                ü™ô
            </div>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-slate-200">KAPRAO POINTS</span>
                    <button onclick="openPointsHistory()" class="px-3 py-1.5 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-xs font-medium rounded-lg shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 flex items-center gap-1">
                        üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå
                    </button>
                </div>
                <div class="flex items-baseline gap-2">
                    <span id="points-count" class="text-3xl font-black text-yellow-500">0</span>
                    <span class="text-sm text-slate-400">‡∏û‡∏≠‡∏¢‡∏ï‡πå</span>
                </div>
                <p class="text-[10px] text-slate-400 mt-1">100 ‡∏û‡∏≠‡∏¢‡∏ï‡πå ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡πÄ‡∏á‡∏¥‡∏ô 10 ‡∏ö‡∏≤‡∏ó</p>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 mt-2">
            <p class="text-[10px] text-slate-400">‡∏™‡∏∞‡∏™‡∏°‡∏û‡∏≠‡∏¢‡∏ï‡πå‡πÅ‡∏•‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°!</p>
            <div class="flex items-center gap-2">
                <button onclick="openMyTickets()" class="btn-bounce bg-slate-800/80 px-3 py-1.5 rounded-full border border-slate-700 shadow-sm flex items-center gap-2 text-xs font-bold text-slate-200 active:bg-slate-700 transition-all">
                    <span>üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                    <div id="unread-ticket-dot" class="w-2 h-2 bg-red-500 rounded-full hidden"></div>
                </button>
            </div>
        </div>

    </div>

    <div class="max-w-md mx-auto px-5 relative z-10">
        
        <div class="mb-3 flex items-center justify-between">
            <h3 class="font-bold text-slate-200 text-lg flex items-center gap-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
            <div class="flex gap-2">
                <button onclick="scrollTabs(-100)" class="btn-bounce bg-slate-800 w-11 h-11 rounded-full flex items-center justify-center text-slate-400 hover:text-indigo-400 transition-all border border-slate-700 shadow-sm"><i class="fas fa-chevron-left text-xs"></i></button>
                <button onclick="scrollTabs(100)" class="btn-bounce bg-slate-800 w-11 h-11 rounded-full flex items-center justify-center text-slate-400 hover:text-indigo-400 transition-all border border-slate-700 shadow-sm"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>
        </div>
        
        <div id="tabs-container" class="sticky top-0 z-30 pt-2 pb-4 -mx-5 px-5 flex gap-3 snap-x scroll-smooth overflow-x-auto hide-scroll transition-all">
            <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠ 4: ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà -->
            <button onclick="switchCategory('tray')" id="tab-tray" aria-label="‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°" class="category-pill category-pill-tray snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üç±</span>
                <span class="text-xs font-bold">‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°</span>
            </button>

            <button onclick="switchCategory('kaprao')" id="tab-kaprao" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üå∂Ô∏è</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤</span>
            </button>
            <button onclick="switchCategory('garlic')" id="tab-garlic" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üßÑ</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</span>
            </button>
            <button onclick="switchCategory('noodle')" id="tab-noodle" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üçú</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô</span>
            </button>
            <button onclick="switchCategory('soup')" id="tab-soup" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üç≤</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°</span>
            </button>
            <button onclick="switchCategory('others')" id="tab-others" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏Ç‡πà/‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üç≥</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏Ç‡πà/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
            </button>
            <button onclick="switchCategory('dessert')" id="tab-dessert" aria-label="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô" class="category-pill category-pill-inactive snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üç®</span>
                <span class="text-xs">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</span>
            </button>
            <button onclick="switchCategory('promotion')" id="tab-promotion" aria-label="‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="category-pill category-pill-promotion snap-start">
                <span class="text-xl tab-icon" aria-hidden="true">üßß</span>
                <span class="text-xs font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
            </button>
        </div>

        <div class="mb-4 mt-2">
            <h3 id="section-title" class="font-bold text-slate-200 text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
        </div>

        <div id="dessert-msg" class="hidden mb-6 stagger-item">
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 flex flex-col items-center justify-center text-center shadow-sm">
                <div class="text-3xl mb-2">üç® ‚ú®</div>
                <h4 class="font-bold text-indigo-400 text-sm">‡∏£‡∏≠‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà‡πÜ ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</h4>
                <p class="text-xs text-slate-400 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏î‡∏™‡∏£‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô</p>
            </div>
        </div>

        <div id="menu-grid" class="grid grid-cols-2 gap-4 mb-20" role="grid" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£"></div>

        <div class="text-center mt-12 mb-20 opacity-50">
            <p class="text-[10px] font-bold tracking-widest text-slate-500 uppercase">DEVELOPED BY SORAWIT THUNTHAKIJ V21.0.1</p>
        </div>

    </div>
    
    <div id="tickets-modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] hidden transition-opacity opacity-0" onclick="closeMyTickets()"></div>
    <div id="tickets-sheet" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-[111] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[70vh] flex flex-col safe-area-pb">
        <div class="w-full flex justify-center pt-4 pb-2">
             <div class="w-12 h-1.5 bg-slate-600 rounded-full"></div>
        </div>
        <div class="px-6 py-2 border-b border-slate-700/50 flex justify-between items-center">
            <h2 class="text-xl font-bold text-slate-200">üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏´‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <button onclick="closeMyTickets()" class="btn-bounce w-11 h-11 rounded-full close-button flex items-center justify-center"><i class="fas fa-times text-sm"></i></button>
        </div>
        <div id="tickets-list" class="flex-1 overflow-y-auto p-4 space-y-3 hide-scroll">
            <div class="text-center text-slate-400 mt-10">
                <div class="text-4xl mb-2 opacity-30">üéüÔ∏è</div>
                <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
            </div>
        </div>
    </div>

    <!-- FIX 3: Added z-[60] to mini-cart-bar and increased bottom spacing -->
    <div id="mini-cart-bar" class="fixed bottom-[calc(2.5rem+env(safe-area-inset-bottom))] left-5 right-5 z-[60] hidden stagger-item">
        <div onclick="openCheckout()" class="btn-bounce bg-slate-800/95 text-slate-100 p-4 rounded-full shadow-2xl flex justify-between items-center cursor-pointer border border-slate-700">
            <div class="flex items-center gap-3 pl-2">
                <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-slate-900 font-bold shadow-lg" id="mini-count">0</div>
                <div class="flex flex-col">
                    <span class="text-xs text-slate-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                    <span class="font-bold text-lg leading-none text-indigo-400" id="mini-total">0 ‡∏ø</span>
                </div>
            </div>
            <div class="flex items-center gap-2 pr-4 text-indigo-400 font-bold text-sm">
                <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>

    <!-- FIX 1: Increased modal z-index to [70] to be above mini-cart (z-[60]) -->
    <!-- FIX 2: Updated checkout sheet to use light theme colors -->
    <div id="checkout-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0" onclick="closeCheckout()"></div>
    
    <!-- FIX 2: Updated checkout sheet styling for light theme -->
    <div id="checkout-sheet" class="fixed bottom-0 w-full h-[90vh] flex flex-col max-w-md mx-auto z-[70] transform translate-y-full transition-transform duration-300 bg-white backdrop-blur-xl rounded-t-[2.5rem] overflow-hidden shadow-2xl border-t border-gray-200">
        
        <!-- ZONE A: FIXED HEADER -->
        <div class="flex-none pt-4 pb-2 px-6 border-b border-gray-200">
            <!-- Drag Handle -->
            <div class="w-full flex justify-center mb-2">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            
            <!-- Title Row -->
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
                <button onclick="closeCheckout()" class="btn-bounce w-11 h-11 rounded-full close-button flex items-center justify-center">
                    <i class="fas fa-times text-sm text-gray-600"></i>
                </button>
            </div>
            
            <!-- Order ID Card -->
            <div id="order-id-banner" class="hidden mb-3">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- ZONE B: SCROLLABLE CONTENT -->
        <div id="checkout-scrollable" class="flex-1 overflow-y-auto hide-scroll">
            <!-- Cart Items -->
            <div id="cart-list-container" class="px-6 py-4 space-y-3"></div>
            
            <!-- Inputs Section -->
            <div class="px-6 py-4 space-y-4">
                <!-- User Name Input -->
                <div>
                    <label class="text-xs font-bold text-gray-700 mb-2 block">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á / Note</label>
                    <div class="bg-gray-50 rounded-lg p-3 flex items-center gap-2 border border-gray-200">
                        <i class="fas fa-user text-gray-500 text-sm"></i>
                        <input type="text" id="user-name" maxlength="20" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤" 
                               class="bg-transparent w-full text-sm outline-none text-gray-800 placeholder:text-gray-400">
                    </div>
                </div>
                
                <!-- Discount Code Input -->
                <div>
                    <label class="text-xs font-bold text-gray-700 mb-2 block">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                    <div class="flex gap-2">
                        <!-- FIX 2: Added id="code-input-container" -->
                        <div id="code-input-container" class="flex-1 bg-gray-50 rounded-lg p-3 flex items-center gap-2 border border-gray-200">
                            <i class="fas fa-ticket-alt text-gray-500 text-sm" id="code-icon"></i>
                            <input type="text" id="discount-code" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" 
                                   class="bg-transparent w-full text-sm outline-none text-gray-800 placeholder:text-gray-400 uppercase">
                        </div>
                        <button onclick="applyDiscount()" id="btn-apply-code" 
                                class="btn-bounce bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-4 rounded-lg transition-colors whitespace-nowrap text-sm">
                            ‡πÉ‡∏ä‡πâ
                        </button>
                    </div>
                    <p id="discount-msg" class="text-xs h-4 mt-1 font-medium text-gray-600"></p>
                </div>
                
                <!-- Points System - UPDATED WITH SLIDER & INPUT -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-xs font-bold text-gray-700">‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                        <span id="user-points-balance" class="text-xs font-bold text-yellow-600">‡∏°‡∏µ <span id="available-points">0</span> ‡∏û‡∏≠‡∏¢‡∏ï‡πå</span>
                    </div>
                    
                    <!-- NEW: Points Slider & Input -->
                    <div id="points-controls-container" class="hidden space-y-4">
                        <!-- Slider -->
                        <div class="points-range-container">
                            <input type="range" id="points-range" min="0" max="100" value="0" step="100" class="points-range">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span id="points-max">100</span>
                            </div>
                        </div>
                        
                        <!-- Input Group -->
                        <div class="points-input-group">
                            <input type="number" id="points-input" min="0" max="100" step="100" value="0" class="points-input text-gray-800">
                            <span class="points-input-label text-gray-600">‡∏û‡∏≠‡∏¢‡∏ï‡πå</span>
                        </div>
                        
                        <!-- Discount Display -->
                        <div class="points-display">
                            ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: <span id="points-discount-amount">0</span> ‡∏ö‡∏≤‡∏ó
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-1 text-center">100 ‡∏û‡∏≠‡∏¢‡∏ï‡πå = ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                    
                    <!-- Toggle Button (Replaces old toggle) -->
                    <button id="points-toggle-btn" onclick="togglePointsUsage()" 
                            class="btn-bounce w-full mt-3 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-xl transition-all border border-gray-300">
                        <i class="fas fa-coins mr-2 text-yellow-600"></i> ‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
                    </button>
                </div>
                
                <!-- Price Breakdown (Inside scroll area) -->
                <div id="price-summary" class="mt-4 pt-4 border-t border-gray-200">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- ZONE C: STICKY FOOTER - UPDATED FOR VISIBILITY -->
        <div class="flex-none bg-white backdrop-blur-xl border-t border-gray-200 px-6 py-4 space-y-3">
            <!-- Upsell Banner -->
            <div id="points-upsell-msg" class="text-center text-xs p-2 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 font-bold hidden">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <!-- Order Summary -->
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                    <span id="summary-subtotal" class="text-sm font-bold text-gray-800">0.-</span>
                </div>
                <div id="discount-summary" class="flex justify-between items-center text-xs hidden">
                    <span class="text-green-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î</span>
                    <span class="font-bold text-green-600">-0.-</span>
                </div>
                <div id="points-summary" class="flex justify-between items-center text-xs hidden">
                    <span class="text-yellow-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏û‡∏≠‡∏¢‡∏ï‡πå</span>
                    <span class="font-bold text-yellow-600">-0.-</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                    <span class="text-lg font-bold text-gray-800">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                    <span id="summary-grand-total" class="text-2xl font-black text-yellow-600">0.-</span>
                </div>
            </div>
            
            <!-- Confirm Button - STICKY AT BOTTOM -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button onclick="submitOrderToLine()" id="btn-submit-order" 
                        class="btn-bounce w-full btn-gradient text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 text-lg">
                    <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</span>
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
            
            <!-- Safe Area Padding -->
            <div class="safe-area-pb"></div>
        </div>
    </div>

    <div id="points-history-modal" class="fixed inset-0 z-[130] bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 hidden">
        <div class="bg-slate-800 rounded-[2rem] p-1 w-full max-w-sm shadow-2xl relative overflow-hidden border border-slate-700">
            <div class="bg-slate-900/90 backdrop-blur-sm rounded-[1.8rem] p-6 text-center relative z-10">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-lg border-4 border-slate-700">
                    ü™ô
                </div>
                <h2 class="text-2xl font-black text-slate-200 mb-1">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏≠‡∏¢‡∏ï‡πå</h2>
                <p class="text-indigo-400 font-bold text-sm mb-4">KAPRAO POINTS HISTORY</p>
                
                <div id="points-history-list" class="max-h-60 overflow-y-auto mb-4">
                    <div class="text-center text-slate-400 py-8">
                        <i class="fas fa-history text-3xl mb-2 opacity-30"></i>
                        <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå</p>
                    </div>
                </div>

                <button onclick="closePointsHistory()" class="btn-bounce w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all border-2 border-indigo-500">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- FIX 1: Increased modal z-index to [70] to be above mini-cart (z-[60]) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0" onclick="closeModal()"></div>
    <div id="modal-content" class="fixed bottom-0 left-0 right-0 glass-heavy rounded-t-[2.5rem] z-[70] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[85vh] flex flex-col touch-pan-y safe-area-pb">
        
        <div id="modal-drag-handle" class="w-full flex justify-center pt-4 pb-2 cursor-grab active:cursor-grabbing z-50">
            <div class="w-12 h-1.5 bg-slate-600 rounded-full"></div>
        </div>

        <button onclick="closeModal()" class="btn-bounce absolute top-4 right-4 z-50 close-button w-11 h-11 rounded-full flex items-center justify-center shadow-lg active:bg-slate-900 transition-all border-2">
            <i class="fas fa-times text-sm"></i>
        </button>

        <div id="modal-scroll-area" class="flex-1 overflow-y-auto hide-scroll px-6 pb-24 pt-4">
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center text-6xl shadow-inner border-4 border-slate-700">
                    <span id="modal-icon">üçú</span>
                </div>
            </div>

            <div class="text-center mb-8">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-200 mb-1 font-round">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h3>
                <div class="flex justify-center items-center gap-2">
                    <span id="modal-kcal" class="text-xs bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded-full font-bold transition-all">0 kcal</span>
                    <span class="text-slate-600">|</span>
                    <span id="modal-price" class="text-xl font-bold text-indigo-400">50</span>
                    <span class="text-sm text-slate-400">‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>

            <div class="flex items-center justify-center gap-6 mb-6">
                <button onclick="adjustQty(-1)" class="btn-bounce w-12 h-12 rounded-full bg-slate-800 text-slate-300 flex items-center justify-center font-bold shadow-sm border border-slate-700 active:bg-slate-700 transition-all text-lg">-</button>
                <span id="modal-qty" class="text-2xl font-bold text-slate-200 w-8 text-center">1</span>
                <button onclick="adjustQty(1)" class="btn-bounce w-12 h-12 rounded-full btn-gradient text-white flex items-center justify-center font-bold shadow-md active:scale-95 transition-all text-lg">+</button>
            </div>

            <div id="modal-meat-section" class="mb-6 hidden">
                <h4 class="font-bold text-slate-200 mb-3 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scroll p-1" id="meat-options-container">
                    <!-- ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                </div>
            </div>

            <div id="tray-options-container" class="mb-6 hidden"></div>

            <div class="mb-6" id="addons-section">
                <h4 class="font-bold text-slate-200 mb-3 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢</h4>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 rounded-2xl bg-slate-800 border border-slate-700 hover:border-yellow-500/50 cursor-pointer transition-all has-[:checked]:bg-yellow-500/20 has-[:checked]:border-yellow-500 btn-bounce shadow-sm">
                        <div class="flex items-center gap-3"><span class="text-sm font-medium text-slate-200">üíé ‡∏û‡∏¥‡πÄ‡∏®‡∏©</span></div>
                        <div class="flex items-center gap-3"><span class="text-xs font-bold text-slate-400">+10.-</span><input type="checkbox" id="modal-opt-special" class="accent-yellow-500 w-5 h-5 rounded" value="10"></div>
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-slate-800 border border-slate-700 has-[:checked]:bg-yellow-500/20 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-slate-200">üç≥ ‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400">+10.-</span><input type="checkbox" id="modal-opt-kaikhon" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-slate-800 border border-slate-700 has-[:checked]:bg-yellow-500/20 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-slate-200">ü•ö ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400">+10.-</span><input type="checkbox" id="modal-opt-kaidao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-slate-800 border border-slate-700 has-[:checked]:bg-yellow-500/20 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-slate-200">ü•û ‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400">+10.-</span><input type="checkbox" id="modal-opt-kaijiao" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-slate-800 border border-slate-700 has-[:checked]:bg-yellow-500/20 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-slate-200">‚ö´ ‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400">+10.-</span><input type="checkbox" id="modal-opt-kaiyiewma" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-slate-800 border border-slate-700 has-[:checked]:bg-yellow-500/20 has-[:checked]:border-yellow-500 cursor-pointer btn-bounce shadow-sm"><span class="text-sm text-slate-200">ü•ö ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400">+10.-</span><input type="checkbox" id="modal-opt-kaitom" class="accent-yellow-500 w-4 h-4" value="10"></div></label>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-bold text-slate-200 mb-2 text-sm">Note</h4>
                <textarea id="modal-note" rows="2" maxlength="100" class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 text-base text-slate-200 focus:ring-2 focus:ring-indigo-500 resize-none shadow-inner placeholder:text-slate-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î, ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢..."></textarea>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-5 bg-slate-900 border-t border-slate-700 rounded-t-[2rem] safe-area-pb-plus">
            <button onclick="addToCart()" class="btn-bounce w-full btn-gradient-purple text-white font-bold text-lg py-4 rounded-full shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
                <span>‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                <i class="fas fa-plus bg-slate-800/20 rounded-full w-6 h-6 flex items-center justify-center text-xs"></i>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-10 z-[120] pointer-events-none">
        <i id="toast-icon" class="fas fa-info-circle text-yellow-400"></i>
        <span class="font-medium text-sm" id="toast-msg">Notification</span>
    </div>

    <div id="receipt-result-modal" class="fixed inset-0 z-[140] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 hidden">
        <div class="bg-transparent w-full max-w-sm flex flex-col items-center">
            <div class="bg-slate-800 p-2 rounded-lg shadow-2xl mb-4 overflow-hidden">
                <img id="receipt-result-img" class="w-full h-auto rounded" src="" alt="Receipt">
            </div>
            
            <div class="flex flex-col gap-2 w-full px-4">
                <button onclick="downloadReceiptImage()" class="btn-bounce bg-gradient-to-r from-yellow-400 to-orange-500 text-white w-full py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 text-lg">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </button>
                
                <p class="text-white/70 text-xs text-center mb-2">
                    (‡∏´‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üì∏)
                </p>

                <button onclick="document.getElementById('receipt-result-modal').classList.add('hidden')" class="btn-bounce bg-slate-800/20 hover:bg-slate-800/30 text-white w-full py-3 rounded-xl font-bold border border-slate-700/50 backdrop-blur-md">
                    ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                </button>
            </div>
        </div>
    </div>

    <div id="receipt-capture">
        <div class="bg-slate-800 p-6 relative">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-400 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm relative overflow-hidden">
                    <img id="receipt-avatar-img" src="" class="w-full h-full object-cover" crossorigin="anonymous">
                </div>
                <h2 class="text-2xl font-black text-slate-200 tracking-wider">KAPRAO52</h2>
                <p class="text-[10px] text-slate-400 tracking-widest uppercase mt-1">Authentic Thai Street Food</p>
                <div class="mt-4 inline-block px-4 py-1 bg-slate-700 rounded-full border border-slate-600">
                    <p class="text-xs font-bold text-slate-300">RECEIPT / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</p>
                </div>
            </div>

            <div class="border-t-2 border-dashed border-slate-700 my-4"></div>

            <div class="flex justify-between items-center mb-1">
                <span class="text-xs text-slate-400">Order ID</span>
                <span class="font-bold text-slate-200 tracking-wide receipt-id">KP-XX99</span>
            </div>
            <div class="flex justify-between items-center mb-1">
                <span class="text-xs text-slate-400">Date</span>
                <span class="font-medium text-xs text-slate-400 receipt-date">01/01/2024 12:00</span>
            </div>
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs text-slate-400">Customer</span>
                <span class="font-bold text-sm text-slate-200 receipt-name">Customer</span>
            </div>

            <div class="bg-slate-900 rounded-lg p-3 mb-4 space-y-2 receipt-items">
            </div>

            <div class="space-y-1">
                <div class="flex justify-between text-xs text-slate-400">
                    <span>Subtotal</span>
                    <span class="receipt-subtotal">0.-</span>
                </div>
                <div class="flex justify-between text-xs text-green-400">
                    <span>Discount</span>
                    <span class="receipt-discount">-0.-</span>
                </div>
                <div class="flex justify-between items-end mt-2 pt-2 border-t border-slate-700">
                    <span class="font-bold text-slate-200">TOTAL</span>
                    <span class="font-black text-3xl text-indigo-400 receipt-total">0.-</span>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t-2 border-dotted border-slate-700 text-center">
                <div class="flex justify-center gap-1 text-2xl text-slate-600 mb-2">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <p class="text-[10px] text-slate-400">THANK YOU FOR YOUR ORDER</p>
                <div class="mt-4 flex justify-center opacity-50">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" class="w-16 h-16 mix-blend-screen">
                </div>
            </div>
            
            <div class="absolute bottom-0 left-0 right-0 h-4 bg-slate-800" style="background: linear-gradient(45deg, transparent 33.333%, #1E293B 33.333%, #1E293B 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #1E293B 33.333%, #1E293B 66.667%, transparent 66.667%); background-size: 20px 40px; transform: translateY(10px);"></div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. DATA (MOVE TO TOP to prevent undefined errors)
        // ============================================
        
        // --- LIFF CONFIGURATION ---
        const MY_LIFF_ID = '2008781875-6whmY1cf'; 
        
        // --- GOOGLE SHEET CONFIG (UPDATED) ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJLm7apFr5a6tZc1OcPUT84JATeVlVMs_cWiDs3cdh7BepP78OAs-TsF-2WqCRh9pj/exec'; 
        
        const menuItems = [
            // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà: ‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î (Moved to top of logic, but rendering order depends on category switch) üî•
            { 
                id: 201, 
                name: "Set 1: Solo Tray (‡∏•‡∏∏‡∏¢‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß)", 
                price: 89, 
                icon: "üì¶", 
                category: "tray", 
                reqMeat: false, 
                isTray: true, 
                trayType: 1, 
                kcal: 750 
            },
            { 
                id: 202, 
                name: "Set 2: Buddy Tray (‡∏Ñ‡∏π‡πà‡∏´‡∏π)", 
                price: 149, 
                icon: "üç±", 
                category: "tray", 
                reqMeat: false, 
                isTray: true, 
                trayType: 2, 
                kcal: 1400 
            },

            { id: 2, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ", price: 55, icon: "üéç", category: "kaprao", reqMeat: true, kcal: 350 },
            { id: 3, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö", price: 50, icon: "üê∑", category: "kaprao", reqMeat: false, kcal: 520 },
            { id: 4, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á", price: 50, icon: "ü•ì", category: "kaprao", reqMeat: false, kcal: 550 },
            { id: 5, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠", price: 50, icon: "ü•©", category: "kaprao", reqMeat: false, kcal: 600 },
            { id: 6, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤", price: 60, icon: "‚ö´", category: "kaprao", reqMeat: false, kcal: 650 },
            { id: 102, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "ü¶ê", category: "kaprao", reqMeat: false, kcal: 450, isNew: true },
            { id: 105, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà", price: 50, icon: "üêî", category: "kaprao", reqMeat: false, kcal: 450, isNew: true }, 
            { id: 108, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å", price: 60, icon: "ü¶ë", category: "kaprao", reqMeat: false, kcal: 480, isNew: true }, 

            { id: 10, name: "‡∏°‡∏≤‡∏°‡πà‡∏≤‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤", price: 50, icon: "üçú", category: "noodle", reqMeat: true, kcal: 450 },
            { id: 1, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô", price: 55, icon: "üçù", category: "noodle", reqMeat: true, kcal: 400 },
            
            { id: 7, name: "‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üßÑ", category: "garlic", reqMeat: false, kcal: 500 },
            { id: 8, name: "‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçñ", category: "garlic", reqMeat: false, kcal: 580 },
            { id: 9, name: "‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçò", category: "garlic", reqMeat: false, kcal: 530 },
            { id: 103, name: "‡∏Å‡∏∏‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 60, icon: "üç§", category: "garlic", reqMeat: false, kcal: 480, isNew: true },

            { id: 101, name: "‡∏ï‡πâ‡∏°‡∏à‡∏∑‡∏î‡πÑ‡∏Ç‡πà‡∏ô‡πâ‡∏≥ (‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß)", price: 40, icon: "ü•ò", category: "soup", reqMeat: false, kcal: 350, isNew: true },

            { id: 11, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏ú‡∏≤", price: 40, icon: "üå∂Ô∏è", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 450 },
            { id: 12, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô", price: 40, icon: "üçö", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 380 },
            { id: 13, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡∏¥‡∏Å‡∏™‡∏î", price: 50, icon: "ü•ò", category: "others", reqMeat: false, kcal: 420 },
            { id: 14, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß 3 ‡∏ü‡∏≠‡∏á", price: 50, icon: "üç≥", category: "others", reqMeat: false, kcal: 480 },
            { id: 15, name: "‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üéã", category: "others", reqMeat: true, kcal: 300 },
            { id: 104, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "üç≥", category: "others", reqMeat: false, kcal: 550, isNew: true },
            { id: 106, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 520, isNew: true }, 
            { id: 107, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏´‡∏°‡∏π‡∏ä‡∏¥‡πâ‡∏ô (‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠)", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 600, isNew: true }, 

            { id: 20, name: "‡πÄ‡∏â‡∏≤‡∏Å‡πä‡∏ß‡∏¢‡∏ô‡∏°‡∏™‡∏î", price: 30, icon: "üßä", category: "dessert", reqMeat: false, kcal: 150 },
            { id: 21, name: "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", price: 25, icon: "üçå", category: "dessert", reqMeat: false, kcal: 220 },
        ];

        const promotions = [
            { 
                code: "SAVE10", 
                title: "Set ‡∏≠‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏° (Value) ü•â", 
                desc: "‡∏Ñ‡∏£‡∏ö 150.- ‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó", 
                minOrder: 150, 
                type: "discount", 
                value: 10, 
                color: "bg-orange-400", 
                icon: "ü•°" 
            },
            { 
                code: "SAVE25", 
                title: "Set ‡∏¢‡∏Å‡πÅ‡∏Å‡πä‡∏á (Gang) ü•à", 
                desc: "‡∏Ñ‡∏£‡∏ö 300.- ‡∏•‡∏î 25 ‡∏ö‡∏≤‡∏ó", 
                minOrder: 300, 
                type: "discount", 
                value: 25, 
                color: "bg-blue-500", 
                icon: "üõµ" 
            },
            { 
                code: "SAVE50", 
                title: "Set ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏° (Grand) ü•á", 
                desc: "‡∏Ñ‡∏£‡∏ö 500.- ‡∏•‡∏î 50 ‡∏ö‡∏≤‡∏ó", 
                minOrder: 500, 
                type: "discount", 
                value: 50, 
                color: "bg-brand-purple", 
                icon: "üè¢" 
            }
        ];

        // --- GLOBAL SYNC LOCK ---
        let isSyncing = false;

        // --- BACK BUTTON HANDLER ---
        let currentOpenModal = null;

        function pushModalState(modalId) {
            currentOpenModal = modalId;
            window.history.pushState({ modal: modalId }, null, "");
        }

        window.addEventListener('popstate', function(event) {
            if (currentOpenModal) {
                if (currentOpenModal === 'menu') closeModal(true);
                else if (currentOpenModal === 'checkout') closeCheckout(true);
                else if (currentOpenModal === 'tickets') closeMyTickets(true);
                else if (currentOpenModal === 'avatar') closeAvatarModal(true);
                else if (currentOpenModal === 'points-history') closePointsHistory(true);
                
                currentOpenModal = null;
            }
        });

        // --- SOUNDS ---
        const sfxPop = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3'); 
        const sfxTrash = new Audio('https://www.soundjay.com/misc/sounds/crumple-paper-1.mp3'); 
        const sfxWin = new Audio('https://www.soundjay.com/misc/sounds/magic-chime-01.mp3');
        const sfxSwitch = new Audio('https://www.soundjay.com/buttons/sounds/button-20.mp3'); 
        
        sfxPop.volume = 0.4;
        sfxSwitch.volume = 0.2;
        sfxTrash.volume = 0.8;

        function playSound(type) {
            if(type === 'pop') { sfxPop.currentTime = 0; sfxPop.play(); }
            else if(type === 'switch') { sfxSwitch.currentTime = 0; sfxSwitch.play(); }
        }

        document.addEventListener('click', (e) => {
            if(e.target.closest('.btn-bounce')) {
                playSound('pop');
            }
        });

        function triggerHaptic(intensity = 'light') {
            if (navigator.vibrate) {
                switch(intensity) {
                    case 'heavy':
                        navigator.vibrate([100, 50, 100]);
                        break;
                    case 'medium':
                        navigator.vibrate(50);
                        break;
                    case 'double':
                        navigator.vibrate([30, 30, 30]);
                        break;
                    case 'success':
                        navigator.vibrate([10, 20, 10, 20, 50]);
                        break;
                    case 'error':
                        navigator.vibrate([100, 50, 100, 50, 100]);
                        break;
                    default: // light
                        navigator.vibrate(10);
                }
            }
        }

        // --- GLOBAL LOADER ---
        function showGlobalLoader(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
            const loader = document.getElementById('global-loader');
            const txt = document.getElementById('loader-text');
            txt.innerText = text;
            loader.classList.remove('loader-hidden');
        }

        function hideGlobalLoader() {
            const loader = document.getElementById('global-loader');
            loader.classList.add('loader-hidden');
        }

        // --- NOTIFICATION ---
        function requestNotifPermission() {
            if (!("Notification" in window)) {
                showToast("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô");
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showToast("‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üîî");
                    triggerHaptic();
                }
            });
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');
            
            // Set icon and color based on type
            icon.className = 'fas ';
            switch(type) {
                case 'success':
                    icon.className += 'fa-check-circle text-green-400';
                    toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    icon.className += 'fa-exclamation-circle text-red-400';
                    toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                case 'warning':
                    icon.className += 'fa-exclamation-triangle text-orange-400';
                    toast.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                    break;
                default: // info
                    icon.className += 'fa-info-circle text-blue-400';
                    toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            }
            
            msg.innerText = message;
            toast.classList.remove('-translate-y-10', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            // Add haptic feedback
            triggerHaptic();
            
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('-translate-y-10', 'opacity-0');
            }, 3000);
        }

        setTimeout(() => {
            hideGlobalLoader();
        }, 4000);

        // --- AVATAR LOGIC ---
        const avatarOptions = [
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Dog%20face/3D/dog_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Cat%20face/3D/cat_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Tiger%20face/3D/tiger_face_3d.png',
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Lion/3D/lion_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Monkey%20face/3D/monkey_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Elephant/3D/elephant_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Pig%20face/3D/pig_face_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Chicken/3D/chicken_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Panda/3D/panda_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Frog/3D/frog_3d.png', 
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Giraffe/3D/giraffe_3d.png'  
        ];
        
        let userAvatar = { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î', userId: null };

        function openAvatarModal() {
            pushModalState('avatar'); 

            const grid = document.getElementById('avatar-grid');
            grid.innerHTML = '';
            avatarOptions.forEach(imgSrc => {
                const el = document.createElement('div');
                el.className = `avatar-option ${userAvatar.image === imgSrc ? 'avatar-selected' : ''}`;
                el.innerHTML = `<img src="${imgSrc}" alt="avatar">`;
                el.onclick = () => selectAvatar(imgSrc);
                grid.appendChild(el);
            });
            
            document.getElementById('pet-name-input').value = userAvatar.name || '';

            const modal = document.getElementById('avatar-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeAvatarModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'avatar') { history.back(); return; }

            const modal = document.getElementById('avatar-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            
            const nameInput = document.getElementById('pet-name-input').value.trim();
            if(nameInput) {
                userAvatar.name = escapeHtml(nameInput);
                const orderNameInput = document.getElementById('user-name');
                if(orderNameInput) orderNameInput.value = userAvatar.name;
            }

            saveToLS();
            updateAvatarDisplay();
            currentOpenModal = null;
        }

        function selectAvatar(imgSrc) {
            userAvatar.image = imgSrc;
            const options = document.querySelectorAll('.avatar-option');
            options.forEach(opt => {
                const img = opt.querySelector('img');
                if (img && img.src === imgSrc) opt.classList.add('avatar-selected');
                else opt.classList.remove('avatar-selected');
            });
            triggerHaptic();
            playSound('pop');
        }

        function updateAvatarDisplay() {
            document.getElementById('avatar-img').src = userAvatar.image;
            const nameDisplay = document.getElementById('avatar-name-display');
            nameDisplay.innerText = userAvatar.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
        }

        function loadAvatar() {
            const saved = JSON.parse(localStorage.getItem('kaprao52_user'));
            if (saved && saved.avatar) {
                userAvatar = saved.avatar;
            }
            updateAvatarDisplay();
        }

        // --- WELCOME POPUP ---
        function closeWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.5s ease';
            setTimeout(() => modal.classList.add('hidden'), 500);
            triggerHaptic();
        }

        // --- BUBBLES LOGIC (Optimized) ---
        function createBubbles() {
            const container = document.getElementById('bubbles-container');
            const bubbleCount = 15; // Limit count for performance
            
            for(let i=0; i<bubbleCount; i++){
                const b = document.createElement('div');
                b.className = 'bubble';
                b.style.width = Math.random() * 60 + 20 + 'px';
                b.style.height = b.style.width;
                b.style.left = Math.random() * 100 + '%';
                b.style.animationDelay = Math.random() * 15 + 's';
                b.style.animationDuration = Math.random() * 10 + 15 + 's'; 
                if(i % 2 === 0) b.classList.add('purple'); // Alternate colors
                container.appendChild(b);
            }
        }
        
        document.addEventListener('DOMContentLoaded', createBubbles);
        
        // === ENHANCED THEME MANAGEMENT ===
        
        // --- STATE MANAGEMENT ---
        let cart = [];
        let currentItem = null;
        let activeCategory = 'kaprao';
        let discountValue = 0;
        let modalQty = 1;
        let userStats = { points: 0 }; 
        let lottoHistory = []; 
        let isSubmitting = false; 
        let pointsRedeemed = 0;
        let isPointsActive = false; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏≠‡∏¢‡∏ï‡πå
        
        const addonIds = ['special', 'kaikhon', 'kaidao', 'kaijiao', 'kaitom', 'kaiyiewma'];
        const addonCalories = { 'special': 80, 'kaikhon': 150, 'kaidao': 120, 'kaijiao': 200, 'kaitom': 75, 'kaiyiewma': 100 };

        const KEYS = {
            USER: 'kaprao52_user',
            HISTORY: 'kaprao_lotto_history',
            STATS: 'kaprao_stats',
            VERSION: 'kaprao_ver'
        };

        const CURRENT_VERSION = '21.0.1'; 

        // ============================================
        // UPDATED POINT SYSTEM FUNCTIONS FOR NEW UI
        // ============================================

        function calculatePoints(netTotal) {
            if (netTotal < 60) return 0;
            if (netTotal < 100) return 10;
            if (netTotal < 150) return 20;
            if (netTotal < 200) return 30;
            if (netTotal < 250) return 40;
            if (netTotal < 300) return 50;
            return 60;
        }

        function getNextTierInfo(currentTotal) {
            if (currentTotal < 60) return { needed: 60 - currentTotal, points: 10 };
            if (currentTotal < 100) return { needed: 100 - currentTotal, points: 20 };
            if (currentTotal < 150) return { needed: 150 - currentTotal, points: 30 };
            if (currentTotal < 200) return { needed: 200 - currentTotal, points: 40 };
            if (currentTotal < 250) return { needed: 250 - currentTotal, points: 50 };
            if (currentTotal < 300) return { needed: 300 - currentTotal, points: 60 };
            return null; // Already at max tier
        }

        function updatePointsDisplay() {
            const points = userStats.points || 0;
            document.getElementById('points-count').innerText = points;
            document.getElementById('available-points').innerText = points;
            
            // Update checkout display if open
            updateCheckoutPointsInfo();
        }

        // FIX 1: Removed the circular dependency - updateCheckoutPointsInfo should NOT call updateTotalSummary
        function updateCheckoutPointsInfo() {
            const subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            const netTotal = Math.max(0, subtotal - discountValue);
            const pointsEarned = calculatePoints(netTotal);
            
            // Update user points balance in checkout
            const userPointsBalance = document.getElementById('user-points-balance');
            if (userPointsBalance) {
                userPointsBalance.innerHTML = `‡∏°‡∏µ <span id="available-points">${userStats.points || 0}</span> ‡∏û‡∏≠‡∏¢‡∏ï‡πå`;
            }
            
            // Upsell message
            const upsellMsg = document.getElementById('points-upsell-msg');
            if (upsellMsg) {
                const nextTier = getNextTierInfo(netTotal);
                if (nextTier && nextTier.needed > 0 && nextTier.needed <= 50) {
                    upsellMsg.classList.remove('hidden');
                    upsellMsg.innerHTML = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å ${nextTier.needed}.- ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö +${nextTier.points} ‡∏û‡∏≠‡∏¢‡∏ï‡πå!`;
                } else {
                    upsellMsg.classList.add('hidden');
                }
            }
            
            // CRITICAL FIX: REMOVED the call to updateTotalSummary() to break the infinite loop
            // The total summary will be updated separately when needed
        }

        // NEW: Enhanced points system with slider and input
        function togglePointsUsage() {
            const controlsContainer = document.getElementById('points-controls-container');
            const toggleBtn = document.getElementById('points-toggle-btn');
            const userPoints = userStats.points || 0;
            
            if (controlsContainer.classList.contains('hidden')) {
                // Turn ON points usage
                if (userPoints < 100) {
                    showToast(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${userPoints} ‡∏û‡∏≠‡∏¢‡∏ï‡πå (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 100 ‡∏û‡∏≠‡∏¢‡∏ï‡πå)`, 'error');
                    return;
                }
                
                controlsContainer.classList.remove('hidden');
                isPointsActive = true;
                toggleBtn.innerHTML = '<i class="fas fa-times mr-2"></i> ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏≠‡∏¢‡∏ï‡πå';
                toggleBtn.classList.remove('bg-slate-800');
                toggleBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                
                // Initialize slider and input
                const maxPoints = Math.floor(userPoints / 100) * 100; // Round down to nearest 100
                document.getElementById('points-range').max = maxPoints;
                document.getElementById('points-max').textContent = maxPoints;
                document.getElementById('points-input').max = maxPoints;
                
                // Set initial value to 100 or max if less than 100
                const initialPoints = maxPoints >= 100 ? 100 : maxPoints;
                document.getElementById('points-range').value = initialPoints;
                document.getElementById('points-input').value = initialPoints;
                
                updatePointsDiscount(initialPoints);
                showToast('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } else {
                // Turn OFF points usage
                controlsContainer.classList.add('hidden');
                isPointsActive = false;
                pointsRedeemed = 0;
                toggleBtn.innerHTML = '<i class="fas fa-coins mr-2 text-yellow-400"></i> ‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î';
                toggleBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                toggleBtn.classList.add('bg-slate-800', 'hover:bg-slate-700');
                updateTotalSummary();
                showToast('‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'info');
            }
            
            triggerHaptic();
        }

        // NEW: Update points based on slider or input
        function updatePointsFromUI(value) {
            const userPoints = userStats.points || 0;
            let pointsValue = parseInt(value) || 0;
            
            // Round to nearest 100
            pointsValue = Math.round(pointsValue / 100) * 100;
            
            // Apply constraints
            if (pointsValue < 0) pointsValue = 0;
            if (pointsValue > userPoints) pointsValue = Math.floor(userPoints / 100) * 100;
            
            // Update both inputs
            document.getElementById('points-range').value = pointsValue;
            document.getElementById('points-input').value = pointsValue;
            
            updatePointsDiscount(pointsValue);
        }

        // NEW: Update points discount calculation
        function updatePointsDiscount(pointsAmount) {
            pointsAmount = pointsAmount || parseInt(document.getElementById('points-input').value) || 0;
            const discountAmount = Math.floor(pointsAmount / 100) * 10;
            
            // Update display
            const discountDisplay = document.getElementById('points-discount-amount');
            if (discountDisplay) {
                discountDisplay.textContent = `${discountAmount}`;
            }
            
            // Update state
            pointsRedeemed = pointsAmount;
            discountValue = discountAmount;
            updateTotalSummary();
        }

        // NEW: Reset points discount for new UI
        function resetPointsDiscount() {
            const controlsContainer = document.getElementById('points-controls-container');
            const toggleBtn = document.getElementById('points-toggle-btn');
            
            controlsContainer.classList.add('hidden');
            isPointsActive = false;
            pointsRedeemed = 0;
            toggleBtn.innerHTML = '<i class="fas fa-coins mr-2 text-yellow-400"></i> ‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î';
            toggleBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            toggleBtn.classList.add('bg-slate-800', 'hover:bg-slate-700');
            
            updateTotalSummary();
        }

        function openPointsHistory() {
            pushModalState('points-history');
            
            const modal = document.getElementById('points-history-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            
            // In a real app, you would fetch and display points history here
            const historyList = document.getElementById('points-history-list');
            historyList.innerHTML = `
                <div class="text-center text-slate-400 py-8">
                    <i class="fas fa-history text-3xl mb-2 opacity-30"></i>
                    <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå</p>
                </div>
            `;
        }

        function closePointsHistory(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'points-history') { 
                history.back(); 
                return; 
            }
            
            const modal = document.getElementById('points-history-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            currentOpenModal = null;
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function getStandardDate(dateObj) {
            if(!dateObj) dateObj = new Date();
            const d = dateObj.getDate().toString().padStart(2, '0');
            const m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const y = dateObj.getFullYear(); 
            return `${d}/${m}/${y}`;
        }

        function formatTime(dateObj) {
            if(!dateObj) dateObj = new Date();
            const h = dateObj.getHours().toString().padStart(2, '0');
            const m = dateObj.getMinutes().toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        function loadUserDataSafe() {
            try {
                const savedUser = localStorage.getItem(KEYS.USER);
                if (savedUser) {
                    const u = JSON.parse(savedUser);
                    cart = u.cart || [];
                    userAvatar = u.avatar || { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î' };
                    if(u.name) document.getElementById('user-name').value = u.name;
                    
                    if (u.userId) {
                        userAvatar.userId = u.userId;
                    }
                }

                const savedHistory = localStorage.getItem(KEYS.HISTORY);
                if (savedHistory) {
                    lottoHistory = JSON.parse(savedHistory) || [];
                }

                const savedStats = localStorage.getItem(KEYS.STATS);
                if (savedStats) {
                    userStats = JSON.parse(savedStats) || { points: 0 };
                }

            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error);
                userStats = { points: 0 };
            }
        }

        function saveToLS() {
            let safeName = escapeHtml(document.getElementById('user-name').value);
            let oldData = {};
            try {
                oldData = JSON.parse(localStorage.getItem(KEYS.USER)) || {};
            } catch (e) {}

            const userState = { 
                ...oldData, 
                cart: cart, 
                name: safeName,
                avatar: userAvatar
            };
            
            localStorage.setItem(KEYS.USER, JSON.stringify(userState));
        }
        
        async function checkForUpdate() {
            try {
                const response = await fetch(window.location.href + '?t=' + new Date().getTime());
                const text = await response.text();
                const serverVerMatch = text.match(/const CURRENT_VERSION = '([\d.]+)';/);
                
                if (serverVerMatch && serverVerMatch[1]) {
                    const serverVer = serverVerMatch[1];
                    if (serverVer !== CURRENT_VERSION) {
                        if ('caches' in window) {
                            try {
                                const names = await caches.keys();
                                await Promise.all(names.map(name => caches.delete(name)));
                            } catch(e) {}
                        }
                        // Use standard reload (boolean param deprecated)
                        window.location.reload();
                    }
                }
            } catch (err) {
            }
        }

        async function syncTicketHistory(userId) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getHistory&userId=' + userId);
                const serverTickets = await response.json();

                if (!Array.isArray(serverTickets) || serverTickets.length === 0) return;

                let updated = false;
                
                serverTickets.forEach(serverT => {
                    const exists = lottoHistory.some(localT => localT.id === serverT.id);
                    if (!exists) {
                        const drawDateObj = getNextDrawDate(); 
                        
                        const newTicket = {
                            id: serverT.id,
                            number: serverT.id.slice(-2),
                            date: serverT.date,
                            drawDate: getStandardDate(drawDateObj), 
                            drawDateTimestamp: drawDateObj.getTime(),
                            timestamp: Date.now(), 
                            price: serverT.price,
                            status: 'pending',
                            checkedDate: null,
                            items: [{ name: serverT.itemsStr, price: serverT.price }], 
                            customerName: 'Synced'
                        };
                        
                        lottoHistory.push(newTicket);
                        updated = true;
                    }
                });

                if (updated) {
                    lottoHistory.sort((a, b) => b.timestamp - a.timestamp); 
                    if(lottoHistory.length > 20) lottoHistory = lottoHistory.slice(0, 20);
                    
                    localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
                    updateTicketBadge();
                    autoCheckLottery(); 
                }

            } catch (e) {
                console.error("Sync History Failed", e);
            }
        }

        async function syncUserStatsFromServer(userId) {
            if(!userId) return;
            
            isSyncing = true; 

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getUserStats&userId=' + userId);
                const serverData = await response.json();
                
                if(serverData && serverData.points !== undefined) {
                    userStats.points = serverData.points;
                    localStorage.setItem(KEYS.STATS, JSON.stringify(userStats));
                    updatePointsDisplay();
                }
                
                isSyncing = false;

            } catch (error) {
                console.error("Sync Error:", error);
                updatePointsDisplay();
                isSyncing = false;
            }
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    // Show VIP badge for logged-in users
                    const vip = document.getElementById('vip-badge');
                    if (vip) { vip.classList.remove('hidden'); vip.innerText = 'VIP'; }
                    const profile = await liff.getProfile();
                    
                    const loginBtn = document.getElementById('line-login-btn');
                    if(loginBtn) loginBtn.classList.add('hidden');

                    let savedUser = {};
                    try {
                        savedUser = JSON.parse(localStorage.getItem(KEYS.USER)) || {};
                    } catch(e) {}

                    savedUser.userId = profile.userId;
                    userAvatar.userId = profile.userId; 

                    const nameInput = document.getElementById('user-name');
                    if(nameInput && (!nameInput.value || nameInput.value.trim() === '')) {
                        nameInput.value = profile.displayName;
                        savedUser.name = profile.displayName;
                    }

                    const isDefaultAvatar = avatarOptions.includes(userAvatar.image);
                    if(profile.pictureUrl && (isDefaultAvatar || !userAvatar.image)) {
                        userAvatar.image = profile.pictureUrl;
                        userAvatar.name = profile.displayName; 
                        savedUser.avatar = userAvatar;
                        updateAvatarDisplay(); 
                    }
                    
                    localStorage.setItem(KEYS.USER, JSON.stringify(savedUser));
                    
                    if (cart.length === 0 && savedUser.cart && savedUser.cart.length > 0) {
                        cart = savedUser.cart;
                        updateMiniCart();
                        renderCheckoutList();
                    }

                    const localHistoryIds = lottoHistory.map(t => t.id);
                    
                    if (localHistoryIds.length > 0) {
                        fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'claim_orders',
                                userId: profile.userId,
                                orderIds: localHistoryIds
                            })
                        }).then(() => {
                            syncUserStatsFromServer(profile.userId); 
                            syncTicketHistory(profile.userId);       
                        });
                    } else {
                        syncUserStatsFromServer(profile.userId);
                        syncTicketHistory(profile.userId); 
                    }

                } else {
                    // Hide VIP badge when not logged in
                    const vipEl = document.getElementById('vip-badge'); if (vipEl) vipEl.classList.add('hidden');
                    if (!liff.isInClient()) {
                        const loginBtn = document.getElementById('line-login-btn');
                        if(loginBtn) loginBtn.classList.remove('hidden');
                    } else {
                        liff.login();
                    }
                }
            } catch (err) {
                console.error("LIFF Error", err);
            }
        }

        function handleLogin() {
            const btn = document.getElementById('line-login-btn');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...';
            btn.classList.add('opacity-75');
            
            if (liff.ready) {
                 liff.login();
            } else {
                 liff.init({ liffId: MY_LIFF_ID }).then(() => {
                      liff.login();
                 });
            }
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß) ---
        function createMeatOptions() {
            const container = document.getElementById('meat-options-container');
            container.innerHTML = '';
            
            const meatOptions = [
                { value: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠', label: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠' },
                { value: '‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', label: '‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö' },
                { value: '‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á', label: '‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á' }
            ];
            
            meatOptions.forEach((meat, index) => {
                const optionId = `meat-option-${meat.value}`;
                const label = document.createElement('label');
                label.className = 'cursor-pointer flex-shrink-0';
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'modal-meat';
                input.value = meat.value;
                input.id = optionId;
                input.className = 'peer sr-only';
                input.setAttribute('aria-label', meat.label);
                if (index === 0) input.checked = true;
                
                const optionDiv = document.createElement('div');
                optionDiv.className = 'meat-option';
                optionDiv.textContent = meat.label;
                optionDiv.setAttribute('data-value', meat.value);
                optionDiv.setAttribute('tabindex', '0');
                optionDiv.setAttribute('role', 'radio');
                optionDiv.setAttribute('aria-checked', input.checked ? 'true' : 'false');
                
                label.appendChild(input);
                label.appendChild(optionDiv);
                container.appendChild(label);
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö visual feedback
                input.addEventListener('change', function() {
                    // ‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ selected ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    document.querySelectorAll('.meat-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.setAttribute('aria-checked', 'false');
                    });
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ selected ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    if (this.checked) {
                        const selectedDiv = this.nextElementSibling;
                        selectedDiv.classList.add('selected');
                        selectedDiv.setAttribute('aria-checked', 'true');
                        
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏° haptic feedback
                        triggerHaptic();
                        playSound('pop');
                    }
                });
            });
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏£‡∏Å
            if (container.firstChild) {
                const firstInput = container.firstChild.querySelector('input');
                const firstDiv = container.firstChild.querySelector('.meat-option');
                if (firstInput && firstDiv) {
                    firstInput.checked = true;
                    firstDiv.classList.add('selected');
                    firstDiv.setAttribute('aria-checked', 'true');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedVer = localStorage.getItem(KEYS.VERSION);
            if(savedVer !== CURRENT_VERSION) {
                localStorage.setItem(KEYS.VERSION, CURRENT_VERSION);
            }

            loadUserDataSafe();
            
            fetchLottoResults();
            initLIFF(); 

            setTimeout(autoCheckLottery, 1000);
            updateTicketBadge();
            updateAvatarDisplay();
            updatePointsDisplay();
            updateMiniCart();
            renderCheckoutList();
            
            setTimeout(checkForUpdate, 2000);
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    checkForUpdate();
                }
            });

            const inputs = document.querySelectorAll('input[type="text"], textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
            
            renderMenu();
            // Micro-interactions (squash & stretch) setup
            try { setupMicroInteractions(); } catch(e) { /* safe fallback */ }

            // Setup points slider and input events
            const pointsRange = document.getElementById('points-range');
            const pointsInput = document.getElementById('points-input');
            
            if (pointsRange) {
                pointsRange.addEventListener('input', function() {
                    updatePointsFromUI(this.value);
                });
            }
            
            if (pointsInput) {
                pointsInput.addEventListener('input', function() {
                    updatePointsFromUI(this.value);
                });
                
                pointsInput.addEventListener('change', function() {
                    updatePointsFromUI(this.value);
                });
            }

            // Ensure ARIA labels exist for buttons/inputs that lack them (friendly fallbacks)
            try {
                document.querySelectorAll('button:not([aria-label])').forEach(btn => {
                    const txt = (btn.innerText || '').trim();
                    if (txt) btn.setAttribute('aria-label', txt.replace(/\n\s+/g,' '));
                });
                document.querySelectorAll('input:not([aria-label])').forEach(inp => {
                    if (inp.id) {
                        const labelEl = document.querySelector(`label[for="${inp.id}"]`);
                        if (labelEl) inp.setAttribute('aria-label', (labelEl.innerText || inp.name || inp.type).trim());
                    } else if (inp.placeholder) {
                        inp.setAttribute('aria-label', inp.placeholder.trim());
                    }
                });
            } catch(e) {}
        });
        
        let wheelSpinning = false;
        const wheelSegments = [
            { text: "‡∏•‡∏î 5 ‡∏ö‡∏≤‡∏ó", color: "#FFFFFF", type: "discount_5" },
            { text: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•", color: "#F3F4F6", type: "none" },
            { text: "‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ 40‡∏ö.", color: "#FBBF24", type: "free_40" },
            { text: "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", color: "#FFFFFF", type: "none" }, 
            { text: "‡∏ü‡∏£‡∏µ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß", color: "#F3F4F6", type: "free_egg" },
            { text: "‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó", color: "#FBBF24", type: "discount_10" }
        ];
        function drawWheel() {
            const canvas = document.getElementById('wheel-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            const center = size / 2;
            const sliceAngle = (2 * Math.PI) / wheelSegments.length;

            wheelSegments.forEach((seg, i) => {
                const startAngle = i * sliceAngle - (Math.PI / 2); 
                const endAngle = startAngle + sliceAngle;
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, center, startAngle, endAngle);
                ctx.fillStyle = seg.color;
                ctx.fill();
                ctx.strokeStyle = "#E5E7EB";
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#1F2937";
                ctx.font = "bold 14px Kanit";
                ctx.fillText(seg.text, center - 20, 5);
                ctx.restore();
            });
        }
        function spinWheel() {
            if (wheelSpinning) return;
            const today = getStandardDate(new Date()); 
            const lastDate = localStorage.getItem('kaprao_spin_date');
            let count = parseInt(localStorage.getItem('kaprao_spin_count') || '0');

            if (lastDate !== today) {
                count = 0;
                localStorage.setItem('kaprao_spin_date', today);
            }

            if (count >= 3) {
                showToast("‚õî ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!", 'warning');
                return; 
            }

            localStorage.setItem('kaprao_spin_count', count + 1);

            wheelSpinning = true;
            triggerHaptic();
            sfxPop.play();
            const box = document.getElementById('wheel-canvas');
            const fullSpins = 360 * 8; 
            const targetDegree = 150;  
            const randomVariance = Math.floor(Math.random() * 40) - 20; 
            const nextRotation = fullSpins + targetDegree + randomVariance;
            box.style.transform = `rotate(${nextRotation}deg)`;
            setTimeout(() => {
                wheelSpinning = false;
                box.style.transform = `rotate(${targetDegree}deg)`; 
                box.style.transition = 'none';
                handleReward(wheelSegments[3]); 
                setTimeout(() => box.style.transition = 'transform 8s cubic-bezier(0.1, 0.99, 0.1, 0.99)', 50);
            }, 8000); 
        }
        function handleReward(reward) {
            if(reward.type === 'none') showToast("‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡∏µ‡∏¢‡∏ß! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞", 'warning');
            else showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${reward.text}`, 'success');
        }

        function scrollTabs(amount) {
            document.getElementById('tabs-container').scrollBy({ left: amount, behavior: 'smooth' });
        }

        function renderSkeletonLoader() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            for(let i=0; i<6; i++) {
                const el = document.createElement('div');
                el.className = "fast-card p-4 flex flex-col shadow-sm";
                el.innerHTML = `
                    <div class="flex flex-col items-center mb-3">
                        <div class="w-20 h-20 rounded-2xl skeleton mb-3"></div>
                        <div class="h-4 w-full skeleton rounded mb-2"></div>
                        <div class="h-3 w-2/3 skeleton rounded"></div>
                    </div>
                    <div class="mt-auto pt-3 border-t border-slate-700/50">
                        <div class="h-4 w-1/2 skeleton rounded mb-2"></div>
                        <div class="h-10 w-full skeleton rounded"></div>
                    </div>
                `;
                grid.appendChild(el);
            }
        }

        // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ñ‡∏≤‡∏î (Updated Grid Layout)
        function renderTrayOptions(type) {
            const container = document.getElementById('tray-options-container');
            let html = '';

            // --- SET 1: SOLO TRAY ---
            if (type === 1) {
                html += `<h4 class="font-bold text-slate-200 mb-2 text-sm">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏•‡∏±‡∏Å</h4>`;
                html += `<div class="grid grid-cols-2 gap-3 mb-4">`; // Use Grid Layout
                const meats = [
                    {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üê∑'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô', p:0, i:'üêî'},
                    {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ-‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üéç'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á', p:10, i:'ü•ì'},
                    {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠', p:10, i:'ü•©'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ó‡∏∞‡πÄ‡∏• (‡∏Å‡∏∏‡πâ‡∏á/‡∏´‡∏°‡∏∂‡∏Å)', p:20, i:'ü¶ê'}
                ];
                meats.forEach((m, i) => {
                    html += `
                        <label class="cursor-pointer group relative">
                            <input type="radio" name="tray-meat" value="${m.n}" data-price="${m.p}" aria-label="${m.n}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only">
                            <div class="h-full meat-option peer-checked:selected rounded-2xl p-3 flex flex-col items-center justify-center gap-2 transition-all" tabindex="0" role="radio" aria-checked="${i===0? 'true' : 'false'}">
                                <div class="text-3xl filter group-hover:scale-110 transition-transform">${m.i}</div>
                                <div class="text-xs font-bold text-center leading-tight">${m.n}</div>
                                ${m.p>0 ? `<div class="text-[10px] text-white bg-orange-500 px-2 py-0.5 rounded-full font-bold">+${m.p}</div>` : ''}
                                <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 text-yellow-400 transition-opacity"><i class="fas fa-check-circle"></i></div>
                            </div>
                        </label>`;
                });
                html += `</div>`;

                html += `<h4 class="font-bold text-slate-200 mb-2 text-sm">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏Ç‡πà‡∏Ñ‡∏π‡πà‡πÉ‡∏à</h4>`;
                html += `<div class="grid grid-cols-3 gap-2 mb-4">`; // Use Grid Layout
                const eggs = [{n:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', p:0, i:'üç≥'}, {n:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', p:5, i:'ü•û'}, {n:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô', p:10, i:'ü•ò'}];
                eggs.forEach((e, i) => {
                    html += `
                        <label class="cursor-pointer group relative">
                            <input type="radio" name="tray-egg" value="${e.n}" data-price="${e.p}" aria-label="${e.n}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only">
                            <div class="h-full meat-option peer-checked:selected rounded-2xl p-2 flex flex-col items-center justify-center gap-1 transition-all" tabindex="0" role="radio" aria-checked="${i===0? 'true' : 'false'}">
                                <div class="text-2xl">${e.i}</div>
                                <div class="text-xs font-bold text-center">${e.n}</div>
                                ${e.p>0 ? `<div class="text-[9px] text-orange-400 font-bold">+${e.p}</div>` : ''}
                            </div>
                        </label>`;
                });
                html += `</div>`;
            } 
            // --- SET 2: BUDDY TRAY ---
            else if (type === 2) {
                html += `<h4 class="font-bold text-slate-200 mb-2 text-sm">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏≤‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå)</h4>`;
                html += `<div class="grid grid-cols-2 gap-3 mb-4">`; // Use Grid Layout
                const meats = [
                    {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üê∑'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô', p:0, i:'üêî'},
                    {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ-‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', p:0, i:'üéç'}, 
                    {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á', p:20, i:'ü•ì'}, {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠', p:20, i:'ü•©'},
                    {n:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ó‡∏∞‡πÄ‡∏•', p:30, i:'ü¶ê'}, {n:'‡∏ó‡∏π‡πÇ‡∏ó‡∏ô (‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö+‡πÑ‡∏Å‡πà)', p:10, i:'‚ú®'}
                ];
                meats.forEach((m, i) => {
                    html += `
                    <label class="cursor-pointer group relative">
                        <input type="radio" name="tray-meat" value="${m.n}" data-price="${m.p}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only">
                        <div class="h-full meat-option peer-checked:selected rounded-2xl p-3 flex flex-col items-center justify-center gap-2 transition-all">
                            <div class="text-3xl filter group-hover:scale-110 transition-transform">${m.i}</div>
                            <div class="text-xs font-bold text-center leading-tight">${m.n}</div>
                            ${m.p>0 ? `<div class="text-[10px] text-white bg-orange-500 px-2 py-0.5 rounded-full font-bold">+${m.p}</div>` : ''}
                            <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 text-yellow-400 transition-opacity"><i class="fas fa-check-circle"></i></div>
                        </div>
                    </label>`;
                });
                html += `</div>`;

                html += `<h4 class="font-bold text-slate-200 mb-2 text-sm">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏Ç‡πà‡∏Ñ‡∏π‡πà‡πÉ‡∏à (‡πÑ‡∏î‡πâ 2 ‡∏ü‡∏≠‡∏á)</h4>`;
                html += `<div class="grid grid-cols-3 gap-2 mb-4">`; // Use Grid Layout
                const eggs = [{n:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß‡∏Ñ‡∏π‡πà', p:0, i:'üç≥üç≥'}, {n:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡πÅ‡∏ú‡πà‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå', p:0, i:'ü•û'}, {n:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏£‡∏≤‡∏î‡∏Ç‡πâ‡∏≤‡∏ß', p:15, i:'ü•ò'}];
                eggs.forEach((e, i) => {
                    html += `
                    <label class="cursor-pointer group relative">
                        <input type="radio" name="tray-egg" value="${e.n}" data-price="${e.p}" ${i===0?'checked':''} onchange="updateModalPrice()" class="peer sr-only">
                        <div class="h-full meat-option peer-checked:selected rounded-2xl p-2 flex flex-col items-center justify-center gap-1 transition-all">
                            <div class="text-2xl">${e.i}</div>
                            <div class="text-xs font-bold text-center">${e.n}</div>
                            ${e.p>0 ? `<div class="text-[9px] text-orange-400 font-bold">+${e.p}</div>` : ''}
                        </div>
                    </label>`;
                });
                html += `</div>`;
            }

            // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Summary) üî•
            html += `
            <div class="mt-6 p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg">üç±</span>
                    <h4 class="text-sm font-bold text-indigo-400">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ñ‡∏≤‡∏î:</h4>
                </div>
                <p id="tray-summary-text" class="text-sm text-slate-300 leading-relaxed pl-1"></p>
                <div class="mt-3 pt-2 border-t border-indigo-500/30 flex items-center gap-2 text-[10px] text-indigo-400">
                    <i class="fas fa-utensils"></i>
                    <span>‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏ã‡∏∏‡∏õ‡∏ü‡∏£‡∏µ!</span>
                </div>
            </div>`;

            container.innerHTML = html;
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ selected ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏£‡∏Å‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ñ‡∏≤‡∏î
            setTimeout(() => {
                document.querySelectorAll('.meat-option').forEach((opt, index) => {
                    if (index === 0) {
                        opt.classList.add('selected');
                    }
                });
            }, 50);
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ñ‡∏≤‡∏î
        function updateTraySummary() {
            if(!currentItem || !currentItem.isTray) return;
            const meat = document.querySelector('input[name="tray-meat"]:checked');
            const egg = document.querySelector('input[name="tray-egg"]:checked');
            const txt = document.getElementById('tray-summary-text');

            if(meat && egg && txt) {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î
                txt.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-slate-400">1. ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å:</span>
                        <span class="font-bold text-slate-200">${meat.value}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-400">2. ‡πÑ‡∏Ç‡πà‡∏Ñ‡∏π‡πà‡πÉ‡∏à:</span>
                        <span class="font-bold text-slate-200">${egg.value}</span>
                    </div>
                `;
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠ 4: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô switchCategory ‡πÉ‡∏´‡∏°‡πà
        function switchCategory(cat) {
            if(activeCategory === cat) return;
            activeCategory = cat; 
            triggerHaptic();
            playSound('switch');
            
            const grid = document.getElementById('menu-grid');
            const msg = document.getElementById('dessert-msg');
            
            grid.classList.add('page-out');
            if(!msg.classList.contains('hidden')) msg.classList.add('page-out');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
            const categories = ['tray', 'kaprao', 'garlic', 'noodle', 'soup', 'others', 'dessert', 'promotion'];
            categories.forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                if (c === cat) {
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô active
                    if (c === 'promotion') {
                        btn.className = "category-pill category-pill-promotion category-pill-active snap-start";
                    } else if (c === 'tray') {
                        btn.className = "category-pill category-pill-tray category-pill-active snap-start";
                    } else {
                        btn.className = "category-pill category-pill-active snap-start";
                    }
                } else {
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô inactive
                    if (c === 'promotion') {
                        btn.className = "category-pill category-pill-promotion snap-start";
                    } else if (c === 'tray') {
                        btn.className = "category-pill category-pill-tray snap-start";
                    } else {
                        btn.className = "category-pill category-pill-inactive snap-start";
                    }
                }
            });

            setTimeout(() => {
                const title = document.getElementById('section-title');
                msg.classList.add('hidden');
                msg.classList.remove('page-out');

                grid.classList.remove('page-out');
                renderSkeletonLoader();

                setTimeout(() => {
                    if (cat === 'promotion') {
                        title.innerText = "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á & ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô";
                        renderPromotions();
                    } else if (cat === 'dessert') {
                        title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô";
                        msg.classList.remove('hidden'); 
                        renderMenu();
                    } else if (cat === 'soup') {
                        title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°";
                        renderMenu();
                    } else if (cat === 'tray') {
                        title.innerText = "‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°";
                        renderMenu();
                    } else {
                        title.innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥";
                        renderMenu();
                    }
                    
                    document.getElementById('section-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    grid.classList.add('page-in');
                    setTimeout(() => grid.classList.remove('page-in'), 300);
                }, 50);

            }, 150);
        }
                
        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filteredItems = menuItems.filter(i => i.category === activeCategory);
            
            if(filteredItems.length === 0) {
                 grid.innerHTML = `<div class="text-center text-slate-400 mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏£‡∏±‡∏ö...</div>`;
                 return;
            }

            filteredItems.forEach((item, index) => {
                const isDessert = item.category === 'dessert';
                const isSoldOut = item.soldOut || false; 
                const isTrayWait = (item.id === 201 || item.id === 202); 
                
                const el = document.createElement('div');
                el.style.animationDelay = `${index * 0.05}s`;
                
                const grayscaleClass = (isSoldOut || isTrayWait) ? 'grayscale opacity-70' : '';
                const pointerClass = (isDessert || isSoldOut || isTrayWait) ? '' : 'cursor-pointer';

                el.className = `fast-card p-4 flex flex-col stagger-item group ${pointerClass} ${grayscaleClass} relative overflow-hidden`;
                
                el.onclick = () => {
                    if (isTrayWait) {
                        showToast('‚ö†Ô∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                        triggerHaptic('medium');
                        return;
                    }
                    
                    if (isSoldOut) {
                        showToast('‚õî ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
                        triggerHaptic('error');
                    } else if (isDessert) {
                        showToast('‚è≥ ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö', 'info');
                        triggerHaptic();
                    } else {
                        openModal(item);
                    }
                };

                let statusBadge = '';
                if (isTrayWait) {
                    statusBadge = `<div class="absolute top-2 right-2 bg-indigo-500/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20">‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</div>`;
                } else if (isSoldOut) {
                    statusBadge = `<div class="absolute top-2 right-2 bg-red-500/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20">‡∏´‡∏°‡∏î</div>`;
                } else if (isDessert) {
                    statusBadge = `<div class="absolute top-2 right-2 bg-slate-600/90 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-lg z-20">‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</div>`;
                }
                
                const priceDisplay = (isDessert || isSoldOut || isTrayWait) 
                    ? `<span class="font-bold text-slate-500 text-base line-through decoration-transparent">${item.price} ‡∏ø</span>` 
                    : `<span class="font-bold text-indigo-400 text-xl">${item.price} <span class="text-sm text-slate-400">‡∏ø</span></span>`;
                
                const contentStyle = (isDessert || isSoldOut || isTrayWait) ? 'opacity-60 grayscale-[50%]' : '';

                const newBadge = item.isNew && !isSoldOut 
                    ? `<div class="absolute top-2 left-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[8px] font-black px-2 py-1 rounded-full shadow-lg z-20 animate-pulse border border-white/30">NEW</div>` 
                    : '';

                const actionButton = (!isDessert && !isSoldOut && !isTrayWait)
                    ? `<button onclick="event.stopPropagation(); const item = menuItems.find(i => i.id === ${item.id}); if(item) openModal(item);" class="mt-3 w-full btn-gradient text-white font-bold py-2.5 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 text-sm group-hover:scale-105">
                        <i class="fas fa-plus text-xs"></i>
                        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                    </button>`
                    : `<div class="mt-3 w-full bg-slate-700/50 text-slate-400 font-medium py-2.5 rounded-xl text-center text-sm">‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</div>`;

                el.innerHTML = `
                    ${newBadge}
                    ${statusBadge}
                    <div class="flex flex-col items-center mb-3 ${contentStyle}">
                        <div class="relative w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center text-4xl mb-3 shadow-lg border border-slate-700/50 group-hover:scale-110 transition-transform">
                            <span class="menu-icon" aria-hidden="true">${item.icon}</span>
                        </div>
                        <h3 class="font-bold text-slate-200 text-sm text-center leading-tight group-hover:text-indigo-400 transition-colors mb-2 line-clamp-2 min-h-[2.5rem]">${item.name}</h3>
                        <div class="flex flex-wrap items-center justify-center gap-1.5 mb-2">
                            <span class="text-[10px] text-slate-400 bg-slate-800 px-2 py-0.5 rounded-full border border-slate-700">${item.kcal} kcal</span>
                            ${item.reqMeat ? '<span class="text-[9px] text-yellow-400 border border-yellow-500/30 bg-yellow-500/20 px-1.5 py-0.5 rounded-full">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</span>' : ''}
                        </div>
                    </div>
                    <div class="mt-auto pt-3 border-t border-slate-700/50">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-slate-400">‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                            ${priceDisplay}
                        </div>
                        ${actionButton}
                    </div>
                `;
                grid.appendChild(el);
            });
        }
        
        function renderPromotions() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            promotions.forEach((promo, index) => {
                const el = document.createElement('div');
                el.style.animationDelay = `${index * 0.1}s`;
                el.className = "fast-card p-4 flex flex-col cursor-pointer shadow-sm btn-bounce stagger-item col-span-2";
                
                el.onclick = () => {
                    const input = document.getElementById('discount-code');
                    if(input) {
                        input.value = promo.code;
                        applyDiscount(); 
                    }

                    if(navigator.clipboard) {
                        navigator.clipboard.writeText(promo.code).catch(err => console.warn('Copy failed (non-secure context)', err));
                    } else {
                        console.warn('Clipboard API not available');
                    }

                    showToast(`‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î ${promo.code} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
                    playSound('pop');
                    triggerHaptic();
                };

                el.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 ${promo.color} rounded-2xl flex items-center justify-center text-3xl shadow-lg">
                            ${promo.icon}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-200 text-base mb-1">${promo.title}</h3>
                            <p class="text-xs text-slate-400 mb-2">${promo.desc}</p>
                            <div class="bg-slate-900 inline-block px-3 py-1.5 rounded-lg text-xs font-bold text-slate-300 tracking-wider border border-slate-700 shadow-sm">${promo.code}</div>
                        </div>
                        <div class="text-slate-500 text-xs">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ</div>
                    </div>
                `;
                grid.appendChild(el);
            });

            const wheelDiv = document.createElement('div');
            wheelDiv.className = "w-full fast-card p-6 mt-4 mb-6 shadow-sm flex flex-col items-center stagger-item col-span-2";
            wheelDiv.style.animationDelay = "0.3s";
            wheelDiv.innerHTML = `
                <h3 class="font-bold text-slate-200 text-lg mb-1">‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ! üé°</h3>
                <p class="text-xs text-slate-400 mb-4">‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤ 40 ‡∏ö‡∏≤‡∏ó ‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô)</p>
                <div id="wheel-container">
                    <div class="wheel-pointer"></div>
                    <canvas id="wheel-canvas" width="300" height="300"></canvas>
                    <div class="wheel-center text-2xl">üòã</div>
                </div>
                <button onclick="spinWheel()" class="btn-bounce btn-gradient-purple text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all hover:scale-105">‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡∏¢!</button>
            `;
            grid.appendChild(wheelDiv);
            setTimeout(drawWheel, 100);
        }

        // üî• Updated Open Modal
        function openModal(item) {
            pushModalState('menu'); 
            
            triggerHaptic();
            playSound('pop');
            currentItem = item;
            modalQty = 1; 
            document.getElementById('modal-qty').innerText = modalQty;
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-icon').innerText = item.icon;
            document.getElementById('modal-note').value = '';
            
            // Reset Standard Options
            document.querySelectorAll('input[name="modal-meat"]').forEach(el => el.checked = false);
            addonIds.forEach(id => document.getElementById(`modal-opt-${id}`).checked = false);
            
            const meatSec = document.getElementById('modal-meat-section');
            const traySec = document.getElementById('tray-options-container'); 
            const addonsSec = document.getElementById('addons-section'); // üî• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢
            
            document.getElementById('meat-options-container').classList.remove('animate-shake', 'border', 'border-red-500', 'rounded-xl');

            // --- LOGIC ‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
            if(item.isTray) {
                meatSec.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
                traySec.classList.remove('hidden'); // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏î
                addonsSec.classList.add('hidden'); // üî• ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏ñ‡∏≤‡∏î
                renderTrayOptions(item.trayType); 
                updateTraySummary(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            } else {
                traySec.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏î
                addonsSec.classList.remove('hidden'); // üî• ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏Å‡∏ï‡∏¥
                // ‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
                if(item.reqMeat) {
                    meatSec.classList.remove('hidden');
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡∏°‡πà
                    createMeatOptions();
                } else {
                    meatSec.classList.add('hidden');
                }
            }
            
            updateModalPrice();
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.style.transform = ''; 
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            }, 10);
        }

        function closeModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'menu') { 
                history.back(); 
                return; 
            }

            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                currentItem = null;
                content.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function adjustQty(n) {
            modalQty += n;
            if(modalQty < 1) modalQty = 1;
            document.getElementById('modal-qty').innerText = modalQty;
            triggerHaptic();
            updateModalPrice();
        }

        // üî• Updated Price Logic
        function updateModalPrice() {
            if (!currentItem) return;
            let total = currentItem.price;
            let totalKcal = currentItem.kcal || 0;
            
            // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ñ‡∏≤‡∏î ---
            if(currentItem.isTray) {
                const meatOpt = document.querySelector('input[name="tray-meat"]:checked');
                const eggOpt = document.querySelector('input[name="tray-egg"]:checked');
                if(meatOpt) total += parseInt(meatOpt.getAttribute('data-price') || 0);
                if(eggOpt) total += parseInt(eggOpt.getAttribute('data-price') || 0);
                
                updateTraySummary(); // üî• ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå‡πÉ‡∏´‡∏°‡πà)
            }
            
            // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ Addon ‡∏õ‡∏Å‡∏ï‡∏¥ ---
            addonIds.forEach(id => {
                if(document.getElementById(`modal-opt-${id}`).checked) {
                    total += 10;
                    totalKcal += (addonCalories[id] || 0); 
                }
            });
            
            total = total * modalQty;
            totalKcal = totalKcal * modalQty;
            const priceEl = document.getElementById('modal-price');
            priceEl.innerText = total;
            priceEl.classList.remove('price-pop');
            void priceEl.offsetWidth;
            priceEl.classList.add('price-pop');
            document.getElementById('modal-kcal').innerText = totalKcal + ' kcal';
        }

        addonIds.forEach(id => {
            const el = document.getElementById(`modal-opt-${id}`);
            if (el) el.addEventListener('change', updateModalPrice);
        });

        // üî• Updated Add To Cart with Confetti Animation

        // Helper: animate a flying icon from a source element to the mini-cart
        function animateFlyToCart(sourceEl, emoji = 'üç±') {
            try {
                const target = document.getElementById('mini-count') || document.getElementById('mini-cart-bar');
                if (!sourceEl || !target) return Promise.resolve();

                const srcRect = sourceEl.getBoundingClientRect();
                const tgtRect = target.getBoundingClientRect();

                const fly = document.createElement('div');
                fly.className = 'fly-item';
                fly.innerText = emoji;
                document.body.appendChild(fly);

                const startX = srcRect.left + srcRect.width / 2;
                const startY = srcRect.top + srcRect.height / 2;
                const endX = tgtRect.left + tgtRect.width / 2;
                const endY = tgtRect.top + tgtRect.height / 2;

                fly.style.left = startX - 24 + 'px';
                fly.style.top = startY - 24 + 'px';

                const midX = (startX + endX) / 2 + (Math.random() * 80 - 40); // arc control
                const midY = Math.min(startY, endY) - 140;

                const keyframes = [
                    { transform: `translate(0px, 0px) scale(1)`, opacity: 1 },
                    { transform: `translate(${midX - startX}px, ${midY - startY}px) scale(0.95) rotate(${(Math.random()*20)-10}deg)`, opacity: 1, offset: 0.55 },
                    { transform: `translate(${endX - startX}px, ${endY - startY}px) scale(0.6) rotate(20deg)`, opacity: 0.0 }
                ];

                const anim = fly.animate(keyframes, { duration: 700 + Math.random()*200, easing: 'cubic-bezier(0.2,0.8,0.2,1)' });
                return new Promise(resolve => {
                    anim.onfinish = () => { fly.remove(); resolve(); };
                });
            } catch (e) { return Promise.resolve(); }
        }

        // Setup micro-interactions (squash & stretch) for interactive buttons
        function setupMicroInteractions() {
            const buttons = Array.from(document.querySelectorAll('.btn-bounce'));
            buttons.forEach(btn => {
                // ensure element has btn-press class for CSS
                btn.classList.add('btn-press');

                let pointerDown = false;
                const onDown = (e) => {
                    if (btn.disabled) return;
                    pointerDown = true;
                    btn.classList.remove('rebound');
                    btn.classList.add('squash');
                };
                const onUp = (e) => {
                    if (!pointerDown) return;
                    pointerDown = false;
                    btn.classList.remove('squash');
                    btn.classList.add('rebound');
                    // cleanup after animation
                    btn.addEventListener('animationend', function _end() { btn.classList.remove('rebound'); btn.removeEventListener('animationend', _end); });
                };

                btn.addEventListener('pointerdown', onDown, { passive: true });
                ['pointerup','pointercancel','pointerleave'].forEach(ev => btn.addEventListener(ev, onUp));
            });
        }

        function addToCart() {
            if (!currentItem) return;
            let meat = null;
            let noteExtra = "";

            // --- LOGIC ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ñ‡∏≤‡∏î ---
            if (currentItem.isTray) {
                 const meatOpt = document.querySelector('input[name="tray-meat"]:checked');
                 const eggOpt = document.querySelector('input[name="tray-egg"]:checked');
                 
                 meat = meatOpt ? meatOpt.value : '‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö'; // Default ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß
                 noteExtra = `[${eggOpt ? eggOpt.value : ''}]`;
            } 
            // --- LOGIC ‡πÄ‡∏î‡∏¥‡∏° ---
            else if (currentItem.reqMeat) {
                const r = document.querySelector('input[name="modal-meat"]:checked');
                
                if(!r) {
                    const meatContainer = document.getElementById('meat-options-container');
                    meatContainer.classList.remove('animate-shake');
                    void meatContainer.offsetWidth;
                    meatContainer.classList.add('animate-shake', 'border', 'border-red-500', 'rounded-xl');
                    triggerHaptic();
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', 'warning');
                    return; 
                }
                meat = r.value;
            }

            let addons = [];
            let addPrice = 0;
            const names = {special:'‡∏û‡∏¥‡πÄ‡∏®‡∏©', kaikhon:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô', kaidao:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', kaijiao:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', kaitom:'‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°', kaiyiewma:'‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤'};
            addonIds.forEach(id => {
                if(document.getElementById(`modal-opt-${id}`).checked) {
                    addons.push(names[id]);
                    addPrice += 10;
                }
            });
            
            // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏≤‡∏î
            let trayAddPrice = 0;
            if(currentItem.isTray) {
                const meatOpt = document.querySelector('input[name="tray-meat"]:checked');
                const eggOpt = document.querySelector('input[name="tray-egg"]:checked');
                if(meatOpt) trayAddPrice += parseInt(meatOpt.getAttribute('data-price') || 0);
                if(eggOpt) trayAddPrice += parseInt(eggOpt.getAttribute('data-price') || 0);
            }
            
            let noteSafe = escapeHtml(document.getElementById('modal-note').value.trim());
            if(noteExtra) noteSafe = (noteSafe ? noteSafe + " " : "") + noteExtra;

            for(let i=0; i<modalQty; i++){
                cart.push({
                    id: Date.now() + i,
                    name: currentItem.name,
                    price: currentItem.price + addPrice + trayAddPrice,
                    meat: meat,
                    addons: addons,
                    note: noteSafe
                });
            }
            
            // Enhanced feedback
            playSound('pop'); 
            triggerHaptic();
            
            // Flying icon animation to cart (non-blocking)
            try {
                const modalIconEl = document.getElementById('modal-icon');
                const srcEl = modalIconEl ? modalIconEl.parentElement : null;
                animateFlyToCart(srcEl, currentItem.icon || (modalIconEl ? modalIconEl.innerText : 'üç±'));
            } catch (e) {}

            // confetti removed (user requested no "‡∏û‡∏•‡∏∏" when adding to cart)
            
            // Bounce animation for cart button
            const cartBtn = document.getElementById('mini-cart-bar');
            if(cartBtn) {
                cartBtn.classList.remove('hidden');
                cartBtn.style.animation = 'bounce 0.5s ease-out';
                setTimeout(() => cartBtn.style.animation = '', 500);
            }
            
            closeModal();
            updateMiniCart();
            saveToLS();
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${modalQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
        }

        function getNextDrawDate() {
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth();
            const year = today.getFullYear();
            let drawDate = new Date();
            if (day <= 1) drawDate = new Date(year, month, 1);
            else if (day <= 16) drawDate = new Date(year, month, 16);
            else drawDate = new Date(year, month + 1, 1);
            return drawDate;
        }

        let OFFICIAL_RESULTS = {};

        async function fetchLottoResults() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getLotto');
                const data = await response.json();
                OFFICIAL_RESULTS = data;
                autoCheckLottery(); 
            } catch (error) {
                console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏´‡∏ß‡∏¢‡πÑ‡∏î‡πâ:", error);
            }
        }

        function getWinningNumberForDate(dateStr) {
            if (OFFICIAL_RESULTS[dateStr]) return OFFICIAL_RESULTS[dateStr];
            return "NotSet"; 
        }

        let currentOrderId = "";
        
        function generateOrderId() {
            const now = Date.now().toString();
            const timePart = now.slice(-2); 

            const myPendingNumbers = lottoHistory
                .filter(t => t.status === 'pending')
                .map(t => t.number);

            let randomPart;
            let isDuplicate = true;
            let attempts = 0;

            while (isDuplicate && attempts < 500) {
                randomPart = Math.floor(Math.random() * 100).toString().padStart(2, '0');

                if (!myPendingNumbers.includes(randomPart) || myPendingNumbers.length >= 100) {
                    isDuplicate = false;
                }
                attempts++;
            }

            currentOrderId = `KP-${timePart}${randomPart}`;
            return currentOrderId;
        }

        function saveTicketToHistory(orderId, totalPrice) {
            const today = new Date();
            const drawDateObj = getNextDrawDate();
            
            const todayStr = getStandardDate(today);
            const drawDateStr = getStandardDate(drawDateObj);

            const name = document.getElementById('user-name').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            
            const ticket = {
                id: orderId,
                number: orderId.slice(-2),
                date: todayStr,
                drawDate: drawDateStr,
                drawDateTimestamp: drawDateObj.getTime(),
                timestamp: Date.now(),
                price: totalPrice,
                status: 'pending',
                checkedDate: null,
                items: JSON.parse(JSON.stringify(cart)), 
                customerName: name 
            };
            
            lottoHistory.unshift(ticket);
            
            if (lottoHistory.length > 20) {
                lottoHistory = lottoHistory.slice(0, 20); 
            }

            localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
            updateTicketBadge();
        }

        function autoCheckLottery() {
            const pendingTickets = lottoHistory.filter(t => t.status === 'pending');
            if(pendingTickets.length === 0) return;
            const now = new Date();
            now.setHours(0, 0, 0, 0); 
            let winCount = 0;
            let updated = false;
            pendingTickets.forEach(t => {
                let targetDate;
                if (t.drawDateTimestamp) targetDate = t.drawDateTimestamp;
                else targetDate = 0; 
                
                if (now.getTime() < targetDate) return; 

                const winningNum = getWinningNumberForDate(t.drawDate || getStandardDate(new Date()));
                
                if (t.number === winningNum) {
                    t.status = 'won';
                    winCount++;
                    if (Notification.permission === "granted") {
                        new Notification("‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ü§ë", { 
                            body: `‡∏á‡∏ß‡∏î ${t.drawDate}: Order ${t.id} ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ!`, 
                            icon: 'https://cdn-icons-png.flaticon.com/512/3170/3170733.png' 
                        });
                    }
                } else if (winningNum !== "NotSet") {
                    t.status = 'lost';
                }
                if (winningNum !== "NotSet") {
                    t.checkedDate = getStandardDate(new Date());
                    updated = true;
                }
            });
                if (updated) {
                    localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
                    if(winCount > 0) {
                        sfxWin.play();
                        if (typeof confetti === 'function') {
                            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                        }
                        showToast(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${winCount} ‡πÉ‡∏ö!`);
                    }
                    updateTicketBadge();
                }
        }

        function updateTicketBadge() {
            const pending = lottoHistory.filter(t => t.status === 'pending').length;
            const dot = document.getElementById('unread-ticket-dot');
            if(pending > 0) dot.classList.remove('hidden'); else dot.classList.add('hidden');
        }

        function openMyTickets() {
            pushModalState('tickets'); 

            triggerHaptic();
            playSound('pop');
            const list = document.getElementById('tickets-list');
            list.innerHTML = '';
            if(lottoHistory.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-slate-400 mt-10">
                        <div class="text-4xl mb-2 opacity-30">üéüÔ∏è</div>
                        <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                    </div>`;
            } else {
                lottoHistory.forEach((t, index) => {
                    let statusHtml = '';
                    let statusClass = '';
                    if(t.status === 'pending') {
                        statusHtml = `<span class="text-indigo-600 font-bold"><i class="far fa-clock"></i> ‡∏£‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏á‡∏ß‡∏î ${t.drawDate || '‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ'}</span>`;
                        statusClass = 'border-l-4 border-indigo-500 bg-indigo-50/50';
                    } else if(t.status === 'won') {
                        statusHtml = '<span class="text-yellow-400 font-bold"><i class="fas fa-trophy"></i> ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!</span>';
                        statusClass = 'border-l-4 border-yellow-500 bg-yellow-500/20';
                    } else {
                        statusHtml = '<span class="text-slate-400 font-bold"><i class="fas fa-times-circle"></i> ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>';
                        statusClass = 'border-l-4 border-slate-600 bg-slate-800/50 opacity-70 grayscale';
                    }
                    const item = document.createElement('div');
                    item.onclick = () => reprintReceipt(index);
                    item.className = `ticket-stub p-4 rounded-lg shadow-sm border border-slate-700 mb-3 flex justify-between items-center relative overflow-hidden cursor-pointer active:scale-95 transition-transform btn-bounce ${statusClass}`;
                    item.innerHTML = `
                        <div>
                            <div class="text-[10px] text-slate-400">Order ID: ${t.id}</div>
                            <div class="flex items-baseline gap-2 mt-1">
                                <span class="text-xs text-slate-300">‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô:</span>
                                <span class="text-2xl font-black text-indigo-400 tracking-widest">${t.number}</span>
                            </div>
                            <div class="text-[10px] text-slate-400 mt-1">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${t.date}</div>
                            <div class="text-[10px] text-indigo-400 font-bold mt-2"><i class="fas fa-print"></i> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                        </div>
                        <div class="text-right flex flex-col items-end">
                             <div class="text-xs mb-1 bg-slate-800/80 px-2 py-1 rounded-full shadow-sm whitespace-nowrap">${statusHtml}</div>
                             ${t.status === 'won' ? '<button class="text-[10px] bg-yellow-500 text-white font-bold px-2 py-1 rounded shadow-sm mt-1 animate-pulse">‡πÅ‡∏Ñ‡∏õ‡∏à‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>' : ''}
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            const overlay = document.getElementById('tickets-modal-overlay');
            const sheet = document.getElementById('tickets-sheet');
            sheet.style.transform = '';
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                sheet.classList.remove('translate-y-full');
            }, 10);
        }

        function closeMyTickets(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'tickets') { history.back(); return; }

            const overlay = document.getElementById('tickets-modal-overlay');
            const sheet = document.getElementById('tickets-sheet');
            overlay.classList.add('opacity-0');
            sheet.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                sheet.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        // FIX 4: Added try-catch wrapper to openCheckout function
        function openCheckout() {
            try {
                pushModalState('checkout'); 

                triggerHaptic();
                playSound('pop');
                renderCheckoutList();
                if(document.getElementById('discount-code').value.trim() !== '' && discountValue > 0) applyDiscount();
                
                // Show Order ID Banner
                const bannerContainer = document.getElementById('order-id-banner');
                if(cart.length > 0) {
                    const lottoId = generateOrderId(); 
                    bannerContainer.classList.remove('hidden');
                    bannerContainer.innerHTML = `
                        <div class="bg-gray-100 border border-gray-300 p-4 rounded-xl mb-3 flex justify-between items-center shadow-sm relative overflow-hidden stagger-item">
                            <div class="absolute -right-4 -top-4 bg-indigo-100 opacity-50 w-20 h-20 rounded-full"></div>
                            <div class="flex flex-col z-10">
                                <span class="text-[10px] text-gray-600 uppercase tracking-wider">Order ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
                                <div class="flex items-baseline gap-1">
                                    <span class="font-bold text-xl text-gray-800">${lottoId.slice(0, -2)}</span>
                                    <span class="font-black text-3xl text-yellow-600 drop-shadow-sm">${lottoId.slice(-2)}</span>
                                </div>
                            </div>
                            <div class="z-10 text-right">
                                <div class="text-2xl">üéüÔ∏è</div>
                                <span class="text-[10px] font-bold text-gray-600">‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ!</span>
                            </div>
                        </div>
                    `;
                } else {
                    bannerContainer.classList.add('hidden');
                }
                
                // Reset points toggle
                resetPointsDiscount();
                
                const overlay = document.getElementById('checkout-overlay');
                const sheet = document.getElementById('checkout-sheet');
                sheet.style.transform = '';
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    sheet.classList.remove('translate-y-full');
                }, 10);
            } catch (error) {
                // FIX 4: Alert error message for debugging
                alert('Error in openCheckout: ' + error.message);
                console.error('openCheckout error:', error);
                throw error;
            }
        }

        function closeCheckout(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'checkout') { history.back(); return; }

            const overlay = document.getElementById('checkout-overlay');
            const sheet = document.getElementById('checkout-sheet');
            overlay.classList.add('opacity-0');
            sheet.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                sheet.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function updateMiniCart() {
            const miniBar = document.getElementById('mini-cart-bar');
            if(cart.length > 0) {
                miniBar.classList.remove('hidden');
                let total = cart.reduce((sum, i) => sum + i.price, 0);
                document.getElementById('mini-count').innerText = cart.length;
                document.getElementById('mini-total').innerText = total + " ‡∏ø";
            } else {
                miniBar.classList.add('hidden');
                // Reset mini cart display when empty
                document.getElementById('mini-count').innerText = '0';
                document.getElementById('mini-total').innerText = '0 ‡∏ø';
            }
        }

        function removeFromCart(id) {
            const index = cart.findIndex(item => item.id === id);
            if (index !== -1) {
                cart.splice(index, 1);
                saveToLS();
                
                if(cart.length === 0) {
                    removeDiscount();
                    resetPointsDiscount();
                } else if(discountValue > 0) {
                    applyDiscount();
                }
                
                renderCheckoutList();
                updateMiniCart();
                if(cart.length === 0) closeCheckout();
                
                showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                triggerHaptic();
            }
        }

        // UPDATED: Render checkout list for new layout with improved text visibility
        function renderCheckoutList() {
            const container = document.getElementById('cart-list-container');
            container.innerHTML = '';
            cart.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-gray-50 p-3 rounded-xl border border-gray-200 flex justify-between items-start stagger-item";
                let detail = item.meat ? `<span class="text-orange-600 text-xs bg-orange-100 px-1 rounded">${item.meat}</span> ` : '';
                if(item.addons.length) detail += `<span class="text-gray-600 text-xs">+${item.addons.join(',')}</span>`;
                el.innerHTML = `
                    <div>
                        <h4 class="cart-item-title font-bold text-gray-800">${item.name}</h4>
                        <div class="cart-item-details mt-1">${detail}</div>
                        ${item.note ? `<div class="text-[10px] text-gray-500 mt-1">Note: ${item.note}</div>` : ''}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="font-bold text-gray-800">${item.price}.-</span>
                        <button onclick="removeFromCart(${item.id})" class="text-xs text-red-600 bg-red-100 w-9 h-9 rounded flex items-center justify-center border border-red-200 btn-bounce"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
            updateTotalSummary();
        }

        function clearCart() {
            if(cart.length === 0) return;
            if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
            sfxTrash.play();
            cart = [];
            discountValue = 0;
            pointsRedeemed = 0;
            isPointsActive = false;
            currentOrderId = "";
            
            // Reset discount code input
            document.getElementById('discount-code').value = '';
            document.getElementById('discount-msg').innerText = '';
            
            // Reset points toggle
            resetPointsDiscount();
            
            saveToLS();
            
            // Update UI components
            updateMiniCart();
            renderCheckoutList();
            updateTotalSummary();
            closeCheckout();
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üóëÔ∏è');
            
            // Hide order ID banner
            const bannerContainer = document.getElementById('order-id-banner');
            if (bannerContainer) bannerContainer.classList.add('hidden');
        }

        // UPDATED: Total summary for new layout with improved visibility
        function updateTotalSummary() {
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            let discountFromCode = 0;
            let discountFromPoints = 0;
            
            // Calculate code discount
            const code = document.getElementById('discount-code').value.trim().toUpperCase();
            const promo = promotions.find(p => p.code === code);
            if (promo && subtotal >= promo.minOrder) {
                discountFromCode = promo.value;
            }
            
            // Calculate points discount
            if (pointsRedeemed > 0) {
                discountFromPoints = Math.floor(pointsRedeemed / 100) * 10;
            }
            
            const netTotal = Math.max(0, subtotal - discountFromCode - discountFromPoints);
            
            // Update summary displays with improved visibility
            document.getElementById('summary-subtotal').textContent = `${subtotal}.-`;
            document.getElementById('summary-grand-total').textContent = `${netTotal}.-`;
            
            // Update discount summary
            const discountSummary = document.getElementById('discount-summary');
            const pointsSummary = document.getElementById('points-summary');
            
            if (discountFromCode > 0) {
                discountSummary.classList.remove('hidden');
                discountSummary.querySelector('span:last-child').textContent = `-${discountFromCode}.-`;
            } else {
                discountSummary.classList.add('hidden');
            }
            
            if (discountFromPoints > 0) {
                pointsSummary.classList.remove('hidden');
                pointsSummary.querySelector('span:last-child').textContent = `-${discountFromPoints}.-`;
            } else {
                pointsSummary.classList.add('hidden');
            }
            
            // FIX 1: Call updateCheckoutPointsInfo instead of it calling us (prevents infinite loop)
            updateCheckoutPointsInfo();
        }

        function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim().toUpperCase();
            let total = cart.reduce((sum, i) => sum + i.price, 0);
            const msg = document.getElementById('discount-msg');
            const btn = document.getElementById('btn-apply-code');
            
            discountValue = 0;

            if (code === '') {
                msg.innerText = '';
                btn.innerHTML = '‡πÉ‡∏ä‡πâ';
                btn.className = 'btn-bounce bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-4 rounded-lg transition-colors whitespace-nowrap text-sm';
                btn.onclick = applyDiscount;
                updateTotalSummary();
                return;
            }

            const promo = promotions.find(p => p.code === code);

            if (promo && total >= promo.minOrder) {
                discountValue = promo.value;
                msg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏î ${promo.value} ‡∏ö‡∏≤‡∏ó</span>`;
                btn.innerHTML = '<i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                btn.className = 'btn-bounce bg-red-500 hover:bg-red-600 text-white font-bold px-4 rounded-lg transition-colors whitespace-nowrap text-sm';
                btn.onclick = removeDiscount;
                playSound('pop');
            }
            else {
                msg.innerHTML = `<span class="text-red-600">${promo ? '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö '+promo.minOrder : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î'}</span>`;
                btn.innerHTML = '‡πÉ‡∏ä‡πâ';
                btn.className = 'btn-bounce bg-gray-500 hover:bg-gray-600 text-white font-bold px-4 rounded-lg transition-colors whitespace-nowrap text-sm';
                btn.onclick = applyDiscount;
            }
            updateTotalSummary();
        }

        function removeDiscount() {
            document.getElementById('discount-code').value = '';
            document.getElementById('discount-msg').innerText = '';
            discountValue = 0;
            applyDiscount();
        }

        function openReceiptResult(imgData) {
            const modal = document.getElementById('receipt-result-modal');
            const img = document.getElementById('receipt-result-img');
            img.src = imgData;
            modal.classList.remove('hidden');
        }

        function downloadReceiptImage() {
            const img = document.getElementById('receipt-result-img');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = 'kaprao52-receipt-' + Date.now() + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...');
        }

        function generateOrderCard() {
            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...");
            const name = document.getElementById('user-name').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            
            const nowStr = `${getStandardDate(new Date())} ${formatTime(new Date())}`;

            let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            let discountFromCode = 0;
            let discountFromPoints = 0;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î
            const code = document.getElementById('discount-code').value.trim().toUpperCase();
            const promo = promotions.find(p => p.code === code);
            if (promo && subtotal >= promo.minOrder) {
                discountFromCode = promo.value;
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏û‡∏≠‡∏¢‡∏ï‡πå
            if (pointsRedeemed > 0) {
                discountFromPoints = Math.floor(pointsRedeemed / 100) * 10;
            }
            
            const netTotal = Math.max(0, subtotal - discountFromCode - discountFromPoints);

            document.querySelector('.receipt-id').innerText = currentOrderId || 'KP-XXXX';
            document.querySelector('.receipt-date').innerText = nowStr;
            document.querySelector('.receipt-name').innerText = escapeHtml(name);
            document.querySelector('.receipt-subtotal').innerText = subtotal + '.-';
            document.querySelector('.receipt-discount').innerText = '-' + (discountFromCode + discountFromPoints) + '.-';
            document.querySelector('.receipt-total').innerText = netTotal + '.-';

            const receiptAvatar = document.getElementById('receipt-avatar-img');
            
            // --- FIX: USE GENERIC ICON TO AVOID CORS ---
            receiptAvatar.src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            // ------------------------------------------
            
            const itemsContainer = document.querySelector('.receipt-items');
            itemsContainer.innerHTML = '';
            cart.forEach((i, index) => {
                let detail = `${i.name}`;
                if(i.meat) detail += ` (${i.meat})`;
                if(i.addons.length) detail += ` +${i.addons.join(',')}`;
                const row = document.createElement('div');
                row.className = "flex justify-between text-xs";
                row.innerHTML = `
                    <div class="flex gap-1 text-slate-300">
                        <span class="w-4">${index+1}.</span>
                        <span>${detail}</span>
                    </div>
                    <span class="font-bold text-slate-200">${i.price}.-</span>
                `;
                itemsContainer.appendChild(row);
            });

            const div = document.getElementById('receipt-capture');

            html2canvas(div, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: null 
            }).then(canvas => {
                hideGlobalLoader();
                openReceiptResult(canvas.toDataURL());
                showToast('‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
            }).catch((err) => {
                console.error(err);
                hideGlobalLoader();
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û');
            });
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠ 3: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô reprintReceipt ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° loading
        function reprintReceipt(ticketIndex) {
            triggerHaptic();
            playSound('pop');
            const ticket = lottoHistory[ticketIndex];
            
            if (!ticket.items || ticket.items.length === 0) {
                showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤ üò¢");
                return;
            }

            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏Å‡πà‡∏≤..."); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ
            
            const name = ticket.customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            const subtotal = ticket.items.reduce((sum, i) => sum + i.price, 0);
            const netTotal = ticket.price; 
            const discount = subtotal - netTotal; 

            const tDate = new Date(ticket.timestamp);
            const dateStr = `${getStandardDate(tDate)} ${formatTime(tDate)}`;

            document.querySelector('.receipt-id').innerText = ticket.id;
            document.querySelector('.receipt-date').innerText = dateStr;
            document.querySelector('.receipt-name').innerText = escapeHtml(name);
            document.querySelector('.receipt-subtotal').innerText = subtotal + '.-';
            document.querySelector('.receipt-discount').innerText = '-' + discount + '.-';
            document.querySelector('.receipt-total').innerText = netTotal + '.-';

            // --- FIX: USE GENERIC ICON TO AVOID CORS ---
            const receiptAvatar = document.getElementById('receipt-avatar-img');
            receiptAvatar.src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            // ------------------------------------------

            const itemsContainer = document.querySelector('.receipt-items');
            itemsContainer.innerHTML = '';
            ticket.items.forEach((i, index) => {
                let detail = `${i.name}`;
                if(i.meat) detail += ` (${i.meat})`;
                if(i.addons.length) detail += ` +${i.addons.join(',')}`;
                const row = document.createElement('div');
                row.className = "flex justify-between text-xs";
                row.innerHTML = `
                    <div class="flex gap-1 text-slate-300">
                        <span class="w-4">${index+1}.</span>
                        <span>${detail}</span>
                    </div>
                    <span class="font-bold text-slate-200">${i.price}.-</span>
                `;
                itemsContainer.appendChild(row);
            });

            setTimeout(() => {
                const div = document.getElementById('receipt-capture');

                html2canvas(div, { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: null 
                }).then(canvas => {
                    hideGlobalLoader();
                    openReceiptResult(canvas.toDataURL());
                    showToast('‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
                }).catch(() => {
                    hideGlobalLoader();
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û');
                });
            }, 500);
        }

        async function submitOrderToLine() {
            // FIX: RACE CONDITION CHECK
            if (isSyncing) {
                showToast("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");
                return;
            }
            // -------------------------

            if (isSubmitting) return;

            const name = document.getElementById('user-name').value.trim();
            if (!name) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á');

            isSubmitting = true;
            const btn = document.getElementById('btn-submit-order');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå...");
                
                let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î
                let discountFromCode = 0;
                const code = document.getElementById('discount-code').value.trim().toUpperCase();
                const promo = promotions.find(p => p.code === code);
                if (promo && subtotal >= promo.minOrder) {
                    discountFromCode = promo.value;
                }
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏û‡∏≠‡∏¢‡∏ï‡πå
                let discountFromPoints = 0;
                if (pointsRedeemed > 0) {
                    discountFromPoints = Math.floor(pointsRedeemed / 100) * 10;
                }
                
                const netTotal = Math.max(0, subtotal - discountFromCode - discountFromPoints);
                
                // Calculate points
                const pointsEarned = calculatePoints(netTotal);
                const currentPoints = userStats.points || 0;
                const newPointsBalance = currentPoints + pointsEarned - pointsRedeemed;
                
                // Update user stats
                userStats.points = newPointsBalance;
                localStorage.setItem(KEYS.STATS, JSON.stringify(userStats));
                
                // Update display immediately
                updatePointsDisplay();
                
                const allNotes = cart.filter(i => i.note).map(i => i.note).join(", ");
                
                if(!currentOrderId) generateOrderId();

                const nowStr = `${getStandardDate(new Date())} ${formatTime(new Date())}`;
                
                let msg = `üî• ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà! [${currentOrderId}]\n`;
                msg += `üéüÔ∏è ‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢: ${currentOrderId.slice(-2)}\n`;
                msg += `üìÖ ${nowStr}\n`;
                msg += `üë§ ‡∏Ñ‡∏∏‡∏ì ${name}\n`;
                msg += `ü™ô ‡∏û‡∏≠‡∏¢‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ: +${pointsEarned} ‡∏û‡∏≠‡∏¢‡∏ï‡πå\n`;
                msg += `------------------------\n`;
                cart.forEach((i, index) => {
                    let detail = `${i.name} ${i.meat ? '('+i.meat+')' : ''}`;
                    if(i.addons.length) detail += ` +${i.addons.join('+')}`;
                    if(i.note) detail += ` [${i.note}]`;
                    msg += `${index + 1}. ${detail} (${i.price}.-)\n`;
                });
                msg += `------------------------\n`;
                msg += `üíµ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${subtotal} ‡∏ö‡∏≤‡∏ó\n`;
                if (discountFromCode > 0) {
                    msg += `üè∑Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î: -${discountFromCode} ‡∏ö‡∏≤‡∏ó\n`;
                }
                if (discountFromPoints > 0) {
                    msg += `ü™ô ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏≠‡∏¢‡∏ï‡πå: -${discountFromPoints} ‡∏ö‡∏≤‡∏ó\n`;
                }
                if (pointsRedeemed > 0) {
                    msg += `ü™ô ‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏¢‡∏ï‡πå: ${pointsRedeemed} ‡∏û‡∏≠‡∏¢‡∏ï‡πå\n`;
                }
                msg += `üí∞ ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${netTotal} ‡∏ö‡∏≤‡∏ó\n`;

                const sheetData = {
                    orderId: currentOrderId,
                    name: name,
                    items: cart,
                    totalPrice: subtotal,
                    discountCode: discountFromCode,
                    discountPoints: discountFromPoints,
                    netTotal: netTotal,
                    pointsEarned: pointsEarned,
                    pointsRedeemed: pointsRedeemed,
                    pointsBalance: newPointsBalance,
                    allNotes: allNotes,
                    userId: userAvatar.userId 
                };

                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sheetData),
                        keepalive: true 
                    }).catch(err => console.error("Sheet Error:", err));
                }

                saveTicketToHistory(currentOrderId, netTotal);
                
                const lineOAId = "@772ysswn";
                const encodedMsg = encodeURIComponent(msg);
                
                setTimeout(() => {
                    cart = []; 
                    discountValue = 0;
                    pointsRedeemed = 0;
                    isPointsActive = false;
                    currentOrderId = "";
                    saveToLS();
                    updateMiniCart();
                    closeCheckout();
                    hideGlobalLoader();
                    
                    window.location.href = `https://line.me/R/oaMessage/${lineOAId}/?${encodedMsg}`;
                    
                    isSubmitting = false;
                    btn.innerHTML = originalText;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }, 1000);

            } catch (error) {
                console.error("Critical Submit Error:", error);
                hideGlobalLoader();
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                isSubmitting = false;
                btn.innerHTML = originalText;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- SWIPE UTILS ---
        function enableSwipeToClose(el, scrollEl, closeCallback) {
            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            el.addEventListener('touchstart', (e) => {
                if (scrollEl.scrollTop <= 0) { startY = e.touches[0].clientY; isDragging = true; el.style.transition = 'none'; }
            }, { passive: true });
            el.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const diff = e.touches[0].clientY - startY;
                if (diff > 0) { if (scrollEl.scrollTop > 0) return; e.preventDefault(); el.style.transform = `translateY(${diff}px)`; currentY = diff; }
            }, { passive: false });
            el.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                el.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
                if (currentY > 150) closeCallback(); else el.style.transform = '';
                currentY = 0;
            });
        }
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ swipe handlers ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const _modalContent = document.getElementById('modal-content');
                const _modalScroll = document.getElementById('modal-scroll-area');
                if (_modalContent && _modalScroll) enableSwipeToClose(_modalContent, _modalScroll, closeModal);

                const _checkoutSheet = document.getElementById('checkout-sheet');
                const _cartList = document.getElementById('checkout-scrollable');
                if (_checkoutSheet && _cartList) enableSwipeToClose(_checkoutSheet, _cartList, closeCheckout);

                const _ticketsSheet = document.getElementById('tickets-sheet');
                const _ticketsList = document.getElementById('tickets-list');
                if (_ticketsSheet && _ticketsList) enableSwipeToClose(_ticketsSheet, _ticketsList, closeMyTickets);
            }, 500);
        });

        // --- KEYBOARD HANDLING ---
        document.addEventListener('keydown', function(e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                triggerHaptic();
                if (currentOpenModal === 'menu') closeModal(true);
                else if (currentOpenModal === 'checkout') closeCheckout(true);
                else if (currentOpenModal === 'tickets') closeMyTickets(true);
                else if (currentOpenModal === 'avatar') closeAvatarModal(true);
                else if (currentOpenModal === 'points-history') closePointsHistory(true);
                else if (!document.getElementById('welcome-modal').classList.contains('hidden')) {
                    closeWelcome();
                }
            }
            
            // Enter to submit forms
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                triggerHaptic();
                
                // Submit order if in checkout
                if (activeElement && activeElement.id === 'user-name') {
                    const submitBtn = document.getElementById('btn-submit-order');
                    if (submitBtn && !submitBtn.disabled) {
                        submitOrderToLine();
                    }
                }
                
                // Add to cart if modal is open
                if (currentOpenModal === 'menu' && currentItem) {
                    addToCart();
                }
                
                // Apply discount code
                if (activeElement && activeElement.id === 'discount-code') {
                    applyDiscount();
                }
            }
            
            // Arrow keys for quantity adjustment
            if (currentOpenModal === 'menu' && currentItem) {
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    triggerHaptic();
                    adjustQty(1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    triggerHaptic();
                    adjustQty(-1);
                }
            }
        });

        document.getElementById('user-name').addEventListener('input', saveToLS);
        
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠ 5: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö error ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á app
            e.preventDefault();
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault();
        });
    </script>
    <script>
        document.addEventListener('error', function(e) {
            if (e.target.tagName.toLowerCase() === 'img') {
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô
                e.target.src = 'https://cdn-icons-png.flaticon.com/512/135/135161.png'; // ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß generic
                e.target.alt = 'Image not found';
                e.target.classList.add('opacity-50'); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ó‡∏ô
            }
        }, true);
    </script>
</body>
</html>
