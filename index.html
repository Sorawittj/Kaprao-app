<!DOCTYPE html>
<html lang="th">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4FR74WPRNY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4FR74WPRNY');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#7C77D6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448609.png">
    
    <title>Kaprao52 - APP</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            purple: '#7C77D6', 
                            yellow: '#FFD755', 
                            bg: '#F5F7FB',        
                            text: '#2D3436',      
                        }
                    },
                    fontFamily: {
                        sans: ['Kanit', 'sans-serif'],
                        round: ['Varela Round', 'sans-serif']
                    },
                    borderRadius: {
                        '4xl': '2.5rem',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á (iOS Fix) - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö */
        body { background-color: #F5F7FB; color: #2D3436; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }
        .safe-area-pt { padding-top: var(--sat); }
        .safe-area-pb { padding-bottom: var(--sab); }
        .safe-area-pb-plus { padding-bottom: calc(1rem + var(--sab)); }

        /* Transition Animations */
        .fade-in-up { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Page Transition Effect */
        .page-out { animation: pageOut 0.2s ease-in forwards; }
        .page-in { animation: pageIn 0.3s ease-out forwards; }
        @keyframes pageOut { to { opacity: 0; transform: translateY(-10px) scale(0.95); } }
        @keyframes pageIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .price-pop { animation: pricePop 0.3s ease-out; }
        @keyframes pricePop { 50% { transform: scale(1.2); } }

        /* SHAKE ANIMATION */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.4s ease-in-out;
            border-color: #ef4444 !important; 
        }

        .category-pill-active {
            background-color: #FFD755;
            color: #2D3436;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(255, 215, 85, 0.3);
            border: 2px solid #FFD755;
        }
        
        .category-pill-inactive {
            background-color: #FFFFFF;
            color: #9CA3AF;
            border: 2px solid #F3F4F6;
        }

        .menu-card-style {
            background-color: #FFFFFF;
            border-radius: 1.5rem;
            transition: all 0.2s ease;
        }
        
        .menu-card-style:active {
            transform: scale(0.98);
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-success {
            border-color: #22c55e !important;
            background-color: #f0fdf4 !important;
            color: #15803d !important;
        }

        /* --- GLOBAL LOADER STYLES --- */
        #global-loader {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background-color: #F5F7FB;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s ease, visibility 0.4s;
        }
        .loader-hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .cooking-pan {
            font-size: 4rem;
            animation: panFlip 1.5s infinite ease-in-out;
            transform-origin: center bottom;
        }
        @keyframes panFlip {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* Parallax Background Pattern */
        #parallax-bg {
            background-image: radial-gradient(#7C77D6 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.1;
        }

        /* --- CLEAN TITLE STYLES --- */
        .grand-title {
            display: flex;
            align-items: baseline;
            font-weight: 900;
            font-size: 2.25rem;
            line-height: 1;
            color: #2D3436; 
            letter-spacing: -1px;
        }

        .title-highlight {
            color: #FFD755; 
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1); 
            margin-left: 2px;
        }

        /* --- LUCKY WHEEL STYLES --- */
        #wheel-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 20px auto;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }
        #wheel-canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 8s cubic-bezier(0.1, 0.99, 0.1, 0.99);
        }
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; 
            height: 0; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 35px solid #FFD755; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
            z-index: 20;
        }
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* --- FLOATING BUBBLES --- */
        .bubble {
            position: absolute;
            bottom: -50px;
            background-color: rgba(124, 119, 214, 0.15);
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp 15s infinite linear;
            z-index: -1;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-120vh) scale(1.5); opacity: 0; }
        }

        /* --- RECEIPT CAPTURE AREA (Hidden) --- */
        #receipt-capture {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 400px; 
            background: #FFFFFF;
            padding: 0;
            border-radius: 0;
            font-family: 'Kanit', sans-serif;
            color: #2D3436;
        }

        /* --- ACHIEVEMENT BAR --- */
        .xp-bar-bg { background-color: #E5E7EB; border-radius: 9999px; overflow: hidden; height: 8px; }
        .xp-bar-fill { background: linear-gradient(90deg, #FFD755, #f59e0b); height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* --- TICKET STYLES --- */
        .ticket-stub {
            background-image: radial-gradient(circle at 0 50%, transparent 8px, #FFFFFF 8.5px), radial-gradient(circle at 100% 50%, transparent 8px, #FFFFFF 8.5px);
            background-position: 0 0, 0 0;
            background-size: 100% 100%;
            transition: transform 0.1s ease;
        }
        .ticket-stub:active {
            transform: scale(0.98);
        }

        /* --- AVATAR STYLES (Verified 3D) --- */
        .avatar-option {
            width: 65px;
            height: 65px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #ffffff;
            padding: 5px;
            border: 2px solid #f3f4f6;
        }
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        .avatar-option:hover { transform: scale(1.1); border-color: #e5e7eb; }
        .avatar-selected { background: #fffbeb !important; border: 2px solid #FFD755; box-shadow: 0 4px 6px rgba(255, 215, 85, 0.4); }
        
        .chef-hat-overlay {
            width: 40px;
            height: 40px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/1830/1830839.png');
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        /* New Level Badges */
        .badge-newbie { background: linear-gradient(135deg, #fefce8, #fff7ed); color: #d97706; border: 2px solid #fde68a; }
        .badge-regular { background: linear-gradient(135deg, #dbeafe, #60a5fa); color: #1e40af; border: 2px solid #93c5fd; }
        .badge-god { background: linear-gradient(135deg, #fef3c7, #f59e0b); color: #78350f; border: 2px solid #fcd34d; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }

        /* --- PET PLAYGROUND STYLES --- */
        #pet-playground {
            position: fixed;
            bottom: calc(4.5rem + env(safe-area-inset-bottom)); /* Sit above tickets/cart bar */
            left: 0;
            width: 100%;
            height: 100px;
            z-index: 5; /* Low index, behind cart modal */
            pointer-events: none; /* Let clicks pass through empty space */
            overflow: hidden;
        }
        
        #active-pet-container {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto; /* Enable clicking on the pet */
            cursor: pointer;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), left 2s ease-in-out;
        }

        #pet-body-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
        }

        .pet-bounce { animation: petBounce 2s infinite ease-in-out; }
        @keyframes petBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        
        .pet-walk-left { transform: scaleX(-1); animation: petWalk 0.5s infinite steps(2); }
        .pet-walk-right { transform: scaleX(1); animation: petWalk 0.5s infinite steps(2); }
        @keyframes petWalk { 0% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .pet-heart {
            position: absolute;
            font-size: 24px;
            color: #ff4757;
            animation: floatHeart 1s ease-out forwards;
            pointer-events: none;
            z-index: 20;
        }
        @keyframes floatHeart {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            50% { opacity: 1; transform: translateY(-30px) scale(1.2); }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }
    </style>
</head>
<body class="pb-32 font-sans select-none relative overflow-x-hidden safe-area-pt">

    <div id="global-loader">
        <div class="relative mb-4">
            <div class="absolute inset-0 bg-yellow-200 rounded-full blur-xl opacity-50 animate-pulse"></div>
            <div class="cooking-pan relative z-10">üç≥</div>
        </div>
        <h2 class="text-xl font-bold text-gray-800 tracking-wider">KAPRAO<span class="text-brand-yellow">52</span></h2>
        <p id="loader-text" class="text-xs text-gray-400 mt-2 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡πâ‡∏≤‡∏ô...</p>
    </div>

    <div id="parallax-bg" class="fixed top-0 left-0 w-full h-[120vh] z-[-1] pointer-events-none transition-transform duration-75 ease-out"></div>
    <div id="bubbles-container" class="fixed inset-0 overflow-hidden pointer-events-none z-[-1]"></div>

    <div id="pet-playground">
        <div id="active-pet-container" onclick="petInteract()">
            <div id="pet-body" class="w-full h-full relative select-none">
                <img id="pet-body-img" src="" alt="Pet">
                <div id="pet-hat" class="absolute -top-6 left-1/2 -translate-x-1/2 w-8 h-8 bg-contain bg-no-repeat pointer-events-none hidden" style="background-image: url('https://cdn-icons-png.flaticon.com/512/1830/1830839.png');"></div>
            </div>
            <div class="absolute -bottom-1 w-12 h-3 bg-black/10 rounded-full blur-md"></div>
        </div>
    </div>

    <div id="welcome-modal" class="fixed inset-0 z-[100] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-6 fade-in-up">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-200 rounded-full opacity-50 blur-2xl"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-purple-200 rounded-full opacity-50 blur-2xl"></div>
            
            <div class="relative z-10">
                <div class="w-24 h-24 bg-gradient-to-br from-yellow-300 to-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4 text-5xl shadow-lg border-4 border-white animate-bounce-slow">
                    üéüÔ∏è
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î!</h2>
                <p class="text-gray-600 mb-6 leading-relaxed text-sm">
                    <span class="font-bold text-brand-purple text-base">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á!</span><br>
                    ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ (‡∏ô‡πâ‡∏≠‡∏¢‡πÜ) ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô<br>
                    ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ Order ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö<br>
                    <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•</span><br>
                    ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! üéÅ
                </p>
                <div class="flex flex-col gap-3">
                      <button onclick="requestNotifPermission()" class="w-full bg-white text-brand-purple font-bold py-3 rounded-xl shadow-sm border border-brand-purple active:scale-95 active:bg-purple-50 transition-all text-sm">
                        <i class="fas fa-bell mr-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏´‡∏ß‡∏¢
                    </button>
                    <button onclick="closeWelcome()" class="w-full bg-gradient-to-r from-brand-purple to-indigo-600 text-white font-bold py-4 rounded-xl shadow-xl shadow-indigo-300/50 active:scale-95 transition-all text-lg border-2 border-transparent hover:border-yellow-300">
                        ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢! ‡∏•‡∏∏‡πâ‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î üé∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="avatar-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-[120] hidden transition-opacity opacity-0 flex items-center justify-center p-6">
        <div class="bg-white rounded-[2rem] p-6 max-w-sm w-full shadow-2xl scale-in">
            <h3 class="text-xl font-bold text-center mb-4 text-gray-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üêæ</h3>
            
            <div class="grid grid-cols-4 gap-4 mb-6" id="avatar-grid">
                </div>

            <div class="mb-6">
                 <label class="text-sm font-bold text-gray-700 mb-2 block pl-1">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á üí¨</label>
                 <input type="text" id="pet-name-input" maxlength="12" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏ï‡∏π‡∏ö" class="w-full bg-gray-50 border-2 border-gray-100 rounded-xl p-3 text-center font-bold text-brand-purple focus:border-brand-yellow outline-none transition-all">
            </div>

            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl mb-6">
                <span class="text-sm font-bold text-gray-700">‡πÉ‡∏™‡πà‡∏´‡∏°‡∏ß‡∏Å‡πÄ‡∏ä‡∏ü üë®‚Äçüç≥</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="hat-toggle" class="sr-only peer" onchange="toggleHat()">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-purple"></div>
                </label>
            </div>

            <button onclick="closeAvatarModal()" class="w-full bg-brand-yellow text-gray-900 font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">
                ‡∏ï‡∏Å‡∏•‡∏á
            </button>
        </div>
    </div>

    <div class="px-6 pt-6 pb-2 bg-transparent relative z-10">
        
        <div class="flex justify-between items-start mb-6">
            <div class="flex flex-col justify-center">
                <p class="text-xs text-gray-400 font-medium mb-1">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ?</p>
                <h1 class="grand-title leading-none tracking-tight mb-2 relative z-10 pt-1">
                    KAPRAO<span class="title-highlight">52</span>
                </h1>
                <div id="streak-display" class="hidden mt-1 inline-flex items-center gap-1 bg-gradient-to-r from-orange-400 to-red-500 text-white text-[10px] px-2 py-0.5 rounded-full w-max shadow-sm animate-pulse">
                    <i class="fas fa-fire"></i> <span id="streak-text">‡∏™‡∏±‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô 0 ‡∏ß‡∏±‡∏ô</span>
                </div>
            </div>

            <div class="flex flex-col items-center">
                 <div id="header-avatar-btn" onclick="openAvatarModal()" class="w-24 h-24 rounded-full bg-white border-4 border-white shadow-xl flex items-center justify-center relative cursor-pointer active:scale-90 transition-transform">
                      <img id="avatar-img" src="" class="w-20 h-20 z-10 relative object-contain filter drop-shadow-md">
                      
                      <div id="avatar-hat-container" class="absolute top-[-25px] left-1/2 -translate-x-1/2 z-20"></div>

                      <div class="absolute bottom-0 right-0 bg-brand-purple rounded-full w-7 h-7 flex items-center justify-center shadow-md border-2 border-white z-30">
                         <i class="fas fa-pen text-xs text-white"></i>
                      </div>
                </div>
                <p id="avatar-name-display" class="text-xs font-round font-bold text-brand-purple mt-3 tracking-wide bg-white/90 backdrop-blur-sm px-4 py-1 rounded-full shadow-md animate-bounce-slow border border-purple-100">‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</p>
            </div>
        </div>

        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-1 flex items-center gap-3 fade-in-up" style="animation-delay: 0.1s;">
            <div id="badge-icon" class="w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-inner transition-all duration-500 border-2 border-gray-100">
                üê£
            </div>
            <div class="flex-1">
                <div class="flex justify-between items-end mb-1">
                    <span id="level-title" class="text-sm font-bold text-gray-700">‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏±‡∏î‡∏Å‡∏¥‡∏ô</span>
                    <span id="level-count" class="text-[10px] text-gray-400">0/10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                </div>
                <div class="xp-bar-bg">
                    <div id="level-fill" class="xp-bar-fill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 mt-2">
            <p class="text-[10px] text-gray-400">‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©! üéÅ</p>
            <button onclick="openMyTickets()" class="bg-white px-3 py-1.5 rounded-full border border-gray-100 shadow-sm flex items-center gap-2 text-xs font-bold text-gray-700 active:scale-95 active:bg-gray-50 transition-all">
                <span>üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                <div id="unread-ticket-dot" class="w-2 h-2 bg-red-500 rounded-full hidden"></div>
            </button>
        </div>

    </div>

    <div class="max-w-md mx-auto px-5 relative z-10">
        
        <div class="mb-3 flex items-center justify-between">
            <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà 
                <button onclick="randomMenu()" class="bg-brand-purple text-white px-3 py-1 rounded-full text-xs font-bold shadow-md hover:bg-indigo-600 active:scale-95 transition-all flex items-center gap-1 ml-2">
                    <i id="dice-icon" class="fas fa-dice"></i> ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
                </button>
            </h3>
            <div class="flex gap-2">
                <button onclick="scrollTabs(-100)" class="nav-btn w-11 h-11 rounded-full flex items-center justify-center text-gray-500 hover:text-brand-purple active:scale-90 active:bg-gray-100 transition-all"><i class="fas fa-chevron-left text-xs"></i></button>
                <button onclick="scrollTabs(100)" class="nav-btn w-11 h-11 rounded-full flex items-center justify-center text-gray-500 hover:text-brand-purple active:scale-90 active:bg-gray-100 transition-all"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>
        </div>
        
        <div id="tabs-container" class="sticky top-0 z-30 bg-[#F5F7FB] pt-2 pb-4 -mx-5 px-5 flex gap-3 snap-x scroll-smooth overflow-x-auto hide-scroll transition-all">
            <button onclick="switchCategory('kaprao')" id="tab-kaprao" class="snap-start category-pill-active min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üå∂Ô∏è</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤</span>
            </button>
            <button onclick="switchCategory('garlic')" id="tab-garlic" class="snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üßÑ</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</span>
            </button>
            <button onclick="switchCategory('noodle')" id="tab-noodle" class="snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üçú</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô</span>
            </button>
            <button onclick="switchCategory('soup')" id="tab-soup" class="snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üç≤</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°</span>
            </button>
            <button onclick="switchCategory('others')" id="tab-others" class="snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üç≥</span>
                <span class="text-xs">‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏Ç‡πà/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
            </button>
            <button onclick="switchCategory('dessert')" id="tab-dessert" class="snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all">
                <span class="text-xl">üç®</span>
                <span class="text-xs">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</span>
            </button>
            <button onclick="switchCategory('promotion')" id="tab-promotion" class="snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all border-dashed border-red-300 text-red-500">
                <span class="text-xl">üßß</span>
                <span class="text-xs font-bold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
            </button>
        </div>

        <div class="mb-4 mt-2">
            <h3 id="section-title" class="font-bold text-gray-800 text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
        </div>

        <div id="dessert-msg" class="hidden mb-6 fade-in-up">
            <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 flex flex-col items-center justify-center text-center">
                <div class="text-3xl mb-2">üç® ‚ú®</div>
                <h4 class="font-bold text-brand-purple text-sm">‡∏£‡∏≠‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà‡πÜ ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</h4>
                <p class="text-xs text-gray-500 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏î‡∏™‡∏£‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô</p>
            </div>
        </div>

        <div id="menu-grid" class="flex flex-col gap-4 min-h-[300px]"></div>

        <div class="text-center mt-12 mb-20 opacity-50">
            <p class="text-[10px] font-bold tracking-widest text-gray-400 uppercase">DEVELOPED BY SORAWIT THUNTHAKIJ V15.3</p>
        </div>

    </div>
    
    <div id="tickets-modal-overlay" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-[110] hidden transition-opacity opacity-0" onclick="closeMyTickets()"></div>
    <div id="tickets-sheet" class="fixed bottom-0 left-0 right-0 bg-[#F5F7FB] rounded-t-[2.5rem] z-[111] transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[70vh] flex flex-col safe-area-pb">
        <div class="w-full flex justify-center pt-4 pb-2">
             <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>
        <div class="px-6 py-2 border-b border-gray-200 flex justify-between items-center bg-white rounded-t-[2.5rem]">
            <h2 class="text-xl font-bold text-gray-800">üé´ ‡∏ï‡∏±‡πã‡∏ß‡∏´‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <button onclick="closeMyTickets()" class="w-11 h-11 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-times text-sm"></i></button>
        </div>
        <div id="tickets-list" class="flex-1 overflow-y-auto p-4 space-y-3 hide-scroll">
            <div class="text-center text-gray-400 mt-10">
                <div class="text-4xl mb-2 opacity-30">üéüÔ∏è</div>
                <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
            </div>
        </div>
    </div>

    <div id="mini-cart-bar" class="fixed bottom-[calc(1.5rem+env(safe-area-inset-bottom))] left-5 right-5 z-40 hidden fade-in-up">
        <div onclick="openCheckout()" class="bg-gray-900 text-white p-4 rounded-full shadow-2xl shadow-gray-400/50 flex justify-between items-center cursor-pointer active:scale-95 active:bg-black transition-all">
            <div class="flex items-center gap-3 pl-2">
                <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center border border-gray-700 text-brand-yellow font-bold" id="mini-count">0</div>
                <div class="flex flex-col">
                    <span class="text-xs text-gray-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                    <span class="font-bold text-lg leading-none" id="mini-total">0 ‡∏ø</span>
                </div>
            </div>
            <div class="flex items-center gap-2 pr-4 text-brand-yellow font-bold text-sm">
                <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>

    <div id="checkout-overlay" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-50 hidden transition-opacity opacity-0" onclick="closeCheckout()"></div>
    <div id="checkout-sheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] z-50 transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[85vh] flex flex-col touch-pan-y safe-area-pb">
        
        <div id="checkout-drag-handle" class="w-full flex justify-center pt-4 pb-2 cursor-grab active:cursor-grabbing z-50 bg-white rounded-t-[2.5rem]">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <div class="px-6 pb-4 border-b border-gray-100 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
            <div class="flex gap-2">
                <button onclick="clearCart()" class="w-11 h-11 rounded-full bg-red-50 flex items-center justify-center text-red-500 active:scale-90 active:bg-red-100 transition-all"><i class="fas fa-trash text-xs"></i></button>
                
                <button onclick="generateOrderCard()" class="h-11 px-4 rounded-full bg-indigo-50 flex items-center gap-2 text-indigo-600 font-bold text-xs active:scale-95 active:bg-indigo-100 transition-all shadow-sm border border-indigo-100">
                    <i class="fas fa-download"></i>
                    <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•</span>
                </button>

                <button onclick="closeCheckout()" class="w-11 h-11 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 active:scale-90 active:bg-gray-200 transition-all"><i class="fas fa-times text-sm"></i></button>
            </div>
        </div>
        
        <div id="cart-list-container" class="flex-1 overflow-y-auto px-6 py-4 space-y-3 hide-scroll"></div>
        
        <div class="p-6 bg-gray-50 rounded-t-[2rem] space-y-3">
            <div class="bg-white rounded-xl p-3 flex items-center border border-gray-200 shadow-sm gap-2">
                <i class="fas fa-user text-gray-400 ml-1"></i>
                <input type="text" id="user-name" maxlength="20" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á" class="bg-transparent w-full text-base outline-none text-gray-700">
            </div>
            
            <div class="bg-white rounded-xl p-2 pl-4 flex items-center border border-gray-200 shadow-sm justify-between transition-colors" id="code-input-container">
                <div class="flex items-center gap-2 w-full">
                    <i class="fas fa-ticket-alt text-gray-400" id="code-icon"></i>
                    <input type="text" id="discount-code" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="bg-transparent w-full text-base outline-none text-gray-700 uppercase transition-colors">
                </div>
                <button onclick="applyDiscount()" id="btn-apply-code" class="bg-gray-800 hover:bg-gray-700 text-white text-xs px-4 py-2 rounded-lg transition-colors font-bold whitespace-nowrap active:bg-gray-900">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
            </div>
            <p id="discount-msg" class="text-xs h-4 pl-2 font-medium"></p>

            <div class="flex justify-between items-end mb-2 px-2">
                <div class="flex flex-col">
                    <span class="text-gray-500 text-sm">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                </div>
                <span id="sheet-grand-total" class="text-2xl font-bold text-brand-purple">0 ‡∏ø</span>
            </div>

            <button onclick="submitOrderToLine()" id="btn-submit-order" class="w-full bg-brand-yellow text-gray-900 font-bold py-4 rounded-xl shadow-xl shadow-yellow-500/30 active:scale-95 active:bg-[#e5c04d] transition-all flex justify-center items-center gap-2">
                <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</span>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 hidden transition-opacity opacity-0" onclick="closeModal()"></div>
    <div id="modal-content" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] z-50 transform translate-y-full transition-transform duration-300 shadow-2xl max-w-md mx-auto h-[85vh] flex flex-col touch-pan-y safe-area-pb">
        
        <div id="modal-drag-handle" class="w-full flex justify-center pt-4 pb-2 cursor-grab active:cursor-grabbing z-50 bg-white rounded-t-[2.5rem]">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <button onclick="closeModal()" class="absolute top-4 right-4 z-50 bg-gray-900 text-white w-11 h-11 rounded-full flex items-center justify-center shadow-lg active:scale-90 active:bg-black transition-all border-2 border-white">
            <i class="fas fa-times text-sm"></i>
        </button>

        <div id="modal-scroll-area" class="flex-1 overflow-y-auto hide-scroll px-6 pb-24 pt-4">
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 bg-brand-bg rounded-full flex items-center justify-center text-6xl shadow-inner border-4 border-white">
                    <span id="modal-icon">üçú</span>
                </div>
            </div>

            <div class="text-center mb-8">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-1 font-round">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h3>
                <div class="flex justify-center items-center gap-2">
                    <span id="modal-kcal" class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-bold transition-all">0 kcal</span>
                    <span class="text-gray-300">|</span>
                    <span id="modal-price" class="text-xl font-bold text-brand-purple">50</span>
                    <span class="text-sm text-gray-400">‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>

            <div class="flex items-center justify-center gap-6 mb-6">
                <button onclick="adjustQty(-1)" class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center font-bold shadow-sm active:scale-90 active:bg-gray-200 transition-all text-lg">-</button>
                <span id="modal-qty" class="text-2xl font-bold text-gray-800 w-8 text-center">1</span>
                <button onclick="adjustQty(1)" class="w-12 h-12 rounded-full bg-brand-yellow text-gray-800 flex items-center justify-center font-bold shadow-md active:scale-90 active:bg-[#e5c04d] transition-all text-lg">+</button>
            </div>

            <div id="modal-meat-section" class="mb-6 hidden">
                <h4 class="font-bold text-gray-800 mb-3 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scroll p-1" id="meat-options-container">
                    <label class="cursor-pointer flex-shrink-0"><input type="radio" name="modal-meat" value="‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠" class="peer sr-only"><div class="px-4 py-2 rounded-xl border-2 border-gray-100 bg-white text-sm text-gray-500 peer-checked:border-brand-yellow peer-checked:bg-yellow-50 peer-checked:text-gray-800 transition-all">‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠</div></label>
                    <label class="cursor-pointer flex-shrink-0"><input type="radio" name="modal-meat" value="‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö" class="peer sr-only"><div class="px-4 py-2 rounded-xl border-2 border-gray-100 bg-white text-sm text-gray-500 peer-checked:border-brand-yellow peer-checked:bg-yellow-50 peer-checked:text-gray-800 transition-all">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö</div></label>
                    <label class="cursor-pointer flex-shrink-0"><input type="radio" name="modal-meat" value="‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á" class="peer sr-only"><div class="px-4 py-2 rounded-xl border-2 border-gray-100 bg-white text-sm text-gray-500 peer-checked:border-brand-yellow peer-checked:bg-yellow-50 peer-checked:text-gray-800 transition-all">‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á</div></label>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold text-gray-800 mb-3 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢</h4>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 rounded-2xl bg-gray-50 border border-transparent hover:border-yellow-200 cursor-pointer transition-all has-[:checked]:bg-yellow-50 has-[:checked]:border-brand-yellow">
                        <div class="flex items-center gap-3"><span class="text-sm font-medium text-gray-700">üíé ‡∏û‡∏¥‡πÄ‡∏®‡∏©</span></div>
                        <div class="flex items-center gap-3"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-special" class="accent-brand-yellow w-5 h-5 rounded" value="10"></div>
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-gray-50 border border-transparent has-[:checked]:bg-yellow-50 has-[:checked]:border-brand-yellow cursor-pointer"><span class="text-sm text-gray-700">üç≥ ‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaikhon" class="accent-brand-yellow w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-gray-50 border border-transparent has-[:checked]:bg-yellow-50 has-[:checked]:border-brand-yellow cursor-pointer"><span class="text-sm text-gray-700">ü•ö ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaidao" class="accent-brand-yellow w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-gray-50 border border-transparent has-[:checked]:bg-yellow-50 has-[:checked]:border-brand-yellow cursor-pointer"><span class="text-sm text-gray-700">ü•û ‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaijiao" class="accent-brand-yellow w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-gray-50 border border-transparent has-[:checked]:bg-yellow-50 has-[:checked]:border-brand-yellow cursor-pointer"><span class="text-sm text-gray-700">‚ö´ ‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaiyiewma" class="accent-brand-yellow w-4 h-4" value="10"></div></label>
                        <label class="flex items-center justify-between p-3 rounded-2xl bg-gray-50 border border-transparent has-[:checked]:bg-yellow-50 has-[:checked]:border-brand-yellow cursor-pointer"><span class="text-sm text-gray-700">ü•ö ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-400">+10.-</span><input type="checkbox" id="modal-opt-kaitom" class="accent-brand-yellow w-4 h-4" value="10"></div></label>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-bold text-gray-800 mb-2 text-sm">Note</h4>
                <textarea id="modal-note" rows="2" maxlength="100" class="w-full bg-gray-50 border-none rounded-2xl p-4 text-base focus:ring-2 focus:ring-brand-purple resize-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î, ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢..."></textarea>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-100 rounded-t-[2rem] safe-area-pb-plus">
            <button onclick="addToCart()" class="w-full bg-brand-purple text-white font-bold text-lg py-4 rounded-full shadow-xl shadow-indigo-300/50 active:scale-95 active:bg-indigo-600 transition-all flex justify-center items-center gap-2">
                <span>‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                <i class="fas fa-plus bg-white/20 rounded-full w-6 h-6 flex items-center justify-center text-xs"></i>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-10 z-[120] pointer-events-none">
        <i class="fas fa-info-circle text-brand-yellow"></i>
        <span class="font-medium text-sm" id="toast-msg">Notification</span>
    </div>

    <div id="receipt-capture">
        <div class="bg-white p-6 relative">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-brand-yellow rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm relative overflow-hidden">
                    <img id="receipt-avatar-img" src="" class="w-full h-full object-contain z-10 relative">
                    <div id="receipt-hat" class="absolute top-0 left-1/2 -translate-x-1/2 w-8 h-8 bg-contain bg-no-repeat pointer-events-none hidden z-20" style="background-image: url('https://cdn-icons-png.flaticon.com/512/1830/1830839.png');"></div>
                </div>
                <h2 class="text-2xl font-black text-gray-800 tracking-wider">KAPRAO52</h2>
                <p class="text-[10px] text-gray-400 tracking-widest uppercase mt-1">Authentic Thai Street Food</p>
                <div class="mt-4 inline-block px-4 py-1 bg-gray-100 rounded-full border border-gray-200">
                    <p class="text-xs font-bold text-gray-600">RECEIPT / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</p>
                </div>
            </div>

            <div class="border-t-2 border-dashed border-gray-200 my-4"></div>

            <div class="flex justify-between items-center mb-1">
                <span class="text-xs text-gray-400">Order ID</span>
                <span class="font-bold text-gray-800 tracking-wide receipt-id">KP-XX99</span>
            </div>
            <div class="flex justify-between items-center mb-1">
                <span class="text-xs text-gray-400">Date</span>
                <span class="font-medium text-xs text-gray-600 receipt-date">01/01/2024 12:00</span>
            </div>
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs text-gray-400">Customer</span>
                <span class="font-bold text-sm text-gray-800 receipt-name">Customer</span>
            </div>

            <div class="bg-gray-50 rounded-lg p-3 mb-4 space-y-2 receipt-items">
            </div>

            <div class="space-y-1">
                <div class="flex justify-between text-xs text-gray-500">
                    <span>Subtotal</span>
                    <span class="receipt-subtotal">0.-</span>
                </div>
                <div class="flex justify-between text-xs text-green-600">
                    <span>Discount</span>
                    <span class="receipt-discount">-0.-</span>
                </div>
                <div class="flex justify-between items-end mt-2 pt-2 border-t border-gray-200">
                    <span class="font-bold text-gray-800">TOTAL</span>
                    <span class="font-black text-3xl text-brand-purple receipt-total">0.-</span>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t-2 border-dotted border-gray-200 text-center">
                <div class="flex justify-center gap-1 text-2xl text-gray-300 mb-2">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <p class="text-[10px] text-gray-400">THANK YOU FOR YOUR ORDER</p>
                <div class="mt-4 flex justify-center opacity-50">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" class="w-16 h-16 mix-blend-multiply">
                </div>
            </div>
            
            <div class="absolute bottom-0 left-0 right-0 h-4 bg-white" style="background: linear-gradient(45deg, transparent 33.333%, #ffffff 33.333%, #ffffff 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #ffffff 33.333%, #ffffff 66.667%, transparent 66.667%); background-size: 20px 40px; transform: translateY(10px);"></div>
        </div>
    </div>

    <script>
        // --- GOOGLE SHEET CONFIG ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0RU3dBQQkuGOVicVGnVIgGKOWidVvFZ3iRk0RUpeQbZGZ88VNfxlT2dnMRbeyhy8/exec'; 
        // ---------------------------

        // --- BACK BUTTON HANDLER (UX FIX) ---
        let currentOpenModal = null;

        function pushModalState(modalId) {
            currentOpenModal = modalId;
            window.history.pushState({ modal: modalId }, null, "");
        }

        window.addEventListener('popstate', function(event) {
            if (currentOpenModal) {
                if (currentOpenModal === 'menu') closeModal(true);
                else if (currentOpenModal === 'checkout') closeCheckout(true);
                else if (currentOpenModal === 'tickets') closeMyTickets(true);
                else if (currentOpenModal === 'avatar') closeAvatarModal(true);
                
                currentOpenModal = null;
            }
        });

        // --- SOUNDS ---
        const sfxPop = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3');
        const sfxOrder = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
        const sfxTrash = new Audio('https://www.soundjay.com/misc/sounds/crumple-paper-1.mp3'); 
        const sfxWin = new Audio('https://www.soundjay.com/misc/sounds/magic-chime-01.mp3');
        sfxPop.volume = 0.5;
        sfxOrder.volume = 0.6;
        sfxTrash.volume = 0.8;

        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(10); 
        }

        // --- GLOBAL LOADER ---
        function showGlobalLoader(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
            const loader = document.getElementById('global-loader');
            const txt = document.getElementById('loader-text');
            txt.innerText = text;
            loader.classList.remove('loader-hidden');
        }

        function hideGlobalLoader() {
            const loader = document.getElementById('global-loader');
            loader.classList.add('loader-hidden');
        }

        // --- NOTIFICATION ---
        function requestNotifPermission() {
            if (!("Notification" in window)) {
                showToast("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô");
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showToast("‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üîî");
                    triggerHaptic();
                }
            });
        }

        setTimeout(() => {
            hideGlobalLoader();
        }, 4000);

        // --- AVATAR LOGIC (UPDATED for V15.0 - THE REAL FIX) ---
        // Using High-Quality 3D Microsoft Fluent Emojis via Reliable CDN
        const avatarOptions = [
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Dog%20face/3D/dog_face_3d.png', // Dog
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Cat%20face/3D/cat_face_3d.png', // Cat
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Tiger%20face/3D/tiger_face_3d.png', // Tiger
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Lion/3D/lion_3d.png', // Lion
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Monkey%20face/3D/monkey_face_3d.png', // Monkey
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Elephant/3D/elephant_3d.png', // Elephant
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Pig%20face/3D/pig_face_3d.png', // Pig
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Chicken/3D/chicken_3d.png', // Chicken
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Panda/3D/panda_3d.png', // Panda
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Frog/3D/frog_3d.png', // Frog
            'https://cdn.jsdelivr.net/gh/microsoft/fluentui-emoji@main/assets/Giraffe/3D/giraffe_3d.png'  // Giraffe
        ];
        
        // Default state includes name now
        let userAvatar = { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î' };

        function openAvatarModal() {
            pushModalState('avatar'); // Added History

            const grid = document.getElementById('avatar-grid');
            grid.innerHTML = '';
            avatarOptions.forEach(imgSrc => {
                const el = document.createElement('div');
                el.className = `avatar-option ${userAvatar.image === imgSrc ? 'avatar-selected' : ''}`;
                el.innerHTML = `<img src="${imgSrc}" alt="avatar">`;
                el.onclick = () => selectAvatar(imgSrc);
                grid.appendChild(el);
            });
            document.getElementById('hat-toggle').checked = userAvatar.hat;
            // Load current name into input
            document.getElementById('pet-name-input').value = userAvatar.name || '';
            
            const modal = document.getElementById('avatar-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeAvatarModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'avatar') { history.back(); return; }

            const modal = document.getElementById('avatar-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            
            // Save Name
            const nameInput = document.getElementById('pet-name-input').value.trim();
            if(nameInput) {
                userAvatar.name = escapeHtml(nameInput);
            }

            saveToLS();
            updateAvatarDisplay();
            initPetSystem(); // Update Pet playground
            currentOpenModal = null;
        }

        function selectAvatar(imgSrc) {
            userAvatar.image = imgSrc;
            // Redraw grid to show selection
            const options = document.querySelectorAll('.avatar-option');
            options.forEach(opt => {
                const img = opt.querySelector('img');
                if (img && img.src === imgSrc) opt.classList.add('avatar-selected');
                else opt.classList.remove('avatar-selected');
            });
            triggerHaptic();
        }

        function toggleHat() {
            userAvatar.hat = document.getElementById('hat-toggle').checked;
        }

        function updateAvatarDisplay() {
            // Update Header Avatar Image
            document.getElementById('avatar-img').src = userAvatar.image;
            
            // Update Header Pet Name (with nice font)
            const nameDisplay = document.getElementById('avatar-name-display');
            nameDisplay.innerText = userAvatar.name || '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î';

            const hatContainer = document.getElementById('avatar-hat-container');
            hatContainer.innerHTML = ''; // Clear old hat first

            if (userAvatar.hat) {
                const hat = document.createElement('div');
                hat.className = 'chef-hat-overlay';
                hatContainer.appendChild(hat);
            }
        }

        function loadAvatar() {
            const saved = JSON.parse(localStorage.getItem('kaprao52_user'));
            if (saved && saved.avatar) {
                userAvatar = saved.avatar;
            }
            updateAvatarDisplay();
        }

        // --- WELCOME POPUP ---
        function closeWelcome() {
            const modal = document.getElementById('welcome-modal');
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.5s ease';
            setTimeout(() => modal.classList.add('hidden'), 500);
            triggerHaptic();
        }

        // --- PARALLAX & BUBBLES ---
        window.addEventListener('scroll', () => {
            const scrolled = window.scrollY;
            const bg = document.getElementById('parallax-bg');
            if(bg) bg.style.transform = `translateY(${scrolled * 0.3}px)`;
        });

        function createBubbles() {
            const container = document.getElementById('bubbles-container');
            const bubbleCount = 10;
            for(let i=0; i<bubbleCount; i++){
                const b = document.createElement('div');
                b.className = 'bubble';
                const size = Math.random() * 40 + 20;
                b.style.width = size + 'px';
                b.style.height = size + 'px';
                b.style.left = Math.random() * 100 + '%';
                b.style.animationDelay = Math.random() * 15 + 's';
                b.style.animationDuration = Math.random() * 10 + 10 + 's';
                container.appendChild(b);
            }
        }
        createBubbles();

        // DATA
        const menuItems = [
            { id: 2, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ", price: 55, icon: "üéç", category: "kaprao", reqMeat: true, kcal: 350 },
            { id: 3, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö", price: 50, icon: "üê∑", category: "kaprao", reqMeat: false, kcal: 520 },
            { id: 4, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á", price: 50, icon: "ü•ì", category: "kaprao", reqMeat: false, kcal: 550 },
            { id: 5, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠", price: 50, icon: "ü•©", category: "kaprao", reqMeat: false, kcal: 600 },
            { id: 6, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤", price: 60, icon: "‚ö´", category: "kaprao", reqMeat: false, kcal: 650 },
            { id: 102, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "ü¶ê", category: "kaprao", reqMeat: false, kcal: 450, isNew: true },
            { id: 105, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà", price: 50, icon: "üêî", category: "kaprao", reqMeat: false, kcal: 450, isNew: true }, // NEW
            
            { id: 10, name: "‡∏°‡∏≤‡∏°‡πà‡∏≤‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤", price: 50, icon: "üçú", category: "noodle", reqMeat: true, kcal: 450 },
            { id: 1, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô", price: 55, icon: "üçù", category: "noodle", reqMeat: true, kcal: 400 },
            
            { id: 7, name: "‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üßÑ", category: "garlic", reqMeat: false, kcal: 500 },
            { id: 8, name: "‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçñ", category: "garlic", reqMeat: false, kcal: 580 },
            { id: 9, name: "‡∏´‡∏°‡∏π‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 50, icon: "üçò", category: "garlic", reqMeat: false, kcal: 530 },
            { id: 103, name: "‡∏Å‡∏∏‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: 60, icon: "üç§", category: "garlic", reqMeat: false, kcal: 480, isNew: true },

            { id: 101, name: "‡∏ï‡πâ‡∏°‡∏à‡∏∑‡∏î‡πÑ‡∏Ç‡πà‡∏ô‡πâ‡∏≥ (‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß)", price: 40, icon: "ü•ò", category: "soup", reqMeat: false, kcal: 350, isNew: true },

            { id: 11, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏ú‡∏≤", price: 40, icon: "üå∂Ô∏è", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 450 },
            { id: 12, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô", price: 40, icon: "üçö", category: "others", reqMeat: false, desc: "‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á", kcal: 380 },
            { id: 13, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡∏¥‡∏Å‡∏™‡∏î", price: 50, icon: "ü•ò", category: "others", reqMeat: false, kcal: 420 },
            { id: 14, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß 3 ‡∏ü‡∏≠‡∏á", price: 50, icon: "üç≥", category: "others", reqMeat: false, kcal: 480 },
            { id: 15, name: "‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üéã", category: "others", reqMeat: true, kcal: 300 },
            { id: 104, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô‡∏Å‡∏∏‡πâ‡∏á", price: 60, icon: "üç≥", category: "others", reqMeat: false, kcal: 550, isNew: true },
            { id: 106, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡πÑ‡∏Ç‡πà", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 520, isNew: true }, // NEW
            { id: 107, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏´‡∏°‡∏π‡∏ä‡∏¥‡πâ‡∏ô (‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠)", price: 50, icon: "üçõ", category: "others", reqMeat: false, kcal: 600, isNew: true }, // NEW

            { id: 20, name: "‡πÄ‡∏â‡∏≤‡∏Å‡πä‡∏ß‡∏¢‡∏ô‡∏°‡∏™‡∏î", price: 30, icon: "üßä", category: "dessert", reqMeat: false, kcal: 150 },
            { id: 21, name: "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", price: 25, icon: "üçå", category: "dessert", reqMeat: false, kcal: 220 },
        ];

        const promotions = [
            { code: "MANU", title: "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ü‡∏ô‡πÅ‡∏°‡∏ô‡∏¢‡∏π üî¥", desc: "‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö 100.- ‡∏•‡∏î 5 ‡∏ö‡∏≤‡∏ó", minOrder: 100, type: "discount", value: 5, color: "bg-red-600", icon: "‚öΩ" }
        ];

        // --- STATE MANAGEMENT ---
        let cart = [];
        let currentItem = null;
        let activeCategory = 'kaprao';
        let discountValue = 0;
        let modalQty = 1;
        let userStats = { orders: 0 }; 
        let lottoHistory = []; 
        
        const addonIds = ['special', 'kaikhon', 'kaidao', 'kaijiao', 'kaitom', 'kaiyiewma'];
        const addonCalories = { 'special': 80, 'kaikhon': 150, 'kaidao': 120, 'kaijiao': 200, 'kaitom': 75, 'kaiyiewma': 100 };

        // ----------------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        // ----------------------------------------------------
        
        const KEYS = {
            USER: 'kaprao52_user',
            HISTORY: 'kaprao_lotto_history',
            STATS: 'kaprao_stats',
            VERSION: 'kaprao_ver'
        };

        const CURRENT_VERSION = '15.3';

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏Å‡πÜ)
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function loadUserDataSafe() {
            try {
                const savedUser = localStorage.getItem(KEYS.USER);
                if (savedUser) {
                    const u = JSON.parse(savedUser);
                    cart = u.cart || [];
                    // Migrate avatar data structure if needed, or use default
                    userAvatar = u.avatar || { image: avatarOptions[0], hat: false, name: '‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î' };
                    if(u.name) document.getElementById('user-name').value = u.name;
                }

                const savedHistory = localStorage.getItem(KEYS.HISTORY);
                if (savedHistory) {
                    lottoHistory = JSON.parse(savedHistory) || [];
                }

                const savedStats = localStorage.getItem(KEYS.STATS);
                if (savedStats) {
                    userStats = JSON.parse(savedStats) || { orders: 0 };
                }

            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error);
                showToast("‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô...");
            }
        }

        function saveToLS() {
            // Sanitize Name ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ã‡∏ü
            let safeName = escapeHtml(document.getElementById('user-name').value);
            const userState = { 
                cart: cart, 
                name: safeName,
                avatar: userAvatar 
            };
            localStorage.setItem(KEYS.USER, JSON.stringify(userState));
        }
        
        // --- SYSTEM: AUTO UPDATE CHECKER ---
        async function checkForUpdate() {
            try {
                // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÑ‡∏ü‡∏•‡πå index.html (‡πÉ‡∏™‡πà timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î Cache)
                const response = await fetch(window.location.href + '?t=' + new Date().getTime());
                const text = await response.text();
                
                // ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ CURRENT_VERSION ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô Server
                const serverVerMatch = text.match(/const CURRENT_VERSION = '([\d.]+)';/);
                
                if (serverVerMatch && serverVerMatch[1]) {
                    const serverVer = serverVerMatch[1];
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (Server ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤)
                    if (serverVer !== CURRENT_VERSION) {
                        console.log(`New version found: ${serverVer} (Current: ${CURRENT_VERSION})`);
                        
                        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Cache ‡∏Ç‡∏≠‡∏á Browser ‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
                        if ('caches' in window) {
                            try {
                                const names = await caches.keys();
                                await Promise.all(names.map(name => caches.delete(name)));
                            } catch(e) {}
                        }
                        
                        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Server
                        window.location.reload(true);
                    }
                }
            } catch (err) {
                console.log("Check update failed (Offline?)", err);
            }
        }

        window.addEventListener('load', () => {
            const savedVer = localStorage.getItem(KEYS.VERSION);
            if(savedVer !== CURRENT_VERSION) {
                localStorage.setItem(KEYS.VERSION, CURRENT_VERSION);
            }

            loadUserDataSafe();

            setTimeout(autoCheckLottery, 1000);
            updateTicketBadge();
            updateStreak(); 
            updateAvatarDisplay();
            updateLevelUI();
            updateMiniCart();
            renderCheckoutList();
            initPetSystem(); // START PET
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πá‡∏Å)
            setTimeout(checkForUpdate, 2000);
            
            // ‡πÄ‡∏ä‡πá‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏≠‡∏û‡πÑ‡∏õ‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤)
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    checkForUpdate();
                }
            });
        });

        // --- ACHIEVEMENT UI ENHANCED (NEW ICONS) ---
        function updateLevelUI() {
            const count = userStats.orders;
            const bar = document.getElementById('level-fill');
            const txt = document.getElementById('level-count');
            const title = document.getElementById('level-title');
            const icon = document.getElementById('badge-icon');
            
            let percent = (count % 10) * 10;
            if(count > 0 && count % 10 === 0) percent = 100;
            
            bar.style.width = `${percent}%`;
            txt.innerText = `${count}/10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
            
            // Clear old classes
            icon.className = "w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-inner transition-all duration-500 border-2";

            if(count >= 10) {
                icon.innerText = 'üëë';
                icon.classList.add('badge-god');
                title.innerText = "‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤";
                title.style.color = '#d97706';
            } else if(count >= 5) {
                icon.innerText = 'üòé';
                icon.classList.add('badge-regular');
                title.innerText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥";
                title.style.color = '#1e40af';
            } else {
                icon.innerText = 'üê£';
                icon.classList.add('badge-newbie');
                title.innerText = "‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏±‡∏î‡∏Å‡∏¥‡∏ô";
                title.style.color = '#d97706';
            }
        }

        // --- PET SYSTEM LOGIC (UPDATED for V15.0) ---
        function initPetSystem() {
            const petBodyImg = document.getElementById('pet-body-img');
            const petHat = document.getElementById('pet-hat');
            
            // Set Image URL instead of emoji
            petBodyImg.src = userAvatar.image;

            // Set Hat
            if(userAvatar.hat) petHat.classList.remove('hidden');
            else petHat.classList.add('hidden');

            // Set Growth Scale
            const scale = Math.min(1.5, 1 + (userStats.orders * 0.05));
            document.getElementById('pet-body').style.transform = `scale(${scale})`;

            // Start Wandering
            petWander();
        }

        function petWander() {
            const container = document.getElementById('active-pet-container');
            const petBody = document.getElementById('pet-body');
            
            // Random Behavior Loop
            setInterval(() => {
                const action = Math.random();
                const screenWidth = window.innerWidth;
                
                if (action < 0.4) {
                    // IDLE: Bounce
                    petBody.className = "w-full h-full relative select-none pet-bounce";
                } else if (action < 0.7) {
                    // WALK RIGHT
                    const currentLeft = container.offsetLeft;
                    if (currentLeft < screenWidth - 80) {
                        petBody.className = "w-full h-full relative select-none pet-walk-right";
                        container.style.left = (currentLeft + 60) + 'px';
                    } else {
                        // Turn back
                        petBody.className = "w-full h-full relative select-none pet-walk-left";
                        container.style.left = (currentLeft - 60) + 'px';
                    }
                } else {
                    // WALK LEFT
                    const currentLeft = container.offsetLeft;
                    if (currentLeft > 20) {
                        petBody.className = "w-full h-full relative select-none pet-walk-left";
                        container.style.left = (currentLeft - 60) + 'px';
                    } else {
                        // Turn back
                        petBody.className = "w-full h-full relative select-none pet-walk-right";
                        container.style.left = (currentLeft + 60) + 'px';
                    }
                }
            }, 3000); // Change action every 3 seconds
        }

        function petInteract() {
            triggerHaptic();
            const petBody = document.getElementById('pet-body');
            petBody.classList.remove('pet-bounce', 'pet-walk-left', 'pet-walk-right');
            void petBody.offsetWidth; // Reset animation
            petBody.classList.add('pet-bounce'); // Jump!
            
            // Create Heart
            const container = document.getElementById('active-pet-container');
            const heart = document.createElement('div');
            heart.innerText = "‚ù§Ô∏è";
            heart.className = "pet-heart";
            container.appendChild(heart);
            setTimeout(() => heart.remove(), 1000);
        }

        function feedPet() {
            const petBody = document.getElementById('pet-body');
            // Flash effect
            petBody.style.transition = 'transform 0.2s';
            const currentScale = Math.min(1.5, 1 + ((userStats.orders + 1) * 0.05)); // +1 for visual feedback
            petBody.style.transform = `scale(${currentScale + 0.2})`; // Puff up
            setTimeout(() => {
                petBody.style.transform = `scale(${currentScale})`; // Settle at new size
                // Show many hearts
                for(let i=0; i<3; i++) {
                    setTimeout(petInteract, i * 200);
                }
            }, 200);
        }

        // --- WHEEL ---
        let wheelSpinning = false;
        const wheelSegments = [
            { text: "‡∏•‡∏î 5 ‡∏ö‡∏≤‡∏ó", color: "#FFFFFF", type: "discount_5" },
            { text: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•", color: "#F3F4F6", type: "none" },
            { text: "‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ 40‡∏ö.", color: "#FFD755", type: "free_40" },
            { text: "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", color: "#FFFFFF", type: "none" }, 
            { text: "‡∏ü‡∏£‡∏µ‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß", color: "#F3F4F6", type: "free_egg" },
            { text: "‡∏•‡∏î 10 ‡∏ö‡∏≤‡∏ó", color: "#FFD755", type: "discount_10" }
        ];
        function drawWheel() {
            const canvas = document.getElementById('wheel-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            const center = size / 2;
            const sliceAngle = (2 * Math.PI) / wheelSegments.length;

            wheelSegments.forEach((seg, i) => {
                const startAngle = i * sliceAngle - (Math.PI / 2); 
                const endAngle = startAngle + sliceAngle;
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, center, startAngle, endAngle);
                ctx.fillStyle = seg.color;
                ctx.fill();
                ctx.strokeStyle = "#E5E7EB";
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#2D3436";
                ctx.font = "bold 14px Kanit";
                ctx.fillText(seg.text, center - 20, 5);
                ctx.restore();
            });
        }
        function spinWheel() {
            if (wheelSpinning) return;
            const today = new Date().toLocaleDateString('th-TH');
            const lastDate = localStorage.getItem('kaprao_spin_date');
            let count = parseInt(localStorage.getItem('kaprao_spin_count') || '0');

            if (lastDate !== today) {
                count = 0;
                localStorage.setItem('kaprao_spin_date', today);
            }

            if (count >= 3) {
                showToast("‚õî ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!");
                return; 
            }

            localStorage.setItem('kaprao_spin_count', count + 1);

            wheelSpinning = true;
            triggerHaptic();
            sfxPop.play();
            const box = document.getElementById('wheel-canvas');
            const fullSpins = 360 * 8; 
            const targetDegree = 150;  
            const randomVariance = Math.floor(Math.random() * 40) - 20; 
            const nextRotation = fullSpins + targetDegree + randomVariance;
            box.style.transform = `rotate(${nextRotation}deg)`;
            setTimeout(() => {
                wheelSpinning = false;
                box.style.transform = `rotate(${targetDegree}deg)`; 
                box.style.transition = 'none';
                handleReward(wheelSegments[3]); 
                setTimeout(() => box.style.transition = 'transform 8s cubic-bezier(0.1, 0.99, 0.1, 0.99)', 50);
            }, 8000); 
        }
        function handleReward(reward) {
            if(reward.type === 'none') showToast("‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡∏µ‡∏¢‡∏ß! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞");
            else showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${reward.text}`);
        }

        // --- CORE FUNCTIONS ---
        function scrollTabs(amount) {
            document.getElementById('tabs-container').scrollBy({ left: amount, behavior: 'smooth' });
        }

        function switchCategory(cat) {
            if(activeCategory === cat) return;
            triggerHaptic();
            const grid = document.getElementById('menu-grid');
            const msg = document.getElementById('dessert-msg');
            grid.classList.add('page-out');
            if(!msg.classList.contains('hidden')) msg.classList.add('page-out');
            
            setTimeout(() => {
                activeCategory = cat;
                ['kaprao', 'garlic', 'noodle', 'soup', 'others', 'dessert', 'promotion'].forEach(c => {
                    const btn = document.getElementById(`tab-${c}`);
                    if (c === cat) {
                        btn.className = "snap-start category-pill-active min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all transform scale-105";
                    } else {
                        btn.className = "snap-start category-pill-inactive min-w-[100px] py-3 rounded-full flex flex-col items-center justify-center gap-1 transition-all";
                        if(c === 'promotion') btn.classList.add('border-dashed', 'border-red-300', 'text-red-400');
                    }
                });
                
                const title = document.getElementById('section-title');
                
                msg.classList.add('hidden');
                msg.classList.remove('page-out');

                if (cat === 'promotion') {
                    title.innerText = "‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á & ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô";
                    renderPromotions();
                } else if (cat === 'dessert') {
                    title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô";
                    msg.classList.remove('hidden'); 
                    renderMenu();
                } else if (cat === 'soup') {
                    title.innerText = "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡∏á/‡∏ï‡πâ‡∏°";
                    renderMenu();
                } else {
                    title.innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥";
                    renderMenu();
                }

                grid.classList.remove('page-out');
                grid.classList.add('page-in');
                setTimeout(() => grid.classList.remove('page-in'), 300);
            }, 200);
        }

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filteredItems = menuItems.filter(i => i.category === activeCategory);
            
            if(filteredItems.length === 0) {
                 grid.innerHTML = `<div class="text-center text-gray-400 mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏£‡∏±‡∏ö...</div>`;
                 return;
            }

            filteredItems.forEach((item, index) => {
                const isDessert = item.category === 'dessert';
                const el = document.createElement('div');
                el.style.animationDelay = `${index * 0.05}s`;
                
                el.className = `menu-card-style p-4 flex items-center justify-between shadow-sm border border-gray-100 fade-in-up group ${isDessert ? '' : 'cursor-pointer'}`;
                
                el.onclick = () => {
                    if(isDessert) {
                        showToast('‚è≥ ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö');
                        triggerHaptic();
                    } else {
                        openModal(item);
                    }
                };

                const actionButton = isDessert 
                    ? `<span class="text-[10px] font-bold text-white bg-gray-400 px-2 py-1 rounded-full">‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</span>` 
                    : `<div class="w-8 h-8 rounded-full bg-brand-yellow text-gray-800 flex items-center justify-center shadow-md"><i class="fas fa-plus text-xs"></i></div>`;
                
                const priceDisplay = isDessert
                    ? `<span class="font-bold text-gray-300 text-lg line-through decoration-transparent">${item.price}</span>`
                    : `<span class="font-bold text-gray-700 text-lg">${item.price}</span>`;
                
                const contentStyle = isDessert ? 'opacity-60 grayscale-[50%]' : '';

                // NEW BADGE LOGIC
                const newBadge = item.isNew 
                    ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full border-2 border-white shadow-sm z-10 animate-pulse">NEW!</span>` 
                    : '';

                // GRADIENT BORDERS
                el.innerHTML = `
                    <div class="flex items-center gap-4 ${contentStyle}">
                        <div class="relative p-[2px] rounded-2xl bg-gradient-to-br from-brand-yellow to-brand-purple shadow-sm">
                            ${newBadge}
                            <div class="w-16 h-16 rounded-2xl bg-white flex items-center justify-center text-3xl">
                                ${item.icon}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-base group-hover:text-brand-purple transition-colors">${item.name}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md">${item.kcal} kcal</span>
                                ${item.reqMeat ? '<span class="text-[10px] text-orange-400 border border-orange-200 px-1.5 rounded">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${priceDisplay}
                        ${actionButton}
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        function renderPromotions() {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            promotions.forEach(promo => {
                const el = document.createElement('div');
                el.className = "menu-card-style p-0 flex overflow-hidden cursor-pointer shadow-sm border border-gray-100 fade-in-up mb-2";
                el.onclick = () => {
                    navigator.clipboard.writeText(promo.code);
                    showToast(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î ${promo.code} ‡πÅ‡∏•‡πâ‡∏ß!`);
                    document.getElementById('discount-code').value = promo.code;
                };
                el.innerHTML = `
                    <div class="w-24 ${promo.color} flex flex-col items-center justify-center text-white p-2">
                        <span class="text-2xl">${promo.icon}</span>
                        <span class="text-[10px] opacity-80 mt-1">TAP</span>
                    </div>
                    <div class="flex-1 p-4 flex flex-col justify-center relative bg-white">
                        <div class="absolute left-0 top-0 bottom-0 border-l-2 border-dashed border-gray-100"></div>
                        <h3 class="font-bold text-gray-800">${promo.title}</h3>
                        <p class="text-xs text-gray-400 mt-0.5">${promo.desc}</p>
                        <div class="mt-2 bg-gray-100 inline-block px-2 py-1 rounded text-xs font-bold text-gray-600 tracking-wider w-max border border-gray-200">${promo.code}</div>
                    </div>
                `;
                grid.appendChild(el);
            });

            const wheelDiv = document.createElement('div');
            wheelDiv.className = "w-full bg-white rounded-[1.5rem] p-6 mt-4 mb-6 shadow-sm border border-gray-100 flex flex-col items-center fade-in-up";
            wheelDiv.innerHTML = `
                <h3 class="font-bold text-gray-800 text-lg mb-1">‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ! üé°</h3>
                <p class="text-xs text-gray-400 mb-4">‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤ 40 ‡∏ö‡∏≤‡∏ó ‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô)</p>
                <div id="wheel-container">
                    <div class="wheel-pointer"></div>
                    <canvas id="wheel-canvas" width="300" height="300"></canvas>
                    <div class="wheel-center text-2xl">üòã</div>
                </div>
                <button onclick="spinWheel()" class="bg-brand-purple text-white px-8 py-3 rounded-full font-bold shadow-xl shadow-indigo-300/50 active:scale-95 active:bg-indigo-600 transition-all hover:bg-indigo-500">‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡∏¢!</button>
            `;
            grid.appendChild(wheelDiv);
            setTimeout(drawWheel, 100);
        }

        function openModal(item) {
            pushModalState('menu'); // Added History
            
            triggerHaptic();
            currentItem = item;
            modalQty = 1; 
            document.getElementById('modal-qty').innerText = modalQty;
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-icon').innerText = item.icon;
            document.getElementById('modal-note').value = '';
            document.querySelectorAll('input[name="modal-meat"]').forEach(el => el.checked = false);
            addonIds.forEach(id => document.getElementById(`modal-opt-${id}`).checked = false);
            const meatSec = document.getElementById('modal-meat-section');
            
            // Remove previous shake
            document.getElementById('meat-options-container').classList.remove('animate-shake', 'border', 'border-red-500', 'rounded-xl');

            if(item.reqMeat) meatSec.classList.remove('hidden'); else meatSec.classList.add('hidden');
            updateModalPrice();
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.style.transform = ''; 
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            }, 10);
        }

        function closeModal(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'menu') { 
                history.back(); // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° X ‡∏ö‡∏ô‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á Back ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå History
                return; 
            }

            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                currentItem = null;
                content.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function adjustQty(n) {
            modalQty += n;
            if(modalQty < 1) modalQty = 1;
            document.getElementById('modal-qty').innerText = modalQty;
            triggerHaptic();
            updateModalPrice();
        }

        function updateModalPrice() {
            if (!currentItem) return;
            let total = currentItem.price;
            let totalKcal = currentItem.kcal || 0;
            addonIds.forEach(id => {
                if(document.getElementById(`modal-opt-${id}`).checked) {
                    total += 10;
                    totalKcal += (addonCalories[id] || 0); 
                }
            });
            total = total * modalQty;
            totalKcal = totalKcal * modalQty;
            const priceEl = document.getElementById('modal-price');
            priceEl.innerText = total;
            priceEl.classList.remove('price-pop');
            void priceEl.offsetWidth;
            priceEl.classList.add('price-pop');
            document.getElementById('modal-kcal').innerText = totalKcal + ' kcal';
        }

        addonIds.forEach(id => document.getElementById(`modal-opt-${id}`).addEventListener('change', updateModalPrice));

        function addToCart() {
            if (!currentItem) return;
            let meat = null;
            if (currentItem.reqMeat) {
                const r = document.querySelector('input[name="modal-meat"]:checked');
                
                // SHAKE ANIMATION
                if(!r) {
                    const meatContainer = document.getElementById('meat-options-container');
                    meatContainer.classList.remove('animate-shake');
                    void meatContainer.offsetWidth; // Trigger reflow
                    meatContainer.classList.add('animate-shake', 'border', 'border-red-500', 'rounded-xl');
                    triggerHaptic();
                    return; // Stop here
                }
                meat = r.value;
            }
            let addons = [];
            let addPrice = 0;
            const names = {special:'‡∏û‡∏¥‡πÄ‡∏®‡∏©', kaikhon:'‡πÑ‡∏Ç‡πà‡∏Ç‡πâ‡∏ô', kaidao:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', kaijiao:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', kaitom:'‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°', kaiyiewma:'‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤'};
            addonIds.forEach(id => {
                if(document.getElementById(`modal-opt-${id}`).checked) {
                    addons.push(names[id]);
                    addPrice += 10;
                }
            });
            
            // Sanitize Note
            const noteSafe = escapeHtml(document.getElementById('modal-note').value.trim());

            for(let i=0; i<modalQty; i++){
                cart.push({
                    id: Date.now() + i,
                    name: currentItem.name,
                    price: currentItem.price + addPrice,
                    meat: meat,
                    addons: addons,
                    note: noteSafe
                });
            }
            sfxPop.currentTime = 0; sfxPop.play(); triggerHaptic();
            closeModal();
            updateMiniCart();
            saveToLS();
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${modalQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!`);
        }
        
        // --- STREAK LOGIC ---
        function updateStreak() {
            const today = new Date().toDateString();
            const lastOrderDate = localStorage.getItem('kaprao_last_order_date');
            let currentStreak = parseInt(localStorage.getItem('kaprao_streak') || 0);

            // Display Logic
            const display = document.getElementById('streak-display');
            const text = document.getElementById('streak-text');
            
            if (currentStreak > 1) {
                display.classList.remove('hidden');
                text.innerText = `‡∏™‡∏±‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô ${currentStreak} ‡∏ß‡∏±‡∏ô!`;
            } else {
                display.classList.add('hidden');
            }
        }

        function recordOrderForStreak() {
            const today = new Date();
            const todayStr = today.toDateString();
            const lastOrderDate = localStorage.getItem('kaprao_last_order_date');
            let currentStreak = parseInt(localStorage.getItem('kaprao_streak') || 0);

            if (lastOrderDate) {
                const lastDate = new Date(lastOrderDate);
                const diffTime = Math.abs(today - lastDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                if (todayStr === lastOrderDate) {
                    // Same day, do nothing
                } else if (diffDays === 1) {
                    // Consecutive day
                    currentStreak++;
                } else {
                    // Missed a day
                    currentStreak = 1;
                }
            } else {
                // First order ever
                currentStreak = 1;
            }

            localStorage.setItem('kaprao_last_order_date', todayStr);
            localStorage.setItem('kaprao_streak', currentStreak);
            updateStreak();
        }

        // --- LOTTERY UTILS ---
        
        function getNextDrawDate() {
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth();
            const year = today.getFullYear();
            let drawDate = new Date();
            if (day <= 1) drawDate = new Date(year, month, 1);
            else if (day <= 16) drawDate = new Date(year, month, 16);
            else drawDate = new Date(year, month + 1, 1);
            return drawDate;
        }

        const OFFICIAL_RESULTS = {
             "16/12/2566": "52",
             "30/12/2566": "99",
             "17/1/2567": "00",
             "1/11/2566": "52",
             "16/11/2566": "99"
        };

        function getWinningNumberForDate(dateStr) {
            if (OFFICIAL_RESULTS[dateStr]) return OFFICIAL_RESULTS[dateStr];
            return "NotSet"; 
        }

        let currentOrderId = "";
        function generateOrderId() {
            const now = Date.now().toString(); 
            const randomPart = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            const timePart = now.slice(-2);
            currentOrderId = `KP-${timePart}${randomPart}`;
            return currentOrderId;
        }

        function saveTicketToHistory(orderId, totalPrice) {
            const today = new Date();
            const drawDateObj = getNextDrawDate();
            const drawDateStr = drawDateObj.toLocaleDateString('th-TH');
            const name = document.getElementById('user-name').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            
            const ticket = {
                id: orderId,
                number: orderId.slice(-2),
                date: today.toLocaleDateString('th-TH'),
                drawDate: drawDateStr,
                drawDateTimestamp: drawDateObj.getTime(),
                timestamp: Date.now(),
                price: totalPrice,
                status: 'pending',
                checkedDate: null,
                items: JSON.parse(JSON.stringify(cart)), 
                customerName: name 
            };
            lottoHistory.unshift(ticket);
            localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
            updateTicketBadge();
        }

        function autoCheckLottery() {
            const pendingTickets = lottoHistory.filter(t => t.status === 'pending');
            if(pendingTickets.length === 0) return;
            const now = new Date();
            now.setHours(0, 0, 0, 0); 
            let winCount = 0;
            let updated = false;
            pendingTickets.forEach(t => {
                let targetDate;
                if (t.drawDateTimestamp) targetDate = t.drawDateTimestamp;
                else targetDate = 0; 
                if (now.getTime() < targetDate) return;
                const winningNum = getWinningNumberForDate(t.drawDate || new Date().toLocaleDateString('th-TH'));
                if (t.number === winningNum) {
                    t.status = 'won';
                    winCount++;
                    if (Notification.permission === "granted") {
                        new Notification("‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ü§ë", { 
                            body: `‡∏á‡∏ß‡∏î ${t.drawDate}: Order ${t.id} ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡∏¥‡∏ô‡∏ü‡∏£‡∏µ!`, 
                            icon: 'https://cdn-icons-png.flaticon.com/512/3170/3170733.png' 
                        });
                    }
                } else if (winningNum !== "NotSet") {
                    t.status = 'lost';
                }
                if (winningNum !== "NotSet") {
                    t.checkedDate = new Date().toLocaleDateString('th-TH');
                    updated = true;
                }
            });
            if (updated) {
                localStorage.setItem(KEYS.HISTORY, JSON.stringify(lottoHistory));
                if(winCount > 0) {
                    sfxWin.play();
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    showToast(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${winCount} ‡πÉ‡∏ö!`);
                }
                updateTicketBadge();
            }
        }

        function updateTicketBadge() {
            const pending = lottoHistory.filter(t => t.status === 'pending').length;
            const dot = document.getElementById('unread-ticket-dot');
            if(pending > 0) dot.classList.remove('hidden'); else dot.classList.add('hidden');
        }

        function openMyTickets() {
            pushModalState('tickets'); // Added History

            triggerHaptic();
            const list = document.getElementById('tickets-list');
            list.innerHTML = '';
            if(lottoHistory.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <div class="text-4xl mb-2 opacity-30">üéüÔ∏è</div>
                        <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                    </div>`;
            } else {
                lottoHistory.forEach((t, index) => {
                    let statusHtml = '';
                    let statusClass = '';
                    if(t.status === 'pending') {
                        statusHtml = `<span class="text-brand-purple font-bold"><i class="far fa-clock"></i> ‡∏£‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏á‡∏ß‡∏î ${t.drawDate || '‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ'}</span>`;
                        statusClass = 'border-l-4 border-brand-purple bg-indigo-50';
                    } else if(t.status === 'won') {
                        statusHtml = '<span class="text-yellow-600 font-bold"><i class="fas fa-trophy"></i> ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!</span>';
                        statusClass = 'border-l-4 border-yellow-500 bg-yellow-50';
                    } else {
                        statusHtml = '<span class="text-gray-400 font-bold"><i class="fas fa-times-circle"></i> ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>';
                        statusClass = 'border-l-4 border-gray-300 bg-gray-50 opacity-70 grayscale';
                    }
                    const item = document.createElement('div');
                    item.onclick = () => reprintReceipt(index);
                    item.className = `ticket-stub p-4 rounded-lg shadow-sm border border-gray-200 mb-3 flex justify-between items-center relative overflow-hidden cursor-pointer active:scale-95 transition-transform ${statusClass}`;
                    item.innerHTML = `
                        <div>
                            <div class="text-[10px] text-gray-400">Order ID: ${t.id}</div>
                            <div class="flex items-baseline gap-2 mt-1">
                                <span class="text-xs text-gray-600">‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô:</span>
                                <span class="text-2xl font-black text-brand-purple tracking-widest">${t.number}</span>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${t.date}</div>
                            <div class="text-[10px] text-indigo-500 font-bold mt-2"><i class="fas fa-print"></i> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                        </div>
                        <div class="text-right flex flex-col items-end">
                             <div class="text-xs mb-1 bg-white/80 px-2 py-1 rounded-full shadow-sm whitespace-nowrap">${statusHtml}</div>
                             ${t.status === 'won' ? '<button class="text-[10px] bg-yellow-500 text-white font-bold px-2 py-1 rounded shadow-sm mt-1 animate-pulse">‡πÅ‡∏Ñ‡∏õ‡∏à‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>' : ''}
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            const overlay = document.getElementById('tickets-modal-overlay');
            const sheet = document.getElementById('tickets-sheet');
            sheet.style.transform = '';
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                sheet.classList.remove('translate-y-full');
            }, 10);
        }

        function closeMyTickets(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'tickets') { history.back(); return; }

            const overlay = document.getElementById('tickets-modal-overlay');
            const sheet = document.getElementById('tickets-sheet');
            overlay.classList.add('opacity-0');
            sheet.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                sheet.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function openCheckout() {
            pushModalState('checkout'); // Added History

            triggerHaptic();
            renderCheckoutList();
            if(document.getElementById('discount-code').value.trim() !== '' && discountValue > 0) applyDiscount();
            if(cart.length > 0) {
                 const lottoId = generateOrderId();
                 const listContainer = document.getElementById('cart-list-container');
                 const lottoBanner = document.createElement('div');
                 lottoBanner.className = "bg-gradient-to-r from-brand-purple to-indigo-600 text-white p-4 rounded-xl mb-4 flex justify-between items-center shadow-md relative overflow-hidden";
                 lottoBanner.innerHTML = `
                    <div class="absolute -right-4 -top-4 bg-white opacity-10 w-20 h-20 rounded-full"></div>
                    <div class="flex flex-col z-10">
                        <span class="text-[10px] opacity-90 uppercase tracking-wider">Order ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
                        <div class="flex items-baseline gap-1">
                            <span class="font-bold text-xl">${lottoId.slice(0, -2)}</span>
                            <span class="font-black text-3xl text-brand-yellow drop-shadow-md">${lottoId.slice(-2)}</span>
                        </div>
                    </div>
                    <div class="z-10 text-right">
                        <div class="text-2xl">üéüÔ∏è</div>
                        <span class="text-[10px] font-bold">‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ!</span>
                    </div>
                 `;
                 listContainer.insertBefore(lottoBanner, listContainer.firstChild);
            }
            const overlay = document.getElementById('checkout-overlay');
            const sheet = document.getElementById('checkout-sheet');
            sheet.style.transform = '';
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                sheet.classList.remove('translate-y-full');
            }, 10);
        }

        function closeCheckout(isBackNav = false) {
            if (!isBackNav && currentOpenModal === 'checkout') { history.back(); return; }

            const overlay = document.getElementById('checkout-overlay');
            const sheet = document.getElementById('checkout-sheet');
            overlay.classList.add('opacity-0');
            sheet.classList.add('translate-y-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
                sheet.style.transform = '';
            }, 300);
            currentOpenModal = null;
        }

        function updateMiniCart() {
            const miniBar = document.getElementById('mini-cart-bar');
            if(cart.length > 0) {
                miniBar.classList.remove('hidden');
                let total = cart.reduce((sum, i) => sum + i.price, 0);
                document.getElementById('mini-count').innerText = cart.length;
                document.getElementById('mini-total').innerText = total + " ‡∏ø";
            } else {
                miniBar.classList.add('hidden');
            }
        }

        function renderCheckoutList() {
            const container = document.getElementById('cart-list-container');
            container.innerHTML = '';
            cart.forEach(item => {
                const el = document.createElement('div');
                el.className = "bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-start";
                let detail = item.meat ? `<span class="text-orange-500 text-xs bg-orange-50 px-1 rounded">${item.meat}</span> ` : '';
                if(item.addons.length) detail += `<span class="text-gray-400 text-xs">+${item.addons.join(',')}</span>`;
                el.innerHTML = `
                    <div>
                        <h4 class="font-bold text-gray-800 text-sm">${item.name}</h4>
                        <div class="mt-1">${detail}</div>
                        ${item.note ? `<div class="text-[10px] text-gray-400 mt-1">Note: ${item.note}</div>` : ''}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="font-bold text-gray-700">${item.price}.-</span>
                        <button onclick="removeFromCart(${item.id})" class="text-xs text-red-400 bg-red-50 w-9 h-9 rounded flex items-center justify-center border border-red-100"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
            updateTotalSummary();
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            saveToLS();
            if(cart.length === 0) removeDiscount();
            else if(discountValue > 0) applyDiscount();
            renderCheckoutList();
            updateMiniCart();
            if(cart.length === 0) closeCheckout();
        }
        
        function clearCart() {
            if(cart.length === 0) return;
            if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
            sfxTrash.play();
            cart = [];
            saveToLS();
            removeDiscount();
            updateMiniCart();
            closeCheckout();
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üóëÔ∏è');
        }

        function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim().toUpperCase();
            let total = cart.reduce((sum, i) => sum + i.price, 0);
            const msg = document.getElementById('discount-msg');
            const promo = promotions.find(p => p.code === code);
            discountValue = 0;
            const inputContainer = document.getElementById('code-input-container');
            const btn = document.getElementById('btn-apply-code');
            if (promo && total >= promo.minOrder) {
                discountValue = promo.value;
                msg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏î ${promo.value} ‡∏ö‡∏≤‡∏ó</span>`;
                inputContainer.className = "input-success rounded-xl p-2 pl-4 flex items-center border shadow-sm justify-between transition-colors";
                btn.innerHTML = '<i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                btn.className = 'bg-red-500 hover:bg-red-600 text-white text-xs px-4 py-2 rounded-lg transition-colors font-bold whitespace-nowrap';
                btn.onclick = removeDiscount;
            } else {
                msg.innerHTML = `<span class="text-red-400">${promo ? '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏ö '+promo.minOrder : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î'}</span>`;
                inputContainer.className = "bg-white rounded-xl p-2 pl-4 flex items-center border border-gray-200 shadow-sm justify-between transition-colors";
                btn.innerHTML = '‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î';
                btn.className = 'bg-gray-800 hover:bg-gray-700 text-white text-xs px-4 py-2 rounded-lg transition-colors font-bold whitespace-nowrap';
            }
            updateTotalSummary();
        }

        function removeDiscount() {
            document.getElementById('discount-code').value = '';
            document.getElementById('discount-msg').innerText = '';
            discountValue = 0;
            applyDiscount();
        }

        function updateTotalSummary() {
            let total = cart.reduce((sum, i) => sum + i.price, 0);
            let final = Math.max(0, total - discountValue);
            document.getElementById('sheet-grand-total').innerText = final + " ‡∏ø";
        }

        // --- NEW: PREMIUM RECEIPT GENERATOR ---
        function generateOrderCard() {
            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...");
            const name = document.getElementById('user-name').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            const now = new Date().toLocaleString('th-TH');
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            let netTotal = Math.max(0, subtotal - discountValue);

            // Populate Receipt Data
            document.querySelector('.receipt-id').innerText = currentOrderId || 'KP-XXXX';
            document.querySelector('.receipt-date').innerText = now;
            document.querySelector('.receipt-name').innerText = escapeHtml(name);
            document.querySelector('.receipt-subtotal').innerText = subtotal + '.-';
            document.querySelector('.receipt-discount').innerText = '-' + discountValue + '.-';
            document.querySelector('.receipt-total').innerText = netTotal + '.-';

            // SHOW AVATAR ON RECEIPT
            const receiptAvatar = document.getElementById('receipt-avatar-img');
            receiptAvatar.src = userAvatar.image;
            
            // Show hat in receipt
            const receiptHat = document.getElementById('receipt-hat');
            if (userAvatar.hat) receiptHat.classList.remove('hidden');
            else receiptHat.classList.add('hidden');

            const itemsContainer = document.querySelector('.receipt-items');
            itemsContainer.innerHTML = '';
            cart.forEach((i, index) => {
                let detail = `${i.name}`;
                if(i.meat) detail += ` (${i.meat})`;
                if(i.addons.length) detail += ` +${i.addons.join(',')}`;
                const row = document.createElement('div');
                row.className = "flex justify-between text-xs";
                row.innerHTML = `
                    <div class="flex gap-1 text-gray-700">
                        <span class="w-4">${index+1}.</span>
                        <span>${detail}</span>
                    </div>
                    <span class="font-bold text-gray-800">${i.price}.-</span>
                `;
                itemsContainer.appendChild(row);
            });

            // Capture (Feature 5: Save Name)
            const div = document.getElementById('receipt-capture');
            const nowFile = new Date();
            const filename = `Kaprao_${nowFile.toISOString().split('T')[0]}_${nowFile.getHours()}-${nowFile.getMinutes()}.png`;

            html2canvas(div, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: null 
            }).then(canvas => {
                hideGlobalLoader();
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL();
                link.click();
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß üì∏');
            }).catch(() => {
                hideGlobalLoader();
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û');
            });
        }

        // --- NEW: REPRINT RECEIPT FROM HISTORY ---
        function reprintReceipt(ticketIndex) {
            triggerHaptic();
            const ticket = lottoHistory[ticketIndex];
            
            if (!ticket.items || ticket.items.length === 0) {
                showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤ üò¢");
                return;
            }

            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...");
            
            const name = ticket.customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            const subtotal = ticket.items.reduce((sum, i) => sum + i.price, 0);
            const netTotal = ticket.price; 
            const discount = subtotal - netTotal; 

            document.querySelector('.receipt-id').innerText = ticket.id;
            document.querySelector('.receipt-date').innerText = new Date(ticket.timestamp).toLocaleString('th-TH');
            document.querySelector('.receipt-name').innerText = escapeHtml(name);
            document.querySelector('.receipt-subtotal').innerText = subtotal + '.-';
            document.querySelector('.receipt-discount').innerText = '-' + discount + '.-';
            document.querySelector('.receipt-total').innerText = netTotal + '.-';

            const itemsContainer = document.querySelector('.receipt-items');
            itemsContainer.innerHTML = '';
            ticket.items.forEach((i, index) => {
                let detail = `${i.name}`;
                if(i.meat) detail += ` (${i.meat})`;
                if(i.addons.length) detail += ` +${i.addons.join(',')}`;
                const row = document.createElement('div');
                row.className = "flex justify-between text-xs";
                row.innerHTML = `
                    <div class="flex gap-1 text-gray-700">
                        <span class="w-4">${index+1}.</span>
                        <span>${detail}</span>
                    </div>
                    <span class="font-bold text-gray-800">${i.price}.-</span>
                `;
                itemsContainer.appendChild(row);
            });

            // Delay slightly for rendering then Capture
            setTimeout(() => {
                const div = document.getElementById('receipt-capture');
                const tDate = new Date(ticket.timestamp);
                const filename = `Kaprao_Reprint_${tDate.toISOString().split('T')[0]}.png`;

                html2canvas(div, { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: null 
                }).then(canvas => {
                    hideGlobalLoader();
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß üì∏');
                }).catch(() => {
                    hideGlobalLoader();
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û');
                });
            }, 500);
        }

        // --- UPDATED: SEND TO GOOGLE SHEET & LINE ---
        async function submitOrderToLine() {
            const name = document.getElementById('user-name').value.trim();
            if (!name) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á');

            // 1. Show Loading
            showGlobalLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...");
            sfxOrder.play(); triggerHaptic();
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#FFD755', '#7C77D6', '#FFFFFF'] });
            
            // FEED PET AND GROW
            feedPet();

            // Record Streak
            recordOrderForStreak();

            userStats.orders++;
            localStorage.setItem(KEYS.STATS, JSON.stringify(userStats));
            updateLevelUI();
            
            // Calculate Totals
            let subtotal = cart.reduce((sum, i) => sum + i.price, 0);
            let netTotal = Math.max(0, subtotal - discountValue);
            
            // 2. Prepare Data for Google Sheet
            const allNotes = cart.filter(i => i.note).map(i => i.note).join(", ");
            const sheetData = {
                orderId: currentOrderId,
                name: name,
                items: cart,
                totalPrice: subtotal,
                discount: discountValue,
                netTotal: netTotal,
                allNotes: allNotes
            };

            // 3. Send to Google Sheet (using fetch with no-cors to avoid simple CORS issues)
            if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(sheetData)
                    });
                    console.log("Order sent to Sheet successfully");
                } catch (err) {
                    console.error("Error sending to sheet:", err);
                    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert user ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ LINE ‡∏ï‡πà‡∏≠
                }
            } else {
                console.warn("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Script");
            }

            // 4. Generate LINE Message
            const now = new Date().toLocaleString('th-TH');
            let msg = `üî• ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà! [${currentOrderId}]\n`;
            msg += `üéüÔ∏è ‡πÄ‡∏•‡∏Ç‡∏•‡∏∏‡πâ‡∏ô‡∏´‡∏ß‡∏¢: ${currentOrderId.slice(-2)}\n`;
            msg += `üìÖ ${now}\n`;
            msg += `üë§ ‡∏Ñ‡∏∏‡∏ì ${name}\n`;
            msg += `üèÖ ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà: ${userStats.orders}\n`;
            msg += `------------------------\n`;
            cart.forEach((i, index) => {
                let detail = `${i.name} ${i.meat ? '('+i.meat+')' : ''}`;
                if(i.addons.length) detail += ` +${i.addons.join('+')}`;
                if(i.note) detail += ` [${i.note}]`;
                msg += `${index + 1}. ${detail} (${i.price}.-)\n`;
            });
            msg += `------------------------\n`;
            if (discountValue > 0) {
                msg += `üíµ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${subtotal} ‡∏ö‡∏≤‡∏ó\n`;
                msg += `üè∑Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${discountValue} ‡∏ö‡∏≤‡∏ó\n`;
            }
            msg += `üí∞ ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${netTotal} ‡∏ö‡∏≤‡∏ó\n`;
            saveTicketToHistory(currentOrderId, netTotal);
            
            // Check URL Limit
            const encodedMsg = encodeURIComponent(msg);
            if(encodedMsg.length > 1800) {
                 hideGlobalLoader();
                 alert("‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏£‡∏∞‡∏ö‡∏ö LINE ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö \n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ö‡∏¥‡∏•‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
                 return;
            }

            // 5. Redirect to LINE
            setTimeout(() => {
                window.location.href = `https://line.me/R/msg/text/?${encodedMsg}`;
                cart = []; 
                saveToLS();
                updateMiniCart();
                closeCheckout();
                setTimeout(() => {
                    hideGlobalLoader(); 
                }, 1000);
            }, 800);
        }

        function randomMenu() {
            triggerHaptic();
            const dice = document.getElementById('dice-icon');
            dice.classList.add('fa-spin');
            setTimeout(() => {
                dice.classList.remove('fa-spin');
                const item = menuItems[Math.floor(Math.random() * menuItems.length)];
                if(item.category) switchCategory(item.category);
                openModal(item);
            }, 500);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', '-translate-y-10');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-10'), 2000);
        }

        function enableSwipeToClose(el, scrollEl, closeCallback) {
            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            el.addEventListener('touchstart', (e) => {
                if (scrollEl.scrollTop <= 0) { startY = e.touches[0].clientY; isDragging = true; el.style.transition = 'none'; }
            }, { passive: true });
            el.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const diff = e.touches[0].clientY - startY;
                if (diff > 0) { if (scrollEl.scrollTop > 0) return; e.preventDefault(); el.style.transform = `translateY(${diff}px)`; currentY = diff; }
            }, { passive: false });
            el.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                el.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
                if (currentY > 150) closeCallback(); else el.style.transform = '';
                currentY = 0;
            });
        }
        enableSwipeToClose(document.getElementById('modal-content'), document.getElementById('modal-scroll-area'), closeModal);
        enableSwipeToClose(document.getElementById('checkout-sheet'), document.getElementById('cart-list-container'), closeCheckout);
        enableSwipeToClose(document.getElementById('tickets-sheet'), document.getElementById('tickets-list'), closeMyTickets);

        document.getElementById('user-name').addEventListener('input', saveToLS);
        renderMenu();
    </script>
</body>
</html>
